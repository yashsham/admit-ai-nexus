var Nd=Object.defineProperty;var Pd=(r,e,t)=>e in r?Nd(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var y=(r,e,t)=>Pd(r,typeof e!="symbol"?e+"":e,t);import{g as Oc,e as Ld}from"./index-BNzMo3-2.js";import{b as jd}from"./index-D0UyVEDn.js";const Md={"llama-3.1-8b-instant":{maxInputTokens:131072,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:8192,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!1},"mistral-saba-24b":{maxInputTokens:32768,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!1},"llama3-8b-8192":{maxInputTokens:8192,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:8192,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!1},"qwen-qwq-32b":{maxInputTokens:131072,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!1},"llama3-70b-8192":{maxInputTokens:8192,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:8192,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!1},"deepseek-r1-distill-llama-70b":{maxInputTokens:131072,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:8192,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!1},"llama-guard-3-8b":{maxInputTokens:8192,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:8192,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!1},"gemma2-9b-it":{maxInputTokens:8192,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:8192,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!1},"llama-3.3-70b-versatile":{maxInputTokens:131072,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!1},"moonshotai/kimi-k2-instruct-0905":{maxInputTokens:262144,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!1},"moonshotai/kimi-k2-instruct":{maxInputTokens:131072,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!1},"openai/gpt-oss-20b":{maxInputTokens:131072,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!1},"openai/gpt-oss-120b":{maxInputTokens:131072,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!1},"qwen/qwen3-32b":{maxInputTokens:131072,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!1},"meta-llama/llama-4-scout-17b-16e-instruct":{maxInputTokens:131072,imageInputs:!0,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:8192,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!1},"meta-llama/llama-4-maverick-17b-128e-instruct":{maxInputTokens:131072,imageInputs:!0,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:8192,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!1},"meta-llama/llama-guard-4-12b":{maxInputTokens:131072,imageInputs:!0,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:128,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!1}};var Dd=Md,Ud=Object.defineProperty,he=(r,e)=>{for(var t in e)Ud(r,t,{get:e[t],enumerable:!0})};function Cr(r,e,t){function n(o,c){if(o._zod||Object.defineProperty(o,"_zod",{value:{def:c,constr:i,traits:new Set},enumerable:!1}),o._zod.traits.has(r))return;o._zod.traits.add(r),e(o,c);const u=i.prototype,l=Object.keys(u);for(let d=0;d<l.length;d++){const f=l[d];f in o||(o[f]=u[f].bind(o))}}const s=(t==null?void 0:t.Parent)??Object;class a extends s{}Object.defineProperty(a,"name",{value:r});function i(o){var c;const u=t!=null&&t.Parent?new a:this;n(u,o),(c=u._zod).deferred??(c.deferred=[]);for(const l of u._zod.deferred)l();return u}return Object.defineProperty(i,"init",{value:n}),Object.defineProperty(i,Symbol.hasInstance,{value:o=>{var c,u;return t!=null&&t.Parent&&o instanceof t.Parent?!0:(u=(c=o==null?void 0:o._zod)==null?void 0:c.traits)==null?void 0:u.has(r)}}),Object.defineProperty(i,"name",{value:r}),i}class Hr extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const Fd={};function ts(r){return Fd}function Bd(r){const e=Object.values(r).filter(n=>typeof n=="number");return Object.entries(r).filter(([n,s])=>e.indexOf(+n)===-1).map(([n,s])=>s)}function zd(r,e){return typeof e=="bigint"?e.toString():e}function Gd(r){const e=r.startsWith("^")?1:0,t=r.endsWith("$")?r.length-1:r.length;return r.slice(e,t)}const Ci=Symbol("evaluating");function Ni(r,e,t){let n;Object.defineProperty(r,e,{get(){if(n!==Ci)return n===void 0&&(n=Ci,n=t()),n},set(s){Object.defineProperty(r,e,{value:s})},configurable:!0})}function Ac(r,e,t){Object.defineProperty(r,e,{value:t,writable:!0,enumerable:!0,configurable:!0})}function kc(...r){const e={};for(const t of r){const n=Object.getOwnPropertyDescriptors(t);Object.assign(e,n)}return Object.defineProperties({},e)}const Rc="captureStackTrace"in Error?Error.captureStackTrace:(...r)=>{};function Pi(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)}function qd(r){if(Pi(r)===!1)return!1;const e=r.constructor;if(e===void 0||typeof e!="function")return!0;const t=e.prototype;return!(Pi(t)===!1||Object.prototype.hasOwnProperty.call(t,"isPrototypeOf")===!1)}function Rt(r,e,t){const n=new r._zod.constr(e??r._zod.def);return(!e||t!=null&&t.parent)&&(n._zod.parent=r),n}function Hd(r){return{}}function Vd(r,e){if(!qd(e))throw new Error("Invalid input to extend: expected a plain object");const t=r._zod.def.checks;if(t&&t.length>0)throw new Error("Object schemas containing refinements cannot be extended. Use `.safeExtend()` instead.");const s=kc(r._zod.def,{get shape(){const a={...r._zod.def.shape,...e};return Ac(this,"shape",a),a},checks:[]});return Rt(r,s)}function Zd(r,e,t){const n=kc(e._zod.def,{get shape(){const s=e._zod.def.shape,a={...s};for(const i in s)a[i]=r?new r({type:"optional",innerType:s[i]}):s[i];return Ac(this,"shape",a),a},checks:[]});return Rt(e,n)}function bn(r,e=0){var t;if(r.aborted===!0)return!0;for(let n=e;n<r.issues.length;n++)if(((t=r.issues[n])==null?void 0:t.continue)!==!0)return!0;return!1}function En(r){return typeof r=="string"?r:r==null?void 0:r.message}function rs(r,e,t){var s,a,i,o,c,u;const n={...r,path:r.path??[]};if(!r.message){const l=En((i=(a=(s=r.inst)==null?void 0:s._zod.def)==null?void 0:a.error)==null?void 0:i.call(a,r))??En((o=e==null?void 0:e.error)==null?void 0:o.call(e,r))??En((c=t.customError)==null?void 0:c.call(t,r))??En((u=t.localeError)==null?void 0:u.call(t,r))??"Invalid input";n.message=l}return delete n.inst,delete n.continue,e!=null&&e.reportInput||delete n.input,n}const $c=(r,e)=>{r.name="$ZodError",Object.defineProperty(r,"_zod",{value:r._zod,enumerable:!1}),Object.defineProperty(r,"issues",{value:e,enumerable:!1}),r.message=JSON.stringify(e,zd,2),Object.defineProperty(r,"toString",{value:()=>r.message,enumerable:!1})},Jd=Cr("$ZodError",$c),ns=Cr("$ZodError",$c,{Parent:Error}),Wd=r=>(e,t,n,s)=>{const a=n?Object.assign(n,{async:!1}):{async:!1},i=e._zod.run({value:t,issues:[]},a);if(i instanceof Promise)throw new Hr;if(i.issues.length){const o=new((s==null?void 0:s.Err)??r)(i.issues.map(c=>rs(c,a,ts())));throw Rc(o,s==null?void 0:s.callee),o}return i.value},Da=Wd(ns),Kd=r=>async(e,t,n,s)=>{const a=n?Object.assign(n,{async:!0}):{async:!0};let i=e._zod.run({value:t,issues:[]},a);if(i instanceof Promise&&(i=await i),i.issues.length){const o=new((s==null?void 0:s.Err)??r)(i.issues.map(c=>rs(c,a,ts())));throw Rc(o,s==null?void 0:s.callee),o}return i.value},Cc=Kd(ns),Xd=r=>(e,t,n)=>{const s=n?{...n,async:!1}:{async:!1},a=e._zod.run({value:t,issues:[]},s);if(a instanceof Promise)throw new Hr;return a.issues.length?{success:!1,error:new(r??Jd)(a.issues.map(i=>rs(i,s,ts())))}:{success:!0,data:a.value}},Yd=Xd(ns),Qd=r=>async(e,t,n)=>{const s=n?Object.assign(n,{async:!0}):{async:!0};let a=e._zod.run({value:t,issues:[]},s);return a instanceof Promise&&(a=await a),a.issues.length?{success:!1,error:new r(a.issues.map(i=>rs(i,s,ts())))}:{success:!0,data:a.value}},ef=Qd(ns),tf={major:4,minor:1,patch:13},Ua=Cr("$ZodType",(r,e)=>{var s;var t;r??(r={}),r._zod.def=e,r._zod.bag=r._zod.bag||{},r._zod.version=tf;const n=[...r._zod.def.checks??[]];r._zod.traits.has("$ZodCheck")&&n.unshift(r);for(const a of n)for(const i of a._zod.onattach)i(r);if(n.length===0)(t=r._zod).deferred??(t.deferred=[]),(s=r._zod.deferred)==null||s.push(()=>{r._zod.run=r._zod.parse});else{const a=(o,c,u)=>{let l=bn(o),d;for(const f of c){if(f._zod.def.when){if(!f._zod.def.when(o))continue}else if(l)continue;const h=o.issues.length,m=f._zod.check(o);if(m instanceof Promise&&(u==null?void 0:u.async)===!1)throw new Hr;if(d||m instanceof Promise)d=(d??Promise.resolve()).then(async()=>{await m,o.issues.length!==h&&(l||(l=bn(o,h)))});else{if(o.issues.length===h)continue;l||(l=bn(o,h))}}return d?d.then(()=>o):o},i=(o,c,u)=>{if(bn(o))return o.aborted=!0,o;const l=a(c,n,u);if(l instanceof Promise){if(u.async===!1)throw new Hr;return l.then(d=>r._zod.parse(d,u))}return r._zod.parse(l,u)};r._zod.run=(o,c)=>{if(c.skipChecks)return r._zod.parse(o,c);if(c.direction==="backward"){const l=r._zod.parse({value:o.value,issues:[]},{...c,skipChecks:!0});return l instanceof Promise?l.then(d=>i(d,o,c)):i(l,o,c)}const u=r._zod.parse(o,c);if(u instanceof Promise){if(c.async===!1)throw new Hr;return u.then(l=>a(l,n,c))}return a(u,n,c)}}r["~standard"]={validate:a=>{var i;try{const o=Yd(r,a);return o.success?{value:o.data}:{issues:(i=o.error)==null?void 0:i.issues}}catch{return ef(r,a).then(c=>{var u;return c.success?{value:c.data}:{issues:(u=c.error)==null?void 0:u.issues}})}},vendor:"zod",version:1}}),rf=Cr("$ZodUnknown",(r,e)=>{Ua.init(r,e),r._zod.parse=t=>t}),nf=Cr("$ZodNever",(r,e)=>{Ua.init(r,e),r._zod.parse=(t,n)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:r}),t)});function Li(r,e){return r.issues.length&&e===void 0?{issues:[],value:void 0}:r}const Nc=Cr("$ZodOptional",(r,e)=>{Ua.init(r,e),r._zod.optin="optional",r._zod.optout="optional",Ni(r._zod,"values",()=>e.innerType._zod.values?new Set([...e.innerType._zod.values,void 0]):void 0),Ni(r._zod,"pattern",()=>{const t=e.innerType._zod.pattern;return t?new RegExp(`^(${Gd(t.source)})?$`):void 0}),r._zod.parse=(t,n)=>{if(e.innerType._zod.optin==="optional"){const s=e.innerType._zod.run(t,n);return s instanceof Promise?s.then(a=>Li(a,t.value)):Li(s,t.value)}return t.value===void 0?t:e.innerType._zod.run(t,n)}});var ji;class Pc{constructor(){this._map=new WeakMap,this._idmap=new Map}add(e,...t){const n=t[0];if(this._map.set(e,n),n&&typeof n=="object"&&"id"in n){if(this._idmap.has(n.id))throw new Error(`ID ${n.id} already exists in the registry`);this._idmap.set(n.id,e)}return this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(e){const t=this._map.get(e);return t&&typeof t=="object"&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){const t=e._zod.parent;if(t){const n={...this.get(t)??{}};delete n.id;const s={...n,...this._map.get(e)};return Object.keys(s).length?s:void 0}return this._map.get(e)}has(e){return this._map.has(e)}}function sf(){return new Pc}(ji=globalThis).__zod_globalRegistry??(ji.__zod_globalRegistry=sf());const Je=globalThis.__zod_globalRegistry;function af(r){return new r({type:"unknown"})}function of(r,e){return new r({type:"never",...Hd()})}class Mi{constructor(e){this.counter=0,this.metadataRegistry=(e==null?void 0:e.metadata)??Je,this.target=(e==null?void 0:e.target)??"draft-2020-12",this.unrepresentable=(e==null?void 0:e.unrepresentable)??"throw",this.override=(e==null?void 0:e.override)??(()=>{}),this.io=(e==null?void 0:e.io)??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var d,f,h;var n;const s=e._zod.def,a={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},i=this.seen.get(e);if(i)return i.count++,t.schemaPath.includes(e)&&(i.cycle=t.path),i.schema;const o={schema:{},count:1,cycle:void 0,path:t.path};this.seen.set(e,o);const c=(f=(d=e._zod).toJSONSchema)==null?void 0:f.call(d);if(c)o.schema=c;else{const m={...t,schemaPath:[...t.schemaPath,e],path:t.path},T=e._zod.parent;if(T)o.ref=T,this.process(T,m),this.seen.get(T).isParent=!0;else{const w=o.schema;switch(s.type){case"string":{const _=w;_.type="string";const{minimum:b,maximum:v,format:O,patterns:x,contentEncoding:A}=e._zod.bag;if(typeof b=="number"&&(_.minLength=b),typeof v=="number"&&(_.maxLength=v),O&&(_.format=a[O]??O,_.format===""&&delete _.format),A&&(_.contentEncoding=A),x&&x.size>0){const J=[...x];J.length===1?_.pattern=J[0].source:J.length>1&&(o.schema.allOf=[...J.map(E=>({...this.target==="draft-7"||this.target==="draft-4"||this.target==="openapi-3.0"?{type:"string"}:{},pattern:E.source}))])}break}case"number":{const _=w,{minimum:b,maximum:v,format:O,multipleOf:x,exclusiveMaximum:A,exclusiveMinimum:J}=e._zod.bag;typeof O=="string"&&O.includes("int")?_.type="integer":_.type="number",typeof J=="number"&&(this.target==="draft-4"||this.target==="openapi-3.0"?(_.minimum=J,_.exclusiveMinimum=!0):_.exclusiveMinimum=J),typeof b=="number"&&(_.minimum=b,typeof J=="number"&&this.target!=="draft-4"&&(J>=b?delete _.minimum:delete _.exclusiveMinimum)),typeof A=="number"&&(this.target==="draft-4"||this.target==="openapi-3.0"?(_.maximum=A,_.exclusiveMaximum=!0):_.exclusiveMaximum=A),typeof v=="number"&&(_.maximum=v,typeof A=="number"&&this.target!=="draft-4"&&(A<=v?delete _.maximum:delete _.exclusiveMaximum)),typeof x=="number"&&(_.multipleOf=x);break}case"boolean":{const _=w;_.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"null":{this.target==="openapi-3.0"?(w.type="string",w.nullable=!0,w.enum=[null]):w.type="null";break}case"any":break;case"unknown":break;case"undefined":{if(this.unrepresentable==="throw")throw new Error("Undefined cannot be represented in JSON Schema");break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"never":{w.not={};break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{const _=w,{minimum:b,maximum:v}=e._zod.bag;typeof b=="number"&&(_.minItems=b),typeof v=="number"&&(_.maxItems=v),_.type="array",_.items=this.process(s.element,{...m,path:[...m.path,"items"]});break}case"object":{const _=w;_.type="object",_.properties={};const b=s.shape;for(const x in b)_.properties[x]=this.process(b[x],{...m,path:[...m.path,"properties",x]});const v=new Set(Object.keys(b)),O=new Set([...v].filter(x=>{const A=s.shape[x]._zod;return this.io==="input"?A.optin===void 0:A.optout===void 0}));O.size>0&&(_.required=Array.from(O)),((h=s.catchall)==null?void 0:h._zod.def.type)==="never"?_.additionalProperties=!1:s.catchall?s.catchall&&(_.additionalProperties=this.process(s.catchall,{...m,path:[...m.path,"additionalProperties"]})):this.io==="output"&&(_.additionalProperties=!1);break}case"union":{const _=w,b=s.discriminator!==void 0,v=s.options.map((O,x)=>this.process(O,{...m,path:[...m.path,b?"oneOf":"anyOf",x]}));b?_.oneOf=v:_.anyOf=v;break}case"intersection":{const _=w,b=this.process(s.left,{...m,path:[...m.path,"allOf",0]}),v=this.process(s.right,{...m,path:[...m.path,"allOf",1]}),O=A=>"allOf"in A&&Object.keys(A).length===1,x=[...O(b)?b.allOf:[b],...O(v)?v.allOf:[v]];_.allOf=x;break}case"tuple":{const _=w;_.type="array";const b=this.target==="draft-2020-12"?"prefixItems":"items",v=this.target==="draft-2020-12"||this.target==="openapi-3.0"?"items":"additionalItems",O=s.items.map((E,ye)=>this.process(E,{...m,path:[...m.path,b,ye]})),x=s.rest?this.process(s.rest,{...m,path:[...m.path,v,...this.target==="openapi-3.0"?[s.items.length]:[]]}):null;this.target==="draft-2020-12"?(_.prefixItems=O,x&&(_.items=x)):this.target==="openapi-3.0"?(_.items={anyOf:O},x&&_.items.anyOf.push(x),_.minItems=O.length,x||(_.maxItems=O.length)):(_.items=O,x&&(_.additionalItems=x));const{minimum:A,maximum:J}=e._zod.bag;typeof A=="number"&&(_.minItems=A),typeof J=="number"&&(_.maxItems=J);break}case"record":{const _=w;_.type="object",(this.target==="draft-7"||this.target==="draft-2020-12")&&(_.propertyNames=this.process(s.keyType,{...m,path:[...m.path,"propertyNames"]})),_.additionalProperties=this.process(s.valueType,{...m,path:[...m.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{const _=w,b=Bd(s.entries);b.every(v=>typeof v=="number")&&(_.type="number"),b.every(v=>typeof v=="string")&&(_.type="string"),_.enum=b;break}case"literal":{const _=w,b=[];for(const v of s.values)if(v===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof v=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");b.push(Number(v))}else b.push(v);if(b.length!==0)if(b.length===1){const v=b[0];_.type=v===null?"null":typeof v,this.target==="draft-4"||this.target==="openapi-3.0"?_.enum=[v]:_.const=v}else b.every(v=>typeof v=="number")&&(_.type="number"),b.every(v=>typeof v=="string")&&(_.type="string"),b.every(v=>typeof v=="boolean")&&(_.type="string"),b.every(v=>v===null)&&(_.type="null"),_.enum=b;break}case"file":{const _=w,b={type:"string",format:"binary",contentEncoding:"binary"},{minimum:v,maximum:O,mime:x}=e._zod.bag;v!==void 0&&(b.minLength=v),O!==void 0&&(b.maxLength=O),x?x.length===1?(b.contentMediaType=x[0],Object.assign(_,b)):_.anyOf=x.map(A=>({...b,contentMediaType:A})):Object.assign(_,b);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{const _=this.process(s.innerType,m);this.target==="openapi-3.0"?(o.ref=s.innerType,w.nullable=!0):w.anyOf=[_,{type:"null"}];break}case"nonoptional":{this.process(s.innerType,m),o.ref=s.innerType;break}case"success":{const _=w;_.type="boolean";break}case"default":{this.process(s.innerType,m),o.ref=s.innerType,w.default=JSON.parse(JSON.stringify(s.defaultValue));break}case"prefault":{this.process(s.innerType,m),o.ref=s.innerType,this.io==="input"&&(w._prefault=JSON.parse(JSON.stringify(s.defaultValue)));break}case"catch":{this.process(s.innerType,m),o.ref=s.innerType;let _;try{_=s.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}w.default=_;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{const _=w,b=e._zod.pattern;if(!b)throw new Error("Pattern not found in template literal");_.type="string",_.pattern=b.source;break}case"pipe":{const _=this.io==="input"?s.in._zod.def.type==="transform"?s.out:s.in:s.out;this.process(_,m),o.ref=_;break}case"readonly":{this.process(s.innerType,m),o.ref=s.innerType,w.readOnly=!0;break}case"promise":{this.process(s.innerType,m),o.ref=s.innerType;break}case"optional":{this.process(s.innerType,m),o.ref=s.innerType;break}case"lazy":{const _=e._zod.innerType;this.process(_,m),o.ref=_;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}case"function":{if(this.unrepresentable==="throw")throw new Error("Function types cannot be represented in JSON Schema");break}}}}const u=this.metadataRegistry.get(e);return u&&Object.assign(o.schema,u),this.io==="input"&&Be(e)&&(delete o.schema.examples,delete o.schema.default),this.io==="input"&&o.schema._prefault&&((n=o.schema).default??(n.default=o.schema._prefault)),delete o.schema._prefault,this.seen.get(e).schema}emit(e,t){var l,d,f,h,m,T;const n={cycles:(t==null?void 0:t.cycles)??"ref",reused:(t==null?void 0:t.reused)??"inline",external:(t==null?void 0:t.external)??void 0},s=this.seen.get(e);if(!s)throw new Error("Unprocessed schema. This is a bug in Zod.");const a=w=>{var x;const _=this.target==="draft-2020-12"?"$defs":"definitions";if(n.external){const A=(x=n.external.registry.get(w[0]))==null?void 0:x.id,J=n.external.uri??(ye=>ye);if(A)return{ref:J(A)};const E=w[1].defId??w[1].schema.id??`schema${this.counter++}`;return w[1].defId=E,{defId:E,ref:`${J("__shared")}#/${_}/${E}`}}if(w[1]===s)return{ref:"#"};const v=`#/${_}/`,O=w[1].schema.id??`__schema${this.counter++}`;return{defId:O,ref:v+O}},i=w=>{if(w[1].schema.$ref)return;const _=w[1],{ref:b,defId:v}=a(w);_.def={..._.schema},v&&(_.defId=v);const O=_.schema;for(const x in O)delete O[x];O.$ref=b};if(n.cycles==="throw")for(const w of this.seen.entries()){const _=w[1];if(_.cycle)throw new Error(`Cycle detected: #/${(l=_.cycle)==null?void 0:l.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const w of this.seen.entries()){const _=w[1];if(e===w[0]){i(w);continue}if(n.external){const v=(d=n.external.registry.get(w[0]))==null?void 0:d.id;if(e!==w[0]&&v){i(w);continue}}if((f=this.metadataRegistry.get(w[0]))==null?void 0:f.id){i(w);continue}if(_.cycle){i(w);continue}if(_.count>1&&n.reused==="ref"){i(w);continue}}const o=(w,_)=>{const b=this.seen.get(w),v=b.def??b.schema,O={...v};if(b.ref===null)return;const x=b.ref;if(b.ref=null,x){o(x,_);const A=this.seen.get(x).schema;A.$ref&&(_.target==="draft-7"||_.target==="draft-4"||_.target==="openapi-3.0")?(v.allOf=v.allOf??[],v.allOf.push(A)):(Object.assign(v,A),Object.assign(v,O))}b.isParent||this.override({zodSchema:w,jsonSchema:v,path:b.path??[]})};for(const w of[...this.seen.entries()].reverse())o(w[0],{target:this.target});const c={};if(this.target==="draft-2020-12"?c.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?c.$schema="http://json-schema.org/draft-07/schema#":this.target==="draft-4"?c.$schema="http://json-schema.org/draft-04/schema#":this.target==="openapi-3.0"||console.warn(`Invalid target: ${this.target}`),(h=n.external)!=null&&h.uri){const w=(m=n.external.registry.get(e))==null?void 0:m.id;if(!w)throw new Error("Schema is missing an `id` property");c.$id=n.external.uri(w)}Object.assign(c,s.def);const u=((T=n.external)==null?void 0:T.defs)??{};for(const w of this.seen.entries()){const _=w[1];_.def&&_.defId&&(u[_.defId]=_.def)}n.external||Object.keys(u).length>0&&(this.target==="draft-2020-12"?c.$defs=u:c.definitions=u);try{return JSON.parse(JSON.stringify(c))}catch{throw new Error("Error converting schema to JSON.")}}}function Di(r,e){if(r instanceof Pc){const n=new Mi(e),s={};for(const o of r._idmap.entries()){const[c,u]=o;n.process(u)}const a={},i={registry:r,uri:e==null?void 0:e.uri,defs:s};for(const o of r._idmap.entries()){const[c,u]=o;a[c]=n.emit(u,{...e,external:i})}if(Object.keys(s).length>0){const o=n.target==="draft-2020-12"?"$defs":"definitions";a.__shared={[o]:s}}return{schemas:a}}const t=new Mi(e);return t.process(r),t.emit(r,e)}function Be(r,e){const t=e??{seen:new Set};if(t.seen.has(r))return!1;t.seen.add(r);const n=r._zod.def;if(n.type==="transform")return!0;if(n.type==="array")return Be(n.element,t);if(n.type==="set")return Be(n.valueType,t);if(n.type==="lazy")return Be(n.getter(),t);if(n.type==="promise"||n.type==="optional"||n.type==="nonoptional"||n.type==="nullable"||n.type==="readonly"||n.type==="default"||n.type==="prefault")return Be(n.innerType,t);if(n.type==="intersection")return Be(n.left,t)||Be(n.right,t);if(n.type==="record"||n.type==="map")return Be(n.keyType,t)||Be(n.valueType,t);if(n.type==="pipe")return Be(n.in,t)||Be(n.out,t);if(n.type==="object"){for(const s in n.shape)if(Be(n.shape[s],t))return!0;return!1}if(n.type==="union"){for(const s of n.options)if(Be(s,t))return!0;return!1}if(n.type==="tuple"){for(const s of n.items)if(Be(s,t))return!0;return!!(n.rest&&Be(n.rest,t))}return!1}function Oe(r){if(typeof r!="object"||r===null)return!1;const e=r;if(!("_zod"in e))return!1;const t=e._zod;return typeof t=="object"&&t!==null&&"def"in t}function Ce(r){if(typeof r!="object"||r===null)return!1;const e=r;if(!("_def"in e)||"_zod"in e)return!1;const t=e._def;return typeof t=="object"&&t!=null&&"typeName"in t}function cf(r){return Oe(r)&&console.warn("[WARNING] Attempting to use Zod 4 schema in a context where Zod 3 schema is expected. This may cause unexpected behavior."),Ce(r)}function or(r){return!r||typeof r!="object"||Array.isArray(r)?!1:!!(Oe(r)||Ce(r))}function Lc(r){return typeof r=="object"&&r!==null&&"_def"in r&&typeof r._def=="object"&&r._def!==null&&"typeName"in r._def&&r._def.typeName==="ZodLiteral"}function jc(r){return Oe(r)?typeof r=="object"&&r!==null&&"_zod"in r&&typeof r._zod=="object"&&r._zod!==null&&"def"in r._zod&&typeof r._zod.def=="object"&&r._zod.def!==null&&"type"in r._zod.def&&r._zod.def.type==="literal":!1}function uf(r){return!!(Lc(r)||jc(r))}async function Mc(r,e){if(Oe(r))try{return{success:!0,data:await Cc(r,e)}}catch(t){return{success:!1,error:t}}if(Ce(r))return await r.safeParseAsync(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}async function Fa(r,e){if(Oe(r))return await Cc(r,e);if(Ce(r))return await r.parseAsync(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function lf(r,e){if(Oe(r))try{return{success:!0,data:Da(r,e)}}catch(t){return{success:!1,error:t}}if(Ce(r))return r.safeParse(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function df(r,e){if(Oe(r))return Da(r,e);if(Ce(r))return r.parse(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Ba(r){var e;if(Oe(r))return(e=Je.get(r))==null?void 0:e.description;if(Ce(r)||"description"in r&&typeof r.description=="string")return r.description}function ff(r){if(!or(r))return!1;if(Ce(r)){const e=r._def;if(e.typeName==="ZodObject"){const t=r;return!t.shape||Object.keys(t.shape).length===0}if(e.typeName==="ZodRecord")return!0}if(Oe(r)){const e=r._zod.def;if(e.type==="object"){const t=r;return!t.shape||Object.keys(t.shape).length===0}if(e.type==="record")return!0}return typeof r=="object"&&r!==null&&!("shape"in r)}function Dc(r){return or(r)?Ce(r)?r._def.typeName==="ZodString":Oe(r)?r._zod.def.type==="string":!1:!1}function za(r){return typeof r=="object"&&r!==null&&"_def"in r&&typeof r._def=="object"&&r._def!==null&&"typeName"in r._def&&r._def.typeName==="ZodObject"}function vt(r){return Oe(r)?typeof r=="object"&&r!==null&&"_zod"in r&&typeof r._zod=="object"&&r._zod!==null&&"def"in r._zod&&typeof r._zod.def=="object"&&r._zod.def!==null&&"type"in r._zod.def&&r._zod.def.type==="object":!1}function ss(r){return Oe(r)?typeof r=="object"&&r!==null&&"_zod"in r&&typeof r._zod=="object"&&r._zod!==null&&"def"in r._zod&&typeof r._zod.def=="object"&&r._zod.def!==null&&"type"in r._zod.def&&r._zod.def.type==="array":!1}function hf(r){return!!(za(r)||vt(r))}function Qs(r){if(Ce(r))return r.shape;if(Oe(r))return r._zod.def.shape;throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function pf(r,e){if(Ce(r))return r.extend(e);if(Oe(r))return Vd(r,e);throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function mf(r){if(Ce(r))return r.partial();if(Oe(r))return Zd(Nc,r);throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function Fn(r,e=!1){if(Ce(r))return r.strict();if(vt(r)){const t=r._zod.def.shape;if(e)for(const[a,i]of Object.entries(r._zod.def.shape)){if(vt(i)){const c=Fn(i,e);t[a]=c}else if(ss(i)){let c=i._zod.def.element;vt(c)&&(c=Fn(c,e)),t[a]=Rt(i,{...i._zod.def,element:c})}else t[a]=i;const o=Je.get(i);o&&Je.add(t[a],o)}const n=Rt(r,{...r._zod.def,shape:t,catchall:of(nf)}),s=Je.get(r);return s&&Je.add(n,s),n}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function ea(r,e=!1){if(za(r))return r.passthrough();if(vt(r)){const t=r._zod.def.shape;if(e)for(const[a,i]of Object.entries(r._zod.def.shape)){if(vt(i)){const c=ea(i,e);t[a]=c}else if(ss(i)){let c=i._zod.def.element;vt(c)&&(c=ea(c,e)),t[a]=Rt(i,{...i._zod.def,element:c})}else t[a]=i;const o=Je.get(i);o&&Je.add(t[a],o)}const n=Rt(r,{...r._zod.def,shape:t,catchall:af(rf)}),s=Je.get(r);return s&&Je.add(n,s),n}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function gf(r){if(Ce(r))try{const e=r.parse(void 0);return()=>e}catch{return}if(Oe(r))try{const e=Da(r,void 0);return()=>e}catch{return}}function yf(r){return Ce(r)&&"typeName"in r._def&&r._def.typeName==="ZodEffects"}function _f(r){return Oe(r)&&r._zod.def.type==="pipe"}function Ur(r,e,t){const n=t.get(r);if(n!==void 0)return n;if(Ce(r))return yf(r)?Ur(r._def.schema,e,t):r;if(Oe(r)){let s=r;if(_f(r)&&(s=Ur(r._zod.def.in,e,t)),e){if(vt(s)){const i=s._zod.def.shape;for(const[o,c]of Object.entries(s._zod.def.shape))i[o]=Ur(c,e,t);s=Rt(s,{...s._zod.def,shape:i})}else if(ss(s)){const i=Ur(s._zod.def.element,e,t);s=Rt(s,{...s._zod.def,element:i})}}const a=Je.get(r);return a&&Je.add(s,a),t.set(r,s),s}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Uc(r,e=!1){return Ur(r,e,new WeakMap)}function wf(r,e){if(Ce(r)){const t=Qs(r),n={};for(const[s,a]of Object.entries(t))e(s,a)?n[s]=a.optional():n[s]=a;return r.extend(n)}if(Oe(r)){const t=Qs(r),n={...r._zod.def.shape};for(const[i,o]of Object.entries(t))e(i,o)&&(n[i]=new Nc({type:"optional",innerType:o}));const s=Rt(r,{...r._zod.def,shape:n}),a=Je.get(r);return a&&Je.add(s,a),s}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function vf(r){return r instanceof Error&&(r.constructor.name==="ZodError"||r.constructor.name==="$ZodError")}const bf=Symbol("Let zodToJsonSchema decide on which parser to use"),Ef={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},Tf=r=>({...Ef,...r}),Sf=r=>{const e=Tf(r),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,flags:{hasReferencedOpenAiAnyType:!1},currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([n,s])=>[s._def,{def:s._def,path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}},Fc=(r,e)=>{let t=0;for(;t<r.length&&t<e.length&&r[t]===e[t];t++);return[(r.length-t).toString(),...e.slice(t)].join("/")};function Xe(r){if(r.target!=="openAi")return{};const e=[...r.basePath,r.definitionPath,r.openAiAnyTypeName];return r.flags.hasReferencedOpenAiAnyType=!0,{$ref:r.$refStrategy==="relative"?Fc(e,r.currentPath):e.join("/")}}function Bc(r,e,t,n){n!=null&&n.errorMessages&&t&&(r.errorMessage={...r.errorMessage,[e]:t})}function me(r,e,t,n,s){r[e]=t,Bc(r,e,n,s)}var le;(function(r){r.assertEqual=s=>{};function e(s){}r.assertIs=e;function t(s){throw new Error}r.assertNever=t,r.arrayToEnum=s=>{const a={};for(const i of s)a[i]=i;return a},r.getValidEnumValues=s=>{const a=r.objectKeys(s).filter(o=>typeof s[s[o]]!="number"),i={};for(const o of a)i[o]=s[o];return r.objectValues(i)},r.objectValues=s=>r.objectKeys(s).map(function(a){return s[a]}),r.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{const a=[];for(const i in s)Object.prototype.hasOwnProperty.call(s,i)&&a.push(i);return a},r.find=(s,a)=>{for(const i of s)if(a(i))return i},r.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&Number.isFinite(s)&&Math.floor(s)===s;function n(s,a=" | "){return s.map(i=>typeof i=="string"?`'${i}'`:i).join(a)}r.joinValues=n,r.jsonStringifyReplacer=(s,a)=>typeof a=="bigint"?a.toString():a})(le||(le={}));var Ui;(function(r){r.mergeShapes=(e,t)=>({...e,...t})})(Ui||(Ui={}));const F=le.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Bt=r=>{switch(typeof r){case"undefined":return F.undefined;case"string":return F.string;case"number":return Number.isNaN(r)?F.nan:F.number;case"boolean":return F.boolean;case"function":return F.function;case"bigint":return F.bigint;case"symbol":return F.symbol;case"object":return Array.isArray(r)?F.array:r===null?F.null:r.then&&typeof r.then=="function"&&r.catch&&typeof r.catch=="function"?F.promise:typeof Map<"u"&&r instanceof Map?F.map:typeof Set<"u"&&r instanceof Set?F.set:typeof Date<"u"&&r instanceof Date?F.date:F.object;default:return F.unknown}},k=le.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class $t extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(a){return a.message},n={_errors:[]},s=a=>{for(const i of a.issues)if(i.code==="invalid_union")i.unionErrors.map(s);else if(i.code==="invalid_return_type")s(i.returnTypeError);else if(i.code==="invalid_arguments")s(i.argumentsError);else if(i.path.length===0)n._errors.push(t(i));else{let o=n,c=0;for(;c<i.path.length;){const u=i.path[c];c===i.path.length-1?(o[u]=o[u]||{_errors:[]},o[u]._errors.push(t(i))):o[u]=o[u]||{_errors:[]},o=o[u],c++}}};return s(this),n}static assert(e){if(!(e instanceof $t))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,le.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t=Object.create(null),n=[];for(const s of this.issues)if(s.path.length>0){const a=s.path[0];t[a]=t[a]||[],t[a].push(e(s))}else n.push(e(s));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}$t.create=r=>new $t(r);const ta=(r,e)=>{let t;switch(r.code){case k.invalid_type:r.received===F.undefined?t="Required":t=`Expected ${r.expected}, received ${r.received}`;break;case k.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(r.expected,le.jsonStringifyReplacer)}`;break;case k.unrecognized_keys:t=`Unrecognized key(s) in object: ${le.joinValues(r.keys,", ")}`;break;case k.invalid_union:t="Invalid input";break;case k.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${le.joinValues(r.options)}`;break;case k.invalid_enum_value:t=`Invalid enum value. Expected ${le.joinValues(r.options)}, received '${r.received}'`;break;case k.invalid_arguments:t="Invalid function arguments";break;case k.invalid_return_type:t="Invalid function return type";break;case k.invalid_date:t="Invalid date";break;case k.invalid_string:typeof r.validation=="object"?"includes"in r.validation?(t=`Invalid input: must include "${r.validation.includes}"`,typeof r.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${r.validation.position}`)):"startsWith"in r.validation?t=`Invalid input: must start with "${r.validation.startsWith}"`:"endsWith"in r.validation?t=`Invalid input: must end with "${r.validation.endsWith}"`:le.assertNever(r.validation):r.validation!=="regex"?t=`Invalid ${r.validation}`:t="Invalid";break;case k.too_small:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at least":"more than"} ${r.minimum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at least":"over"} ${r.minimum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${r.minimum}`:r.type==="bigint"?t=`Number must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${r.minimum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(r.minimum))}`:t="Invalid input";break;case k.too_big:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at most":"less than"} ${r.maximum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at most":"under"} ${r.maximum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="bigint"?t=`BigInt must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly":r.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(r.maximum))}`:t="Invalid input";break;case k.custom:t="Invalid input";break;case k.invalid_intersection_types:t="Intersection results could not be merged";break;case k.not_multiple_of:t=`Number must be a multiple of ${r.multipleOf}`;break;case k.not_finite:t="Number must be finite";break;default:t=e.defaultError,le.assertNever(r)}return{message:t}};let xf=ta;function If(){return xf}const Of=r=>{const{data:e,path:t,errorMaps:n,issueData:s}=r,a=[...t,...s.path||[]],i={...s,path:a};if(s.message!==void 0)return{...s,path:a,message:s.message};let o="";const c=n.filter(u=>!!u).slice().reverse();for(const u of c)o=u(i,{data:e,defaultError:o}).message;return{...s,path:a,message:o}};function j(r,e){const t=If(),n=Of({issueData:e,data:r.data,path:r.path,errorMaps:[r.common.contextualErrorMap,r.schemaErrorMap,t,t===ta?void 0:ta].filter(s=>!!s)});r.common.issues.push(n)}class Ye{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const s of t){if(s.status==="aborted")return te;s.status==="dirty"&&e.dirty(),n.push(s.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const s of t){const a=await s.key,i=await s.value;n.push({key:a,value:i})}return Ye.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const s of t){const{key:a,value:i}=s;if(a.status==="aborted"||i.status==="aborted")return te;a.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),a.value!=="__proto__"&&(typeof i.value<"u"||s.alwaysSet)&&(n[a.value]=i.value)}return{status:e.value,value:n}}}const te=Object.freeze({status:"aborted"}),Fr=r=>({status:"dirty",value:r}),rt=r=>({status:"valid",value:r}),Fi=r=>r.status==="aborted",Bi=r=>r.status==="dirty",Sr=r=>r.status==="valid",Bn=r=>typeof Promise<"u"&&r instanceof Promise;var z;(function(r){r.errToObj=e=>typeof e=="string"?{message:e}:e||{},r.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(z||(z={}));class Zt{constructor(e,t,n,s){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=s}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const zi=(r,e)=>{if(Sr(e))return{success:!0,data:e.value};if(!r.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new $t(r.common.issues);return this._error=t,this._error}}};function ae(r){if(!r)return{};const{errorMap:e,invalid_type_error:t,required_error:n,description:s}=r;if(e&&(t||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(i,o)=>{const{message:c}=r;return i.code==="invalid_enum_value"?{message:c??o.defaultError}:typeof o.data>"u"?{message:c??n??o.defaultError}:i.code!=="invalid_type"?{message:o.defaultError}:{message:c??t??o.defaultError}},description:s}}class oe{get description(){return this._def.description}_getType(e){return Bt(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Bt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Ye,ctx:{common:e.parent.common,data:e.data,parsedType:Bt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Bn(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){const n={common:{issues:[],async:(t==null?void 0:t.async)??!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Bt(e)},s=this._parseSync({data:e,path:n.path,parent:n});return zi(n,s)}"~validate"(e){var n,s;const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Bt(e)};if(!this["~standard"].async)try{const a=this._parseSync({data:e,path:[],parent:t});return Sr(a)?{value:a.value}:{issues:t.common.issues}}catch(a){(s=(n=a==null?void 0:a.message)==null?void 0:n.toLowerCase())!=null&&s.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(a=>Sr(a)?{value:a.value}:{issues:t.common.issues})}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Bt(e)},s=this._parse({data:e,path:n.path,parent:n}),a=await(Bn(s)?s:Promise.resolve(s));return zi(n,a)}refine(e,t){const n=s=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(s):t;return this._refinement((s,a)=>{const i=e(s),o=()=>a.addIssue({code:k.custom,...n(s)});return typeof Promise<"u"&&i instanceof Promise?i.then(c=>c?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((n,s)=>e(n)?!0:(s.addIssue(typeof t=="function"?t(n,s):t),!1))}_refinement(e){return new Ir({schema:this,typeName:R.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return Ht.create(this,this._def)}nullable(){return Or.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return bt.create(this)}promise(){return Hn.create(this,this._def)}or(e){return Gn.create([this,e],this._def)}and(e){return qn.create(this,e,this._def)}transform(e){return new Ir({...ae(this._def),schema:this,typeName:R.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new sa({...ae(this._def),innerType:this,defaultValue:t,typeName:R.ZodDefault})}brand(){return new Kf({typeName:R.ZodBranded,type:this,...ae(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new aa({...ae(this._def),innerType:this,catchValue:t,typeName:R.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Ga.create(this,e)}readonly(){return ia.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Af=/^c[^\s-]{8,}$/i,kf=/^[0-9a-z]+$/,Rf=/^[0-9A-HJKMNP-TV-Z]{26}$/i,$f=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Cf=/^[a-z0-9_-]{21}$/i,Nf=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Pf=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Lf=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,jf="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Ts;const Mf=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Df=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Uf=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Ff=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Bf=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,zf=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,zc="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Gf=new RegExp(`^${zc}$`);function Gc(r){let e="[0-5]\\d";r.precision?e=`${e}\\.\\d{${r.precision}}`:r.precision==null&&(e=`${e}(\\.\\d+)?`);const t=r.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${t}`}function qf(r){return new RegExp(`^${Gc(r)}$`)}function Hf(r){let e=`${zc}T${Gc(r)}`;const t=[];return t.push(r.local?"Z?":"Z"),r.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Vf(r,e){return!!((e==="v4"||!e)&&Mf.test(r)||(e==="v6"||!e)&&Uf.test(r))}function Zf(r,e){if(!Nf.test(r))return!1;try{const[t]=r.split(".");if(!t)return!1;const n=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),s=JSON.parse(atob(n));return!(typeof s!="object"||s===null||"typ"in s&&(s==null?void 0:s.typ)!=="JWT"||!s.alg||e&&s.alg!==e)}catch{return!1}}function Jf(r,e){return!!((e==="v4"||!e)&&Df.test(r)||(e==="v6"||!e)&&Ff.test(r))}class zt extends oe{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==F.string){const a=this._getOrReturnCtx(e);return j(a,{code:k.invalid_type,expected:F.string,received:a.parsedType}),te}const n=new Ye;let s;for(const a of this._def.checks)if(a.kind==="min")e.data.length<a.value&&(s=this._getOrReturnCtx(e,s),j(s,{code:k.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),n.dirty());else if(a.kind==="max")e.data.length>a.value&&(s=this._getOrReturnCtx(e,s),j(s,{code:k.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),n.dirty());else if(a.kind==="length"){const i=e.data.length>a.value,o=e.data.length<a.value;(i||o)&&(s=this._getOrReturnCtx(e,s),i?j(s,{code:k.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):o&&j(s,{code:k.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),n.dirty())}else if(a.kind==="email")Lf.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"email",code:k.invalid_string,message:a.message}),n.dirty());else if(a.kind==="emoji")Ts||(Ts=new RegExp(jf,"u")),Ts.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"emoji",code:k.invalid_string,message:a.message}),n.dirty());else if(a.kind==="uuid")$f.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"uuid",code:k.invalid_string,message:a.message}),n.dirty());else if(a.kind==="nanoid")Cf.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"nanoid",code:k.invalid_string,message:a.message}),n.dirty());else if(a.kind==="cuid")Af.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"cuid",code:k.invalid_string,message:a.message}),n.dirty());else if(a.kind==="cuid2")kf.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"cuid2",code:k.invalid_string,message:a.message}),n.dirty());else if(a.kind==="ulid")Rf.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"ulid",code:k.invalid_string,message:a.message}),n.dirty());else if(a.kind==="url")try{new URL(e.data)}catch{s=this._getOrReturnCtx(e,s),j(s,{validation:"url",code:k.invalid_string,message:a.message}),n.dirty()}else a.kind==="regex"?(a.regex.lastIndex=0,a.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"regex",code:k.invalid_string,message:a.message}),n.dirty())):a.kind==="trim"?e.data=e.data.trim():a.kind==="includes"?e.data.includes(a.value,a.position)||(s=this._getOrReturnCtx(e,s),j(s,{code:k.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),n.dirty()):a.kind==="toLowerCase"?e.data=e.data.toLowerCase():a.kind==="toUpperCase"?e.data=e.data.toUpperCase():a.kind==="startsWith"?e.data.startsWith(a.value)||(s=this._getOrReturnCtx(e,s),j(s,{code:k.invalid_string,validation:{startsWith:a.value},message:a.message}),n.dirty()):a.kind==="endsWith"?e.data.endsWith(a.value)||(s=this._getOrReturnCtx(e,s),j(s,{code:k.invalid_string,validation:{endsWith:a.value},message:a.message}),n.dirty()):a.kind==="datetime"?Hf(a).test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{code:k.invalid_string,validation:"datetime",message:a.message}),n.dirty()):a.kind==="date"?Gf.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{code:k.invalid_string,validation:"date",message:a.message}),n.dirty()):a.kind==="time"?qf(a).test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{code:k.invalid_string,validation:"time",message:a.message}),n.dirty()):a.kind==="duration"?Pf.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"duration",code:k.invalid_string,message:a.message}),n.dirty()):a.kind==="ip"?Vf(e.data,a.version)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"ip",code:k.invalid_string,message:a.message}),n.dirty()):a.kind==="jwt"?Zf(e.data,a.alg)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"jwt",code:k.invalid_string,message:a.message}),n.dirty()):a.kind==="cidr"?Jf(e.data,a.version)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"cidr",code:k.invalid_string,message:a.message}),n.dirty()):a.kind==="base64"?Bf.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"base64",code:k.invalid_string,message:a.message}),n.dirty()):a.kind==="base64url"?zf.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"base64url",code:k.invalid_string,message:a.message}),n.dirty()):le.assertNever(a);return{status:n.value,value:e.data}}_regex(e,t,n){return this.refinement(s=>e.test(s),{validation:t,code:k.invalid_string,...z.errToObj(n)})}_addCheck(e){return new zt({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...z.errToObj(e)})}url(e){return this._addCheck({kind:"url",...z.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...z.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...z.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...z.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...z.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...z.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...z.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...z.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...z.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...z.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...z.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...z.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(e==null?void 0:e.offset)??!1,local:(e==null?void 0:e.local)??!1,...z.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...z.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...z.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...z.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...z.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...z.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...z.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...z.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...z.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...z.errToObj(t)})}nonempty(e){return this.min(1,z.errToObj(e))}trim(){return new zt({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new zt({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new zt({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}zt.create=r=>new zt({checks:[],typeName:R.ZodString,coerce:(r==null?void 0:r.coerce)??!1,...ae(r)});function Wf(r,e){const t=(r.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,s=t>n?t:n,a=Number.parseInt(r.toFixed(s).replace(".","")),i=Number.parseInt(e.toFixed(s).replace(".",""));return a%i/10**s}class Xr extends oe{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==F.number){const a=this._getOrReturnCtx(e);return j(a,{code:k.invalid_type,expected:F.number,received:a.parsedType}),te}let n;const s=new Ye;for(const a of this._def.checks)a.kind==="int"?le.isInteger(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{code:k.invalid_type,expected:"integer",received:"float",message:a.message}),s.dirty()):a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(n=this._getOrReturnCtx(e,n),j(n,{code:k.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(n=this._getOrReturnCtx(e,n),j(n,{code:k.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="multipleOf"?Wf(e.data,a.value)!==0&&(n=this._getOrReturnCtx(e,n),j(n,{code:k.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):a.kind==="finite"?Number.isFinite(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{code:k.not_finite,message:a.message}),s.dirty()):le.assertNever(a);return{status:s.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,z.toString(t))}gt(e,t){return this.setLimit("min",e,!1,z.toString(t))}lte(e,t){return this.setLimit("max",e,!0,z.toString(t))}lt(e,t){return this.setLimit("max",e,!1,z.toString(t))}setLimit(e,t,n,s){return new Xr({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:z.toString(s)}]})}_addCheck(e){return new Xr({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:z.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:z.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:z.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:z.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:z.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:z.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:z.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:z.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:z.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&le.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(t===null||n.value>t)&&(t=n.value):n.kind==="max"&&(e===null||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Xr.create=r=>new Xr({checks:[],typeName:R.ZodNumber,coerce:(r==null?void 0:r.coerce)||!1,...ae(r)});class Yr extends oe{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==F.bigint)return this._getInvalidInput(e);let n;const s=new Ye;for(const a of this._def.checks)a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(n=this._getOrReturnCtx(e,n),j(n,{code:k.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(n=this._getOrReturnCtx(e,n),j(n,{code:k.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="multipleOf"?e.data%a.value!==BigInt(0)&&(n=this._getOrReturnCtx(e,n),j(n,{code:k.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):le.assertNever(a);return{status:s.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return j(t,{code:k.invalid_type,expected:F.bigint,received:t.parsedType}),te}gte(e,t){return this.setLimit("min",e,!0,z.toString(t))}gt(e,t){return this.setLimit("min",e,!1,z.toString(t))}lte(e,t){return this.setLimit("max",e,!0,z.toString(t))}lt(e,t){return this.setLimit("max",e,!1,z.toString(t))}setLimit(e,t,n,s){return new Yr({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:z.toString(s)}]})}_addCheck(e){return new Yr({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:z.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:z.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:z.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:z.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:z.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Yr.create=r=>new Yr({checks:[],typeName:R.ZodBigInt,coerce:(r==null?void 0:r.coerce)??!1,...ae(r)});class Gi extends oe{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==F.boolean){const n=this._getOrReturnCtx(e);return j(n,{code:k.invalid_type,expected:F.boolean,received:n.parsedType}),te}return rt(e.data)}}Gi.create=r=>new Gi({typeName:R.ZodBoolean,coerce:(r==null?void 0:r.coerce)||!1,...ae(r)});class zn extends oe{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==F.date){const a=this._getOrReturnCtx(e);return j(a,{code:k.invalid_type,expected:F.date,received:a.parsedType}),te}if(Number.isNaN(e.data.getTime())){const a=this._getOrReturnCtx(e);return j(a,{code:k.invalid_date}),te}const n=new Ye;let s;for(const a of this._def.checks)a.kind==="min"?e.data.getTime()<a.value&&(s=this._getOrReturnCtx(e,s),j(s,{code:k.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),n.dirty()):a.kind==="max"?e.data.getTime()>a.value&&(s=this._getOrReturnCtx(e,s),j(s,{code:k.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),n.dirty()):le.assertNever(a);return{status:n.value,value:new Date(e.data.getTime())}}_addCheck(e){return new zn({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:z.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:z.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}zn.create=r=>new zn({checks:[],coerce:(r==null?void 0:r.coerce)||!1,typeName:R.ZodDate,...ae(r)});class qi extends oe{_parse(e){if(this._getType(e)!==F.symbol){const n=this._getOrReturnCtx(e);return j(n,{code:k.invalid_type,expected:F.symbol,received:n.parsedType}),te}return rt(e.data)}}qi.create=r=>new qi({typeName:R.ZodSymbol,...ae(r)});class Hi extends oe{_parse(e){if(this._getType(e)!==F.undefined){const n=this._getOrReturnCtx(e);return j(n,{code:k.invalid_type,expected:F.undefined,received:n.parsedType}),te}return rt(e.data)}}Hi.create=r=>new Hi({typeName:R.ZodUndefined,...ae(r)});class Vi extends oe{_parse(e){if(this._getType(e)!==F.null){const n=this._getOrReturnCtx(e);return j(n,{code:k.invalid_type,expected:F.null,received:n.parsedType}),te}return rt(e.data)}}Vi.create=r=>new Vi({typeName:R.ZodNull,...ae(r)});class ra extends oe{constructor(){super(...arguments),this._any=!0}_parse(e){return rt(e.data)}}ra.create=r=>new ra({typeName:R.ZodAny,...ae(r)});class Zi extends oe{constructor(){super(...arguments),this._unknown=!0}_parse(e){return rt(e.data)}}Zi.create=r=>new Zi({typeName:R.ZodUnknown,...ae(r)});class Jt extends oe{_parse(e){const t=this._getOrReturnCtx(e);return j(t,{code:k.invalid_type,expected:F.never,received:t.parsedType}),te}}Jt.create=r=>new Jt({typeName:R.ZodNever,...ae(r)});class Ji extends oe{_parse(e){if(this._getType(e)!==F.undefined){const n=this._getOrReturnCtx(e);return j(n,{code:k.invalid_type,expected:F.void,received:n.parsedType}),te}return rt(e.data)}}Ji.create=r=>new Ji({typeName:R.ZodVoid,...ae(r)});class bt extends oe{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),s=this._def;if(t.parsedType!==F.array)return j(t,{code:k.invalid_type,expected:F.array,received:t.parsedType}),te;if(s.exactLength!==null){const i=t.data.length>s.exactLength.value,o=t.data.length<s.exactLength.value;(i||o)&&(j(t,{code:i?k.too_big:k.too_small,minimum:o?s.exactLength.value:void 0,maximum:i?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),n.dirty())}if(s.minLength!==null&&t.data.length<s.minLength.value&&(j(t,{code:k.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),n.dirty()),s.maxLength!==null&&t.data.length>s.maxLength.value&&(j(t,{code:k.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>s.type._parseAsync(new Zt(t,i,t.path,o)))).then(i=>Ye.mergeArray(n,i));const a=[...t.data].map((i,o)=>s.type._parseSync(new Zt(t,i,t.path,o)));return Ye.mergeArray(n,a)}get element(){return this._def.type}min(e,t){return new bt({...this._def,minLength:{value:e,message:z.toString(t)}})}max(e,t){return new bt({...this._def,maxLength:{value:e,message:z.toString(t)}})}length(e,t){return new bt({...this._def,exactLength:{value:e,message:z.toString(t)}})}nonempty(e){return this.min(1,e)}}bt.create=(r,e)=>new bt({type:r,minLength:null,maxLength:null,exactLength:null,typeName:R.ZodArray,...ae(e)});function gr(r){if(r instanceof Te){const e={};for(const t in r.shape){const n=r.shape[t];e[t]=Ht.create(gr(n))}return new Te({...r._def,shape:()=>e})}else return r instanceof bt?new bt({...r._def,type:gr(r.element)}):r instanceof Ht?Ht.create(gr(r.unwrap())):r instanceof Or?Or.create(gr(r.unwrap())):r instanceof cr?cr.create(r.items.map(e=>gr(e))):r}class Te extends oe{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=le.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==F.object){const u=this._getOrReturnCtx(e);return j(u,{code:k.invalid_type,expected:F.object,received:u.parsedType}),te}const{status:n,ctx:s}=this._processInputParams(e),{shape:a,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof Jt&&this._def.unknownKeys==="strip"))for(const u in s.data)i.includes(u)||o.push(u);const c=[];for(const u of i){const l=a[u],d=s.data[u];c.push({key:{status:"valid",value:u},value:l._parse(new Zt(s,d,s.path,u)),alwaysSet:u in s.data})}if(this._def.catchall instanceof Jt){const u=this._def.unknownKeys;if(u==="passthrough")for(const l of o)c.push({key:{status:"valid",value:l},value:{status:"valid",value:s.data[l]}});else if(u==="strict")o.length>0&&(j(s,{code:k.unrecognized_keys,keys:o}),n.dirty());else if(u!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const u=this._def.catchall;for(const l of o){const d=s.data[l];c.push({key:{status:"valid",value:l},value:u._parse(new Zt(s,d,s.path,l)),alwaysSet:l in s.data})}}return s.common.async?Promise.resolve().then(async()=>{const u=[];for(const l of c){const d=await l.key,f=await l.value;u.push({key:d,value:f,alwaysSet:l.alwaysSet})}return u}).then(u=>Ye.mergeObjectSync(n,u)):Ye.mergeObjectSync(n,c)}get shape(){return this._def.shape()}strict(e){return z.errToObj,new Te({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,n)=>{var a,i;const s=((i=(a=this._def).errorMap)==null?void 0:i.call(a,t,n).message)??n.defaultError;return t.code==="unrecognized_keys"?{message:z.errToObj(e).message??s}:{message:s}}}:{}})}strip(){return new Te({...this._def,unknownKeys:"strip"})}passthrough(){return new Te({...this._def,unknownKeys:"passthrough"})}extend(e){return new Te({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new Te({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:R.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new Te({...this._def,catchall:e})}pick(e){const t={};for(const n of le.objectKeys(e))e[n]&&this.shape[n]&&(t[n]=this.shape[n]);return new Te({...this._def,shape:()=>t})}omit(e){const t={};for(const n of le.objectKeys(this.shape))e[n]||(t[n]=this.shape[n]);return new Te({...this._def,shape:()=>t})}deepPartial(){return gr(this)}partial(e){const t={};for(const n of le.objectKeys(this.shape)){const s=this.shape[n];e&&!e[n]?t[n]=s:t[n]=s.optional()}return new Te({...this._def,shape:()=>t})}required(e){const t={};for(const n of le.objectKeys(this.shape))if(e&&!e[n])t[n]=this.shape[n];else{let a=this.shape[n];for(;a instanceof Ht;)a=a._def.innerType;t[n]=a}return new Te({...this._def,shape:()=>t})}keyof(){return qc(le.objectKeys(this.shape))}}Te.create=(r,e)=>new Te({shape:()=>r,unknownKeys:"strip",catchall:Jt.create(),typeName:R.ZodObject,...ae(e)});Te.strictCreate=(r,e)=>new Te({shape:()=>r,unknownKeys:"strict",catchall:Jt.create(),typeName:R.ZodObject,...ae(e)});Te.lazycreate=(r,e)=>new Te({shape:r,unknownKeys:"strip",catchall:Jt.create(),typeName:R.ZodObject,...ae(e)});class Gn extends oe{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;function s(a){for(const o of a)if(o.result.status==="valid")return o.result;for(const o of a)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const i=a.map(o=>new $t(o.ctx.common.issues));return j(t,{code:k.invalid_union,unionErrors:i}),te}if(t.common.async)return Promise.all(n.map(async a=>{const i={...t,common:{...t.common,issues:[]},parent:null};return{result:await a._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(s);{let a;const i=[];for(const c of n){const u={...t,common:{...t.common,issues:[]},parent:null},l=c._parseSync({data:t.data,path:t.path,parent:u});if(l.status==="valid")return l;l.status==="dirty"&&!a&&(a={result:l,ctx:u}),u.common.issues.length&&i.push(u.common.issues)}if(a)return t.common.issues.push(...a.ctx.common.issues),a.result;const o=i.map(c=>new $t(c));return j(t,{code:k.invalid_union,unionErrors:o}),te}}get options(){return this._def.options}}Gn.create=(r,e)=>new Gn({options:r,typeName:R.ZodUnion,...ae(e)});function na(r,e){const t=Bt(r),n=Bt(e);if(r===e)return{valid:!0,data:r};if(t===F.object&&n===F.object){const s=le.objectKeys(e),a=le.objectKeys(r).filter(o=>s.indexOf(o)!==-1),i={...r,...e};for(const o of a){const c=na(r[o],e[o]);if(!c.valid)return{valid:!1};i[o]=c.data}return{valid:!0,data:i}}else if(t===F.array&&n===F.array){if(r.length!==e.length)return{valid:!1};const s=[];for(let a=0;a<r.length;a++){const i=r[a],o=e[a],c=na(i,o);if(!c.valid)return{valid:!1};s.push(c.data)}return{valid:!0,data:s}}else return t===F.date&&n===F.date&&+r==+e?{valid:!0,data:r}:{valid:!1}}class qn extends oe{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),s=(a,i)=>{if(Fi(a)||Fi(i))return te;const o=na(a.value,i.value);return o.valid?((Bi(a)||Bi(i))&&t.dirty(),{status:t.value,value:o.data}):(j(n,{code:k.invalid_intersection_types}),te)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([a,i])=>s(a,i)):s(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}qn.create=(r,e,t)=>new qn({left:r,right:e,typeName:R.ZodIntersection,...ae(t)});class cr extends oe{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==F.array)return j(n,{code:k.invalid_type,expected:F.array,received:n.parsedType}),te;if(n.data.length<this._def.items.length)return j(n,{code:k.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),te;!this._def.rest&&n.data.length>this._def.items.length&&(j(n,{code:k.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const a=[...n.data].map((i,o)=>{const c=this._def.items[o]||this._def.rest;return c?c._parse(new Zt(n,i,n.path,o)):null}).filter(i=>!!i);return n.common.async?Promise.all(a).then(i=>Ye.mergeArray(t,i)):Ye.mergeArray(t,a)}get items(){return this._def.items}rest(e){return new cr({...this._def,rest:e})}}cr.create=(r,e)=>{if(!Array.isArray(r))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new cr({items:r,typeName:R.ZodTuple,rest:null,...ae(e)})};class Wi extends oe{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==F.map)return j(n,{code:k.invalid_type,expected:F.map,received:n.parsedType}),te;const s=this._def.keyType,a=this._def.valueType,i=[...n.data.entries()].map(([o,c],u)=>({key:s._parse(new Zt(n,o,n.path,[u,"key"])),value:a._parse(new Zt(n,c,n.path,[u,"value"]))}));if(n.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const c of i){const u=await c.key,l=await c.value;if(u.status==="aborted"||l.status==="aborted")return te;(u.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(u.value,l.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const c of i){const u=c.key,l=c.value;if(u.status==="aborted"||l.status==="aborted")return te;(u.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(u.value,l.value)}return{status:t.value,value:o}}}}Wi.create=(r,e,t)=>new Wi({valueType:e,keyType:r,typeName:R.ZodMap,...ae(t)});class Qr extends oe{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==F.set)return j(n,{code:k.invalid_type,expected:F.set,received:n.parsedType}),te;const s=this._def;s.minSize!==null&&n.data.size<s.minSize.value&&(j(n,{code:k.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),t.dirty()),s.maxSize!==null&&n.data.size>s.maxSize.value&&(j(n,{code:k.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),t.dirty());const a=this._def.valueType;function i(c){const u=new Set;for(const l of c){if(l.status==="aborted")return te;l.status==="dirty"&&t.dirty(),u.add(l.value)}return{status:t.value,value:u}}const o=[...n.data.values()].map((c,u)=>a._parse(new Zt(n,c,n.path,u)));return n.common.async?Promise.all(o).then(c=>i(c)):i(o)}min(e,t){return new Qr({...this._def,minSize:{value:e,message:z.toString(t)}})}max(e,t){return new Qr({...this._def,maxSize:{value:e,message:z.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Qr.create=(r,e)=>new Qr({valueType:r,minSize:null,maxSize:null,typeName:R.ZodSet,...ae(e)});class Ki extends oe{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Ki.create=(r,e)=>new Ki({getter:r,typeName:R.ZodLazy,...ae(e)});class Xi extends oe{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return j(t,{received:t.data,code:k.invalid_literal,expected:this._def.value}),te}return{status:"valid",value:e.data}}get value(){return this._def.value}}Xi.create=(r,e)=>new Xi({value:r,typeName:R.ZodLiteral,...ae(e)});function qc(r,e){return new xr({values:r,typeName:R.ZodEnum,...ae(e)})}class xr extends oe{_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),n=this._def.values;return j(t,{expected:le.joinValues(n),received:t.parsedType,code:k.invalid_type}),te}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return j(t,{received:t.data,code:k.invalid_enum_value,options:n}),te}return rt(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return xr.create(e,{...this._def,...t})}exclude(e,t=this._def){return xr.create(this.options.filter(n=>!e.includes(n)),{...this._def,...t})}}xr.create=qc;class Yi extends oe{_parse(e){const t=le.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==F.string&&n.parsedType!==F.number){const s=le.objectValues(t);return j(n,{expected:le.joinValues(s),received:n.parsedType,code:k.invalid_type}),te}if(this._cache||(this._cache=new Set(le.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const s=le.objectValues(t);return j(n,{received:n.data,code:k.invalid_enum_value,options:s}),te}return rt(e.data)}get enum(){return this._def.values}}Yi.create=(r,e)=>new Yi({values:r,typeName:R.ZodNativeEnum,...ae(e)});class Hn extends oe{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==F.promise&&t.common.async===!1)return j(t,{code:k.invalid_type,expected:F.promise,received:t.parsedType}),te;const n=t.parsedType===F.promise?t.data:Promise.resolve(t.data);return rt(n.then(s=>this._def.type.parseAsync(s,{path:t.path,errorMap:t.common.contextualErrorMap})))}}Hn.create=(r,e)=>new Hn({type:r,typeName:R.ZodPromise,...ae(e)});class Ir extends oe{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===R.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),s=this._def.effect||null,a={addIssue:i=>{j(n,i),i.fatal?t.abort():t.dirty()},get path(){return n.path}};if(a.addIssue=a.addIssue.bind(a),s.type==="preprocess"){const i=s.transform(n.data,a);if(n.common.async)return Promise.resolve(i).then(async o=>{if(t.value==="aborted")return te;const c=await this._def.schema._parseAsync({data:o,path:n.path,parent:n});return c.status==="aborted"?te:c.status==="dirty"||t.value==="dirty"?Fr(c.value):c});{if(t.value==="aborted")return te;const o=this._def.schema._parseSync({data:i,path:n.path,parent:n});return o.status==="aborted"?te:o.status==="dirty"||t.value==="dirty"?Fr(o.value):o}}if(s.type==="refinement"){const i=o=>{const c=s.refinement(o,a);if(n.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(n.common.async===!1){const o=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return o.status==="aborted"?te:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(o=>o.status==="aborted"?te:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(s.type==="transform")if(n.common.async===!1){const i=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!Sr(i))return te;const o=s.transform(i.value,a);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(i=>Sr(i)?Promise.resolve(s.transform(i.value,a)).then(o=>({status:t.value,value:o})):te);le.assertNever(s)}}Ir.create=(r,e,t)=>new Ir({schema:r,typeName:R.ZodEffects,effect:e,...ae(t)});Ir.createWithPreprocess=(r,e,t)=>new Ir({schema:e,effect:{type:"preprocess",transform:r},typeName:R.ZodEffects,...ae(t)});class Ht extends oe{_parse(e){return this._getType(e)===F.undefined?rt(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Ht.create=(r,e)=>new Ht({innerType:r,typeName:R.ZodOptional,...ae(e)});class Or extends oe{_parse(e){return this._getType(e)===F.null?rt(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Or.create=(r,e)=>new Or({innerType:r,typeName:R.ZodNullable,...ae(e)});class sa extends oe{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===F.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}sa.create=(r,e)=>new sa({innerType:r,typeName:R.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...ae(e)});class aa extends oe{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},s=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return Bn(s)?s.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new $t(n.common.issues)},input:n.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new $t(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}aa.create=(r,e)=>new aa({innerType:r,typeName:R.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...ae(e)});class Qi extends oe{_parse(e){if(this._getType(e)!==F.nan){const n=this._getOrReturnCtx(e);return j(n,{code:k.invalid_type,expected:F.nan,received:n.parsedType}),te}return{status:"valid",value:e.data}}}Qi.create=r=>new Qi({typeName:R.ZodNaN,...ae(r)});class Kf extends oe{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class Ga extends oe{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const a=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return a.status==="aborted"?te:a.status==="dirty"?(t.dirty(),Fr(a.value)):this._def.out._parseAsync({data:a.value,path:n.path,parent:n})})();{const s=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return s.status==="aborted"?te:s.status==="dirty"?(t.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:n.path,parent:n})}}static create(e,t){return new Ga({in:e,out:t,typeName:R.ZodPipeline})}}class ia extends oe{_parse(e){const t=this._def.innerType._parse(e),n=s=>(Sr(s)&&(s.value=Object.freeze(s.value)),s);return Bn(t)?t.then(s=>n(s)):n(t)}unwrap(){return this._def.innerType}}ia.create=(r,e)=>new ia({innerType:r,typeName:R.ZodReadonly,...ae(e)});Te.lazycreate;var R;(function(r){r.ZodString="ZodString",r.ZodNumber="ZodNumber",r.ZodNaN="ZodNaN",r.ZodBigInt="ZodBigInt",r.ZodBoolean="ZodBoolean",r.ZodDate="ZodDate",r.ZodSymbol="ZodSymbol",r.ZodUndefined="ZodUndefined",r.ZodNull="ZodNull",r.ZodAny="ZodAny",r.ZodUnknown="ZodUnknown",r.ZodNever="ZodNever",r.ZodVoid="ZodVoid",r.ZodArray="ZodArray",r.ZodObject="ZodObject",r.ZodUnion="ZodUnion",r.ZodDiscriminatedUnion="ZodDiscriminatedUnion",r.ZodIntersection="ZodIntersection",r.ZodTuple="ZodTuple",r.ZodRecord="ZodRecord",r.ZodMap="ZodMap",r.ZodSet="ZodSet",r.ZodFunction="ZodFunction",r.ZodLazy="ZodLazy",r.ZodLiteral="ZodLiteral",r.ZodEnum="ZodEnum",r.ZodEffects="ZodEffects",r.ZodNativeEnum="ZodNativeEnum",r.ZodOptional="ZodOptional",r.ZodNullable="ZodNullable",r.ZodDefault="ZodDefault",r.ZodCatch="ZodCatch",r.ZodPromise="ZodPromise",r.ZodBranded="ZodBranded",r.ZodPipeline="ZodPipeline",r.ZodReadonly="ZodReadonly"})(R||(R={}));const qa=zt.create,eo=ra.create;Jt.create;bt.create;const Ha=Te.create;Te.strictCreate;Gn.create;qn.create;cr.create;xr.create;Hn.create;Ht.create;Or.create;function Xf(r,e){var n,s,a;const t={type:"array"};return(n=r.type)!=null&&n._def&&((a=(s=r.type)==null?void 0:s._def)==null?void 0:a.typeName)!==R.ZodAny&&(t.items=fe(r.type._def,{...e,currentPath:[...e.currentPath,"items"]})),r.minLength&&me(t,"minItems",r.minLength.value,r.minLength.message,e),r.maxLength&&me(t,"maxItems",r.maxLength.value,r.maxLength.message,e),r.exactLength&&(me(t,"minItems",r.exactLength.value,r.exactLength.message,e),me(t,"maxItems",r.exactLength.value,r.exactLength.message,e)),t}function Yf(r,e){const t={type:"integer",format:"int64"};if(!r.checks)return t;for(const n of r.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?me(t,"minimum",n.value,n.message,e):me(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),me(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?me(t,"maximum",n.value,n.message,e):me(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),me(t,"maximum",n.value,n.message,e));break;case"multipleOf":me(t,"multipleOf",n.value,n.message,e);break}return t}function Qf(){return{type:"boolean"}}function Hc(r,e){return fe(r.type._def,e)}const eh=(r,e)=>fe(r.innerType._def,e);function Vc(r,e,t){const n=t??e.dateStrategy;if(Array.isArray(n))return{anyOf:n.map(s=>Vc(r,e,s))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return th(r,e)}}const th=(r,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const n of r.checks)switch(n.kind){case"min":me(t,"minimum",n.value,n.message,e);break;case"max":me(t,"maximum",n.value,n.message,e);break}return t};function rh(r,e){return{...fe(r.innerType._def,e),default:r.defaultValue()}}function nh(r,e){return e.effectStrategy==="input"?fe(r.schema._def,e):Xe(e)}function sh(r){return{type:"string",enum:Array.from(r.values)}}const ah=r=>"type"in r&&r.type==="string"?!1:"allOf"in r;function ih(r,e){const t=[fe(r.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),fe(r.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a);let n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return t.forEach(a=>{if(ah(a))s.push(...a.allOf),a.unevaluatedProperties===void 0&&(n=void 0);else{let i=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:o,...c}=a;i=c}else n=void 0;s.push(i)}}),s.length?{allOf:s,...n}:void 0}function oh(r,e){const t=typeof r.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(r.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[r.value]}:{type:t==="bigint"?"integer":t,const:r.value}}let Ss;const st={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Ss===void 0&&(Ss=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Ss),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function Zc(r,e){const t={type:"string"};if(r.checks)for(const n of r.checks)switch(n.kind){case"min":me(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,n.value):n.value,n.message,e);break;case"max":me(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,n.value):n.value,n.message,e);break;case"email":switch(e.emailStrategy){case"format:email":at(t,"email",n.message,e);break;case"format:idn-email":at(t,"idn-email",n.message,e);break;case"pattern:zod":Ue(t,st.email,n.message,e);break}break;case"url":at(t,"uri",n.message,e);break;case"uuid":at(t,"uuid",n.message,e);break;case"regex":Ue(t,n.regex,n.message,e);break;case"cuid":Ue(t,st.cuid,n.message,e);break;case"cuid2":Ue(t,st.cuid2,n.message,e);break;case"startsWith":Ue(t,RegExp(`^${xs(n.value,e)}`),n.message,e);break;case"endsWith":Ue(t,RegExp(`${xs(n.value,e)}$`),n.message,e);break;case"datetime":at(t,"date-time",n.message,e);break;case"date":at(t,"date",n.message,e);break;case"time":at(t,"time",n.message,e);break;case"duration":at(t,"duration",n.message,e);break;case"length":me(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,n.value):n.value,n.message,e),me(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,n.value):n.value,n.message,e);break;case"includes":Ue(t,RegExp(xs(n.value,e)),n.message,e);break;case"ip":n.version!=="v6"&&at(t,"ipv4",n.message,e),n.version!=="v4"&&at(t,"ipv6",n.message,e);break;case"base64url":Ue(t,st.base64url,n.message,e);break;case"jwt":Ue(t,st.jwt,n.message,e);break;case"cidr":n.version!=="v6"&&Ue(t,st.ipv4Cidr,n.message,e),n.version!=="v4"&&Ue(t,st.ipv6Cidr,n.message,e);break;case"emoji":Ue(t,st.emoji(),n.message,e);break;case"ulid":Ue(t,st.ulid,n.message,e);break;case"base64":switch(e.base64Strategy){case"format:binary":at(t,"binary",n.message,e);break;case"contentEncoding:base64":me(t,"contentEncoding","base64",n.message,e);break;case"pattern:zod":Ue(t,st.base64,n.message,e);break}break;case"nanoid":Ue(t,st.nanoid,n.message,e);break}return t}function xs(r,e){return e.patternStrategy==="escape"?uh(r):r}const ch=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function uh(r){let e="";for(let t=0;t<r.length;t++)ch.has(r[t])||(e+="\\"),e+=r[t];return e}function at(r,e,t,n){var s;r.format||(s=r.anyOf)!=null&&s.some(a=>a.format)?(r.anyOf||(r.anyOf=[]),r.format&&(r.anyOf.push({format:r.format,...r.errorMessage&&n.errorMessages&&{errorMessage:{format:r.errorMessage.format}}}),delete r.format,r.errorMessage&&(delete r.errorMessage.format,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.anyOf.push({format:e,...t&&n.errorMessages&&{errorMessage:{format:t}}})):me(r,"format",e,t,n)}function Ue(r,e,t,n){var s;r.pattern||(s=r.allOf)!=null&&s.some(a=>a.pattern)?(r.allOf||(r.allOf=[]),r.pattern&&(r.allOf.push({pattern:r.pattern,...r.errorMessage&&n.errorMessages&&{errorMessage:{pattern:r.errorMessage.pattern}}}),delete r.pattern,r.errorMessage&&(delete r.errorMessage.pattern,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.allOf.push({pattern:to(e,n),...t&&n.errorMessages&&{errorMessage:{pattern:t}}})):me(r,"pattern",to(e,n),t,n)}function to(r,e){var c;if(!e.applyRegexFlags||!r.flags)return r.source;const t={i:r.flags.includes("i"),m:r.flags.includes("m"),s:r.flags.includes("s")},n=t.i?r.source.toLowerCase():r.source;let s="",a=!1,i=!1,o=!1;for(let u=0;u<n.length;u++){if(a){s+=n[u],a=!1;continue}if(t.i){if(i){if(n[u].match(/[a-z]/)){o?(s+=n[u],s+=`${n[u-2]}-${n[u]}`.toUpperCase(),o=!1):n[u+1]==="-"&&((c=n[u+2])!=null&&c.match(/[a-z]/))?(s+=n[u],o=!0):s+=`${n[u]}${n[u].toUpperCase()}`;continue}}else if(n[u].match(/[a-z]/)){s+=`[${n[u]}${n[u].toUpperCase()}]`;continue}}if(t.m){if(n[u]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(n[u]==="$"){s+=`($|(?=[\r
]))`;continue}}if(t.s&&n[u]==="."){s+=i?`${n[u]}\r
`:`[${n[u]}\r
]`;continue}s+=n[u],n[u]==="\\"?a=!0:i&&n[u]==="]"?i=!1:!i&&n[u]==="["&&(i=!0)}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),r.source}return s}function Jc(r,e){var n,s,a,i,o,c;if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&((n=r.keyType)==null?void 0:n._def.typeName)===R.ZodEnum)return{type:"object",required:r.keyType._def.values,properties:r.keyType._def.values.reduce((u,l)=>({...u,[l]:fe(r.valueType._def,{...e,currentPath:[...e.currentPath,"properties",l]})??Xe(e)}),{}),additionalProperties:e.rejectedAdditionalProperties};const t={type:"object",additionalProperties:fe(r.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??e.allowedAdditionalProperties};if(e.target==="openApi3")return t;if(((s=r.keyType)==null?void 0:s._def.typeName)===R.ZodString&&((a=r.keyType._def.checks)!=null&&a.length)){const{type:u,...l}=Zc(r.keyType._def,e);return{...t,propertyNames:l}}else{if(((i=r.keyType)==null?void 0:i._def.typeName)===R.ZodEnum)return{...t,propertyNames:{enum:r.keyType._def.values}};if(((o=r.keyType)==null?void 0:o._def.typeName)===R.ZodBranded&&r.keyType._def.type._def.typeName===R.ZodString&&((c=r.keyType._def.type._def.checks)!=null&&c.length)){const{type:u,...l}=Hc(r.keyType._def,e);return{...t,propertyNames:l}}}return t}function lh(r,e){if(e.mapStrategy==="record")return Jc(r,e);const t=fe(r.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||Xe(e),n=fe(r.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||Xe(e);return{type:"array",maxItems:125,items:{type:"array",items:[t,n],minItems:2,maxItems:2}}}function dh(r){const e=r.values,n=Object.keys(r.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),s=Array.from(new Set(n.map(a=>typeof a)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:n}}function fh(r){return r.target==="openAi"?void 0:{not:Xe({...r,currentPath:[...r.currentPath,"not"]})}}function hh(r){return r.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Vn={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function ph(r,e){if(e.target==="openApi3")return ro(r,e);const t=r.options instanceof Map?Array.from(r.options.values()):r.options;if(t.every(n=>n._def.typeName in Vn&&(!n._def.checks||!n._def.checks.length))){const n=t.reduce((s,a)=>{const i=Vn[a._def.typeName];return i&&!s.includes(i)?[...s,i]:s},[]);return{type:n.length>1?n:n[0]}}else if(t.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){const n=t.reduce((s,a)=>{const i=typeof a._def.value;switch(i){case"string":case"number":case"boolean":return[...s,i];case"bigint":return[...s,"integer"];case"object":return a._def.value===null?[...s,"null"]:s;case"symbol":case"undefined":case"function":default:return s}},[]);if(n.length===t.length){const s=n.filter((a,i,o)=>o.indexOf(a)===i);return{type:s.length>1?s:s[0],enum:t.reduce((a,i)=>a.includes(i._def.value)?a:[...a,i._def.value],[])}}}else if(t.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((n,s)=>[...n,...s._def.values.filter(a=>!n.includes(a))],[])};return ro(r,e)}const ro=(r,e)=>{const t=(r.options instanceof Map?Array.from(r.options.values()):r.options).map((n,s)=>fe(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return t.length?{anyOf:t}:void 0};function mh(r,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(r.innerType._def.typeName)&&(!r.innerType._def.checks||!r.innerType._def.checks.length))return e.target==="openApi3"?{type:Vn[r.innerType._def.typeName],nullable:!0}:{type:[Vn[r.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const n=fe(r.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const t=fe(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function gh(r,e){const t={type:"number"};if(!r.checks)return t;for(const n of r.checks)switch(n.kind){case"int":t.type="integer",Bc(t,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?me(t,"minimum",n.value,n.message,e):me(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),me(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?me(t,"maximum",n.value,n.message,e):me(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),me(t,"maximum",n.value,n.message,e));break;case"multipleOf":me(t,"multipleOf",n.value,n.message,e);break}return t}function yh(r,e){const t=e.target==="openAi",n={type:"object",properties:{}},s=[],a=r.shape();for(const o in a){let c=a[o];if(c===void 0||c._def===void 0)continue;let u=wh(c);u&&t&&(c._def.typeName==="ZodOptional"&&(c=c._def.innerType),c.isNullable()||(c=c.nullable()),u=!1);const l=fe(c._def,{...e,currentPath:[...e.currentPath,"properties",o],propertyPath:[...e.currentPath,"properties",o]});l!==void 0&&(n.properties[o]=l,u||s.push(o))}s.length&&(n.required=s);const i=_h(r,e);return i!==void 0&&(n.additionalProperties=i),n}function _h(r,e){if(r.catchall._def.typeName!=="ZodNever")return fe(r.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]});switch(r.unknownKeys){case"passthrough":return e.allowedAdditionalProperties;case"strict":return e.rejectedAdditionalProperties;case"strip":return e.removeAdditionalStrategy==="strict"?e.allowedAdditionalProperties:e.rejectedAdditionalProperties}}function wh(r){try{return r.isOptional()}catch{return!0}}const vh=(r,e)=>{var n;if(e.currentPath.toString()===((n=e.propertyPath)==null?void 0:n.toString()))return fe(r.innerType._def,e);const t=fe(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:Xe(e)},t]}:Xe(e)},bh=(r,e)=>{if(e.pipeStrategy==="input")return fe(r.in._def,e);if(e.pipeStrategy==="output")return fe(r.out._def,e);const t=fe(r.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),n=fe(r.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,n].filter(s=>s!==void 0)}};function Eh(r,e){return fe(r.type._def,e)}function Th(r,e){const n={type:"array",uniqueItems:!0,items:fe(r.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return r.minSize&&me(n,"minItems",r.minSize.value,r.minSize.message,e),r.maxSize&&me(n,"maxItems",r.maxSize.value,r.maxSize.message,e),n}function Sh(r,e){return r.rest?{type:"array",minItems:r.items.length,items:r.items.map((t,n)=>fe(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[]),additionalItems:fe(r.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:r.items.length,maxItems:r.items.length,items:r.items.map((t,n)=>fe(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[])}}function xh(r){return{not:Xe(r)}}function Ih(r){return Xe(r)}const Oh=(r,e)=>fe(r.innerType._def,e),Ah=(r,e,t)=>{switch(e){case R.ZodString:return Zc(r,t);case R.ZodNumber:return gh(r,t);case R.ZodObject:return yh(r,t);case R.ZodBigInt:return Yf(r,t);case R.ZodBoolean:return Qf();case R.ZodDate:return Vc(r,t);case R.ZodUndefined:return xh(t);case R.ZodNull:return hh(t);case R.ZodArray:return Xf(r,t);case R.ZodUnion:case R.ZodDiscriminatedUnion:return ph(r,t);case R.ZodIntersection:return ih(r,t);case R.ZodTuple:return Sh(r,t);case R.ZodRecord:return Jc(r,t);case R.ZodLiteral:return oh(r,t);case R.ZodEnum:return sh(r);case R.ZodNativeEnum:return dh(r);case R.ZodNullable:return mh(r,t);case R.ZodOptional:return vh(r,t);case R.ZodMap:return lh(r,t);case R.ZodSet:return Th(r,t);case R.ZodLazy:return()=>r.getter()._def;case R.ZodPromise:return Eh(r,t);case R.ZodNaN:case R.ZodNever:return fh(t);case R.ZodEffects:return nh(r,t);case R.ZodAny:return Xe(t);case R.ZodUnknown:return Ih(t);case R.ZodDefault:return rh(r,t);case R.ZodBranded:return Hc(r,t);case R.ZodReadonly:return Oh(r,t);case R.ZodCatch:return eh(r,t);case R.ZodPipeline:return bh(r,t);case R.ZodFunction:case R.ZodVoid:case R.ZodSymbol:return;default:return(n=>{})()}};function fe(r,e,t=!1){var o;const n=e.seen.get(r);if(e.override){const c=(o=e.override)==null?void 0:o.call(e,r,e,n,t);if(c!==bf)return c}if(n&&!t){const c=kh(n,e);if(c!==void 0)return c}const s={def:r,path:e.currentPath,jsonSchema:void 0};e.seen.set(r,s);const a=Ah(r,r.typeName,e),i=typeof a=="function"?fe(a(),e):a;if(i&&Rh(r,e,i),e.postProcess){const c=e.postProcess(i,r,e);return s.jsonSchema=i,c}return s.jsonSchema=i,i}const kh=(r,e)=>{switch(e.$refStrategy){case"root":return{$ref:r.path.join("/")};case"relative":return{$ref:Fc(e.currentPath,r.path)};case"none":case"seen":return r.path.length<e.currentPath.length&&r.path.every((t,n)=>e.currentPath[n]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),Xe(e)):e.$refStrategy==="seen"?Xe(e):void 0}},Rh=(r,e,t)=>(r.description&&(t.description=r.description,e.markdownDescription&&(t.markdownDescription=r.description)),t),$h=(r,e)=>{const t=Sf(e);let n;const s=e==null?void 0:e.name,a=fe(r._def,t,!1)??Xe(t);t.flags.hasReferencedOpenAiAnyType&&(n||(n={}),n[t.openAiAnyTypeName]||(n[t.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:t.$refStrategy==="relative"?"1":[...t.basePath,t.definitionPath,t.openAiAnyTypeName].join("/")}}));const i=s===void 0?n?{...a,[t.definitionPath]:n}:a:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,s].join("/"),[t.definitionPath]:{...n,[s]:a}};return t.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":(t.target==="jsonSchema2019-09"||t.target==="openAi")&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),t.target==="openAi"&&("anyOf"in i||"oneOf"in i||"allOf"in i||"type"in i&&Array.isArray(i.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),i};function sr(r,e){const t=typeof r;if(t!==typeof e)return!1;if(Array.isArray(r)){if(!Array.isArray(e))return!1;const n=r.length;if(n!==e.length)return!1;for(let s=0;s<n;s++)if(!sr(r[s],e[s]))return!1;return!0}if(t==="object"){if(!r||!e)return r===e;const n=Object.keys(r),s=Object.keys(e);if(n.length!==s.length)return!1;for(const i of n)if(!sr(r[i],e[i]))return!1;return!0}return r===e}function ct(r){return encodeURI(Ch(r))}function Ch(r){return r.replace(/~/g,"~0").replace(/\//g,"~1")}const Nh={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},Ph={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},Lh={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let jh=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function Gt(r,e=Object.create(null),t=jh,n=""){if(r&&typeof r=="object"&&!Array.isArray(r)){const a=r.$id||r.id;if(a){const i=new URL(a,t.href);i.hash.length>1?e[i.href]=r:(i.hash="",n===""?t=i:Gt(r,e,t))}}else if(r!==!0&&r!==!1)return e;const s=t.href+(n?"#"+n:"");if(e[s]!==void 0)throw new Error(`Duplicate schema URI "${s}".`);if(e[s]=r,r===!0||r===!1)return e;if(r.__absolute_uri__===void 0&&Object.defineProperty(r,"__absolute_uri__",{enumerable:!1,value:s}),r.$ref&&r.__absolute_ref__===void 0){const a=new URL(r.$ref,t.href);a.hash=a.hash,Object.defineProperty(r,"__absolute_ref__",{enumerable:!1,value:a.href})}if(r.$recursiveRef&&r.__absolute_recursive_ref__===void 0){const a=new URL(r.$recursiveRef,t.href);a.hash=a.hash,Object.defineProperty(r,"__absolute_recursive_ref__",{enumerable:!1,value:a.href})}if(r.$anchor){const a=new URL("#"+r.$anchor,t.href);e[a.href]=r}for(let a in r){if(Lh[a])continue;const i=`${n}/${ct(a)}`,o=r[a];if(Array.isArray(o)){if(Nh[a]){const c=o.length;for(let u=0;u<c;u++)Gt(o[u],e,t,`${i}/${u}`)}}else if(Ph[a])for(let c in o)Gt(o[c],e,t,`${i}/${ct(c)}`);else Gt(o,e,t,i)}return e}const Mh=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,Dh=[0,31,28,31,30,31,30,31,31,30,31,30,31],Uh=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,Fh=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,Bh=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,zh=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,Gh=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,qh=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,Hh=/^(?:\/(?:[^~/]|~0|~1)*)*$/,Vh=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,Zh=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,Jh=r=>{if(r[0]==='"')return!1;const[e,t,...n]=r.split("@");return!e||!t||n.length!==0||e.length>64||t.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(t)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:t.split(".").every(s=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(s))},Wh=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,Kh=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,Xh=r=>r.length>1&&r.length<80&&(/^P\d+([.,]\d+)?W$/.test(r)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(r)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(r));function yt(r){return r.test.bind(r)}const no={date:Wc,time:Kc.bind(void 0,!1),"date-time":ep,duration:Xh,uri:np,"uri-reference":yt(Bh),"uri-template":yt(zh),url:yt(Gh),email:Jh,hostname:yt(Fh),ipv4:yt(Wh),ipv6:yt(Kh),regex:ap,uuid:yt(qh),"json-pointer":yt(Hh),"json-pointer-uri-fragment":yt(Vh),"relative-json-pointer":yt(Zh)};function Yh(r){return r%4===0&&(r%100!==0||r%400===0)}function Wc(r){const e=r.match(Mh);if(!e)return!1;const t=+e[1],n=+e[2],s=+e[3];return n>=1&&n<=12&&s>=1&&s<=(n==2&&Yh(t)?29:Dh[n])}function Kc(r,e){const t=e.match(Uh);if(!t)return!1;const n=+t[1],s=+t[2],a=+t[3],i=!!t[5];return(n<=23&&s<=59&&a<=59||n==23&&s==59&&a==60)&&(!r||i)}const Qh=/t|\s/i;function ep(r){const e=r.split(Qh);return e.length==2&&Wc(e[0])&&Kc(!0,e[1])}const tp=/\/|:/,rp=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function np(r){return tp.test(r)&&rp.test(r)}const sp=/[^\\]\\Z/;function ap(r){if(sp.test(r))return!1;try{return new RegExp(r,"u"),!0}catch{return!1}}function ip(r){let e=0,t=r.length,n=0,s;for(;n<t;)e++,s=r.charCodeAt(n++),s>=55296&&s<=56319&&n<t&&(s=r.charCodeAt(n),(s&64512)==56320&&n++);return e}function ve(r,e,t="2019-09",n=Gt(e),s=!0,a=null,i="#",o="#",c=Object.create(null)){if(e===!0)return{valid:!0,errors:[]};if(e===!1)return{valid:!1,errors:[{instanceLocation:i,keyword:"false",keywordLocation:i,error:"False boolean schema."}]};const u=typeof r;let l;switch(u){case"boolean":case"number":case"string":l=u;break;case"object":r===null?l="null":Array.isArray(r)?l="array":l="object";break;default:throw new Error(`Instances of "${u}" type are not supported.`)}const{$ref:d,$recursiveRef:f,$recursiveAnchor:h,type:m,const:T,enum:w,required:_,not:b,anyOf:v,allOf:O,oneOf:x,if:A,then:J,else:E,format:ye,properties:xe,patternProperties:ce,additionalProperties:De,unevaluatedProperties:er,minProperties:P,maxProperties:$,propertyNames:C,dependentRequired:G,dependentSchemas:H,dependencies:B,prefixItems:W,items:se,additionalItems:ne,unevaluatedItems:pe,contains:Re,minContains:ue,maxContains:g,minItems:p,maxItems:I,uniqueItems:S,minimum:ie,maximum:ge,exclusiveMinimum:we,exclusiveMaximum:Ae,multipleOf:Pe,minLength:nt,maxLength:Ee,pattern:Qe,__absolute_ref__:pr,__absolute_recursive_ref__:vn}=e,L=[];if(h===!0&&a===null&&(a=e),f==="#"){const K=a===null?n[vn]:a,V=`${o}/$recursiveRef`,Q=ve(r,a===null?e:a,t,n,s,K,i,V,c);Q.valid||L.push({instanceLocation:i,keyword:"$recursiveRef",keywordLocation:V,error:"A subschema had errors."},...Q.errors)}if(d!==void 0){const V=n[pr||d];if(V===void 0){let N=`Unresolved $ref "${d}".`;throw pr&&pr!==d&&(N+=`  Absolute URI "${pr}".`),N+=`
Known schemas:
- ${Object.keys(n).join(`
- `)}`,new Error(N)}const Q=`${o}/$ref`,D=ve(r,V,t,n,s,a,i,Q,c);if(D.valid||L.push({instanceLocation:i,keyword:"$ref",keywordLocation:Q,error:"A subschema had errors."},...D.errors),t==="4"||t==="7")return{valid:L.length===0,errors:L}}if(Array.isArray(m)){let K=m.length,V=!1;for(let Q=0;Q<K;Q++)if(l===m[Q]||m[Q]==="integer"&&l==="number"&&r%1===0&&r===r){V=!0;break}V||L.push({instanceLocation:i,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${l}" is invalid. Expected "${m.join('", "')}".`})}else m==="integer"?(l!=="number"||r%1||r!==r)&&L.push({instanceLocation:i,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${l}" is invalid. Expected "${m}".`}):m!==void 0&&l!==m&&L.push({instanceLocation:i,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${l}" is invalid. Expected "${m}".`});if(T!==void 0&&(l==="object"||l==="array"?sr(r,T)||L.push({instanceLocation:i,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(T)}.`}):r!==T&&L.push({instanceLocation:i,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(T)}.`})),w!==void 0&&(l==="object"||l==="array"?w.some(K=>sr(r,K))||L.push({instanceLocation:i,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(w)}.`}):w.some(K=>r===K)||L.push({instanceLocation:i,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(w)}.`})),b!==void 0){const K=`${o}/not`;ve(r,b,t,n,s,a,i,K).valid&&L.push({instanceLocation:i,keyword:"not",keywordLocation:K,error:'Instance matched "not" schema.'})}let tr=[];if(v!==void 0){const K=`${o}/anyOf`,V=L.length;let Q=!1;for(let D=0;D<v.length;D++){const N=v[D],Y=Object.create(c),X=ve(r,N,t,n,s,h===!0?a:null,i,`${K}/${D}`,Y);L.push(...X.errors),Q=Q||X.valid,X.valid&&tr.push(Y)}Q?L.length=V:L.splice(V,0,{instanceLocation:i,keyword:"anyOf",keywordLocation:K,error:"Instance does not match any subschemas."})}if(O!==void 0){const K=`${o}/allOf`,V=L.length;let Q=!0;for(let D=0;D<O.length;D++){const N=O[D],Y=Object.create(c),X=ve(r,N,t,n,s,h===!0?a:null,i,`${K}/${D}`,Y);L.push(...X.errors),Q=Q&&X.valid,X.valid&&tr.push(Y)}Q?L.length=V:L.splice(V,0,{instanceLocation:i,keyword:"allOf",keywordLocation:K,error:"Instance does not match every subschema."})}if(x!==void 0){const K=`${o}/oneOf`,V=L.length,Q=x.filter((D,N)=>{const Y=Object.create(c),X=ve(r,D,t,n,s,h===!0?a:null,i,`${K}/${N}`,Y);return L.push(...X.errors),X.valid&&tr.push(Y),X.valid}).length;Q===1?L.length=V:L.splice(V,0,{instanceLocation:i,keyword:"oneOf",keywordLocation:K,error:`Instance does not match exactly one subschema (${Q} matches).`})}if((l==="object"||l==="array")&&Object.assign(c,...tr),A!==void 0){const K=`${o}/if`;if(ve(r,A,t,n,s,a,i,K,c).valid){if(J!==void 0){const Q=ve(r,J,t,n,s,a,i,`${o}/then`,c);Q.valid||L.push({instanceLocation:i,keyword:"if",keywordLocation:K,error:'Instance does not match "then" schema.'},...Q.errors)}}else if(E!==void 0){const Q=ve(r,E,t,n,s,a,i,`${o}/else`,c);Q.valid||L.push({instanceLocation:i,keyword:"if",keywordLocation:K,error:'Instance does not match "else" schema.'},...Q.errors)}}if(l==="object"){if(_!==void 0)for(const D of _)D in r||L.push({instanceLocation:i,keyword:"required",keywordLocation:`${o}/required`,error:`Instance does not have required property "${D}".`});const K=Object.keys(r);if(P!==void 0&&K.length<P&&L.push({instanceLocation:i,keyword:"minProperties",keywordLocation:`${o}/minProperties`,error:`Instance does not have at least ${P} properties.`}),$!==void 0&&K.length>$&&L.push({instanceLocation:i,keyword:"maxProperties",keywordLocation:`${o}/maxProperties`,error:`Instance does not have at least ${$} properties.`}),C!==void 0){const D=`${o}/propertyNames`;for(const N in r){const Y=`${i}/${ct(N)}`,X=ve(N,C,t,n,s,a,Y,D);X.valid||L.push({instanceLocation:i,keyword:"propertyNames",keywordLocation:D,error:`Property name "${N}" does not match schema.`},...X.errors)}}if(G!==void 0){const D=`${o}/dependantRequired`;for(const N in G)if(N in r){const Y=G[N];for(const X of Y)X in r||L.push({instanceLocation:i,keyword:"dependentRequired",keywordLocation:D,error:`Instance has "${N}" but does not have "${X}".`})}}if(H!==void 0)for(const D in H){const N=`${o}/dependentSchemas`;if(D in r){const Y=ve(r,H[D],t,n,s,a,i,`${N}/${ct(D)}`,c);Y.valid||L.push({instanceLocation:i,keyword:"dependentSchemas",keywordLocation:N,error:`Instance has "${D}" but does not match dependant schema.`},...Y.errors)}}if(B!==void 0){const D=`${o}/dependencies`;for(const N in B)if(N in r){const Y=B[N];if(Array.isArray(Y))for(const X of Y)X in r||L.push({instanceLocation:i,keyword:"dependencies",keywordLocation:D,error:`Instance has "${N}" but does not have "${X}".`});else{const X=ve(r,Y,t,n,s,a,i,`${D}/${ct(N)}`);X.valid||L.push({instanceLocation:i,keyword:"dependencies",keywordLocation:D,error:`Instance has "${N}" but does not match dependant schema.`},...X.errors)}}}const V=Object.create(null);let Q=!1;if(xe!==void 0){const D=`${o}/properties`;for(const N in xe){if(!(N in r))continue;const Y=`${i}/${ct(N)}`,X=ve(r[N],xe[N],t,n,s,a,Y,`${D}/${ct(N)}`);if(X.valid)c[N]=V[N]=!0;else if(Q=s,L.push({instanceLocation:i,keyword:"properties",keywordLocation:D,error:`Property "${N}" does not match schema.`},...X.errors),Q)break}}if(!Q&&ce!==void 0){const D=`${o}/patternProperties`;for(const N in ce){const Y=new RegExp(N,"u"),X=ce[N];for(const Ge in r){if(!Y.test(Ge))continue;const Ri=`${i}/${ct(Ge)}`,$i=ve(r[Ge],X,t,n,s,a,Ri,`${D}/${ct(N)}`);$i.valid?c[Ge]=V[Ge]=!0:(Q=s,L.push({instanceLocation:i,keyword:"patternProperties",keywordLocation:D,error:`Property "${Ge}" matches pattern "${N}" but does not match associated schema.`},...$i.errors))}}}if(!Q&&De!==void 0){const D=`${o}/additionalProperties`;for(const N in r){if(V[N])continue;const Y=`${i}/${ct(N)}`,X=ve(r[N],De,t,n,s,a,Y,D);X.valid?c[N]=!0:(Q=s,L.push({instanceLocation:i,keyword:"additionalProperties",keywordLocation:D,error:`Property "${N}" does not match additional properties schema.`},...X.errors))}}else if(!Q&&er!==void 0){const D=`${o}/unevaluatedProperties`;for(const N in r)if(!c[N]){const Y=`${i}/${ct(N)}`,X=ve(r[N],er,t,n,s,a,Y,D);X.valid?c[N]=!0:L.push({instanceLocation:i,keyword:"unevaluatedProperties",keywordLocation:D,error:`Property "${N}" does not match unevaluated properties schema.`},...X.errors)}}}else if(l==="array"){I!==void 0&&r.length>I&&L.push({instanceLocation:i,keyword:"maxItems",keywordLocation:`${o}/maxItems`,error:`Array has too many items (${r.length} > ${I}).`}),p!==void 0&&r.length<p&&L.push({instanceLocation:i,keyword:"minItems",keywordLocation:`${o}/minItems`,error:`Array has too few items (${r.length} < ${p}).`});const K=r.length;let V=0,Q=!1;if(W!==void 0){const D=`${o}/prefixItems`,N=Math.min(W.length,K);for(;V<N;V++){const Y=ve(r[V],W[V],t,n,s,a,`${i}/${V}`,`${D}/${V}`);if(c[V]=!0,!Y.valid&&(Q=s,L.push({instanceLocation:i,keyword:"prefixItems",keywordLocation:D,error:"Items did not match schema."},...Y.errors),Q))break}}if(se!==void 0){const D=`${o}/items`;if(Array.isArray(se)){const N=Math.min(se.length,K);for(;V<N;V++){const Y=ve(r[V],se[V],t,n,s,a,`${i}/${V}`,`${D}/${V}`);if(c[V]=!0,!Y.valid&&(Q=s,L.push({instanceLocation:i,keyword:"items",keywordLocation:D,error:"Items did not match schema."},...Y.errors),Q))break}}else for(;V<K;V++){const N=ve(r[V],se,t,n,s,a,`${i}/${V}`,D);if(c[V]=!0,!N.valid&&(Q=s,L.push({instanceLocation:i,keyword:"items",keywordLocation:D,error:"Items did not match schema."},...N.errors),Q))break}if(!Q&&ne!==void 0){const N=`${o}/additionalItems`;for(;V<K;V++){const Y=ve(r[V],ne,t,n,s,a,`${i}/${V}`,N);c[V]=!0,Y.valid||(Q=s,L.push({instanceLocation:i,keyword:"additionalItems",keywordLocation:N,error:"Items did not match additional items schema."},...Y.errors))}}}if(Re!==void 0)if(K===0&&ue===void 0)L.push({instanceLocation:i,keyword:"contains",keywordLocation:`${o}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(ue!==void 0&&K<ue)L.push({instanceLocation:i,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array has less items (${K}) than minContains (${ue}).`});else{const D=`${o}/contains`,N=L.length;let Y=0;for(let X=0;X<K;X++){const Ge=ve(r[X],Re,t,n,s,a,`${i}/${X}`,D);Ge.valid?(c[X]=!0,Y++):L.push(...Ge.errors)}Y>=(ue||0)&&(L.length=N),ue===void 0&&g===void 0&&Y===0?L.splice(N,0,{instanceLocation:i,keyword:"contains",keywordLocation:D,error:"Array does not contain item matching schema."}):ue!==void 0&&Y<ue?L.push({instanceLocation:i,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array must contain at least ${ue} items matching schema. Only ${Y} items were found.`}):g!==void 0&&Y>g&&L.push({instanceLocation:i,keyword:"maxContains",keywordLocation:`${o}/maxContains`,error:`Array may contain at most ${g} items matching schema. ${Y} items were found.`})}if(!Q&&pe!==void 0){const D=`${o}/unevaluatedItems`;for(V;V<K;V++){if(c[V])continue;const N=ve(r[V],pe,t,n,s,a,`${i}/${V}`,D);c[V]=!0,N.valid||L.push({instanceLocation:i,keyword:"unevaluatedItems",keywordLocation:D,error:"Items did not match unevaluated items schema."},...N.errors)}}if(S)for(let D=0;D<K;D++){const N=r[D],Y=typeof N=="object"&&N!==null;for(let X=0;X<K;X++){if(D===X)continue;const Ge=r[X];(N===Ge||Y&&(typeof Ge=="object"&&Ge!==null)&&sr(N,Ge))&&(L.push({instanceLocation:i,keyword:"uniqueItems",keywordLocation:`${o}/uniqueItems`,error:`Duplicate items at indexes ${D} and ${X}.`}),D=Number.MAX_SAFE_INTEGER,X=Number.MAX_SAFE_INTEGER)}}}else if(l==="number"){if(t==="4"?(ie!==void 0&&(we===!0&&r<=ie||r<ie)&&L.push({instanceLocation:i,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${r} is less than ${we?"or equal to ":""} ${ie}.`}),ge!==void 0&&(Ae===!0&&r>=ge||r>ge)&&L.push({instanceLocation:i,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${r} is greater than ${Ae?"or equal to ":""} ${ge}.`})):(ie!==void 0&&r<ie&&L.push({instanceLocation:i,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${r} is less than ${ie}.`}),ge!==void 0&&r>ge&&L.push({instanceLocation:i,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${r} is greater than ${ge}.`}),we!==void 0&&r<=we&&L.push({instanceLocation:i,keyword:"exclusiveMinimum",keywordLocation:`${o}/exclusiveMinimum`,error:`${r} is less than ${we}.`}),Ae!==void 0&&r>=Ae&&L.push({instanceLocation:i,keyword:"exclusiveMaximum",keywordLocation:`${o}/exclusiveMaximum`,error:`${r} is greater than or equal to ${Ae}.`})),Pe!==void 0){const K=r%Pe;Math.abs(0-K)>=11920929e-14&&Math.abs(Pe-K)>=11920929e-14&&L.push({instanceLocation:i,keyword:"multipleOf",keywordLocation:`${o}/multipleOf`,error:`${r} is not a multiple of ${Pe}.`})}}else if(l==="string"){const K=nt===void 0&&Ee===void 0?0:ip(r);nt!==void 0&&K<nt&&L.push({instanceLocation:i,keyword:"minLength",keywordLocation:`${o}/minLength`,error:`String is too short (${K} < ${nt}).`}),Ee!==void 0&&K>Ee&&L.push({instanceLocation:i,keyword:"maxLength",keywordLocation:`${o}/maxLength`,error:`String is too long (${K} > ${Ee}).`}),Qe!==void 0&&!new RegExp(Qe,"u").test(r)&&L.push({instanceLocation:i,keyword:"pattern",keywordLocation:`${o}/pattern`,error:"String does not match pattern."}),ye!==void 0&&no[ye]&&!no[ye](r)&&L.push({instanceLocation:i,keyword:"format",keywordLocation:`${o}/format`,error:`String does not match format "${ye}".`})}return{valid:L.length===0,errors:L}}class op{constructor(e,t="2019-09",n=!0){y(this,"schema");y(this,"draft");y(this,"shortCircuit");y(this,"lookup");this.schema=e,this.draft=t,this.shortCircuit=n,this.lookup=Gt(e)}validate(e){return ve(e,this.schema,this.draft,this.lookup,this.shortCircuit)}addSchema(e,t){t&&(e={...e,$id:t}),Gt(e,this.lookup)}}var cp={};he(cp,{Validator:()=>op,deepCompareStrict:()=>sr,toJsonSchema:()=>Wt,validatesOnlyStrings:()=>Mn});function Wt(r){if(Oe(r)){const e=Uc(r,!0);if(vt(e)){const t=Fn(e,!0);return Di(t)}else return Di(r)}return Ce(r)?$h(r):r}function Mn(r){if(!r||typeof r!="object"||Object.keys(r).length===0||Array.isArray(r))return!1;if("type"in r)return typeof r.type=="string"?r.type==="string":Array.isArray(r.type)?r.type.every(e=>e==="string"):!1;if("enum"in r)return Array.isArray(r.enum)&&r.enum.length>0&&r.enum.every(e=>typeof e=="string");if("const"in r)return typeof r.const=="string";if("allOf"in r&&Array.isArray(r.allOf))return r.allOf.some(e=>Mn(e));if("anyOf"in r&&Array.isArray(r.anyOf)||"oneOf"in r&&Array.isArray(r.oneOf)){const e="anyOf"in r?r.anyOf:r.oneOf;return e.length>0&&e.every(t=>Mn(t))}if("not"in r)return!1;if("$ref"in r&&typeof r.$ref=="string"){const e=r.$ref,t=Gt(r);return t[e]?Mn(t[e]):!1}return!1}function Kt(r){return typeof r=="object"&&r!==null&&"type"in r&&typeof r.type=="string"&&"source_type"in r&&(r.source_type==="url"||r.source_type==="base64"||r.source_type==="text"||r.source_type==="id")}function Va(r){return Kt(r)&&r.source_type==="url"&&"url"in r&&typeof r.url=="string"}function Za(r){return Kt(r)&&r.source_type==="base64"&&"data"in r&&typeof r.data=="string"}function up(r){return Kt(r)&&r.source_type==="text"&&"text"in r&&typeof r.text=="string"}function Xc(r){return Kt(r)&&r.source_type==="id"&&"id"in r&&typeof r.id=="string"}function Yc(r){if(Kt(r)){if(r.source_type==="url")return{type:"image_url",image_url:{url:r.url}};if(r.source_type==="base64"){if(!r.mime_type)throw new Error("mime_type key is required for base64 data.");return{type:"image_url",image_url:{url:`data:${r.mime_type};base64,${r.data}`}}}}throw new Error("Unsupported source type. Only 'url' and 'base64' are supported.")}function lp(r){const e=r.split(";")[0].split("/");if(e.length!==2)throw new Error(`Invalid mime type: "${r}" - does not match type/subtype format.`);const t=e[0].trim(),n=e[1].trim();if(t===""||n==="")throw new Error(`Invalid mime type: "${r}" - type or subtype is empty.`);const s={};for(const a of r.split(";").slice(1)){const i=a.split("=");if(i.length!==2)throw new Error(`Invalid parameter syntax in mime type: "${r}".`);const o=i[0].trim(),c=i[1].trim();if(o==="")throw new Error(`Invalid parameter syntax in mime type: "${r}".`);s[o]=c}return{type:t,subtype:n,parameters:s}}function oa({dataUrl:r,asTypedArray:e=!1}){const t=r.match(/^data:(\w+\/\w+);base64,([A-Za-z0-9+/]+=*)$/);let n;if(t){n=t[1].toLowerCase();const s=e?Uint8Array.from(atob(t[2]),a=>a.charCodeAt(0)):t[2];return{mime_type:n,data:s}}}function dp(r,e){if(r.type==="text"){if(!e.fromStandardTextBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardTextBlock\` method.`);return e.fromStandardTextBlock(r)}if(r.type==="image"){if(!e.fromStandardImageBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardImageBlock\` method.`);return e.fromStandardImageBlock(r)}if(r.type==="audio"){if(!e.fromStandardAudioBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardAudioBlock\` method.`);return e.fromStandardAudioBlock(r)}if(r.type==="file"){if(!e.fromStandardFileBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardFileBlock\` method.`);return e.fromStandardFileBlock(r)}throw new Error(`Unable to convert content block type '${r.type}' to provider-specific format: not recognized.`)}var fp=function(r,e){if(typeof r!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,r.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()};const hp=Oc(fp);var Qc={exports:{}};const pp=/[\p{Lu}]/u,mp=/[\p{Ll}]/u,so=/^[\p{Lu}](?![\p{Lu}])/gu,eu=/([\p{Alpha}\p{N}_]|$)/u,tu=/[_.\- ]+/,gp=new RegExp("^"+tu.source),ao=new RegExp(tu.source+eu.source,"gu"),io=new RegExp("\\d+"+eu.source,"gu"),yp=(r,e,t)=>{let n=!1,s=!1,a=!1;for(let i=0;i<r.length;i++){const o=r[i];n&&pp.test(o)?(r=r.slice(0,i)+"-"+r.slice(i),n=!1,a=s,s=!0,i++):s&&a&&mp.test(o)?(r=r.slice(0,i-1)+"-"+r.slice(i-1),a=s,s=!1,n=!0):(n=e(o)===o&&t(o)!==o,a=s,s=t(o)===o&&e(o)!==o)}return r},_p=(r,e)=>(so.lastIndex=0,r.replace(so,t=>e(t))),wp=(r,e)=>(ao.lastIndex=0,io.lastIndex=0,r.replace(ao,(t,n)=>e(n)).replace(io,t=>e(t))),ru=(r,e)=>{if(!(typeof r=="string"||Array.isArray(r)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(r)?r=r.map(a=>a.trim()).filter(a=>a.length).join("-"):r=r.trim(),r.length===0)return"";const t=e.locale===!1?a=>a.toLowerCase():a=>a.toLocaleLowerCase(e.locale),n=e.locale===!1?a=>a.toUpperCase():a=>a.toLocaleUpperCase(e.locale);return r.length===1?e.pascalCase?n(r):t(r):(r!==t(r)&&(r=yp(r,t,n)),r=r.replace(gp,""),e.preserveConsecutiveUppercase?r=_p(r,t):r=t(r),e.pascalCase&&(r=n(r.charAt(0))+r.slice(1)),wp(r,n))};Qc.exports=ru;Qc.exports.default=ru;function vp(r,e){return(e==null?void 0:e[r])||hp(r)}function bp(r,e,t){const n={};for(const s in r)Object.hasOwn(r,s)&&(n[e(s,t)]=r[s]);return n}var Ep={};he(Ep,{Serializable:()=>Ar,get_lc_unique_name:()=>Ja});function oo(r){return Array.isArray(r)?[...r]:{...r}}function Tp(r,e){const t=oo(r);for(const[n,s]of Object.entries(e)){const[a,...i]=n.split(".").reverse();let o=t;for(const c of i.reverse()){if(o[c]===void 0)break;o[c]=oo(o[c]),o=o[c]}o[a]!==void 0&&(o[a]={lc:1,type:"secret",id:[s]})}return t}function Ja(r){const e=Object.getPrototypeOf(r);return typeof r.lc_name=="function"&&(typeof e.lc_name!="function"||r.lc_name()!==e.lc_name())?r.lc_name():r.name}var Ar=class nu{constructor(e,...t){y(this,"lc_serializable",!1);y(this,"lc_kwargs");this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([n])=>{var s;return(s=this.lc_serializable_keys)==null?void 0:s.includes(n)})):this.lc_kwargs=e??{}}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Ja(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof nu||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},n=Object.keys(this.lc_kwargs).reduce((s,a)=>(s[a]=a in this?this[a]:this.lc_kwargs[a],s),{});for(let s=Object.getPrototypeOf(this);s;s=Object.getPrototypeOf(s))Object.assign(e,Reflect.get(s,"lc_aliases",this)),Object.assign(t,Reflect.get(s,"lc_secrets",this)),Object.assign(n,Reflect.get(s,"lc_attributes",this));return Object.keys(t).forEach(s=>{let a=this,i=n;const[o,...c]=s.split(".").reverse();for(const u of c.reverse()){if(!(u in a)||a[u]===void 0)return;(!(u in i)||i[u]===void 0)&&(typeof a[u]=="object"&&a[u]!=null?i[u]={}:Array.isArray(a[u])&&(i[u]=[])),a=a[u],i=i[u]}o in a&&a[o]!==void 0&&(i[o]=i[o]||a[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:bp(Object.keys(t).length?Tp(n,t):n,vp,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function Z(r,e){return ee(r)&&r.type===e}function ee(r){return typeof r=="object"&&r!==null}function Et(r){return Array.isArray(r)}function M(r){return typeof r=="string"}function ut(r){return typeof r=="number"}function Wa(r){return r instanceof Uint8Array}function co(r){try{return JSON.parse(r)}catch{return}}const en=r=>r();function Sp(r){if(r.type==="char_location"&&M(r.document_title)&&ut(r.start_char_index)&&ut(r.end_char_index)&&M(r.cited_text)){const{document_title:e,start_char_index:t,end_char_index:n,cited_text:s,...a}=r;return{...a,type:"citation",source:"char",title:e??void 0,startIndex:t,endIndex:n,citedText:s}}if(r.type==="page_location"&&M(r.document_title)&&ut(r.start_page_number)&&ut(r.end_page_number)&&M(r.cited_text)){const{document_title:e,start_page_number:t,end_page_number:n,cited_text:s,...a}=r;return{...a,type:"citation",source:"page",title:e??void 0,startIndex:t,endIndex:n,citedText:s}}if(r.type==="content_block_location"&&M(r.document_title)&&ut(r.start_block_index)&&ut(r.end_block_index)&&M(r.cited_text)){const{document_title:e,start_block_index:t,end_block_index:n,cited_text:s,...a}=r;return{...a,type:"citation",source:"block",title:e??void 0,startIndex:t,endIndex:n,citedText:s}}if(r.type==="web_search_result_location"&&M(r.url)&&M(r.title)&&M(r.encrypted_index)&&M(r.cited_text)){const{url:e,title:t,encrypted_index:n,cited_text:s,...a}=r;return{...a,type:"citation",source:"url",url:e,title:t,startIndex:Number(n),endIndex:Number(n),citedText:s}}if(r.type==="search_result_location"&&M(r.source)&&M(r.title)&&ut(r.start_block_index)&&ut(r.end_block_index)&&M(r.cited_text)){const{source:e,title:t,start_block_index:n,end_block_index:s,cited_text:a,...i}=r;return{...i,type:"citation",source:"search",url:e,title:t??void 0,startIndex:n,endIndex:s,citedText:a}}}function su(r){if(Z(r,"document")&&ee(r.source)&&"type"in r.source){if(r.source.type==="base64"&&M(r.source.media_type)&&M(r.source.data))return{type:"file",mimeType:r.source.media_type,data:r.source.data};if(r.source.type==="url"&&M(r.source.url))return{type:"file",url:r.source.url};if(r.source.type==="file"&&M(r.source.file_id))return{type:"file",fileId:r.source.file_id};if(r.source.type==="text"&&M(r.source.data))return{type:"file",mimeType:String(r.source.media_type??"text/plain"),data:r.source.data}}else if(Z(r,"image")&&ee(r.source)&&"type"in r.source){if(r.source.type==="base64"&&M(r.source.media_type)&&M(r.source.data))return{type:"image",mimeType:r.source.media_type,data:r.source.data};if(r.source.type==="url"&&M(r.source.url))return{type:"image",url:r.source.url};if(r.source.type==="file"&&M(r.source.file_id))return{type:"image",fileId:r.source.file_id}}}function xp(r){function*e(){for(const t of r){const n=su(t);n?yield n:yield t}}return Array.from(e())}function uo(r){function*e(){var n;const t=typeof r.content=="string"?[{type:"text",text:r.content}]:r.content;for(const s of t){if(Z(s,"text")&&M(s.text)){const{text:a,citations:i,...o}=s;if(Et(i)&&i.length){const c=i.reduce((u,l)=>{const d=Sp(l);return d?[...u,d]:u},[]);yield{...o,type:"text",text:a,annotations:c};continue}else{yield{...o,type:"text",text:a};continue}}else if(Z(s,"thinking")&&M(s.thinking)){const{thinking:a,signature:i,...o}=s;yield{...o,type:"reasoning",reasoning:a,signature:i};continue}else if(Z(s,"redacted_thinking")){yield{type:"non_standard",value:s};continue}else if(Z(s,"tool_use")&&M(s.name)&&M(s.id)){yield{type:"tool_call",id:s.id,name:s.name,args:s.input};continue}else if(Z(s,"input_json_delta")){if(Op(r)&&((n=r.tool_call_chunks)!=null&&n.length)){const a=r.tool_call_chunks[0];yield{type:"tool_call_chunk",id:a.id,name:a.name,args:a.args,index:a.index};continue}}else if(Z(s,"server_tool_use")&&M(s.name)&&M(s.id)){const{name:a,id:i}=s;if(a==="web_search"){const o=en(()=>{if(typeof s.input=="string")return s.input;if(ee(s.input)&&M(s.input.query))return s.input.query;if(M(s.partial_json)){const c=co(s.partial_json);if(c!=null&&c.query)return c.query}return""});yield{id:i,type:"server_tool_call",name:"web_search",args:{query:o}};continue}else if(s.name==="code_execution"){const o=en(()=>{if(typeof s.input=="string")return s.input;if(ee(s.input)&&M(s.input.code))return s.input.code;if(M(s.partial_json)){const c=co(s.partial_json);if(c!=null&&c.code)return c.code}return""});yield{id:i,type:"server_tool_call",name:"code_execution",args:{code:o}};continue}}else if(Z(s,"web_search_tool_result")&&M(s.tool_use_id)&&Et(s.content)){const{content:a,tool_use_id:i}=s,o=a.reduce((c,u)=>Z(u,"web_search_result")?[...c,u.url]:c,[]);yield{type:"server_tool_call_result",name:"web_search",toolCallId:i,status:"success",output:{urls:o}};continue}else if(Z(s,"code_execution_tool_result")&&M(s.tool_use_id)&&ee(s.content)){yield{type:"server_tool_call_result",name:"code_execution",toolCallId:s.tool_use_id,status:"success",output:s.content};continue}else if(Z(s,"mcp_tool_use")){yield{id:s.id,type:"server_tool_call",name:"mcp_tool_use",args:s.input};continue}else if(Z(s,"mcp_tool_result")&&M(s.tool_use_id)&&ee(s.content)){yield{type:"server_tool_call_result",name:"mcp_tool_use",toolCallId:s.tool_use_id,status:"success",output:s.content};continue}else if(Z(s,"container_upload")){yield{type:"server_tool_call",name:"container_upload",args:s.input};continue}else if(Z(s,"search_result")){yield{id:s.id,type:"non_standard",value:s};continue}else if(Z(s,"tool_result")){yield{id:s.id,type:"non_standard",value:s};continue}else{const a=su(s);if(a){yield a;continue}}yield{type:"non_standard",value:s}}}return Array.from(e())}const Ip={translateContent:uo,translateContentChunk:uo};function Op(r){return typeof(r==null?void 0:r._getType)=="function"&&typeof r.concat=="function"&&r._getType()==="ai"}function Ap(r){return Va(r)?{type:r.type,mimeType:r.mime_type,url:r.url,metadata:r.metadata}:Za(r)?{type:r.type,mimeType:r.mime_type??"application/octet-stream",data:r.data,metadata:r.metadata}:Xc(r)?{type:r.type,mimeType:r.mime_type,fileId:r.id,metadata:r.metadata}:r}function kp(r){return r.map(Ap)}function Rp(r){return!!(Z(r,"image_url")&&ee(r.image_url)||Z(r,"input_audio")&&ee(r.input_audio)||Z(r,"file")&&ee(r.file))}function $p(r){if(Z(r,"image_url")&&ee(r.image_url)&&M(r.image_url.url)){const e=oa({dataUrl:r.image_url.url});return e?{type:"image",mimeType:e.mime_type,data:e.data}:{type:"image",url:r.image_url.url}}else{if(Z(r,"input_audio")&&ee(r.input_audio)&&M(r.input_audio.data)&&M(r.input_audio.format))return{type:"audio",data:r.input_audio.data,mimeType:`audio/${r.input_audio.format}`};if(Z(r,"file")&&ee(r.file)&&M(r.file.data)){const e=oa({dataUrl:r.file.data});if(e)return{type:"file",data:e.data,mimeType:e.mime_type};if(M(r.file.file_id))return{type:"file",fileId:r.file.file_id}}}return r}function Cp(r){const e=[];typeof r.content=="string"?e.push({type:"text",text:r.content}):e.push(...Ka(r.content));for(const t of r.tool_calls??[])e.push({type:"tool_call",id:t.id,name:t.name,args:t.args});return e}function Np(r){const e=[];typeof r.content=="string"?e.push({type:"text",text:r.content}):e.push(...Ka(r.content));for(const t of r.tool_calls??[])e.push({type:"tool_call",id:t.id,name:t.name,args:t.args});return e}function Ka(r){const e=[];for(const t of r)Rp(t)?e.push($p(t)):e.push(t);return e}function Pp(r){if(r.type==="url_citation"){const{url:e,title:t,start_index:n,end_index:s}=r;return{type:"citation",url:e,title:t,startIndex:n,endIndex:s}}if(r.type==="file_citation"){const{file_id:e,filename:t,index:n}=r;return{type:"citation",title:t,startIndex:n,endIndex:n,fileId:e}}return r}function au(r){function*e(){var n;ee((n=r.additional_kwargs)==null?void 0:n.reasoning)&&Et(r.additional_kwargs.reasoning.summary)&&(yield{type:"reasoning",reasoning:r.additional_kwargs.reasoning.summary.reduce((a,i)=>ee(i)&&M(i.text)?`${a}${i.text}`:a,"")});const t=typeof r.content=="string"?[{type:"text",text:r.content}]:r.content;for(const s of t)if(Z(s,"text")){const{text:a,annotations:i,...o}=s;Array.isArray(i)?yield{...o,type:"text",text:String(a),annotations:i.map(Pp)}:yield{...o,type:"text",text:String(a)}}for(const s of r.tool_calls??[])yield{type:"tool_call",id:s.id,name:s.name,args:s.args};if(ee(r.additional_kwargs)&&Et(r.additional_kwargs.tool_outputs))for(const s of r.additional_kwargs.tool_outputs){if(Z(s,"web_search_call")){yield{id:s.id,type:"server_tool_call",name:"web_search",args:{query:s.query}};continue}else if(Z(s,"file_search_call")){yield{id:s.id,type:"server_tool_call",name:"file_search",args:{query:s.query}};continue}else if(Z(s,"computer_call")){yield{type:"non_standard",value:s};continue}else if(Z(s,"code_interpreter_call")){if(M(s.code)&&(yield{id:s.id,type:"server_tool_call",name:"code_interpreter",args:{code:s.code}}),Et(s.outputs)){const a=en(()=>{if(s.status!=="in_progress"){if(s.status==="completed")return 0;if(s.status==="incomplete")return 127;if(s.status!=="interpreting"&&s.status==="failed")return 1}});for(const i of s.outputs)if(Z(i,"logs")){yield{type:"server_tool_call_result",toolCallId:s.id??"",status:"success",output:{type:"code_interpreter_output",returnCode:a??0,stderr:[0,void 0].includes(a)?void 0:String(i.logs),stdout:[0,void 0].includes(a)?String(i.logs):void 0}};continue}}continue}else if(Z(s,"mcp_call")){yield{id:s.id,type:"server_tool_call",name:"mcp_call",args:s.input};continue}else if(Z(s,"mcp_list_tools")){yield{id:s.id,type:"server_tool_call",name:"mcp_list_tools",args:s.input};continue}else if(Z(s,"mcp_approval_request")){yield{type:"non_standard",value:s};continue}else if(Z(s,"image_generation_call")){yield{type:"non_standard",value:s};continue}ee(s)&&(yield{type:"non_standard",value:s})}}return Array.from(e())}function Lp(r){function*e(){yield*au(r);for(const t of r.tool_call_chunks??[])yield{type:"tool_call_chunk",id:t.id,name:t.name,args:t.args}}return Array.from(e())}const jp={translateContent:r=>typeof r.content=="string"?Cp(r):au(r),translateContentChunk:r=>typeof r.content=="string"?Np(r):Lp(r)};function iu(r){return typeof r=="object"&&r!==null&&"type"in r&&"content"in r&&(typeof r.content=="string"||Array.isArray(r.content))}function Mp(r,e="pretty"){return e==="pretty"?Dp(r):JSON.stringify(r)}function Dp(r){const e=[],t=` ${r.type.charAt(0).toUpperCase()+r.type.slice(1)} Message `,n=Math.floor((80-t.length)/2),s="=".repeat(n),a=t.length%2===0?s:`${s}=`;if(e.push(`${s}${t}${a}`),r.type==="ai"){const i=r;if(i.tool_calls&&i.tool_calls.length>0){e.push("Tool Calls:");for(const o of i.tool_calls){e.push(`  ${o.name} (${o.id})`),e.push(` Call ID: ${o.id}`),e.push("  Args:");for(const[c,u]of Object.entries(o.args))e.push(`    ${c}: ${u}`)}}}if(r.type==="tool"){const i=r;i.name&&e.push(`Name: ${i.name}`)}return typeof r.content=="string"&&r.content.trim()&&(e.length>1&&e.push(""),e.push(r.content)),e.join(`
`)}const Is=Symbol.for("langchain.message");function Ct(r,e){return typeof r=="string"?r===""?e:typeof e=="string"?r+e:Array.isArray(e)&&e.length===0?r:Array.isArray(e)&&e.some(t=>Kt(t))?[{type:"text",source_type:"text",text:r},...e]:[{type:"text",text:r},...e]:Array.isArray(e)?cn(r,e)??[...r,...e]:e===""?r:Array.isArray(r)&&r.some(t=>Kt(t))?[...r,{type:"file",source_type:"text",text:e}]:[...r,{type:"text",text:e}]}function ou(r,e){return r==="error"||e==="error"?"error":"success"}function Up(r,e){function t(n,s){if(typeof n!="object"||n===null||n===void 0)return n;if(s>=e)return Array.isArray(n)?"[Array]":"[Object]";if(Array.isArray(n))return n.map(i=>t(i,s+1));const a={};for(const i of Object.keys(n))a[i]=t(n[i],s+1);return a}return JSON.stringify(t(r,0),null,2)}var Ic,Mt=class extends Ar{constructor(e){const t=typeof e=="string"||Array.isArray(e)?{content:e}:e;t.additional_kwargs||(t.additional_kwargs={}),t.response_metadata||(t.response_metadata={});super(t);y(this,"lc_namespace",["langchain_core","messages"]);y(this,"lc_serializable",!0);y(this,Ic,!0);y(this,"id");y(this,"name");y(this,"content");y(this,"additional_kwargs");y(this,"response_metadata");this.name=t.name,t.content===void 0&&t.contentBlocks!==void 0?(this.content=t.contentBlocks,this.response_metadata={output_version:"v1",...t.response_metadata}):t.content!==void 0?(this.content=t.content??[],this.response_metadata=t.response_metadata):(this.content=[],this.response_metadata=t.response_metadata),this.additional_kwargs=t.additional_kwargs,this.id=t.id}get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}_getType(){return this.type}getType(){return this._getType()}get text(){return typeof this.content=="string"?this.content:Array.isArray(this.content)?this.content.map(e=>typeof e=="string"?e:e.type==="text"?e.text:"").join(""):""}get contentBlocks(){const e=typeof this.content=="string"?[{type:"text",text:this.content}]:this.content;return[kp,Ka,xp].reduce((s,a)=>a(s),e)}toDict(){return{type:this.getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}static isInstance(e){return typeof e=="object"&&e!==null&&Is in e&&e[Is]===!0&&iu(e)}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[(Ic=Is,Symbol.toStringTag)](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const t=Up(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}toFormattedString(e="pretty"){return Mp(this,e)}};function Fp(r){return Array.isArray(r)&&r.every(e=>typeof e.index=="number")}function je(r={},e={}){const t={...r};for(const[n,s]of Object.entries(e))if(t[n]==null)t[n]=s;else{if(s==null)continue;if(typeof t[n]!=typeof s||Array.isArray(t[n])!==Array.isArray(s))throw new Error(`field[${n}] already exists in the message chunk, but with a different type.`);if(typeof t[n]=="string"){if(n==="type")continue;["id","name","output_version","model_provider"].includes(n)?t[n]=s:t[n]+=s}else if(typeof t[n]=="object"&&!Array.isArray(t[n]))t[n]=je(t[n],s);else if(Array.isArray(t[n]))t[n]=cn(t[n],s);else{if(t[n]===s)continue;console.warn(`field[${n}] already exists in this message chunk and value has unsupported type.`)}}return t}function cn(r,e){if(!(r===void 0&&e===void 0)){if(r===void 0||e===void 0)return r||e;{const t=[...r];for(const n of e)if(typeof n=="object"&&n!==null&&"index"in n&&typeof n.index=="number"){const s=t.findIndex(a=>{const i=typeof a=="object",o="index"in a&&a.index===n.index,c="id"in a&&"id"in n&&(a==null?void 0:a.id)===(n==null?void 0:n.id),u=!("id"in a)||!(a!=null&&a.id)||!("id"in n)||!(n!=null&&n.id);return i&&o&&(c||u)});s!==-1&&typeof t[s]=="object"&&t[s]!==null?t[s]=je(t[s],n):t.push(n)}else{if(typeof n=="object"&&n!==null&&"text"in n&&n.text==="")continue;t.push(n)}return t}}}function cu(r,e){if(!r&&!e)throw new Error("Cannot merge two undefined objects.");if(!r||!e)return r||e;if(typeof r!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof r}
Right ${typeof e}`);if(typeof r=="string"&&typeof e=="string")return r+e;if(Array.isArray(r)&&Array.isArray(e))return cn(r,e);if(typeof r=="object"&&typeof e=="object")return je(r,e);if(r===e)return r;throw new Error(`Can not merge objects of different types.
Left ${r}
Right ${e}`)}var Yt=class uu extends Mt{static isInstance(e){if(!super.isInstance(e))return!1;let t=Object.getPrototypeOf(e);for(;t!==null;){if(t===uu.prototype)return!0;t=Object.getPrototypeOf(t)}return!1}};function lu(r){return typeof r.role=="string"}function qt(r){return typeof(r==null?void 0:r._getType)=="function"}function Xa(r){return Yt.isInstance(r)}function ca(r,e=as){r=r.trim();const t=r.indexOf("```");if(t===-1)return e(r);let n=r.substring(t+3);n.startsWith(`json
`)?n=n.substring(5):n.startsWith("json")?n=n.substring(4):n.startsWith(`
`)&&(n=n.substring(1));const s=n.indexOf("```");let a=n;return s!==-1&&(a=n.substring(0,s)),e(a.trim())}function as(r){if(typeof r>"u")return null;try{return JSON.parse(r)}catch{}let e="";const t=[];let n=!1,s=!1;for(let a of r){if(n)a==='"'&&!s?n=!1:a===`
`&&!s?a="\\n":a==="\\"?s=!s:s=!1;else if(a==='"')n=!0,s=!1;else if(a==="{")t.push("}");else if(a==="[")t.push("]");else if(a==="}"||a==="]")if(t&&t[t.length-1]===a)t.pop();else return null;e+=a}n&&(e+='"');for(let a=t.length-1;a>=0;a-=1)e+=t[a];try{return JSON.parse(e)}catch{return null}}function Ya(r){switch(r){case"csv":return"text/csv";case"doc":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"docx":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"html":return"text/html";case"md":return"text/markdown";case"pdf":return"application/pdf";case"txt":return"text/plain";case"xls":return"application/vnd.ms-excel";case"xlsx":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";case"gif":return"image/gif";case"jpeg":return"image/jpeg";case"jpg":return"image/jpeg";case"png":return"image/png";case"webp":return"image/webp";case"flv":return"video/flv";case"mkv":return"video/mkv";case"mov":return"video/mov";case"mp4":return"video/mp4";case"mpeg":return"video/mpeg";case"mpg":return"video/mpg";case"three_gp":return"video/three_gp";case"webm":return"video/webm";case"wmv":return"video/wmv";default:return"application/octet-stream"}}function Bp(r){if(ee(r.document)&&ee(r.document.source)){const e=ee(r.document)&&M(r.document.format)?r.document.format:"",t=Ya(e);if(ee(r.document.source)){if(ee(r.document.source.s3Location)&&M(r.document.source.s3Location.uri))return{type:"file",mimeType:t,fileId:r.document.source.s3Location.uri};if(Wa(r.document.source.bytes))return{type:"file",mimeType:t,data:r.document.source.bytes};if(M(r.document.source.text))return{type:"file",mimeType:t,data:Buffer.from(r.document.source.text).toString("base64")};if(Et(r.document.source.content)){const n=r.document.source.content.reduce((s,a)=>ee(a)&&M(a.text)?s+a.text:s,"");return{type:"file",mimeType:t,data:n}}}}return{type:"non_standard",value:r}}function zp(r){if(Z(r,"image")&&ee(r.image)){const e=ee(r.image)&&M(r.image.format)?r.image.format:"",t=Ya(e);if(ee(r.image.source)){if(ee(r.image.source.s3Location)&&M(r.image.source.s3Location.uri))return{type:"image",mimeType:t,fileId:r.image.source.s3Location.uri};if(Wa(r.image.source.bytes))return{type:"image",mimeType:t,data:r.image.source.bytes}}}return{type:"non_standard",value:r}}function Gp(r){if(Z(r,"video")&&ee(r.video)){const e=ee(r.video)&&M(r.video.format)?r.video.format:"",t=Ya(e);if(ee(r.video.source)){if(ee(r.video.source.s3Location)&&M(r.video.source.s3Location.uri))return{type:"video",mimeType:t,fileId:r.video.source.s3Location.uri};if(Wa(r.video.source.bytes))return{type:"video",mimeType:t,data:r.video.source.bytes}}}return{type:"non_standard",value:r}}function lo(r){function*e(){const t=typeof r.content=="string"?[{type:"text",text:r.content}]:r.content;for(const n of t){if(Z(n,"cache_point")){yield{type:"non_standard",value:n};continue}else if(Z(n,"citations_content")&&ee(n.citationsContent)){const s=Et(n.citationsContent.content)?n.citationsContent.content.reduce((i,o)=>ee(o)&&M(o.text)?i+o.text:i,""):"",a=Et(n.citationsContent.citations)?n.citationsContent.citations.reduce((i,o)=>{if(ee(o)){const c=Et(o.sourceContent)?o.sourceContent.reduce((l,d)=>ee(d)&&M(d.text)?l+d.text:l,""):"",u=en(()=>{if(ee(o.location)){const l=o.location.documentChar||o.location.documentPage||o.location.documentChunk;if(ee(l))return{source:ut(l.documentIndex)?l.documentIndex.toString():void 0,startIndex:ut(l.start)?l.start:void 0,endIndex:ut(l.end)?l.end:void 0}}return{}});i.push({type:"citation",citedText:c,...u})}return i},[]):[];yield{type:"text",text:s,annotations:a};continue}else if(Z(n,"document")&&ee(n.document)){yield Bp(n);continue}else if(Z(n,"guard_content")){yield{type:"non_standard",value:n};continue}else if(Z(n,"image")&&ee(n.image)){yield zp(n);continue}else if(Z(n,"reasoning_content")&&M(n.reasoningText)){yield{type:"reasoning",reasoning:n.reasoningText};continue}else if(Z(n,"text")&&M(n.text)){yield{type:"text",text:n.text};continue}else if(Z(n,"tool_result")){yield{type:"non_standard",value:n};continue}else{if(Z(n,"tool_call"))continue;if(Z(n,"video")&&ee(n.video)){yield Gp(n);continue}}yield{type:"non_standard",value:n}}}return Array.from(e())}const qp={translateContent:lo,translateContentChunk:lo};function fo(r){function*e(){const t=typeof r.content=="string"?[{type:"text",text:r.content}]:r.content;for(const n of t){if(Z(n,"text")&&M(n.text)){yield{type:"text",text:n.text};continue}else if(Z(n,"inlineData")&&ee(n.inlineData)&&M(n.inlineData.mimeType)&&M(n.inlineData.data)){yield{type:"file",mimeType:n.inlineData.mimeType,data:n.inlineData.data};continue}else if(Z(n,"functionCall")&&ee(n.functionCall)&&M(n.functionCall.name)&&ee(n.functionCall.args)){yield{type:"tool_call",id:r.id,name:n.functionCall.name,args:n.functionCall.args};continue}else if(Z(n,"functionResponse")){yield{type:"non_standard",value:n};continue}else if(Z(n,"fileData")&&ee(n.fileData)&&M(n.fileData.mimeType)&&M(n.fileData.fileUri)){yield{type:"file",mimeType:n.fileData.mimeType,fileId:n.fileData.fileUri};continue}else if(Z(n,"executableCode")){yield{type:"non_standard",value:n};continue}else if(Z(n,"codeExecutionResult")){yield{type:"non_standard",value:n};continue}yield{type:"non_standard",value:n}}}return Array.from(e())}const Hp={translateContent:fo,translateContentChunk:fo};function ho(r){function*e(){const t=typeof r.content=="string"?[{type:"text",text:r.content}]:r.content;for(const n of t){if(Z(n,"reasoning")&&M(n.reasoning)){const s=en(()=>{var i;const a=t.indexOf(n);if(Et((i=r.additional_kwargs)==null?void 0:i.signatures)&&a>=0)return r.additional_kwargs.signatures.at(a)});M(s)?yield{type:"reasoning",reasoning:n.reasoning,signature:s}:yield{type:"reasoning",reasoning:n.reasoning};continue}else if(Z(n,"text")&&M(n.text)){yield{type:"text",text:n.text};continue}else if(Z(n,"image_url")){if(M(n.image_url))if(n.image_url.startsWith("data:")){const s=/^data:([^;]+);base64,(.+)$/,a=n.image_url.match(s);a?yield{type:"image",data:a[2],mimeType:a[1]}:yield{type:"image",url:n.image_url}}else yield{type:"image",url:n.image_url};continue}else if(Z(n,"media")&&M(n.mimeType)&&M(n.data)){yield{type:"file",mimeType:n.mimeType,data:n.data};continue}yield{type:"non_standard",value:n}}}return Array.from(e())}const Vp={translateContent:ho,translateContentChunk:ho};globalThis.lc_block_translators_registry??(globalThis.lc_block_translators_registry=new Map([["anthropic",Ip],["bedrock-converse",qp],["google-genai",Hp],["google-vertexai",Vp],["openai",jp]]));function du(r){return globalThis.lc_block_translators_registry.get(r)}function fu(r,e){return je(r??{},e??{})}function hu(r,e){const t={};return((r==null?void 0:r.audio)!==void 0||(e==null?void 0:e.audio)!==void 0)&&(t.audio=((r==null?void 0:r.audio)??0)+((e==null?void 0:e.audio)??0)),((r==null?void 0:r.image)!==void 0||(e==null?void 0:e.image)!==void 0)&&(t.image=((r==null?void 0:r.image)??0)+((e==null?void 0:e.image)??0)),((r==null?void 0:r.video)!==void 0||(e==null?void 0:e.video)!==void 0)&&(t.video=((r==null?void 0:r.video)??0)+((e==null?void 0:e.video)??0)),((r==null?void 0:r.document)!==void 0||(e==null?void 0:e.document)!==void 0)&&(t.document=((r==null?void 0:r.document)??0)+((e==null?void 0:e.document)??0)),((r==null?void 0:r.text)!==void 0||(e==null?void 0:e.text)!==void 0)&&(t.text=((r==null?void 0:r.text)??0)+((e==null?void 0:e.text)??0)),t}function Zp(r,e){const t={...hu(r,e)};return((r==null?void 0:r.cache_read)!==void 0||(e==null?void 0:e.cache_read)!==void 0)&&(t.cache_read=((r==null?void 0:r.cache_read)??0)+((e==null?void 0:e.cache_read)??0)),((r==null?void 0:r.cache_creation)!==void 0||(e==null?void 0:e.cache_creation)!==void 0)&&(t.cache_creation=((r==null?void 0:r.cache_creation)??0)+((e==null?void 0:e.cache_creation)??0)),t}function Jp(r,e){const t={...hu(r,e)};return((r==null?void 0:r.reasoning)!==void 0||(e==null?void 0:e.reasoning)!==void 0)&&(t.reasoning=((r==null?void 0:r.reasoning)??0)+((e==null?void 0:e.reasoning)??0)),t}function pu(r,e){return{input_tokens:((r==null?void 0:r.input_tokens)??0)+((e==null?void 0:e.input_tokens)??0),output_tokens:((r==null?void 0:r.output_tokens)??0)+((e==null?void 0:e.output_tokens)??0),total_tokens:((r==null?void 0:r.total_tokens)??0)+((e==null?void 0:e.total_tokens)??0),input_token_details:Zp(r==null?void 0:r.input_token_details,e==null?void 0:e.input_token_details),output_token_details:Jp(r==null?void 0:r.output_token_details,e==null?void 0:e.output_token_details)}}var Wp={};he(Wp,{ToolMessage:()=>Nr,ToolMessageChunk:()=>un,defaultToolCallParser:()=>Qa,isDirectToolOutput:()=>mu,isToolMessage:()=>gu,isToolMessageChunk:()=>yu});function mu(r){return r!=null&&typeof r=="object"&&"lc_direct_tool_output"in r&&r.lc_direct_tool_output===!0}var Nr=class extends Mt{constructor(e,t,n){const s=typeof e=="string"||Array.isArray(e)?{content:e,name:n,tool_call_id:t}:e;super(s);y(this,"lc_direct_tool_output",!0);y(this,"type","tool");y(this,"status");y(this,"tool_call_id");y(this,"metadata");y(this,"artifact");this.tool_call_id=s.tool_call_id,this.artifact=s.artifact,this.status=s.status,this.metadata=s.metadata}static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}static isInstance(e){return super.isInstance(e)&&e.type==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},un=class extends Yt{constructor(e){super(e);y(this,"type","tool");y(this,"tool_call_id");y(this,"status");y(this,"artifact");this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}concat(e){const t=this.constructor;return new t({content:Ct(this.content,e.content),additional_kwargs:je(this.additional_kwargs,e.additional_kwargs),response_metadata:je(this.response_metadata,e.response_metadata),artifact:cu(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:ou(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}};function Qa(r){const e=[],t=[];for(const n of r)if(n.function){const s=n.function.name;try{const a=JSON.parse(n.function.arguments);e.push({name:s||"",args:a||{},id:n.id})}catch{t.push({name:s,args:n.function.arguments,id:n.id,error:"Malformed args."})}}else continue;return[e,t]}function gu(r){return typeof r=="object"&&r!==null&&"getType"in r&&typeof r.getType=="function"&&r.getType()==="tool"}function yu(r){return r._getType()==="tool"}var Nt=class extends Mt{constructor(e){var n;let t;if(typeof e=="string"||Array.isArray(e))t={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:{}};else{t=e;const s=(n=t.additional_kwargs)==null?void 0:n.tool_calls,a=t.tool_calls;s!=null&&s.length>0&&(a===void 0||a.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `pnpm install @langchain/anthropic`,","pnpm install @langchain/openai`, etc."].join(" "));try{if(s!=null&&a===void 0){const[i,o]=Qa(s);t.tool_calls=i??[],t.invalid_tool_calls=o??[]}else t.tool_calls=t.tool_calls??[],t.invalid_tool_calls=t.invalid_tool_calls??[]}catch{t.tool_calls=[],t.invalid_tool_calls=[]}if(t.response_metadata!==void 0&&"output_version"in t.response_metadata&&t.response_metadata.output_version==="v1"&&(t.contentBlocks=t.content,t.content=void 0),t.contentBlocks!==void 0){t.contentBlocks.push(...t.tool_calls.map(o=>({type:"tool_call",id:o.id,name:o.name,args:o.args})));const i=t.contentBlocks.filter(o=>o.type==="tool_call").filter(o=>{var c;return!((c=t.tool_calls)!=null&&c.some(u=>u.id===o.id&&u.name===o.name))});i.length>0&&(t.tool_calls=i.map(o=>({type:"tool_call",id:o.id,name:o.name,args:o.args})))}}super(t);y(this,"type","ai");y(this,"tool_calls",[]);y(this,"invalid_tool_calls",[]);y(this,"usage_metadata");typeof t!="string"&&(this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}static lc_name(){return"AIMessage"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const t=du(this.response_metadata.model_provider);if(t)return t.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls){const t=this.tool_calls.filter(n=>!e.some(s=>s.id===n.id&&s.name===n.name));e.push(...t.map(n=>({...n,type:"tool_call",id:n.id,name:n.name,args:n.args})))}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}};function is(r){return r._getType()==="ai"}function ua(r){return r._getType()==="ai"}var Dt=class extends Yt{constructor(e){var n,s;let t;if(typeof e=="string"||Array.isArray(e))t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0||e.tool_call_chunks.length===0)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{const i=(e.tool_call_chunks??[]).reduce((u,l)=>{const d=u.findIndex(([f])=>"id"in l&&l.id&&"index"in l&&l.index!==void 0?l.id===f.id&&l.index===f.index:"id"in l&&l.id?l.id===f.id:"index"in l&&l.index!==void 0?l.index===f.index:!1);return d!==-1?u[d].push(l):u.push([l]),u},[]),o=[],c=[];for(const u of i){let l=null;const d=((n=u[0])==null?void 0:n.name)??"",f=u.map(T=>T.args||"").join(""),h=f.length?f:"{}",m=(s=u[0])==null?void 0:s.id;try{if(l=as(h),!m||l===null||typeof l!="object"||Array.isArray(l))throw new Error("Malformed tool call chunk args.");o.push({name:d,args:l,id:m,type:"tool_call"})}catch{c.push({name:d,args:h,id:m,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:o,invalid_tool_calls:c,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(t);y(this,"type","ai");y(this,"tool_calls",[]);y(this,"invalid_tool_calls",[]);y(this,"tool_call_chunks",[]);y(this,"usage_metadata");this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const t=du(this.response_metadata.model_provider);if(t)return t.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls&&typeof this.content!="string"){const t=this.content.filter(n=>n.type==="tool_call").map(n=>n.id);for(const n of this.tool_calls)n.id&&!t.includes(n.id)&&e.push({...n,type:"tool_call",id:n.id,name:n.name,args:n.args})}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const t={content:Ct(this.content,e.content),additional_kwargs:je(this.additional_kwargs,e.additional_kwargs),response_metadata:fu(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const s=cn(this.tool_call_chunks,e.tool_call_chunks);s!==void 0&&s.length>0&&(t.tool_call_chunks=s)}(this.usage_metadata!==void 0||e.usage_metadata!==void 0)&&(t.usage_metadata=pu(this.usage_metadata,e.usage_metadata));const n=this.constructor;return new n(t)}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}},fr=class _u extends Mt{constructor(t,n){(typeof t=="string"||Array.isArray(t))&&(t={content:t,role:n});super(t);y(this,"type","generic");y(this,"role");this.role=t.role}static lc_name(){return"ChatMessage"}static _chatMessageClass(){return _u}static isInstance(t){return super.isInstance(t)&&t.type==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},ln=class extends Yt{constructor(e,t){(typeof e=="string"||Array.isArray(e))&&(e={content:e,role:t});super(e);y(this,"type","generic");y(this,"role");this.role=e.role}static lc_name(){return"ChatMessageChunk"}concat(e){const t=this.constructor;return new t({content:Ct(this.content,e.content),additional_kwargs:je(this.additional_kwargs,e.additional_kwargs),response_metadata:je(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}};function Kp(r){return r._getType()==="generic"}function Xp(r){return r._getType()==="generic"}var os=class extends Mt{constructor(e){super(e);y(this,"type","function");y(this,"name");this.name=e.name}static lc_name(){return"FunctionMessage"}},dn=class extends Yt{constructor(){super(...arguments);y(this,"type","function")}static lc_name(){return"FunctionMessageChunk"}concat(e){const t=this.constructor;return new t({content:Ct(this.content,e.content),additional_kwargs:je(this.additional_kwargs,e.additional_kwargs),response_metadata:je(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}};function Yp(r){return r._getType()==="function"}function Qp(r){return r._getType()==="function"}var xt=class extends Mt{constructor(e){super(e);y(this,"type","human")}static lc_name(){return"HumanMessage"}static isInstance(e){return super.isInstance(e)&&e.type==="human"}},fn=class extends Yt{constructor(e){super(e);y(this,"type","human")}static lc_name(){return"HumanMessageChunk"}concat(e){const t=this.constructor;return new t({content:Ct(this.content,e.content),additional_kwargs:je(this.additional_kwargs,e.additional_kwargs),response_metadata:je(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="human"}};function em(r){return r.getType()==="human"}function tm(r){return r.getType()==="human"}var Pt=class Dn extends Mt{constructor(t){super(t);y(this,"type","system")}static lc_name(){return"SystemMessage"}concat(t){if(typeof t=="string")return new Dn({...this,content:Ct(this.content,t)});if(Dn.isInstance(t))return new Dn({...this,additional_kwargs:{...this.additional_kwargs,...t.additional_kwargs},response_metadata:{...this.response_metadata,...t.response_metadata},content:Ct(this.content,t.content)});throw new Error("Unexpected chunk type for system message")}static isInstance(t){return super.isInstance(t)&&t.type==="system"}},Xt=class extends Yt{constructor(e){super(e);y(this,"type","system")}static lc_name(){return"SystemMessageChunk"}concat(e){const t=this.constructor;return new t({content:Ct(this.content,e.content),additional_kwargs:je(this.additional_kwargs,e.additional_kwargs),response_metadata:je(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="system"}};function rm(r){return r._getType()==="system"}function nm(r){return r._getType()==="system"}function wu(r,e){return r.lc_error_code=e,r.message=`${r.message}

Troubleshooting URL: https://docs.langchain.com/oss/javascript/langchain/errors/${e}/
`,r}function vu(r){return!!(r&&typeof r=="object"&&"type"in r&&r.type==="tool_call")}var sm=class extends Error{constructor(e,t){super(e);y(this,"output");this.output=t}},Zn=class extends Mt{constructor(e){super({...e,content:[]});y(this,"type","remove");y(this,"id");this.id=e.id}get _printableFields(){return{...super._printableFields,id:this.id}}static isInstance(e){return super.isInstance(e)&&e.type==="remove"}};const am=r=>r();function im(r){return vu(r)?r:typeof r.id=="string"&&r.type==="function"&&typeof r.function=="object"&&r.function!==null&&"arguments"in r.function&&typeof r.function.arguments=="string"&&"name"in r.function&&typeof r.function.name=="string"?{id:r.id,args:JSON.parse(r.function.arguments),name:r.function.name,type:"tool_call"}:r}function om(r){return typeof r=="object"&&r!=null&&r.lc===1&&Array.isArray(r.id)&&r.kwargs!=null&&typeof r.kwargs=="object"}function Os(r){let e,t;if(om(r)){const n=r.id.at(-1);n==="HumanMessage"||n==="HumanMessageChunk"?e="user":n==="AIMessage"||n==="AIMessageChunk"?e="assistant":n==="SystemMessage"||n==="SystemMessageChunk"?e="system":n==="FunctionMessage"||n==="FunctionMessageChunk"?e="function":n==="ToolMessage"||n==="ToolMessageChunk"?e="tool":e="unknown",t=r.kwargs}else{const{type:n,...s}=r;e=n,t=s}if(e==="human"||e==="user")return new xt(t);if(e==="ai"||e==="assistant"){const{tool_calls:n,...s}=t;if(!Array.isArray(n))return new Nt(t);const a=n.map(im);return new Nt({...s,tool_calls:a})}else{if(e==="system")return new Pt(t);if(e==="developer")return new Pt({...t,additional_kwargs:{...t.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in t)return new Nr({...t,content:t.content,tool_call_id:t.tool_call_id,name:t.name});if(e==="remove"&&"id"in t&&typeof t.id=="string")return new Zn({...t,id:t.id});throw wu(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(r,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function Vr(r){if(typeof r=="string")return new xt(r);if(qt(r))return r;if(Array.isArray(r)){const[e,t]=r;return Os({type:e,content:t})}else if(lu(r)){const{role:e,...t}=r;return Os({...t,type:e})}else return Os(r)}function ei(r,e="Human",t="AI"){const n=[];for(const s of r){let a;if(s._getType()==="human")a=e;else if(s._getType()==="ai")a=t;else if(s._getType()==="system")a="System";else if(s._getType()==="tool")a="Tool";else if(s._getType()==="generic")a=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);const i=s.name?`${s.name}, `:"",o=typeof s.content=="string"?s.content:JSON.stringify(s.content,null,2);n.push(`${a}: ${i}${o}`)}return n.join(`
`)}function cm(r){if(r.data!==void 0)return r;{const e=r;return{type:e.type,data:{content:e.text,role:e.role,name:void 0,tool_call_id:void 0}}}}function ti(r){const e=cm(r);switch(e.type){case"human":return new xt(e.data);case"ai":return new Nt(e.data);case"system":return new Pt(e.data);case"function":if(e.data.name===void 0)throw new Error("Name must be defined for function messages");return new os(e.data);case"tool":if(e.data.tool_call_id===void 0)throw new Error("Tool call ID must be defined for tool messages");return new Nr(e.data);case"generic":if(e.data.role===void 0)throw new Error("Role must be defined for chat messages");return new fr(e.data);default:throw new Error(`Got unexpected type: ${e.type}`)}}function um(r){return r.map(ti)}function lm(r){return r.map(e=>e.toDict())}function Jn(r){var t;const e=r._getType();if(e==="human")return new fn({...r});if(e==="ai"){let n={...r};return"tool_calls"in n&&(n={...n,tool_call_chunks:(t=n.tool_calls)==null?void 0:t.map(s=>({...s,type:"tool_call_chunk",index:void 0,args:JSON.stringify(s.args)}))}),new Dt({...n})}else{if(e==="system")return new Xt({...r});if(e==="function")return new dn({...r});if(fr.isInstance(r))return new ln({...r});throw new Error("Unknown message type.")}}var As={},dm={};he(dm,{getEnv:()=>xu,getEnvironmentVariable:()=>Ot,getRuntimeEnvironment:()=>Iu,isBrowser:()=>bu,isDeno:()=>cs,isJsDom:()=>Tu,isNode:()=>Su,isWebWorker:()=>Eu});const bu=()=>typeof window<"u"&&typeof window.document<"u",Eu=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Tu=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),cs=()=>typeof Deno<"u",Su=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!cs(),xu=()=>{let r;return bu()?r="browser":Su()?r="node":Eu()?r="webworker":Tu()?r="jsdom":cs()?r="deno":r="other",r};let ks;function Iu(){return ks===void 0&&(ks={library:"langchain-js",runtime:xu()}),ks}function Ot(r){try{return typeof process<"u"?As==null?void 0:As[r]:cs()?Deno==null?void 0:Deno.env.get(r):void 0}catch{return}}const fm=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function Zr(r){return typeof r=="string"&&fm.test(r)}function hm(r){if(!Zr(r))throw TypeError("Invalid UUID");var e,t=new Uint8Array(16);return t[0]=(e=parseInt(r.slice(0,8),16))>>>24,t[1]=e>>>16&255,t[2]=e>>>8&255,t[3]=e&255,t[4]=(e=parseInt(r.slice(9,13),16))>>>8,t[5]=e&255,t[6]=(e=parseInt(r.slice(14,18),16))>>>8,t[7]=e&255,t[8]=(e=parseInt(r.slice(19,23),16))>>>8,t[9]=e&255,t[10]=(e=parseInt(r.slice(24,36),16))/1099511627776&255,t[11]=e/4294967296&255,t[12]=e>>>24&255,t[13]=e>>>16&255,t[14]=e>>>8&255,t[15]=e&255,t}var Le=[];for(var Rs=0;Rs<256;++Rs)Le.push((Rs+256).toString(16).slice(1));function ri(r,e=0){return(Le[r[e+0]]+Le[r[e+1]]+Le[r[e+2]]+Le[r[e+3]]+"-"+Le[r[e+4]]+Le[r[e+5]]+"-"+Le[r[e+6]]+Le[r[e+7]]+"-"+Le[r[e+8]]+Le[r[e+9]]+"-"+Le[r[e+10]]+Le[r[e+11]]+Le[r[e+12]]+Le[r[e+13]]+Le[r[e+14]]+Le[r[e+15]]).toLowerCase()}var Tn,pm=new Uint8Array(16);function Ou(){if(!Tn&&(Tn=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Tn))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Tn(pm)}function mm(r){r=unescape(encodeURIComponent(r));for(var e=[],t=0;t<r.length;++t)e.push(r.charCodeAt(t));return e}var gm="6ba7b810-9dad-11d1-80b4-00c04fd430c8",ym="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function _m(r,e,t){function n(s,a,i,o){var c;if(typeof s=="string"&&(s=mm(s)),typeof a=="string"&&(a=hm(a)),((c=a)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var u=new Uint8Array(16+s.length);if(u.set(a),u.set(s,a.length),u=t(u),u[6]=u[6]&15|e,u[8]=u[8]&63|128,i){o=o||0;for(var l=0;l<16;++l)i[o+l]=u[l];return i}return ri(u)}try{n.name=r}catch{}return n.DNS=gm,n.URL=ym,n}var wm=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const po={randomUUID:wm};function Ve(r,e,t){if(po.randomUUID&&!e&&!r)return po.randomUUID();r=r||{};var n=r.random||(r.rng||Ou)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,ri(n)}function vm(r,e,t,n){switch(r){case 0:return e&t^~e&n;case 1:return e^t^n;case 2:return e&t^e&n^t&n;case 3:return e^t^n}}function $s(r,e){return r<<e|r>>>32-e}function bm(r){var e=[1518500249,1859775393,2400959708,3395469782],t=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof r=="string"){var n=unescape(encodeURIComponent(r));r=[];for(var s=0;s<n.length;++s)r.push(n.charCodeAt(s))}else Array.isArray(r)||(r=Array.prototype.slice.call(r));r.push(128);for(var a=r.length/4+2,i=Math.ceil(a/16),o=new Array(i),c=0;c<i;++c){for(var u=new Uint32Array(16),l=0;l<16;++l)u[l]=r[c*64+l*4]<<24|r[c*64+l*4+1]<<16|r[c*64+l*4+2]<<8|r[c*64+l*4+3];o[c]=u}o[i-1][14]=(r.length-1)*8/Math.pow(2,32),o[i-1][14]=Math.floor(o[i-1][14]),o[i-1][15]=(r.length-1)*8&4294967295;for(var d=0;d<i;++d){for(var f=new Uint32Array(80),h=0;h<16;++h)f[h]=o[d][h];for(var m=16;m<80;++m)f[m]=$s(f[m-3]^f[m-8]^f[m-14]^f[m-16],1);for(var T=t[0],w=t[1],_=t[2],b=t[3],v=t[4],O=0;O<80;++O){var x=Math.floor(O/20),A=$s(T,5)+vm(x,w,_,b)+v+e[x]+f[O]>>>0;v=b,b=_,_=$s(w,30)>>>0,w=T,T=A}t[0]=t[0]+T>>>0,t[1]=t[1]+w>>>0,t[2]=t[2]+_>>>0,t[3]=t[3]+b>>>0,t[4]=t[4]+v>>>0}return[t[0]>>24&255,t[0]>>16&255,t[0]>>8&255,t[0]&255,t[1]>>24&255,t[1]>>16&255,t[1]>>8&255,t[1]&255,t[2]>>24&255,t[2]>>16&255,t[2]>>8&255,t[2]&255,t[3]>>24&255,t[3]>>16&255,t[3]>>8&255,t[3]&255,t[4]>>24&255,t[4]>>16&255,t[4]>>8&255,t[4]&255]}var Br=_m("v5",80,bm),mo=null,go=null,it=0;function Em(r,e,t){r=r||{};var n=e&&t||0,s=e||new Uint8Array(16),a=r.random||(r.rng||Ou)(),i=r.msecs!==void 0?r.msecs:Date.now(),o=r.seq!==void 0?r.seq:null,c=go,u=mo;return i>it&&r.msecs===void 0&&(it=i,o!==null&&(c=null,u=null)),o!==null&&(o>2147483647&&(o=2147483647),c=o>>>19&4095,u=o&524287),(c===null||u===null)&&(c=a[6]&127,c=c<<8|a[7],u=a[8]&63,u=u<<8|a[9],u=u<<5|a[10]>>>3),i+1e4>it&&o===null?++u>524287&&(u=0,++c>4095&&(c=0,it++)):it=i,go=c,mo=u,s[n++]=it/1099511627776&255,s[n++]=it/4294967296&255,s[n++]=it/16777216&255,s[n++]=it/65536&255,s[n++]=it/256&255,s[n++]=it&255,s[n++]=c>>>4&15|112,s[n++]=c&255,s[n++]=u>>>13&63|128,s[n++]=u>>>5&255,s[n++]=u<<3&255|a[10]&7,s[n++]=a[11],s[n++]=a[12],s[n++]=a[13],s[n++]=a[14],s[n++]=a[15],e||ri(s)}var Tm={};he(Tm,{BaseCallbackHandler:()=>hn,callbackHandlerPrefersStreaming:()=>Au,isBaseCallbackHandler:()=>ku});var Sm=class{};function Au(r){return"lc_prefer_streaming"in r&&r.lc_prefer_streaming}var hn=class extends Sm{constructor(e){super();y(this,"lc_serializable",!1);y(this,"lc_kwargs");y(this,"ignoreLLM",!1);y(this,"ignoreChain",!1);y(this,"ignoreAgent",!1);y(this,"ignoreRetriever",!1);y(this,"ignoreCustomEvent",!1);y(this,"raiseError",!1);y(this,"awaitHandlers",Ot("LANGCHAIN_CALLBACKS_BACKGROUND")==="false");this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Ja(this.constructor)]}copy(){return new this.constructor(this)}toJSON(){return Ar.prototype.toJSON.call(this)}toJSONNotImplemented(){return Ar.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends hn{constructor(){super();y(this,"name",Ve());Object.assign(this,e)}}return new t}};const ku=r=>{const e=r;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"},xm="gen_ai.operation.name",Im="gen_ai.system",yo="gen_ai.request.model",Om="gen_ai.response.model",_o="gen_ai.usage.input_tokens",wo="gen_ai.usage.output_tokens",vo="gen_ai.usage.total_tokens",Am="gen_ai.request.max_tokens",km="gen_ai.request.temperature",Rm="gen_ai.request.top_p",$m="gen_ai.request.frequency_penalty",Cm="gen_ai.request.presence_penalty",Nm="gen_ai.response.finish_reasons",Pm="gen_ai.prompt",Lm="gen_ai.completion",jm="gen_ai.request.extra_query",Mm="gen_ai.request.extra_body",Dm="gen_ai.serialized.name",Um="gen_ai.serialized.signature",Fm="gen_ai.serialized.doc",Bm="gen_ai.response.id",zm="gen_ai.response.service_tier",Gm="gen_ai.response.system_fingerprint",qm="gen_ai.usage.input_token_details",Hm="gen_ai.usage.output_token_details",Vm="langsmith.trace.session_id",Zm="langsmith.trace.session_name",Jm="langsmith.span.kind",Wm="langsmith.trace.name",Km="langsmith.metadata",bo="langsmith.span.tags",Xm="langsmith.request.streaming",Ym="langsmith.request.headers",Qm=(...r)=>fetch(...r),Ru=Symbol.for("ls:fetch_implementation"),eg=()=>{const r=globalThis[Ru];return r?typeof r=="function"&&"Headers"in r&&"Request"in r&&"Response"in r:!1},tg=r=>async(...e)=>{if(r||Ze("DEBUG")==="true"){const[n,s]=e;console.log(` ${(s==null?void 0:s.method)||"GET"} ${n}`)}const t=await(globalThis[Ru]??Qm)(...e);return(r||Ze("DEBUG")==="true")&&console.log(` ${t.status} ${t.statusText} ${t.url}`),t},$u=()=>Ze("PROJECT")??St("LANGCHAIN_SESSION")??"default",Eo={};function la(r){Eo[r]||(console.warn(r),Eo[r]=!0)}const rg=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function re(r,e){if(!rg.test(r)){const t=e!==void 0?`Invalid UUID for ${e}: ${r}`:`Invalid UUID: ${r}`;throw new Error(t)}return r}function ng(r){const e=typeof r=="string"?Date.parse(r):r;return Em({msecs:e,seq:0})}const Cu="0.3.82";var Jr={};let _t;const sg=()=>typeof window<"u"&&typeof window.document<"u",ag=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",ig=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),Nu=()=>typeof Deno<"u",og=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Nu(),Pu=()=>_t||(typeof Bun<"u"?_t="bun":sg()?_t="browser":og()?_t="node":ag()?_t="webworker":ig()?_t="jsdom":Nu()?_t="deno":_t="other",_t);let Cs;function Lu(){if(Cs===void 0){const r=Pu(),e=ug();Cs={library:"langsmith",runtime:r,sdk:"langsmith-js",sdk_version:Cu,...e}}return Cs}function ju(){const r=cg(),e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[n,s]of Object.entries(r))typeof s=="string"&&!t.includes(n)&&!n.toLowerCase().includes("key")&&!n.toLowerCase().includes("secret")&&!n.toLowerCase().includes("token")&&(n==="LANGCHAIN_REVISION_ID"?e.revision_id=s:e[n]=s);return e}function cg(){const r={};try{if(typeof process<"u"&&Jr)for(const[e,t]of Object.entries(Jr))(e.startsWith("LANGCHAIN_")||e.startsWith("LANGSMITH_"))&&t!=null&&((e.toLowerCase().includes("key")||e.toLowerCase().includes("secret")||e.toLowerCase().includes("token"))&&typeof t=="string"?r[e]=t.slice(0,2)+"*".repeat(t.length-4)+t.slice(-2):r[e]=t)}catch{}return r}function St(r){try{return typeof process<"u"?Jr==null?void 0:Jr[r]:void 0}catch{return}}function Ze(r){return St(`LANGSMITH_${r}`)||St(`LANGCHAIN_${r}`)}let Ns;function ug(){if(Ns!==void 0)return Ns;const r=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const t of r){const n=St(t);n!==void 0&&(e[t]=n)}return Ns=e,e}function Mu(){return St("OTEL_ENABLED")==="true"||Ze("OTEL_ENABLED")==="true"}class lg{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...t){!this.hasWarned&&Mu()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0);let n;if(t.length===1&&typeof t[0]=="function"?n=t[0]:t.length===2&&typeof t[1]=="function"?n=t[1]:t.length===3&&typeof t[2]=="function"&&(n=t[2]),typeof n=="function")return n()}}class dg{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new lg})}getTracer(e,t){return this.mockTracer}getActiveSpan(){}setSpan(e,t){return e}getSpan(e){}setSpanContext(e,t){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}}class fg{active(){return{}}with(e,t){return t()}}const Ps=Symbol.for("ls:otel_trace"),Ls=Symbol.for("ls:otel_context"),To=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),hg=new dg,pg=new fg;class mg{getTraceInstance(){return globalThis[Ps]??hg}getContextInstance(){return globalThis[Ls]??pg}initializeGlobalInstances(e){globalThis[Ps]===void 0&&(globalThis[Ps]=e.trace),globalThis[Ls]===void 0&&(globalThis[Ls]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[To]=e}getDefaultOTLPTracerComponents(){return globalThis[To]??void 0}}const ni=new mg;function Du(){return ni.getTraceInstance()}function gg(){return ni.getContextInstance()}function yg(){return ni.getDefaultOTLPTracerComponents()}const _g={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};function wg(r){return _g[r]||r}class vg{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,t){for(const n of e)try{if(!n.run)continue;if(n.operation==="post"){const s=this.createSpanForRun(n,n.run,t.get(n.id));s&&!n.run.end_time&&this.spans.set(n.id,s)}else this.updateSpanForRun(n,n.run)}catch(s){console.error(`Error processing operation ${n.id}:`,s)}}createSpanForRun(e,t,n){const s=n&&Du().getSpan(n);if(s)try{return this.finishSpanSetup(s,t,e)}catch(a){console.error(`Failed to create span for run ${e.id}:`,a);return}}finishSpanSetup(e,t,n){return this.setSpanAttributes(e,t,n),t.error?(e.setStatus({code:2}),e.recordException(new Error(t.error))):e.setStatus({code:1}),t.end_time&&e.end(new Date(t.end_time)),e}updateSpanForRun(e,t){try{const n=this.spans.get(e.id);if(!n){console.debug(`No span found for run ${e.id} during update`);return}this.setSpanAttributes(n,t,e),t.error?(n.setStatus({code:2}),n.recordException(new Error(t.error))):n.setStatus({code:1});const s=t.end_time;s&&(n.end(new Date(s)),this.spans.delete(e.id))}catch(n){console.error(`Failed to update span for run ${e.id}:`,n)}}extractModelName(e){var t;if((t=e.extra)!=null&&t.metadata){const n=e.extra.metadata;if(n.ls_model_name)return n.ls_model_name;if(n.invocation_params){const s=n.invocation_params;if(s.model)return s.model;if(s.model_name)return s.model_name}}}setSpanAttributes(e,t,n){var o;if("run_type"in t&&t.run_type){e.setAttribute(Jm,t.run_type);const c=wg(t.run_type||"chain");e.setAttribute(xm,c)}"name"in t&&t.name&&e.setAttribute(Wm,t.name),"session_id"in t&&t.session_id&&e.setAttribute(Vm,t.session_id),"session_name"in t&&t.session_name&&e.setAttribute(Zm,t.session_name),this.setGenAiSystem(e,t);const s=this.extractModelName(t);s&&e.setAttribute(yo,s),"prompt_tokens"in t&&typeof t.prompt_tokens=="number"&&e.setAttribute(_o,t.prompt_tokens),"completion_tokens"in t&&typeof t.completion_tokens=="number"&&e.setAttribute(wo,t.completion_tokens),"total_tokens"in t&&typeof t.total_tokens=="number"&&e.setAttribute(vo,t.total_tokens),this.setInvocationParameters(e,t);const a=((o=t.extra)==null?void 0:o.metadata)||{};for(const[c,u]of Object.entries(a))u!=null&&e.setAttribute(`${Km}.${c}`,String(u));const i=t.tags;if(i&&Array.isArray(i)?e.setAttribute(bo,i.join(", ")):i&&e.setAttribute(bo,String(i)),"serialized"in t&&typeof t.serialized=="object"){const c=t.serialized;c.name&&e.setAttribute(Dm,String(c.name)),c.signature&&e.setAttribute(Um,String(c.signature)),c.doc&&e.setAttribute(Fm,String(c.doc))}this.setIOAttributes(e,n)}setGenAiSystem(e,t){let n="langchain";const s=this.extractModelName(t);if(s){const a=s.toLowerCase();a.includes("anthropic")||a.startsWith("claude")?n="anthropic":a.includes("bedrock")?n="aws.bedrock":a.includes("azure")&&a.includes("openai")?n="az.ai.openai":a.includes("azure")&&a.includes("inference")?n="az.ai.inference":a.includes("cohere")?n="cohere":a.includes("deepseek")?n="deepseek":a.includes("gemini")?n="gemini":a.includes("groq")?n="groq":a.includes("watson")||a.includes("ibm")?n="ibm.watsonx.ai":a.includes("mistral")?n="mistral_ai":a.includes("gpt")||a.includes("openai")?n="openai":a.includes("perplexity")||a.includes("sonar")?n="perplexity":a.includes("vertex")?n="vertex_ai":(a.includes("xai")||a.includes("grok"))&&(n="xai")}e.setAttribute(Im,n)}setInvocationParameters(e,t){var s,a;if(!((a=(s=t.extra)==null?void 0:s.metadata)!=null&&a.invocation_params))return;const n=t.extra.metadata.invocation_params;n.max_tokens!==void 0&&e.setAttribute(Am,n.max_tokens),n.temperature!==void 0&&e.setAttribute(km,n.temperature),n.top_p!==void 0&&e.setAttribute(Rm,n.top_p),n.frequency_penalty!==void 0&&e.setAttribute($m,n.frequency_penalty),n.presence_penalty!==void 0&&e.setAttribute(Cm,n.presence_penalty)}setIOAttributes(e,t){if(t.run.inputs)try{const n=t.run.inputs;typeof n=="object"&&n!==null&&(n.model&&Array.isArray(n.messages)&&e.setAttribute(yo,n.model),n.stream!==void 0&&e.setAttribute(Xm,n.stream),n.extra_headers&&e.setAttribute(Ym,JSON.stringify(n.extra_headers)),n.extra_query&&e.setAttribute(jm,JSON.stringify(n.extra_query)),n.extra_body&&e.setAttribute(Mm,JSON.stringify(n.extra_body))),e.setAttribute(Pm,JSON.stringify(n))}catch(n){console.debug(`Failed to process inputs for run ${t.id}`,n)}if(t.run.outputs)try{const n=t.run.outputs,s=this.getUnifiedRunTokens(n);if(s&&(e.setAttribute(_o,s[0]),e.setAttribute(wo,s[1]),e.setAttribute(vo,s[0]+s[1])),n&&typeof n=="object"){if(n.model&&e.setAttribute(Om,String(n.model)),n.id&&e.setAttribute(Bm,n.id),n.choices&&Array.isArray(n.choices)){const a=n.choices.map(i=>i.finish_reason).filter(i=>i).map(String);a.length>0&&e.setAttribute(Nm,a.join(", "))}if(n.service_tier&&e.setAttribute(zm,n.service_tier),n.system_fingerprint&&e.setAttribute(Gm,n.system_fingerprint),n.usage_metadata&&typeof n.usage_metadata=="object"){const a=n.usage_metadata;a.input_token_details&&e.setAttribute(qm,JSON.stringify(a.input_token_details)),a.output_token_details&&e.setAttribute(Hm,JSON.stringify(a.output_token_details))}}e.setAttribute(Lm,JSON.stringify(n))}catch(n){console.debug(`Failed to process outputs for run ${t.id}`,n)}}getUnifiedRunTokens(e){if(!e)return null;let t=this.extractUnifiedRunTokens(e.usage_metadata);if(t)return t;const n=Object.keys(e);for(const i of n){const o=e[i];if(!(!o||typeof o!="object")&&(t=this.extractUnifiedRunTokens(o.usage_metadata),t||o.lc===1&&o.kwargs&&typeof o.kwargs=="object"&&(t=this.extractUnifiedRunTokens(o.kwargs.usage_metadata),t)))return t}const s=e.generations||[];if(!Array.isArray(s))return null;const a=Array.isArray(s[0])?s.flat():s;for(const i of a)if(typeof i=="object"&&i.message&&typeof i.message=="object"&&i.message.kwargs&&typeof i.message.kwargs=="object"&&(t=this.extractUnifiedRunTokens(i.message.kwargs.usage_metadata),t))return t;return null}extractUnifiedRunTokens(e){return!e||typeof e!="object"||typeof e.input_tokens!="number"||typeof e.output_tokens!="number"?null:[e.input_tokens,e.output_tokens]}}const bg=Object.prototype.toString,Eg=r=>bg.call(r)==="[object Error]",Tg=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function Sg(r){if(!(r&&Eg(r)&&r.name==="TypeError"&&typeof r.message=="string"))return!1;const{message:t,stack:n}=r;return t==="Load failed"?n===void 0||"__sentry_captured__"in r:t.startsWith("error sending request for url")?!0:Tg.has(t)}function xg(r){if(typeof r=="number"){if(r<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(r))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(r!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function Sn(r,e,{min:t=0,allowInfinity:n=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${r}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(e))throw new TypeError(`Expected \`${r}\` to be a finite number.`);if(e<t)throw new TypeError(`Expected \`${r}\` to be  ${t}.`)}}let Ig=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}};function Og(r,e){const t=Math.max(1,r+1),n=e.randomize?Math.random()+1:1;let s=Math.round(n*e.minTimeout*e.factor**(t-1));return s=Math.min(s,e.maxTimeout),s}function So(r,e){return Number.isFinite(e)?e-(performance.now()-r):e}async function Ag({error:r,attemptNumber:e,retriesConsumed:t,startTime:n,options:s}){var h,m,T;const a=r instanceof Error?r:new TypeError(`Non-error was thrown: "${r}". You should only throw errors.`);if(a instanceof Ig)throw a.originalError;const i=Number.isFinite(s.retries)?Math.max(0,s.retries-t):s.retries,o=s.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:a,attemptNumber:e,retriesLeft:i,retriesConsumed:t});if(await s.onFailedAttempt(c),So(n,o)<=0)throw a;const u=await s.shouldConsumeRetry(c),l=So(n,o);if(l<=0||i<=0)throw a;if(a instanceof TypeError&&!Sg(a)){if(u)throw a;return(h=s.signal)==null||h.throwIfAborted(),!1}if(!await s.shouldRetry(c))throw a;if(!u)return(m=s.signal)==null||m.throwIfAborted(),!1;const d=Og(t,s),f=Math.min(d,l);return f>0&&await new Promise((w,_)=>{var O,x;const b=()=>{var A;clearTimeout(v),(A=s.signal)==null||A.removeEventListener("abort",b),_(s.signal.reason)},v=setTimeout(()=>{var A;(A=s.signal)==null||A.removeEventListener("abort",b),w()},f);s.unref&&((O=v.unref)==null||O.call(v)),(x=s.signal)==null||x.addEventListener("abort",b,{once:!0})}),(T=s.signal)==null||T.throwIfAborted(),!0}async function kg(r,e={}){var a,i,o;if(e={...e},xg(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??(e.retries=10),e.factor??(e.factor=2),e.minTimeout??(e.minTimeout=1e3),e.maxTimeout??(e.maxTimeout=Number.POSITIVE_INFINITY),e.maxRetryTime??(e.maxRetryTime=Number.POSITIVE_INFINITY),e.randomize??(e.randomize=!1),e.onFailedAttempt??(e.onFailedAttempt=()=>{}),e.shouldRetry??(e.shouldRetry=()=>!0),e.shouldConsumeRetry??(e.shouldConsumeRetry=()=>!0),Sn("factor",e.factor,{min:0,allowInfinity:!1}),Sn("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),Sn("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),Sn("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),(a=e.signal)==null||a.throwIfAborted();let t=0,n=0;const s=performance.now();for(;!Number.isFinite(e.retries)||n<=e.retries;){t++;try{(i=e.signal)==null||i.throwIfAborted();const c=await r(t);return(o=e.signal)==null||o.throwIfAborted(),c}catch(c){await Ag({error:c,attemptNumber:t,retriesConsumed:n,startTime:s,options:e})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}var Uu={},us={exports:{}},Rg=(r,e)=>(e=e||(()=>{}),r.then(t=>new Promise(n=>{n(e())}).then(()=>t),t=>new Promise(n=>{n(e())}).then(()=>{throw t})));const $g=Rg;class Fu extends Error{constructor(e){super(e),this.name="TimeoutError"}}const Bu=(r,e,t)=>new Promise((n,s)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){n(r);return}const a=setTimeout(()=>{if(typeof t=="function"){try{n(t())}catch(c){s(c)}return}const i=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new Fu(i);typeof r.cancel=="function"&&r.cancel(),s(o)},e);$g(r.then(n,s),()=>{clearTimeout(a)})});us.exports=Bu;us.exports.default=Bu;us.exports.TimeoutError=Fu;var Cg=us.exports,si={},ai={};Object.defineProperty(ai,"__esModule",{value:!0});function Ng(r,e,t){let n=0,s=r.length;for(;s>0;){const a=s/2|0;let i=n+a;t(r[i],e)<=0?(n=++i,s-=a+1):s=a}return n}ai.default=Ng;Object.defineProperty(si,"__esModule",{value:!0});const Pg=ai;class Lg{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);const n={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(n);return}const s=Pg.default(this._queue,n,(a,i)=>i.priority-a.priority);this._queue.splice(s,0,n)}dequeue(){const e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}}si.default=Lg;Object.defineProperty(Uu,"__esModule",{value:!0});const jg=Ld,zu=Cg,Mg=si,xn=()=>{},Dg=new zu.TimeoutError;class Ug extends jg{constructor(e){var t,n,s,a;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=xn,this._resolveIdle=xn,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:Mg.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(n=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(a=(s=e.interval)===null||s===void 0?void 0:s.toString())!==null&&a!==void 0?a:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=xn,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=xn,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(this._intervalId===void 0){const t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((n,s)=>{const a=async()=>{this._pendingCount++,this._intervalCount++;try{const i=this._timeout===void 0&&t.timeout===void 0?e():zu.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&s(Dg)});n(await i)}catch(i){s(i)}this._next()};this._queue.enqueue(a,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var At=Uu.default=Ug;const Fg=[408,425,429,500,502,503,504];let xo=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxQueueSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queueSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.maxQueueSizeBytes=e.maxQueueSizeBytes,"default"in At?this.queue=new At.default({concurrency:this.maxConcurrency}):this.queue=new At({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...t){return this.callWithOptions({},e,...t)}callWithOptions(e,t,...n){const s=e.sizeBytes??0;if(this.maxQueueSizeBytes!==void 0&&s>0&&this.queueSizeBytes+s>this.maxQueueSizeBytes)return Promise.reject(new Error(`Queue size limit (${this.maxQueueSizeBytes} bytes) exceeded. Current queue size: ${this.queueSizeBytes} bytes, attempted addition: ${s} bytes.`));s>0&&(this.queueSizeBytes+=s);const a=this.onFailedResponseHook;let i=this.queue.add(()=>kg(()=>t(...n).catch(o=>{throw o instanceof Error?o:new Error(o)}),{async onFailedAttempt({error:o}){if(o.message.startsWith("Cancel")||o.message.startsWith("TimeoutError")||o.name==="TimeoutError"||o.message.startsWith("AbortError")||(o==null?void 0:o.code)==="ECONNABORTED")throw o;const c=o==null?void 0:o.response;if(a&&await a(c))return;const u=(c==null?void 0:c.status)??(o==null?void 0:o.status);if(u&&!Fg.includes(+u))throw o},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0});return s>0&&(i=i.finally(()=>{this.queueSizeBytes-=s})),e.signal?Promise.race([i,new Promise((o,c)=>{var u;(u=e.signal)==null||u.addEventListener("abort",()=>{c(new Error("AbortError"))})})]):i}};function Io(r){return typeof(r==null?void 0:r._getType)=="function"}function Oo(r){const e={type:r._getType(),data:{content:r.content}};return r!=null&&r.additional_kwargs&&Object.keys(r.additional_kwargs).length>0&&(e.data.additional_kwargs={...r.additional_kwargs}),e}var da={exports:{}};const Bg="2.0.0",Gu=256,zg=Number.MAX_SAFE_INTEGER||9007199254740991,Gg=16,qg=Gu-6,Hg=["major","premajor","minor","preminor","patch","prepatch","prerelease"];var ls={MAX_LENGTH:Gu,MAX_SAFE_COMPONENT_LENGTH:Gg,MAX_SAFE_BUILD_LENGTH:qg,MAX_SAFE_INTEGER:zg,RELEASE_TYPES:Hg,SEMVER_SPEC_VERSION:Bg,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},js={};const Vg=typeof process=="object"&&js&&js.NODE_DEBUG&&/\bsemver\b/i.test(js.NODE_DEBUG)?(...r)=>console.error("SEMVER",...r):()=>{};var ds=Vg;(function(r,e){const{MAX_SAFE_COMPONENT_LENGTH:t,MAX_SAFE_BUILD_LENGTH:n,MAX_LENGTH:s}=ls,a=ds;e=r.exports={};const i=e.re=[],o=e.safeRe=[],c=e.src=[],u=e.t={};let l=0;const d="[a-zA-Z0-9-]",f=[["\\s",1],["\\d",s],[d,n]],h=T=>{for(const[w,_]of f)T=T.split(`${w}*`).join(`${w}{0,${_}}`).split(`${w}+`).join(`${w}{1,${_}}`);return T},m=(T,w,_)=>{const b=h(w),v=l++;a(T,v,w),u[T]=v,c[v]=w,i[v]=new RegExp(w,_?"g":void 0),o[v]=new RegExp(b,_?"g":void 0)};m("NUMERICIDENTIFIER","0|[1-9]\\d*"),m("NUMERICIDENTIFIERLOOSE","\\d+"),m("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${d}*`),m("MAINVERSION",`(${c[u.NUMERICIDENTIFIER]})\\.(${c[u.NUMERICIDENTIFIER]})\\.(${c[u.NUMERICIDENTIFIER]})`),m("MAINVERSIONLOOSE",`(${c[u.NUMERICIDENTIFIERLOOSE]})\\.(${c[u.NUMERICIDENTIFIERLOOSE]})\\.(${c[u.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASEIDENTIFIER",`(?:${c[u.NUMERICIDENTIFIER]}|${c[u.NONNUMERICIDENTIFIER]})`),m("PRERELEASEIDENTIFIERLOOSE",`(?:${c[u.NUMERICIDENTIFIERLOOSE]}|${c[u.NONNUMERICIDENTIFIER]})`),m("PRERELEASE",`(?:-(${c[u.PRERELEASEIDENTIFIER]}(?:\\.${c[u.PRERELEASEIDENTIFIER]})*))`),m("PRERELEASELOOSE",`(?:-?(${c[u.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[u.PRERELEASEIDENTIFIERLOOSE]})*))`),m("BUILDIDENTIFIER",`${d}+`),m("BUILD",`(?:\\+(${c[u.BUILDIDENTIFIER]}(?:\\.${c[u.BUILDIDENTIFIER]})*))`),m("FULLPLAIN",`v?${c[u.MAINVERSION]}${c[u.PRERELEASE]}?${c[u.BUILD]}?`),m("FULL",`^${c[u.FULLPLAIN]}$`),m("LOOSEPLAIN",`[v=\\s]*${c[u.MAINVERSIONLOOSE]}${c[u.PRERELEASELOOSE]}?${c[u.BUILD]}?`),m("LOOSE",`^${c[u.LOOSEPLAIN]}$`),m("GTLT","((?:<|>)?=?)"),m("XRANGEIDENTIFIERLOOSE",`${c[u.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),m("XRANGEIDENTIFIER",`${c[u.NUMERICIDENTIFIER]}|x|X|\\*`),m("XRANGEPLAIN",`[v=\\s]*(${c[u.XRANGEIDENTIFIER]})(?:\\.(${c[u.XRANGEIDENTIFIER]})(?:\\.(${c[u.XRANGEIDENTIFIER]})(?:${c[u.PRERELEASE]})?${c[u.BUILD]}?)?)?`),m("XRANGEPLAINLOOSE",`[v=\\s]*(${c[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[u.XRANGEIDENTIFIERLOOSE]})(?:${c[u.PRERELEASELOOSE]})?${c[u.BUILD]}?)?)?`),m("XRANGE",`^${c[u.GTLT]}\\s*${c[u.XRANGEPLAIN]}$`),m("XRANGELOOSE",`^${c[u.GTLT]}\\s*${c[u.XRANGEPLAINLOOSE]}$`),m("COERCEPLAIN",`(^|[^\\d])(\\d{1,${t}})(?:\\.(\\d{1,${t}}))?(?:\\.(\\d{1,${t}}))?`),m("COERCE",`${c[u.COERCEPLAIN]}(?:$|[^\\d])`),m("COERCEFULL",c[u.COERCEPLAIN]+`(?:${c[u.PRERELEASE]})?(?:${c[u.BUILD]})?(?:$|[^\\d])`),m("COERCERTL",c[u.COERCE],!0),m("COERCERTLFULL",c[u.COERCEFULL],!0),m("LONETILDE","(?:~>?)"),m("TILDETRIM",`(\\s*)${c[u.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",m("TILDE",`^${c[u.LONETILDE]}${c[u.XRANGEPLAIN]}$`),m("TILDELOOSE",`^${c[u.LONETILDE]}${c[u.XRANGEPLAINLOOSE]}$`),m("LONECARET","(?:\\^)"),m("CARETTRIM",`(\\s*)${c[u.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",m("CARET",`^${c[u.LONECARET]}${c[u.XRANGEPLAIN]}$`),m("CARETLOOSE",`^${c[u.LONECARET]}${c[u.XRANGEPLAINLOOSE]}$`),m("COMPARATORLOOSE",`^${c[u.GTLT]}\\s*(${c[u.LOOSEPLAIN]})$|^$`),m("COMPARATOR",`^${c[u.GTLT]}\\s*(${c[u.FULLPLAIN]})$|^$`),m("COMPARATORTRIM",`(\\s*)${c[u.GTLT]}\\s*(${c[u.LOOSEPLAIN]}|${c[u.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",m("HYPHENRANGE",`^\\s*(${c[u.XRANGEPLAIN]})\\s+-\\s+(${c[u.XRANGEPLAIN]})\\s*$`),m("HYPHENRANGELOOSE",`^\\s*(${c[u.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[u.XRANGEPLAINLOOSE]})\\s*$`),m("STAR","(<|>)?=?\\s*\\*"),m("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),m("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(da,da.exports);var pn=da.exports;const Zg=Object.freeze({loose:!0}),Jg=Object.freeze({}),Wg=r=>r?typeof r!="object"?Zg:r:Jg;var ii=Wg;const Ao=/^[0-9]+$/,qu=(r,e)=>{const t=Ao.test(r),n=Ao.test(e);return t&&n&&(r=+r,e=+e),r===e?0:t&&!n?-1:n&&!t?1:r<e?-1:1},Kg=(r,e)=>qu(e,r);var Hu={compareIdentifiers:qu,rcompareIdentifiers:Kg};const In=ds,{MAX_LENGTH:ko,MAX_SAFE_INTEGER:On}=ls,{safeRe:Ro,t:$o}=pn,Xg=ii,{compareIdentifiers:mr}=Hu;let Yg=class wt{constructor(e,t){if(t=Xg(t),e instanceof wt){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if(typeof e!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>ko)throw new TypeError(`version is longer than ${ko} characters`);In("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const n=e.trim().match(t.loose?Ro[$o.LOOSE]:Ro[$o.FULL]);if(!n)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+n[1],this.minor=+n[2],this.patch=+n[3],this.major>On||this.major<0)throw new TypeError("Invalid major version");if(this.minor>On||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>On||this.patch<0)throw new TypeError("Invalid patch version");n[4]?this.prerelease=n[4].split(".").map(s=>{if(/^[0-9]+$/.test(s)){const a=+s;if(a>=0&&a<On)return a}return s}):this.prerelease=[],this.build=n[5]?n[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(In("SemVer.compare",this.version,this.options,e),!(e instanceof wt)){if(typeof e=="string"&&e===this.version)return 0;e=new wt(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof wt||(e=new wt(e,this.options)),mr(this.major,e.major)||mr(this.minor,e.minor)||mr(this.patch,e.patch)}comparePre(e){if(e instanceof wt||(e=new wt(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const n=this.prerelease[t],s=e.prerelease[t];if(In("prerelease compare",t,n,s),n===void 0&&s===void 0)return 0;if(s===void 0)return 1;if(n===void 0)return-1;if(n===s)continue;return mr(n,s)}while(++t)}compareBuild(e){e instanceof wt||(e=new wt(e,this.options));let t=0;do{const n=this.build[t],s=e.build[t];if(In("build compare",t,n,s),n===void 0&&s===void 0)return 0;if(s===void 0)return 1;if(n===void 0)return-1;if(n===s)continue;return mr(n,s)}while(++t)}inc(e,t,n){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,n);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,n);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,n),this.inc("pre",t,n);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",t,n),this.inc("pre",t,n);break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const s=Number(n)?1:0;if(!t&&n===!1)throw new Error("invalid increment argument: identifier is empty");if(this.prerelease.length===0)this.prerelease=[s];else{let a=this.prerelease.length;for(;--a>=0;)typeof this.prerelease[a]=="number"&&(this.prerelease[a]++,a=-2);if(a===-1){if(t===this.prerelease.join(".")&&n===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(s)}}if(t){let a=[t,s];n===!1&&(a=[t]),mr(this.prerelease[0],t)===0?isNaN(this.prerelease[1])&&(this.prerelease=a):this.prerelease=a}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};var ze=Yg;const Co=ze,Qg=(r,e,t=!1)=>{if(r instanceof Co)return r;try{return new Co(r,e)}catch(n){if(!t)return null;throw n}};var Pr=Qg;const ey=Pr,ty=(r,e)=>{const t=ey(r,e);return t?t.version:null};var ry=ty;const ny=Pr,sy=(r,e)=>{const t=ny(r.trim().replace(/^[=v]+/,""),e);return t?t.version:null};var ay=sy;const No=ze,iy=(r,e,t,n,s)=>{typeof t=="string"&&(s=n,n=t,t=void 0);try{return new No(r instanceof No?r.version:r,t).inc(e,n,s).version}catch{return null}};var oy=iy;const Po=Pr,cy=(r,e)=>{const t=Po(r,null,!0),n=Po(e,null,!0),s=t.compare(n);if(s===0)return null;const a=s>0,i=a?t:n,o=a?n:t,c=!!i.prerelease.length;if(!!o.prerelease.length&&!c)return!o.patch&&!o.minor?"major":i.patch?"patch":i.minor?"minor":"major";const l=c?"pre":"";return t.major!==n.major?l+"major":t.minor!==n.minor?l+"minor":t.patch!==n.patch?l+"patch":"prerelease"};var uy=cy;const ly=ze,dy=(r,e)=>new ly(r,e).major;var fy=dy;const hy=ze,py=(r,e)=>new hy(r,e).minor;var my=py;const gy=ze,yy=(r,e)=>new gy(r,e).patch;var _y=yy;const wy=Pr,vy=(r,e)=>{const t=wy(r,e);return t&&t.prerelease.length?t.prerelease:null};var by=vy;const Lo=ze,Ey=(r,e,t)=>new Lo(r,t).compare(new Lo(e,t));var pt=Ey;const Ty=pt,Sy=(r,e,t)=>Ty(e,r,t);var xy=Sy;const Iy=pt,Oy=(r,e)=>Iy(r,e,!0);var Ay=Oy;const jo=ze,ky=(r,e,t)=>{const n=new jo(r,t),s=new jo(e,t);return n.compare(s)||n.compareBuild(s)};var oi=ky;const Ry=oi,$y=(r,e)=>r.sort((t,n)=>Ry(t,n,e));var Cy=$y;const Ny=oi,Py=(r,e)=>r.sort((t,n)=>Ny(n,t,e));var Ly=Py;const jy=pt,My=(r,e,t)=>jy(r,e,t)>0;var fs=My;const Dy=pt,Uy=(r,e,t)=>Dy(r,e,t)<0;var ci=Uy;const Fy=pt,By=(r,e,t)=>Fy(r,e,t)===0;var Vu=By;const zy=pt,Gy=(r,e,t)=>zy(r,e,t)!==0;var Zu=Gy;const qy=pt,Hy=(r,e,t)=>qy(r,e,t)>=0;var ui=Hy;const Vy=pt,Zy=(r,e,t)=>Vy(r,e,t)<=0;var li=Zy;const Jy=Vu,Wy=Zu,Ky=fs,Xy=ui,Yy=ci,Qy=li,e_=(r,e,t,n)=>{switch(e){case"===":return typeof r=="object"&&(r=r.version),typeof t=="object"&&(t=t.version),r===t;case"!==":return typeof r=="object"&&(r=r.version),typeof t=="object"&&(t=t.version),r!==t;case"":case"=":case"==":return Jy(r,t,n);case"!=":return Wy(r,t,n);case">":return Ky(r,t,n);case">=":return Xy(r,t,n);case"<":return Yy(r,t,n);case"<=":return Qy(r,t,n);default:throw new TypeError(`Invalid operator: ${e}`)}};var Ju=e_;const t_=ze,r_=Pr,{safeRe:An,t:kn}=pn,n_=(r,e)=>{if(r instanceof t_)return r;if(typeof r=="number"&&(r=String(r)),typeof r!="string")return null;e=e||{};let t=null;if(!e.rtl)t=r.match(e.includePrerelease?An[kn.COERCEFULL]:An[kn.COERCE]);else{const c=e.includePrerelease?An[kn.COERCERTLFULL]:An[kn.COERCERTL];let u;for(;(u=c.exec(r))&&(!t||t.index+t[0].length!==r.length);)(!t||u.index+u[0].length!==t.index+t[0].length)&&(t=u),c.lastIndex=u.index+u[1].length+u[2].length;c.lastIndex=-1}if(t===null)return null;const n=t[2],s=t[3]||"0",a=t[4]||"0",i=e.includePrerelease&&t[5]?`-${t[5]}`:"",o=e.includePrerelease&&t[6]?`+${t[6]}`:"";return r_(`${n}.${s}.${a}${i}${o}`,e)};var s_=n_;class a_{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);if(t!==void 0)return this.map.delete(e),this.map.set(e,t),t}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&t!==void 0){if(this.map.size>=this.max){const s=this.map.keys().next().value;this.delete(s)}this.map.set(e,t)}return this}}var i_=a_,Ms,Mo;function mt(){if(Mo)return Ms;Mo=1;const r=/\s+/g;class e{constructor($,C){if(C=s(C),$ instanceof e)return $.loose===!!C.loose&&$.includePrerelease===!!C.includePrerelease?$:new e($.raw,C);if($ instanceof a)return this.raw=$.value,this.set=[[$]],this.formatted=void 0,this;if(this.options=C,this.loose=!!C.loose,this.includePrerelease=!!C.includePrerelease,this.raw=$.trim().replace(r," "),this.set=this.raw.split("||").map(G=>this.parseRange(G.trim())).filter(G=>G.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const G=this.set[0];if(this.set=this.set.filter(H=>!T(H[0])),this.set.length===0)this.set=[G];else if(this.set.length>1){for(const H of this.set)if(H.length===1&&w(H[0])){this.set=[H];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let $=0;$<this.set.length;$++){$>0&&(this.formatted+="||");const C=this.set[$];for(let G=0;G<C.length;G++)G>0&&(this.formatted+=" "),this.formatted+=C[G].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange($){const G=((this.options.includePrerelease&&h)|(this.options.loose&&m))+":"+$,H=n.get(G);if(H)return H;const B=this.options.loose,W=B?c[u.HYPHENRANGELOOSE]:c[u.HYPHENRANGE];$=$.replace(W,De(this.options.includePrerelease)),i("hyphen replace",$),$=$.replace(c[u.COMPARATORTRIM],l),i("comparator trim",$),$=$.replace(c[u.TILDETRIM],d),i("tilde trim",$),$=$.replace(c[u.CARETTRIM],f),i("caret trim",$);let se=$.split(" ").map(ue=>b(ue,this.options)).join(" ").split(/\s+/).map(ue=>ce(ue,this.options));B&&(se=se.filter(ue=>(i("loose invalid filter",ue,this.options),!!ue.match(c[u.COMPARATORLOOSE])))),i("range list",se);const ne=new Map,pe=se.map(ue=>new a(ue,this.options));for(const ue of pe){if(T(ue))return[ue];ne.set(ue.value,ue)}ne.size>1&&ne.has("")&&ne.delete("");const Re=[...ne.values()];return n.set(G,Re),Re}intersects($,C){if(!($ instanceof e))throw new TypeError("a Range is required");return this.set.some(G=>_(G,C)&&$.set.some(H=>_(H,C)&&G.every(B=>H.every(W=>B.intersects(W,C)))))}test($){if(!$)return!1;if(typeof $=="string")try{$=new o($,this.options)}catch{return!1}for(let C=0;C<this.set.length;C++)if(er(this.set[C],$,this.options))return!0;return!1}}Ms=e;const t=i_,n=new t,s=ii,a=hs(),i=ds,o=ze,{safeRe:c,t:u,comparatorTrimReplace:l,tildeTrimReplace:d,caretTrimReplace:f}=pn,{FLAG_INCLUDE_PRERELEASE:h,FLAG_LOOSE:m}=ls,T=P=>P.value==="<0.0.0-0",w=P=>P.value==="",_=(P,$)=>{let C=!0;const G=P.slice();let H=G.pop();for(;C&&G.length;)C=G.every(B=>H.intersects(B,$)),H=G.pop();return C},b=(P,$)=>(i("comp",P,$),P=A(P,$),i("caret",P),P=O(P,$),i("tildes",P),P=E(P,$),i("xrange",P),P=xe(P,$),i("stars",P),P),v=P=>!P||P.toLowerCase()==="x"||P==="*",O=(P,$)=>P.trim().split(/\s+/).map(C=>x(C,$)).join(" "),x=(P,$)=>{const C=$.loose?c[u.TILDELOOSE]:c[u.TILDE];return P.replace(C,(G,H,B,W,se)=>{i("tilde",P,G,H,B,W,se);let ne;return v(H)?ne="":v(B)?ne=`>=${H}.0.0 <${+H+1}.0.0-0`:v(W)?ne=`>=${H}.${B}.0 <${H}.${+B+1}.0-0`:se?(i("replaceTilde pr",se),ne=`>=${H}.${B}.${W}-${se} <${H}.${+B+1}.0-0`):ne=`>=${H}.${B}.${W} <${H}.${+B+1}.0-0`,i("tilde return",ne),ne})},A=(P,$)=>P.trim().split(/\s+/).map(C=>J(C,$)).join(" "),J=(P,$)=>{i("caret",P,$);const C=$.loose?c[u.CARETLOOSE]:c[u.CARET],G=$.includePrerelease?"-0":"";return P.replace(C,(H,B,W,se,ne)=>{i("caret",P,H,B,W,se,ne);let pe;return v(B)?pe="":v(W)?pe=`>=${B}.0.0${G} <${+B+1}.0.0-0`:v(se)?B==="0"?pe=`>=${B}.${W}.0${G} <${B}.${+W+1}.0-0`:pe=`>=${B}.${W}.0${G} <${+B+1}.0.0-0`:ne?(i("replaceCaret pr",ne),B==="0"?W==="0"?pe=`>=${B}.${W}.${se}-${ne} <${B}.${W}.${+se+1}-0`:pe=`>=${B}.${W}.${se}-${ne} <${B}.${+W+1}.0-0`:pe=`>=${B}.${W}.${se}-${ne} <${+B+1}.0.0-0`):(i("no pr"),B==="0"?W==="0"?pe=`>=${B}.${W}.${se}${G} <${B}.${W}.${+se+1}-0`:pe=`>=${B}.${W}.${se}${G} <${B}.${+W+1}.0-0`:pe=`>=${B}.${W}.${se} <${+B+1}.0.0-0`),i("caret return",pe),pe})},E=(P,$)=>(i("replaceXRanges",P,$),P.split(/\s+/).map(C=>ye(C,$)).join(" ")),ye=(P,$)=>{P=P.trim();const C=$.loose?c[u.XRANGELOOSE]:c[u.XRANGE];return P.replace(C,(G,H,B,W,se,ne)=>{i("xRange",P,G,H,B,W,se,ne);const pe=v(B),Re=pe||v(W),ue=Re||v(se),g=ue;return H==="="&&g&&(H=""),ne=$.includePrerelease?"-0":"",pe?H===">"||H==="<"?G="<0.0.0-0":G="*":H&&g?(Re&&(W=0),se=0,H===">"?(H=">=",Re?(B=+B+1,W=0,se=0):(W=+W+1,se=0)):H==="<="&&(H="<",Re?B=+B+1:W=+W+1),H==="<"&&(ne="-0"),G=`${H+B}.${W}.${se}${ne}`):Re?G=`>=${B}.0.0${ne} <${+B+1}.0.0-0`:ue&&(G=`>=${B}.${W}.0${ne} <${B}.${+W+1}.0-0`),i("xRange return",G),G})},xe=(P,$)=>(i("replaceStars",P,$),P.trim().replace(c[u.STAR],"")),ce=(P,$)=>(i("replaceGTE0",P,$),P.trim().replace(c[$.includePrerelease?u.GTE0PRE:u.GTE0],"")),De=P=>($,C,G,H,B,W,se,ne,pe,Re,ue,g)=>(v(G)?C="":v(H)?C=`>=${G}.0.0${P?"-0":""}`:v(B)?C=`>=${G}.${H}.0${P?"-0":""}`:W?C=`>=${C}`:C=`>=${C}${P?"-0":""}`,v(pe)?ne="":v(Re)?ne=`<${+pe+1}.0.0-0`:v(ue)?ne=`<${pe}.${+Re+1}.0-0`:g?ne=`<=${pe}.${Re}.${ue}-${g}`:P?ne=`<${pe}.${Re}.${+ue+1}-0`:ne=`<=${ne}`,`${C} ${ne}`.trim()),er=(P,$,C)=>{for(let G=0;G<P.length;G++)if(!P[G].test($))return!1;if($.prerelease.length&&!C.includePrerelease){for(let G=0;G<P.length;G++)if(i(P[G].semver),P[G].semver!==a.ANY&&P[G].semver.prerelease.length>0){const H=P[G].semver;if(H.major===$.major&&H.minor===$.minor&&H.patch===$.patch)return!0}return!1}return!0};return Ms}var Ds,Do;function hs(){if(Do)return Ds;Do=1;const r=Symbol("SemVer ANY");class e{static get ANY(){return r}constructor(l,d){if(d=t(d),l instanceof e){if(l.loose===!!d.loose)return l;l=l.value}l=l.trim().split(/\s+/).join(" "),i("comparator",l,d),this.options=d,this.loose=!!d.loose,this.parse(l),this.semver===r?this.value="":this.value=this.operator+this.semver.version,i("comp",this)}parse(l){const d=this.options.loose?n[s.COMPARATORLOOSE]:n[s.COMPARATOR],f=l.match(d);if(!f)throw new TypeError(`Invalid comparator: ${l}`);this.operator=f[1]!==void 0?f[1]:"",this.operator==="="&&(this.operator=""),f[2]?this.semver=new o(f[2],this.options.loose):this.semver=r}toString(){return this.value}test(l){if(i("Comparator.test",l,this.options.loose),this.semver===r||l===r)return!0;if(typeof l=="string")try{l=new o(l,this.options)}catch{return!1}return a(l,this.operator,this.semver,this.options)}intersects(l,d){if(!(l instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new c(l.value,d).test(this.value):l.operator===""?l.value===""?!0:new c(this.value,d).test(l.semver):(d=t(d),d.includePrerelease&&(this.value==="<0.0.0-0"||l.value==="<0.0.0-0")||!d.includePrerelease&&(this.value.startsWith("<0.0.0")||l.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&l.operator.startsWith(">")||this.operator.startsWith("<")&&l.operator.startsWith("<")||this.semver.version===l.semver.version&&this.operator.includes("=")&&l.operator.includes("=")||a(this.semver,"<",l.semver,d)&&this.operator.startsWith(">")&&l.operator.startsWith("<")||a(this.semver,">",l.semver,d)&&this.operator.startsWith("<")&&l.operator.startsWith(">")))}}Ds=e;const t=ii,{safeRe:n,t:s}=pn,a=Ju,i=ds,o=ze,c=mt();return Ds}const o_=mt(),c_=(r,e,t)=>{try{e=new o_(e,t)}catch{return!1}return e.test(r)};var ps=c_;const u_=mt(),l_=(r,e)=>new u_(r,e).set.map(t=>t.map(n=>n.value).join(" ").trim().split(" "));var d_=l_;const f_=ze,h_=mt(),p_=(r,e,t)=>{let n=null,s=null,a=null;try{a=new h_(e,t)}catch{return null}return r.forEach(i=>{a.test(i)&&(!n||s.compare(i)===-1)&&(n=i,s=new f_(n,t))}),n};var m_=p_;const g_=ze,y_=mt(),__=(r,e,t)=>{let n=null,s=null,a=null;try{a=new y_(e,t)}catch{return null}return r.forEach(i=>{a.test(i)&&(!n||s.compare(i)===1)&&(n=i,s=new g_(n,t))}),n};var w_=__;const Us=ze,v_=mt(),Uo=fs,b_=(r,e)=>{r=new v_(r,e);let t=new Us("0.0.0");if(r.test(t)||(t=new Us("0.0.0-0"),r.test(t)))return t;t=null;for(let n=0;n<r.set.length;++n){const s=r.set[n];let a=null;s.forEach(i=>{const o=new Us(i.semver.version);switch(i.operator){case">":o.prerelease.length===0?o.patch++:o.prerelease.push(0),o.raw=o.format();case"":case">=":(!a||Uo(o,a))&&(a=o);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${i.operator}`)}}),a&&(!t||Uo(t,a))&&(t=a)}return t&&r.test(t)?t:null};var E_=b_;const T_=mt(),S_=(r,e)=>{try{return new T_(r,e).range||"*"}catch{return null}};var x_=S_;const I_=ze,Wu=hs(),{ANY:O_}=Wu,A_=mt(),k_=ps,Fo=fs,Bo=ci,R_=li,$_=ui,C_=(r,e,t,n)=>{r=new I_(r,n),e=new A_(e,n);let s,a,i,o,c;switch(t){case">":s=Fo,a=R_,i=Bo,o=">",c=">=";break;case"<":s=Bo,a=$_,i=Fo,o="<",c="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(k_(r,e,n))return!1;for(let u=0;u<e.set.length;++u){const l=e.set[u];let d=null,f=null;if(l.forEach(h=>{h.semver===O_&&(h=new Wu(">=0.0.0")),d=d||h,f=f||h,s(h.semver,d.semver,n)?d=h:i(h.semver,f.semver,n)&&(f=h)}),d.operator===o||d.operator===c||(!f.operator||f.operator===o)&&a(r,f.semver))return!1;if(f.operator===c&&i(r,f.semver))return!1}return!0};var di=C_;const N_=di,P_=(r,e,t)=>N_(r,e,">",t);var L_=P_;const j_=di,M_=(r,e,t)=>j_(r,e,"<",t);var D_=M_;const zo=mt(),U_=(r,e,t)=>(r=new zo(r,t),e=new zo(e,t),r.intersects(e,t));var F_=U_;const B_=ps,z_=pt;var G_=(r,e,t)=>{const n=[];let s=null,a=null;const i=r.sort((l,d)=>z_(l,d,t));for(const l of i)B_(l,e,t)?(a=l,s||(s=l)):(a&&n.push([s,a]),a=null,s=null);s&&n.push([s,null]);const o=[];for(const[l,d]of n)l===d?o.push(l):!d&&l===i[0]?o.push("*"):d?l===i[0]?o.push(`<=${d}`):o.push(`${l} - ${d}`):o.push(`>=${l}`);const c=o.join(" || "),u=typeof e.raw=="string"?e.raw:String(e);return c.length<u.length?c:e};const Go=mt(),fi=hs(),{ANY:Fs}=fi,Mr=ps,hi=pt,q_=(r,e,t={})=>{if(r===e)return!0;r=new Go(r,t),e=new Go(e,t);let n=!1;e:for(const s of r.set){for(const a of e.set){const i=V_(s,a,t);if(n=n||i!==null,i)continue e}if(n)return!1}return!0},H_=[new fi(">=0.0.0-0")],qo=[new fi(">=0.0.0")],V_=(r,e,t)=>{if(r===e)return!0;if(r.length===1&&r[0].semver===Fs){if(e.length===1&&e[0].semver===Fs)return!0;t.includePrerelease?r=H_:r=qo}if(e.length===1&&e[0].semver===Fs){if(t.includePrerelease)return!0;e=qo}const n=new Set;let s,a;for(const h of r)h.operator===">"||h.operator===">="?s=Ho(s,h,t):h.operator==="<"||h.operator==="<="?a=Vo(a,h,t):n.add(h.semver);if(n.size>1)return null;let i;if(s&&a){if(i=hi(s.semver,a.semver,t),i>0)return null;if(i===0&&(s.operator!==">="||a.operator!=="<="))return null}for(const h of n){if(s&&!Mr(h,String(s),t)||a&&!Mr(h,String(a),t))return null;for(const m of e)if(!Mr(h,String(m),t))return!1;return!0}let o,c,u,l,d=a&&!t.includePrerelease&&a.semver.prerelease.length?a.semver:!1,f=s&&!t.includePrerelease&&s.semver.prerelease.length?s.semver:!1;d&&d.prerelease.length===1&&a.operator==="<"&&d.prerelease[0]===0&&(d=!1);for(const h of e){if(l=l||h.operator===">"||h.operator===">=",u=u||h.operator==="<"||h.operator==="<=",s){if(f&&h.semver.prerelease&&h.semver.prerelease.length&&h.semver.major===f.major&&h.semver.minor===f.minor&&h.semver.patch===f.patch&&(f=!1),h.operator===">"||h.operator===">="){if(o=Ho(s,h,t),o===h&&o!==s)return!1}else if(s.operator===">="&&!Mr(s.semver,String(h),t))return!1}if(a){if(d&&h.semver.prerelease&&h.semver.prerelease.length&&h.semver.major===d.major&&h.semver.minor===d.minor&&h.semver.patch===d.patch&&(d=!1),h.operator==="<"||h.operator==="<="){if(c=Vo(a,h,t),c===h&&c!==a)return!1}else if(a.operator==="<="&&!Mr(a.semver,String(h),t))return!1}if(!h.operator&&(a||s)&&i!==0)return!1}return!(s&&u&&!a&&i!==0||a&&l&&!s&&i!==0||f||d)},Ho=(r,e,t)=>{if(!r)return e;const n=hi(r.semver,e.semver,t);return n>0?r:n<0||e.operator===">"&&r.operator===">="?e:r},Vo=(r,e,t)=>{if(!r)return e;const n=hi(r.semver,e.semver,t);return n<0?r:n>0||e.operator==="<"&&r.operator==="<="?e:r};var Z_=q_;const Bs=pn,Zo=ls,J_=ze,Jo=Hu,W_=Pr,K_=ry,X_=ay,Y_=oy,Q_=uy,ew=fy,tw=my,rw=_y,nw=by,sw=pt,aw=xy,iw=Ay,ow=oi,cw=Cy,uw=Ly,lw=fs,dw=ci,fw=Vu,hw=Zu,pw=ui,mw=li,gw=Ju,yw=s_,_w=hs(),ww=mt(),vw=ps,bw=d_,Ew=m_,Tw=w_,Sw=E_,xw=x_,Iw=di,Ow=L_,Aw=D_,kw=F_,Rw=G_,$w=Z_;Bs.re,Bs.src,Bs.t,Zo.SEMVER_SPEC_VERSION,Zo.RELEASE_TYPES,Jo.compareIdentifiers,Jo.rcompareIdentifiers;function Ut(r){if(!r||r.split("/").length>2||r.startsWith("/")||r.endsWith("/")||r.split(":").length>2)throw new Error(`Invalid identifier format: ${r}`);const[e,t]=r.split(":"),n=t||"latest";if(e.includes("/")){const[s,a]=e.split("/",2);if(!s||!a)throw new Error(`Invalid identifier format: ${r}`);return[s,a,n]}else{if(!e)throw new Error(`Invalid identifier format: ${r}`);return["-",e,n]}}class Cw extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function q(r,e,t){let n;if(r.ok){t&&(n=await r.text());return}if(r.status===403)try{const i=await r.json();(i==null?void 0:i.error)==="org_scoped_key_requires_workspace"&&(n="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch{const o=new Error(`${r.status} ${r.statusText}`);throw o.status=r==null?void 0:r.status,o}if(n===void 0)try{n=await r.text()}catch{n=""}const s=`Failed to ${e}. Received status [${r.status}]: ${r.statusText}. Message: ${n}`;if(r.status===409)throw new Cw(s);const a=new Error(s);throw a.status=r.status,a}const Ku="ERR_CONFLICTING_ENDPOINTS";class Nw extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:Ku}),this.name="ConflictingEndpointsError"}}function Pw(r){return typeof r=="object"&&r!==null&&r.code===Ku}var Wo="[...]",Lw={result:"[Circular]"},Wn=[],wr=[];const jw=new TextEncoder;function Mw(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function Rn(r){return jw.encode(r)}function Xu(r){if(r&&typeof r=="object"&&r!==null){if(r instanceof Map)return Object.fromEntries(r);if(r instanceof Set)return Array.from(r);if(r instanceof Date)return r.toISOString();if(r instanceof RegExp)return r.toString();if(r instanceof Error)return{name:r.name,message:r.message}}else if(typeof r=="bigint")return r.toString();return r}function Dw(r){return function(e,t){return Xu(t)}}function We(r,e,t,n,s){var a;try{const i=JSON.stringify(r,Dw(t),n);return Rn(i)}catch(i){if(!((a=i.message)!=null&&a.includes("Converting circular structure to JSON")))return console.warn(`[WARNING]: LangSmith received unserializable value.${e?`
Context: ${e}`:""}`),Rn("[Unserializable]");Ze("SUPPRESS_CIRCULAR_JSON_WARNINGS")!=="true"&&console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${e?`
Context: ${e}`:""}`),typeof s>"u"&&(s=Mw()),fa(r,"",0,[],void 0,0,s);let o;try{wr.length===0?o=JSON.stringify(r,t,n):o=JSON.stringify(r,Uw(t),n)}catch{return Rn("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;Wn.length!==0;){const c=Wn.pop();c.length===4?Object.defineProperty(c[0],c[1],c[3]):c[0][c[1]]=c[2]}}return Rn(o)}}function zs(r,e,t,n){var s=Object.getOwnPropertyDescriptor(n,t);s.get!==void 0?s.configurable?(Object.defineProperty(n,t,{value:r}),Wn.push([n,t,e,s])):wr.push([e,t,r]):(n[t]=r,Wn.push([n,t,e]))}function fa(r,e,t,n,s,a,i){a+=1;var o;if(typeof r=="object"&&r!==null){for(o=0;o<n.length;o++)if(n[o]===r){zs(Lw,r,e,s);return}if(typeof i.depthLimit<"u"&&a>i.depthLimit){zs(Wo,r,e,s);return}if(typeof i.edgesLimit<"u"&&t+1>i.edgesLimit){zs(Wo,r,e,s);return}if(n.push(r),Array.isArray(r))for(o=0;o<r.length;o++)fa(r[o],o,o,n,r,a,i);else{r=Xu(r);var c=Object.keys(r);for(o=0;o<c.length;o++){var u=c[o];fa(r[u],u,o,n,r,a,i)}}n.pop()}}function Uw(r){return r=typeof r<"u"?r:function(e,t){return t},function(e,t){if(wr.length>0)for(var n=0;n<wr.length;n++){var s=wr[n];if(s[1]===e&&s[0]===t){t=s[2],wr.splice(n,1);break}}return r.call(this,e,t)}}function Ko(r,e){const t=Lu(),n=e??ju(),s=r.extra??{},a=s.metadata;return r.extra={...s,runtime:{...t,...s==null?void 0:s.runtime},metadata:{...n,...n.revision_id||"revision_id"in r&&r.revision_id?{revision_id:("revision_id"in r?r.revision_id:void 0)??n.revision_id}:{},...a}},r}const Fw=r=>{const e=(r==null?void 0:r.toString())??Ze("TRACING_SAMPLING_RATE");if(e===void 0)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t},Bw=r=>{const t=r.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"};async function zw(r){const e=[];for await(const t of r)e.push(t);return e}function $n(r){if(r!==void 0)return r.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const Gw=async r=>{if((r==null?void 0:r.status)===429){const e=parseInt(r.headers.get("retry-after")??"10",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1};function Xo(r){return typeof r=="number"?Number(r.toFixed(4)):r}const qw=24*1024*1024,Yu=1024*1024*1024,Hw=1e4,Vw=100,Yo="https://api.smith.langchain.com";class Zw{constructor(e){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"maxSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxSizeBytes=e??Yu}peek(){return this.items[0]}push(e){let t;const n=new Promise(a=>{t=a}),s=We(e.item,`Serializing run with id: ${e.item.id}`).length;return this.sizeBytes+s>this.maxSizeBytes&&this.items.length>0?(console.warn(`AutoBatchQueue size limit (${this.maxSizeBytes} bytes) exceeded. Dropping run with id: ${e.item.id}. Current queue size: ${this.sizeBytes} bytes, attempted addition: ${s} bytes.`),t(),n):(this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:t,itemPromise:n,size:s}),this.sizeBytes+=s,n)}pop({upToSizeBytes:e,upToSize:t}){var a;if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const n=[];let s=0;for(;s+(((a=this.peek())==null?void 0:a.size)??0)<e&&this.items.length>0&&n.length<t;){const i=this.items.shift();i&&(n.push(i),s+=i.size,this.sizeBytes-=i.size)}if(n.length===0&&this.items.length>0){const i=this.items.shift();n.push(i),s+=i.size,this.sizeBytes-=i.size}return[n.map(i=>({action:i.action,item:i.payload,otelContext:i.otelContext,apiKey:i.apiKey,apiUrl:i.apiUrl,size:i.size})),()=>n.forEach(i=>i.itemPromiseResolve())]}}class tn{get _fetch(){return this.fetchImplementation||tg(this.debug)}constructor(e={}){var s;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:St("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:St("LANGSMITH_DEBUG")==="true"});const t=tn.getDefaultClientConfig();if(this.tracingSampleRate=Fw(e.tracingSamplingRate),this.apiUrl=$n(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=$n(e.apiKey??t.apiKey),this.webUrl=$n(e.webUrl??t.webUrl),(s=this.webUrl)!=null&&s.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=$n(e.workspaceId??Ze("WORKSPACE_ID")),this.timeout_ms=e.timeout_ms??9e4,this.caller=new xo({...e.callerOptions??{},maxRetries:4,debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.fetchImplementation=e.fetchImplementation;const n=e.maxIngestMemoryBytes??Yu;this.batchIngestCaller=new xo({maxRetries:4,maxConcurrency:this.traceBatchConcurrency,maxQueueSizeBytes:n,...e.callerOptions??{},onFailedResponseHook:Gw,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.autoBatchQueue=new Zw(n),this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.batchSizeLimit=e.batchSizeLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode,Mu()&&(this.langSmithToOTELTranslator=new vg),this.cachedLSEnvVarsForMetadata=ju()}static getDefaultClientConfig(){const e=Ze("API_KEY"),t=Ze("ENDPOINT")??Yo,n=Ze("HIDE_INPUTS")==="true",s=Ze("HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:n,hideOutputs:s}}getHostUrl(){return this.webUrl?this.webUrl:Bw(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${Cu}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(e["x-tenant-id"]=this.workspaceId),e}_getPlatformEndpointPath(e){return this.apiUrl.slice(-3)!=="/v1"&&this.apiUrl.slice(-4)!=="/v1/"?`/v1/platform/${e}`:`/platform/${e}`}async processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}async processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const t={...e};return t.inputs!==void 0&&(t.inputs=await this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=await this.processOutputs(t.outputs)),t}async _getResponse(e,t){const n=(t==null?void 0:t.toString())??"",s=`${this.apiUrl}${e}?${n}`;return await this.caller.call(async()=>{const i=await this._fetch(s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(i,`fetch ${e}`),i})}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,n){let s=Number(t.get("offset"))||0;const a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(s)),t.set("limit",String(a));const i=`${this.apiUrl}${e}?${t}`,o=await this.caller.call(async()=>{const u=await this._fetch(i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(u,`fetch ${e}`),u}),c=n?n(await o.json()):await o.json();if(c.length===0||(yield c,c.length<a))break;s+=c.length}}async*_getCursorPaginatedList(e,t=null,n="POST",s="runs"){const a=t?{...t}:{};for(;;){const i=JSON.stringify(a),c=await(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await q(l,`fetch ${e}`),l})).json();if(!c||!c[s])break;yield c[s];const u=c.cursors;if(!u||!u.next)break;a.cursor=u.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){const n=[];for(const s of e)this.filteredPostUuids.has(s.trace_id)?s.id===s.trace_id&&this.filteredPostUuids.delete(s.trace_id):n.push(s);return n}else{const n=[];for(const s of e){const a=s.trace_id??s.id;this.filteredPostUuids.has(a)||(s.id===a?this._shouldSample()?n.push(s):this.filteredPostUuids.add(a):n.push(s))}return n}}async _getBatchSizeLimitBytes(){var t;const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??((t=e.batch_ingest_config)==null?void 0:t.size_limit_bytes)??qw}async _getBatchSizeLimit(){var t;const e=await this._ensureServerInfo();return this.batchSizeLimit??((t=e.batch_ingest_config)==null?void 0:t.size_limit)??Vw}async _getDatasetExamplesMultiPartSupport(){var t;return((t=(await this._ensureServerInfo()).instance_flags)==null?void 0:t.dataset_examples_multipart_enabled)??!1}drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:t}){const n=[];for(;this.autoBatchQueue.items.length>0;){const[s,a]=this.autoBatchQueue.pop({upToSizeBytes:e,upToSize:t});if(!s.length){a();break}const i=s.reduce((u,l)=>{const d=l.apiUrl??this.apiUrl,f=l.apiKey??this.apiKey,m=l.apiKey===this.apiKey&&l.apiUrl===this.apiUrl?"default":`${d}|${f}`;return u[m]||(u[m]=[]),u[m].push(l),u},{}),o=[];for(const[u,l]of Object.entries(i)){const d=this._processBatch(l,{apiUrl:u==="default"?void 0:u.split("|")[0],apiKey:u==="default"?void 0:u.split("|")[1]});o.push(d)}const c=Promise.all(o).finally(a);n.push(c)}return Promise.all(n)}async _processBatch(e,t){var s,a;if(!e.length)return;const n=e.reduce((i,o)=>i+(o.size??0),0);try{if(this.langSmithToOTELTranslator!==void 0)this._sendBatchToOTELTranslator(e);else{const i={runCreates:e.filter(c=>c.action==="create").map(c=>c.item),runUpdates:e.filter(c=>c.action==="update").map(c=>c.item)},o=await this._ensureServerInfo();if((s=o==null?void 0:o.batch_ingest_config)!=null&&s.use_multipart_endpoint){const c=(a=o==null?void 0:o.instance_flags)==null?void 0:a.gzip_body_enabled;await this.multipartIngestRuns(i,{...t,useGzip:c,sizeBytes:n})}else await this.batchIngestRuns(i,{...t,sizeBytes:n})}}catch(i){console.error("Error exporting batch:",i)}}_sendBatchToOTELTranslator(e){if(this.langSmithToOTELTranslator!==void 0){const t=new Map,n=[];for(const s of e)s.item.id&&s.otelContext&&(t.set(s.item.id,s.otelContext),s.action==="create"?n.push({operation:"post",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}):n.push({operation:"patch",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}));this.langSmithToOTELTranslator.exportBatch(n,t)}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.item=Ko(e.item,this.cachedLSEnvVarsForMetadata);const t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;const n=await this._getBatchSizeLimitBytes(),s=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>n||this.autoBatchQueue.items.length>s)&&this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:s}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:s})},this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){const t=await(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(Hw),...this.fetchOptions});return await q(n,"get server info"),n})).json();return this.debug&&console.log(`
=== LangSmith Server Configuration ===
`+JSON.stringify(t,null,2)+`
`),t}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${e.status??"Unspecified status code"} ${e.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes(),t=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:t})}_cloneCurrentOTELContext(){const e=Du(),t=gg();if(this.langSmithToOTELTranslator!==void 0){const n=e.getActiveSpan();if(n)return e.setSpan(t.active(),n)}}async createRun(e,t){if(!this._filterForSampling([e]).length)return;const n={...this.headers,"Content-Type":"application/json"},s=e.project_name;delete e.project_name;const a=await this.prepareRunCreateOrUpdateInputs({session_name:s,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){const c=this._cloneCurrentOTELContext();this.processRunOperation({action:"create",item:a,otelContext:c,apiKey:t==null?void 0:t.apiKey,apiUrl:t==null?void 0:t.apiUrl}).catch(console.error);return}const i=Ko(a,this.cachedLSEnvVarsForMetadata);(t==null?void 0:t.apiKey)!==void 0&&(n["x-api-key"]=t.apiKey),(t==null?void 0:t.workspaceId)!==void 0&&(n["x-tenant-id"]=t.workspaceId);const o=We(i,`Creating run with id: ${i.id}`);await this.caller.call(async()=>{const c=await this._fetch(`${(t==null?void 0:t.apiUrl)??this.apiUrl}/runs`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await q(c,"create run",!0),c})}async batchIngestRuns({runCreates:e,runUpdates:t},n){if(e===void 0&&t===void 0)return;let s=await Promise.all((e==null?void 0:e.map(c=>this.prepareRunCreateOrUpdateInputs(c)))??[]),a=await Promise.all((t==null?void 0:t.map(c=>this.prepareRunCreateOrUpdateInputs(c)))??[]);if(s.length>0&&a.length>0){const c=s.reduce((l,d)=>(d.id&&(l[d.id]=d),l),{}),u=[];for(const l of a)l.id!==void 0&&c[l.id]?c[l.id]={...c[l.id],...l}:u.push(l);s=Object.values(c),a=u}const i={post:s,patch:a};if(!i.post.length&&!i.patch.length)return;const o={post:[],patch:[]};for(const c of["post","patch"]){const u=c,l=i[u].reverse();let d=l.pop();for(;d!==void 0;)o[u].push(d),d=l.pop()}if(o.post.length>0||o.patch.length>0){const c=o.post.map(u=>u.id).concat(o.patch.map(u=>u.id)).join(",");await this._postBatchIngestRuns(We(o,`Ingesting runs with ids: ${c}`),n)}}async _postBatchIngestRuns(e,t){const n={...this.headers,"Content-Type":"application/json",Accept:"application/json"};(t==null?void 0:t.apiKey)!==void 0&&(n["x-api-key"]=t.apiKey),await this.batchIngestCaller.callWithOptions({sizeBytes:t==null?void 0:t.sizeBytes},async()=>{const s=await this._fetch(`${(t==null?void 0:t.apiUrl)??this.apiUrl}/runs/batch`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await q(s,"batch create run",!0),s})}async multipartIngestRuns({runCreates:e,runUpdates:t},n){if(e===void 0&&t===void 0)return;const s={};let a=[];for(const d of e??[]){const f=await this.prepareRunCreateOrUpdateInputs(d);f.id!==void 0&&f.attachments!==void 0&&(s[f.id]=f.attachments),delete f.attachments,a.push(f)}let i=[];for(const d of t??[])i.push(await this.prepareRunCreateOrUpdateInputs(d));if(a.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(i.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(a.length>0&&i.length>0){const d=a.reduce((h,m)=>(m.id&&(h[m.id]=m),h),{}),f=[];for(const h of i)h.id!==void 0&&d[h.id]?d[h.id]={...d[h.id],...h}:f.push(h);a=Object.values(d),i=f}if(a.length===0&&i.length===0)return;const u=[],l=[];for(const[d,f]of[["post",a],["patch",i]])for(const h of f){const{inputs:m,outputs:T,events:w,extra:_,error:b,serialized:v,attachments:O,...x}=h,A={inputs:m,outputs:T,events:w,extra:_,error:b,serialized:v},J=We(x,`Serializing for multipart ingestion of run with id: ${x.id}`);l.push({name:`${d}.${x.id}`,payload:new Blob([J],{type:`application/json; length=${J.length}`})});for(const[E,ye]of Object.entries(A)){if(ye===void 0)continue;const xe=We(ye,`Serializing ${E} for multipart ingestion of run with id: ${x.id}`);l.push({name:`${d}.${x.id}.${E}`,payload:new Blob([xe],{type:`application/json; length=${xe.length}`})})}if(x.id!==void 0){const E=s[x.id];if(E){delete s[x.id];for(const[ye,xe]of Object.entries(E)){let ce,De;if(Array.isArray(xe)?[ce,De]=xe:(ce=xe.mimeType,De=xe.data),ye.includes(".")){console.warn(`Skipping attachment '${ye}' for run ${x.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}l.push({name:`attachment.${x.id}.${ye}`,payload:new Blob([De],{type:`${ce}; length=${De.byteLength}`})})}}}u.push(`trace=${x.trace_id},id=${x.id}`)}await this._sendMultipartRequest(l,u.join("; "),n)}async _createNodeFetchBody(e,t){const n=[];for(const i of e)n.push(new Blob([`--${t}\r
`])),n.push(new Blob([`Content-Disposition: form-data; name="${i.name}"\r
`,`Content-Type: ${i.payload.type}\r
\r
`])),n.push(i.payload),n.push(new Blob([`\r
`]));return n.push(new Blob([`--${t}--\r
`])),await new Blob(n).arrayBuffer()}async _createMultipartStream(e,t){const n=new TextEncoder;return new ReadableStream({async start(a){const i=async o=>{typeof o=="string"?a.enqueue(n.encode(o)):a.enqueue(o)};for(const o of e){await i(`--${t}\r
`),await i(`Content-Disposition: form-data; name="${o.name}"\r
`),await i(`Content-Type: ${o.payload.type}\r
\r
`);const u=o.payload.stream().getReader();try{let l;for(;!(l=await u.read()).done;)a.enqueue(l.value)}finally{u.releaseLock()}await i(`\r
`)}await i(`--${t}--\r
`),a.close()}})}async _sendMultipartRequest(e,t,n){const s="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),a=eg(),i=()=>this._createNodeFetchBody(e,s),o=()=>this._createMultipartStream(e,s),c=async u=>this.batchIngestCaller.callWithOptions({sizeBytes:n==null?void 0:n.sizeBytes},async()=>{const l=await u(),d={...this.headers,"Content-Type":`multipart/form-data; boundary=${s}`};(n==null?void 0:n.apiKey)!==void 0&&(d["x-api-key"]=n.apiKey);let f=l;n!=null&&n.useGzip&&typeof l=="object"&&"pipeThrough"in l&&(f=l.pipeThrough(new CompressionStream("gzip")),d["Content-Encoding"]="gzip");const h=await this._fetch(`${(n==null?void 0:n.apiUrl)??this.apiUrl}/runs/multipart`,{method:"POST",headers:d,body:f,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(h,"Failed to send multipart request",!0),h});try{let u,l=!1;!a&&!this.multipartStreamingDisabled&&Pu()!=="bun"?(l=!0,u=await c(o)):u=await c(i),(!this.multipartStreamingDisabled||l)&&u.status===422&&((n==null?void 0:n.apiUrl)??this.apiUrl)!==Yo&&(console.warn(`Streaming multipart upload to ${(n==null?void 0:n.apiUrl)??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${t}".`),this.multipartStreamingDisabled=!0,u=await c(i))}catch(u){console.warn(`${u.message.trim()}

Context: ${t}`)}}async updateRun(e,t,n){re(e),t.inputs&&(t.inputs=await this.processInputs(t.inputs)),t.outputs&&(t.outputs=await this.processOutputs(t.outputs));const s={...t,id:e};if(!this._filterForSampling([s],!0).length)return;if(this.autoBatchTracing&&s.trace_id!==void 0&&s.dotted_order!==void 0){const o=this._cloneCurrentOTELContext();if(t.end_time!==void 0&&s.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:n==null?void 0:n.apiKey,apiUrl:n==null?void 0:n.apiUrl}).catch(console.error);return}else this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:n==null?void 0:n.apiKey,apiUrl:n==null?void 0:n.apiUrl}).catch(console.error);return}const a={...this.headers,"Content-Type":"application/json"};(n==null?void 0:n.apiKey)!==void 0&&(a["x-api-key"]=n.apiKey),(n==null?void 0:n.workspaceId)!==void 0&&(a["x-tenant-id"]=n.workspaceId);const i=We(t,`Serializing payload to update run with id: ${e}`);await this.caller.call(async()=>{const o=await this._fetch(`${(n==null?void 0:n.apiUrl)??this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await q(o,"update run",!0),o})}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){re(e);let n=await this._get(`/runs/${e}`);return t&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:t,projectOpts:n}){if(t!==void 0){let s;t.session_id?s=t.session_id:n!=null&&n.projectName?s=(await this.readProject({projectName:n==null?void 0:n.projectName})).id:n!=null&&n.projectId?s=n==null?void 0:n.projectId:s=(await this.readProject({projectName:Ze("PROJECT")||"default"})).id;const a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${s}/r/${t.id}?poll=true`}else if(e!==void 0){const s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){var a;const t=await zw(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),n={},s={};t.sort((i,o)=>((i==null?void 0:i.dotted_order)??"").localeCompare((o==null?void 0:o.dotted_order)??""));for(const i of t){if(i.parent_run_id===null||i.parent_run_id===void 0)throw new Error(`Child run ${i.id} has no parent`);(a=i.dotted_order)!=null&&a.startsWith(e.dotted_order??"")&&i.id!==e.id&&(i.parent_run_id in n||(n[i.parent_run_id]=[]),n[i.parent_run_id].push(i),s[i.id]=i)}e.child_runs=n[e.id]||[];for(const i in n)i!==e.id&&(s[i].child_runs=n[i]);return e}async*listRuns(e){const{projectId:t,projectName:n,parentRunId:s,traceId:a,referenceExampleId:i,startTime:o,executionOrder:c,isRoot:u,runType:l,error:d,id:f,query:h,filter:m,traceFilter:T,treeFilter:w,limit:_,select:b,order:v}=e;let O=[];if(t&&(O=Array.isArray(t)?t:[t]),n){const E=Array.isArray(n)?n:[n],ye=await Promise.all(E.map(xe=>this.readProject({projectName:xe}).then(ce=>ce.id)));O.push(...ye)}const x=["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],A={session:O.length?O:null,run_type:l,reference_example:i,query:h,filter:m,trace_filter:T,tree_filter:w,execution_order:c,parent_run:s,start_time:o?o.toISOString():null,error:d,id:f,limit:_,trace:a,select:b||x,is_root:u,order:v};A.select.includes("child_run_ids")&&la("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let J=0;for await(const E of this._getCursorPaginatedList("/runs/query",A))if(_){if(J>=_)break;if(E.length+J>_){yield*E.slice(0,_-J);break}J+=E.length,yield*E}else yield*E}async*listGroupRuns(e){const{projectId:t,projectName:n,groupBy:s,filter:a,startTime:i,endTime:o,limit:c,offset:u}=e,d={session_id:t||(await this.readProject({projectName:n})).id,group_by:s,filter:a,start_time:i?i.toISOString():null,end_time:o?o.toISOString():null,limit:Number(c)||100};let f=Number(u)||0;const h="/runs/group",m=`${this.apiUrl}${h}`;for(;;){const T={...d,offset:f},w=Object.fromEntries(Object.entries(T).filter(([A,J])=>J!==void 0)),_=JSON.stringify(w),v=await(await this.caller.call(async()=>{const A=await this._fetch(m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:_});return await q(A,`Failed to fetch ${h}`),A})).json(),{groups:O,total:x}=v;if(O.length===0)break;for(const A of O)yield A;if(f+=O.length,f>=x)break}}async getRunStats({id:e,trace:t,parentRun:n,runType:s,projectNames:a,projectIds:i,referenceExampleIds:o,startTime:c,endTime:u,error:l,query:d,filter:f,traceFilter:h,treeFilter:m,isRoot:T,dataSourceType:w}){let _=i||[];a&&(_=[...i||[],...await Promise.all(a.map(J=>this.readProject({projectName:J}).then(E=>E.id)))]);const v=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:n,run_type:s,session:_,reference_example:o,start_time:c,end_time:u,error:l,query:d,filter:f,trace_filter:h,tree_filter:m,is_root:T,data_source_type:w}).filter(([J,E])=>E!==void 0)),O=JSON.stringify(v);return await(await this.caller.call(async()=>{const J=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:O});return await q(J,"get run stats"),J})).json()}async shareRun(e,{shareId:t}={}){const n={run_id:e,share_token:t||Ve()};re(e);const s=JSON.stringify(n),i=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await q(o,"share run"),o})).json();if(i===null||!("share_token"in i))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${i.share_token}/r`}async unshareRun(e){re(e),await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(t,"unshare run",!0),t})}async readRunSharedLink(e){re(e);const n=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(s,"read run shared link"),s})).json();if(!(n===null||!("share_token"in n)))return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const n=new URLSearchParams({share_token:e});if(t!==void 0)for(const i of t)n.append("id",i);return re(e),await(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(i,"list shared runs"),i})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),re(e);const s=await(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(a,"read dataset shared schema"),a})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const n={dataset_id:e};re(e);const s=JSON.stringify(n),i=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await q(o,"share dataset"),o})).json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async unshareDataset(e){re(e),await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(t,"unshare dataset",!0),t})}async readSharedDataset(e){return re(e),await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(s,"read shared dataset"),s})).json()}async listSharedExamples(e,t){const n={};t!=null&&t.exampleIds&&(n.id=t.exampleIds);const s=new URLSearchParams;Object.entries(n).forEach(([o,c])=>{Array.isArray(c)?c.forEach(u=>s.append(o,u)):s.append(o,c)});const a=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/public/${e}/examples?${s.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(o,"list shared examples"),o}),i=await a.json();if(!a.ok)throw"detail"in i?new Error(`Failed to list shared examples.
Status: ${a.status}
Message: ${Array.isArray(i.detail)?i.detail.join(`
`):"Unspecified error"}`):new Error(`Failed to list shared examples: ${a.status} ${a.statusText}`);return i.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:n=null,upsert:s=!1,projectExtra:a=null,referenceDatasetId:i=null}){const o=s?"?upsert=true":"",c=`${this.apiUrl}/sessions${o}`,u=a||{};n&&(u.metadata=n);const l={name:e,extra:u,description:t};i!==null&&(l.reference_dataset_id=i);const d=JSON.stringify(l);return await(await this.caller.call(async()=>{const m=await this._fetch(c,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:d});return await q(m,"create project"),m})).json()}async updateProject(e,{name:t=null,description:n=null,metadata:s=null,projectExtra:a=null,endTime:i=null}){const o=`${this.apiUrl}/sessions/${e}`;let c=a;s&&(c={...c||{},metadata:s});const u=JSON.stringify({name:t,extra:c,description:n,end_time:i?new Date(i).toISOString():null});return await(await this.caller.call(async()=>{const f=await this._fetch(o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await q(f,"update project"),f})).json()}async hasProject({projectId:e,projectName:t}){let n="/sessions";const s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)re(e),n+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");const a=await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}${n}?${s}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(i,"has project"),i});try{const i=await a.json();return a.ok?Array.isArray(i)?i.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:n}){let s="/sessions";const a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)re(e),s+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");n!==void 0&&a.append("include_stats",n.toString());const i=await this._get(s,a);let o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:e,projectName:t}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${n.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");const n=await this.readDataset({datasetId:e,datasetName:t}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/datasets/${n.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:n,referenceDatasetId:s,referenceDatasetName:a,includeStats:i,datasetVersion:o,referenceFree:c,metadata:u}={}){const l=new URLSearchParams;if(e!==void 0)for(const d of e)l.append("id",d);if(t!==void 0&&l.append("name",t),n!==void 0&&l.append("name_contains",n),s!==void 0)l.append("reference_dataset",s);else if(a!==void 0){const d=await this.readDataset({datasetName:a});l.append("reference_dataset",d.id)}i!==void 0&&l.append("include_stats",i.toString()),o!==void 0&&l.append("dataset_version",o),c!==void 0&&l.append("reference_free",c.toString()),u!==void 0&&l.append("metadata",JSON.stringify(u));for await(const d of this._getPaginated("/sessions",l))yield*d}async deleteProject({projectId:e,projectName:t}){let n;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?n=(await this.readProject({projectName:t})).id:n=e,re(n),await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(s,`delete session ${n} (${t})`,!0),s})}async uploadCsv({csvFile:e,fileName:t,inputKeys:n,outputKeys:s,description:a,dataType:i,name:o}){const c=`${this.apiUrl}/datasets/upload`,u=new FormData;return u.append("file",e,t),n.forEach(f=>{u.append("input_keys",f)}),s.forEach(f=>{u.append("output_keys",f)}),a&&u.append("description",a),i&&u.append("data_type",i),o&&u.append("name",o),await(await this.caller.call(async()=>{const f=await this._fetch(c,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await q(f,"upload CSV"),f})).json()}async createDataset(e,{description:t,dataType:n,inputsSchema:s,outputsSchema:a,metadata:i}={}){const o={name:e,description:t,extra:i?{metadata:i}:void 0};n&&(o.data_type=n),s&&(o.inputs_schema_definition=s),a&&(o.outputs_schema_definition=a);const c=JSON.stringify(o);return await(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await q(d,"create dataset"),d})).json()}async readDataset({datasetId:e,datasetName:t}){let n="/datasets";const s=new URLSearchParams({limit:"1"});if(e&&t)throw new Error("Must provide either datasetName or datasetId, not both");if(e)re(e),n+=`/${e}`;else if(t)s.append("name",t);else throw new Error("Must provide datasetName or datasetId");const a=await this._get(n,s);let i;if(Array.isArray(a)){if(a.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=a[0]}else i=a;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(n){if(n instanceof Error&&n.message.toLocaleLowerCase().includes("not found"))return!1;throw n}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:n,toVersion:s}){let a=e;if(a===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(a!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");a===void 0&&(a=(await this.readDataset({datasetName:t})).id);const i=new URLSearchParams({from_version:typeof n=="string"?n:n.toISOString(),to_version:typeof s=="string"?s:s.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){const n="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${n}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:n,datasetName:s,datasetNameContains:a,metadata:i}={}){const o="/datasets",c=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(n!==void 0)for(const u of n)c.append("id",u);s!==void 0&&c.append("name",s),a!==void 0&&c.append("name_contains",a),i!==void 0&&c.append("metadata",JSON.stringify(i));for await(const u of this._getPaginated(o,c))yield*u}async updateDataset(e){const{datasetId:t,datasetName:n,...s}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");const a=t??(await this.readDataset({datasetName:n})).id;re(a);const i=JSON.stringify(s);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await q(c,"update dataset"),c})).json()}async updateDatasetTag(e){const{datasetId:t,datasetName:n,asOf:s,tag:a}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");const i=t??(await this.readDataset({datasetName:n})).id;re(i);const o=JSON.stringify({as_of:typeof s=="string"?s:s.toISOString(),tag:a});await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${i}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await q(c,"update dataset tags",!0),c})}async deleteDataset({datasetId:e,datasetName:t}){let n="/datasets",s=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(s=(await this.readDataset({datasetName:t})).id),s!==void 0)re(s),n+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");await this.caller.call(async()=>{const a=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(a,`delete ${n}`,!0),a})}async indexDataset({datasetId:e,datasetName:t,tag:n}){let s=e;if(!s&&!t)throw new Error("Must provide either datasetName or datasetId");if(s&&t)throw new Error("Must provide either datasetName or datasetId, not both");s||(s=(await this.readDataset({datasetName:t})).id),re(s);const i=JSON.stringify({tag:n});await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${s}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await q(c,"index dataset"),c})).json()}async similarExamples(e,t,n,{filter:s}={}){const a={limit:n,inputs:e};s!==void 0&&(a.filter=s),re(t);const i=JSON.stringify(a);return(await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/datasets/${t}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:i});return await q(u,"fetch similar examples"),u})).json()).examples}async createExample(e,t,n){var l;if(Qo(e)&&(t!==void 0||n!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let s=t?n==null?void 0:n.datasetId:e.dataset_id;const a=t?n==null?void 0:n.datasetName:e.dataset_name;if(s===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:a})).id);const i=(t?n==null?void 0:n.createdAt:e.created_at)||new Date;let o;Qo(e)?o=e:o={inputs:e,outputs:t,created_at:i==null?void 0:i.toISOString(),id:n==null?void 0:n.exampleId,metadata:n==null?void 0:n.metadata,split:n==null?void 0:n.split,source_run_id:n==null?void 0:n.sourceRunId,use_source_run_io:n==null?void 0:n.useSourceRunIO,use_source_run_attachments:n==null?void 0:n.useSourceRunAttachments,attachments:n==null?void 0:n.attachments};const c=await this._uploadExamplesMultipart(s,[o]);return await this.readExample(((l=c.example_ids)==null?void 0:l[0])??Ve())}async createExamples(e){if(Array.isArray(e)){if(e.length===0)return[];const b=e;let v=b[0].dataset_id;const O=b[0].dataset_name;if(v===void 0&&O===void 0)throw new Error("Must provide either datasetName or datasetId");if(v!==void 0&&O!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");v===void 0&&(v=(await this.readDataset({datasetName:O})).id);const x=await this._uploadExamplesMultipart(v,b);return await Promise.all(x.example_ids.map(J=>this.readExample(J)))}const{inputs:t,outputs:n,metadata:s,splits:a,sourceRunIds:i,useSourceRunIOs:o,useSourceRunAttachments:c,attachments:u,exampleIds:l,datasetId:d,datasetName:f}=e;if(t===void 0)throw new Error("Must provide inputs when using legacy parameters");let h=d;const m=f;if(h===void 0&&m===void 0)throw new Error("Must provide either datasetName or datasetId");if(h!==void 0&&m!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");h===void 0&&(h=(await this.readDataset({datasetName:m})).id);const T=t.map((b,v)=>({dataset_id:h,inputs:b,outputs:n==null?void 0:n[v],metadata:s==null?void 0:s[v],split:a==null?void 0:a[v],id:l==null?void 0:l[v],attachments:u==null?void 0:u[v],source_run_id:i==null?void 0:i[v],use_source_run_io:o==null?void 0:o[v],use_source_run_attachments:c==null?void 0:c[v]})),w=await this._uploadExamplesMultipart(h,T);return await Promise.all(w.example_ids.map(b=>this.readExample(b)))}async createLLMExample(e,t,n){return this.createExample({input:e},{output:t},n)}async createChatExample(e,t,n){const s=e.map(i=>Io(i)?Oo(i):i),a=Io(t)?Oo(t):t;return this.createExample({input:s},{output:a},n)}async readExample(e){re(e);const t=`/examples/${e}`,n=await this._get(t),{attachment_urls:s,...a}=n,i=a;return s&&(i.attachments=Object.entries(s).reduce((o,[c,u])=>(o[c.slice(11)]={presigned_url:u.presigned_url,mime_type:u.mime_type},o),{})),i}async*listExamples({datasetId:e,datasetName:t,exampleIds:n,asOf:s,splits:a,inlineS3Urls:i,metadata:o,limit:c,offset:u,filter:l,includeAttachments:d}={}){let f;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)f=e;else if(t!==void 0)f=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");const h=new URLSearchParams({dataset:f}),m=s?typeof s=="string"?s:s==null?void 0:s.toISOString():void 0;m&&h.append("as_of",m);const T=i??!0;if(h.append("inline_s3_urls",T.toString()),n!==void 0)for(const _ of n)h.append("id",_);if(a!==void 0)for(const _ of a)h.append("splits",_);if(o!==void 0){const _=JSON.stringify(o);h.append("metadata",_)}c!==void 0&&h.append("limit",c.toString()),u!==void 0&&h.append("offset",u.toString()),l!==void 0&&h.append("filter",l),d===!0&&["attachment_urls","outputs","metadata"].forEach(_=>h.append("select",_));let w=0;for await(const _ of this._getPaginated("/examples",h)){for(const b of _){const{attachment_urls:v,...O}=b,x=O;v&&(x.attachments=Object.entries(v).reduce((A,[J,E])=>(A[J.slice(11)]={presigned_url:E.presigned_url,mime_type:E.mime_type||void 0},A),{})),yield x,w++}if(c!==void 0&&w>=c)break}}async deleteExample(e){re(e);const t=`/examples/${e}`;await this.caller.call(async()=>{const n=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(n,`delete ${t}`,!0),n})}async updateExample(e,t){let n;t?n=e:n=e.id,re(n);let s;t?s={id:n,...t}:s=e;let a;return s.dataset_id!==void 0?a=s.dataset_id:a=(await this.readExample(n)).dataset_id,this._updateExamplesMultipart(a,[s])}async updateExamples(e){let t;return e[0].dataset_id===void 0?t=(await this.readExample(e[0].id)).dataset_id:t=e[0].dataset_id,this._updateExamplesMultipart(t,e)}async readDatasetVersion({datasetId:e,datasetName:t,asOf:n,tag:s}){let a;if(e?a=e:a=(await this.readDataset({datasetName:t})).id,re(a),n&&s||!n&&!s)throw new Error("Exactly one of asOf and tag must be specified.");const i=new URLSearchParams;return n!==void 0&&i.append("as_of",typeof n=="string"?n:n.toISOString()),s!==void 0&&i.append("tag",s),await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${a}/version?${i.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(c,"read dataset version"),c})).json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:n}){let s;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?s=(await this.readDataset({datasetName:t})).id:s=e,re(s);const a=new URLSearchParams,i=n?typeof n=="string"?n:n==null?void 0:n.toISOString():void 0;return i&&a.append("as_of",i),await this._get(`/datasets/${s}/splits`,a)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:n,exampleIds:s,remove:a=!1}){let i;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?i=(await this.readDataset({datasetName:t})).id:i=e,re(i);const o={split_name:n,examples:s.map(u=>(re(u),u)),remove:a},c=JSON.stringify(o);await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await q(u,"update dataset splits",!0),u})}async evaluateRun(e,t,{sourceInfo:n,loadChildRuns:s,referenceExample:a}={loadChildRuns:!1}){la("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:s});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(a=await this.readExample(i.reference_example_id));const o=await t.evaluateRun(i,a),[c,u]=await this._logEvaluationFeedback(o,i,n);return u[0]}async createFeedback(e,t,{score:n,value:s,correction:a,comment:i,sourceInfo:o,feedbackSourceType:c="api",sourceRunId:u,feedbackId:l,feedbackConfig:d,projectId:f,comparativeExperimentId:h}){var b;if(!e&&!f)throw new Error("One of runId or projectId must be provided");if(e&&f)throw new Error("Only one of runId or projectId can be provided");const m={type:c??"api",metadata:o??{}};u!==void 0&&(m==null?void 0:m.metadata)!==void 0&&!m.metadata.__run&&(m.metadata.__run={run_id:u}),(m==null?void 0:m.metadata)!==void 0&&((b=m.metadata.__run)==null?void 0:b.run_id)!==void 0&&re(m.metadata.__run.run_id);const T={id:l??Ve(),run_id:e,key:t,score:Xo(n),value:s,correction:a,comment:i,feedback_source:m,comparative_experiment_id:h,feedbackConfig:d,session_id:f},w=JSON.stringify(T),_=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{const v=await this._fetch(_,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:w});return await q(v,"create feedback",!0),v}),T}async updateFeedback(e,{score:t,value:n,correction:s,comment:a}){const i={};t!=null&&(i.score=Xo(t)),n!=null&&(i.value=n),s!=null&&(i.correction=s),a!=null&&(i.comment=a),re(e);const o=JSON.stringify(i);await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await q(c,"update feedback",!0),c})}async readFeedback(e){re(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){re(e);const t=`/feedback/${e}`;await this.caller.call(async()=>{const n=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(n,`delete ${t}`,!0),n})}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:n}={}){const s=new URLSearchParams;if(e)for(const a of e)re(a),s.append("run",a);if(t)for(const a of t)s.append("key",a);if(n)for(const a of n)s.append("source",a);for await(const a of this._getPaginated("/feedback",s))yield*a}async createPresignedFeedbackToken(e,t,{expiration:n,feedbackConfig:s}={}){const a={run_id:e,feedback_key:t,feedback_config:s};n?typeof n=="string"?a.expires_at=n:(n!=null&&n.hours||n!=null&&n.minutes||n!=null&&n.days)&&(a.expires_in=n):a.expires_in={hours:3};const i=JSON.stringify(a);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await q(c,"create presigned feedback token"),c})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:n,createdAt:s,description:a,metadata:i,id:o}){var d;if(t.length===0)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:t[0]})).reference_dataset_id),!n==null)throw new Error("A reference dataset is required");const c={id:o,name:e,experiment_ids:t,reference_dataset_id:n,description:a,created_at:(d=s??new Date)==null?void 0:d.toISOString(),extra:{}};i&&(c.extra.metadata=i);const u=JSON.stringify(c);return(await this.caller.call(async()=>{const f=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await q(f,"create comparative experiment"),f})).json()}async*listPresignedFeedbackTokens(e){re(e);const t=new URLSearchParams({run_id:e});for await(const n of this._getPaginated("/feedback/tokens",t))yield*n}_selectEvalResults(e){let t;return"results"in e?t=e.results:Array.isArray(e)?t=e:t=[e],t}async _logEvaluationFeedback(e,t,n){const s=this._selectEvalResults(e),a=[];for(const i of s){let o=n||{};i.evaluatorInfo&&(o={...i.evaluatorInfo,...o});let c=null;i.targetRunId?c=i.targetRunId:t&&(c=t.id),a.push(await this.createFeedback(c,i.key,{score:i.score,value:i.value,comment:i.comment,correction:i.correction,sourceInfo:o,sourceRunId:i.sourceRunId,feedbackConfig:i.feedbackConfig,feedbackSourceType:"model"}))}return[s,a]}async logEvaluationFeedback(e,t,n){const[s]=await this._logEvaluationFeedback(e,t,n);return s}async*listAnnotationQueues(e={}){const{queueIds:t,name:n,nameContains:s,limit:a}=e,i=new URLSearchParams;t&&t.forEach((c,u)=>{re(c,`queueIds[${u}]`),i.append("ids",c)}),n&&i.append("name",n),s&&i.append("name_contains",s),i.append("limit",(a!==void 0?Math.min(a,100):100).toString());let o=0;for await(const c of this._getPaginated("/annotation-queues",i))if(yield*c,o++,a!==void 0&&o>=a)break}async createAnnotationQueue(e){const{name:t,description:n,queueId:s,rubricInstructions:a}=e,i={name:t,description:n,id:s||Ve(),rubric_instructions:a},o=JSON.stringify(Object.fromEntries(Object.entries(i).filter(([u,l])=>l!==void 0)));return(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await q(u,"create annotation queue"),u})).json()}async readAnnotationQueue(e){return(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${re(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(n,"read annotation queue"),n})).json()}async updateAnnotationQueue(e,t){const{name:n,description:s,rubricInstructions:a}=t,i=JSON.stringify({name:n,description:s,rubric_instructions:a});await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/annotation-queues/${re(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await q(o,"update annotation queue",!0),o})}async deleteAnnotationQueue(e){await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${re(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(t,"delete annotation queue",!0),t})}async addRunsToAnnotationQueue(e,t){const n=JSON.stringify(t.map((s,a)=>re(s,`runIds[${a}]`).toString()));await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/annotation-queues/${re(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await q(s,"add runs to annotation queue",!0),s})}async getRunFromAnnotationQueue(e,t){const n=`/annotation-queues/${re(e,"queueId")}/run`;return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${n}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(a,"get run from annotation queue"),a})).json()}async deleteRunFromAnnotationQueue(e,t){await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${re(e,"queueId")}/runs/${re(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(n,"delete run from annotation queue",!0),n})}async getSizeFromAnnotationQueue(e){return(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${re(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(n,"get size from annotation queue"),n})).json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return e=="-"||t.tenant_handle===e}async _ownerConflictError(e,t){const n=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${n.tenant_handle}

      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const n=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(s,"get latest commit hash"),s})).json();if(n.commits.length!==0)return n.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[n,s,a]=Ut(e),i=JSON.stringify({like:t});return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/likes/${n}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await q(c,`${t?"like":"unlike"} prompt`),c})).json()}async _getPromptUrl(e){const[t,n,s]=Ut(e);if(await this._currentTenantIsOwner(t)){const a=await this._getSettings();return s!=="latest"?`${this.getHostUrl()}/prompts/${n}/${s.substring(0,8)}?organizationId=${a.id}`:`${this.getHostUrl()}/prompts/${n}?organizationId=${a.id}`}else return s!=="latest"?`${this.getHostUrl()}/hub/${t}/${n}/${s.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${n}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,n=>n.commits))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",(e==null?void 0:e.sortField)??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!(e!=null&&e.isArchived)).toString()),(e==null?void 0:e.isPublic)!==void 0&&t.append("is_public",e.isPublic.toString()),e!=null&&e.query&&t.append("query",e.query);for await(const n of this._getPaginated("/repos",t,s=>s.repos))yield*n}async getPrompt(e){const[t,n,s]=Ut(e),a=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/repos/${t}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return(o==null?void 0:o.status)===404?null:(await q(o,"get prompt"),o)}),i=await(a==null?void 0:a.json());return i!=null&&i.repo?i.repo:null}async createPrompt(e,t){const n=await this._getSettings();if(t!=null&&t.isPublic&&!n.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle.
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[s,a,i]=Ut(e);if(!await this._currentTenantIsOwner(s))throw await this._ownerConflictError("create a prompt",s);const o={repo_handle:a,...(t==null?void 0:t.description)&&{description:t.description},...(t==null?void 0:t.readme)&&{readme:t.readme},...(t==null?void 0:t.tags)&&{tags:t.tags},is_public:!!(t!=null&&t.isPublic)},c=JSON.stringify(o),u=await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await q(d,"create prompt"),d}),{repo:l}=await u.json();return l}async createCommit(e,t,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[s,a,i]=Ut(e),o=(n==null?void 0:n.parentCommitHash)==="latest"||!(n!=null&&n.parentCommitHash)?await this._getLatestCommitHash(`${s}/${a}`):n==null?void 0:n.parentCommitHash,c={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},u=JSON.stringify(c),d=await(await this.caller.call(async()=>{const f=await this._fetch(`${this.apiUrl}/commits/${s}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await q(f,"create commit"),f})).json();return this._getPromptUrl(`${s}/${a}${d.commit_hash?`:${d.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){return this._updateExamplesMultipart(e,t)}async _updateExamplesMultipart(e,t=[]){var i;if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const o of t){const c=o.id,u={...o.metadata&&{metadata:o.metadata},...o.split&&{split:o.split}},l=We(u,`Serializing body for example with id: ${c}`),d=new Blob([l],{type:"application/json"});if(n.append(c,d),o.inputs){const f=We(o.inputs,`Serializing inputs for example with id: ${c}`),h=new Blob([f],{type:"application/json"});n.append(`${c}.inputs`,h)}if(o.outputs){const f=We(o.outputs,`Serializing outputs whle updating example with id: ${c}`),h=new Blob([f],{type:"application/json"});n.append(`${c}.outputs`,h)}if(o.attachments)for(const[f,h]of Object.entries(o.attachments)){let m,T;Array.isArray(h)?[m,T]=h:(m=h.mimeType,T=h.data);const w=new Blob([T],{type:`${m}; length=${T.byteLength}`});n.append(`${c}.attachment.${f}`,w)}if(o.attachments_operations){const f=We(o.attachments_operations,`Serializing attachments while updating example with id: ${c}`),h=new Blob([f],{type:"application/json"});n.append(`${c}.attachments_operations`,h)}}const s=e??((i=t[0])==null?void 0:i.dataset_id);return(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${s}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await q(o,"update examples"),o})).json()}async uploadExamplesMultipart(e,t=[]){return this._uploadExamplesMultipart(e,t)}async _uploadExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const a of t){const i=(a.id??Ve()).toString(),o={created_at:a.created_at,...a.metadata&&{metadata:a.metadata},...a.split&&{split:a.split},...a.source_run_id&&{source_run_id:a.source_run_id},...a.use_source_run_io&&{use_source_run_io:a.use_source_run_io},...a.use_source_run_attachments&&{use_source_run_attachments:a.use_source_run_attachments}},c=We(o,`Serializing body for uploaded example with id: ${i}`),u=new Blob([c],{type:"application/json"});if(n.append(i,u),a.inputs){const l=We(a.inputs,`Serializing inputs for uploaded example with id: ${i}`),d=new Blob([l],{type:"application/json"});n.append(`${i}.inputs`,d)}if(a.outputs){const l=We(a.outputs,`Serializing outputs for uploaded example with id: ${i}`),d=new Blob([l],{type:"application/json"});n.append(`${i}.outputs`,d)}if(a.attachments)for(const[l,d]of Object.entries(a.attachments)){let f,h;Array.isArray(d)?[f,h]=d:(f=d.mimeType,h=d.data);const m=new Blob([h],{type:`${f}; length=${h.byteLength}`});n.append(`${i}.attachment.${l}`,m)}}return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${e}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await q(a,"upload examples"),a})).json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,s]=Ut(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("update a prompt",n);const a={};if((t==null?void 0:t.description)!==void 0&&(a.description=t.description),(t==null?void 0:t.readme)!==void 0&&(a.readme=t.readme),(t==null?void 0:t.tags)!==void 0&&(a.tags=t.tags),(t==null?void 0:t.isPublic)!==void 0&&(a.is_public=t.isPublic),(t==null?void 0:t.isArchived)!==void 0&&(a.is_archived=t.isArchived),Object.keys(a).length===0)throw new Error("No valid update options provided");const i=JSON.stringify(a);return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/repos/${n}/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await q(c,"update prompt"),c})).json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,n,s]=Ut(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/repos/${t}/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(i,"delete prompt"),i})).json()}async pullPromptCommit(e,t){const[n,s,a]=Ut(e),o=await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/commits/${n}/${s}/${a}${t!=null&&t.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await q(c,"pull prompt commit"),c})).json();return{owner:n,repo:s,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,t){const n=await this.pullPromptCommit(e,{includeModel:t==null?void 0:t.includeModel});return JSON.stringify(n.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some(s=>s!=="object")&&await this.updatePrompt(e,{description:t==null?void 0:t.description,readme:t==null?void 0:t.readme,tags:t==null?void 0:t.tags,isPublic:t==null?void 0:t.isPublic}):await this.createPrompt(e,{description:t==null?void 0:t.description,readme:t==null?void 0:t.readme,tags:t==null?void 0:t.tags,isPublic:t==null?void 0:t.isPublic}),t!=null&&t.object?await this.createCommit(e,t==null?void 0:t.object,{parentCommitHash:t==null?void 0:t.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){const{sourceApiUrl:n=this.apiUrl,datasetName:s}=t,[a,i]=this.parseTokenOrUrl(e,n),o=new tn({apiUrl:a,apiKey:"placeholder"}),c=await o.readSharedDataset(i),u=s||c.name;try{if(await this.hasDataset({datasetId:u})){console.log(`Dataset ${u} already exists in your tenant. Skipping.`);return}}catch{}const l=await o.listSharedExamples(i),d=await this.createDataset(u,{description:c.description,dataType:c.data_type||"kv",inputsSchema:c.inputs_schema_definition??void 0,outputsSchema:c.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map(f=>f.inputs),outputs:l.flatMap(f=>f.outputs?[f.outputs]:[]),datasetId:d.id})}catch(f){throw console.error(`An error occurred while creating dataset ${u}. You should delete it manually.`),f}}parseTokenOrUrl(e,t,n=2,s="dataset"){try{return re(e),[t,e]}catch{}try{const i=new URL(e).pathname.split("/").filter(o=>o!=="");if(i.length>=n){const o=i[i.length-n];return[t,o]}else throw new Error(`Invalid public ${s} URL: ${e}`)}catch{throw new Error(`Invalid public ${s} URL or token: ${e}`)}}async awaitPendingTraceBatches(){var e,t;if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:n})=>n),this.batchIngestCaller.queue.onIdle()]),this.langSmithToOTELTranslator!==void 0&&await((t=(e=yg())==null?void 0:e.DEFAULT_LANGSMITH_SPAN_PROCESSOR)==null?void 0:t.forceFlush())}}function Qo(r){return"dataset_id"in r||"dataset_name"in r}const Jw=r=>!!["TRACING_V2","TRACING"].find(t=>Ze(t)==="true"),Vt=Symbol.for("lc:context_variables"),Gs=Symbol.for("langsmith:replica_trace_roots");function ec(r,e){if(Vt in r)return r[Vt][e]}function Ww(r,e,t){const n=Vt in r?r[Vt]:{};n[e]=t,r[Vt]=n}const Dr=36,zr="6ba7b810-9dad-11d1-80b4-00c04fd430c8";function tc(r){const t=Object.keys(r).sort().map(n=>`${n}:${r[n]??""}`).join("|");return Br(t,zr)}function Kw(r){return r.replace(/[-:.]/g,"")}function Qu(r,e=1){const t=e.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(r).toISOString().slice(0,-1)}${t}Z`}function el(r,e,t=1){const n=Qu(r,t);return{dottedOrder:Kw(n)+e,microsecondPrecisionDatestring:n}}class Kn{constructor(e,t,n,s){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t,this.project_name=n,this.replicas=s}static fromHeader(e){const t=e.split(",");let n={},s=[],a,i;for(const o of t){const[c,u]=o.split("="),l=decodeURIComponent(u);c==="langsmith-metadata"?n=JSON.parse(l):c==="langsmith-tags"?s=l.split(","):c==="langsmith-project"?a=l:c==="langsmith-replicas"&&(i=JSON.parse(l))}return new Kn(n,s,a,i)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class He{constructor(e){var o;if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"distributedParentId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Xw(e)){Object.assign(this,{...e});return}const t=He.getDefaultConfig(),{metadata:n,...s}=e,a=s.client??He.getSharedClient(),i={...n,...(o=s==null?void 0:s.extra)==null?void 0:o.metadata};if(s.extra={...s.extra,metadata:i},"id"in s&&s.id==null&&delete s.id,Object.assign(this,{...t,...s,client:a}),this.execution_order??(this.execution_order=1),this.child_execution_order??(this.child_execution_order=1),this.dotted_order||(this._serialized_start_time=Qu(this.start_time,this.execution_order)),this.id||(this.id=ng(this._serialized_start_time??this.start_time)),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=tv(this.replicas),!this.dotted_order){const{dottedOrder:c}=el(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+c:this.dotted_order=c}}set metadata(e){var t;this.extra={...this.extra,metadata:{...(t=this.extra)==null?void 0:t.metadata,...e}}}get metadata(){var e;return(e=this.extra)==null?void 0:e.metadata}static getDefaultConfig(){const e=Date.now();return{run_type:"chain",project_name:$u(),child_runs:[],api_url:St("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:St("LANGCHAIN_API_KEY"),caller_options:{},start_time:e,serialized:{},inputs:{},extra:{}}}static getSharedClient(){return He.sharedClient||(He.sharedClient=new tn),He.sharedClient}createChild(e){var l,d,f,h,m,T,w;const t=this.child_execution_order+1,n=(l=this.replicas)==null?void 0:l.map(_=>{const{reroot:b,...v}=_;return v}),s=e.replicas??n,a=new He({...e,parent_run:this,project_name:this.project_name,replicas:s,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});Vt in this&&(a[Vt]=this[Vt]);const i=Symbol.for("lc:child_config"),o=((d=e.extra)==null?void 0:d[i])??this.extra[i];if(Qw(o)){const _={...o},b=Yw(_.callbacks)?(h=(f=_.callbacks).copy)==null?void 0:h.call(f):void 0;b&&(Object.assign(b,{_parentRunId:a.id}),(w=(T=(m=b.handlers)==null?void 0:m.find(tl))==null?void 0:T.updateFromRunTree)==null||w.call(T,a),_.callbacks=b),a.extra[i]=_}const c=new Set;let u=this;for(;u!=null&&!c.has(u.id);)c.add(u.id),u.child_execution_order=Math.max(u.child_execution_order,t),u=u.parent_run;return this.child_runs.push(a),a}async end(e,t,n=Date.now(),s){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??n,s&&Object.keys(s).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...s}}:{metadata:s})}_convertToCreate(e,t,n=!0){var o,c;const s=e.extra??{};if(((o=s==null?void 0:s.runtime)==null?void 0:o.library)===void 0&&(s.runtime||(s.runtime={}),t))for(const[u,l]of Object.entries(t))s.runtime[u]||(s.runtime[u]=l);let a,i;return n?(i=((c=e.parent_run)==null?void 0:c.id)??e.parent_run_id,a=[]):(a=e.child_runs.map(u=>this._convertToCreate(u,t,n)),i=void 0),{id:e.id,name:e.name,start_time:e._serialized_start_time??e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:s,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:a,parent_run_id:i,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_sliceParentId(e,t){if(t.dotted_order){const n=t.dotted_order.split(".");let s=null;for(let a=0;a<n.length;a++)if(n[a].slice(-Dr)===e){s=a;break}if(s!==null){const a=n.slice(s+1);t.dotted_order=a.join("."),a.length>0?t.trace_id=a[0].slice(-Dr):t.trace_id=t.id}}t.parent_run_id===e&&(t.parent_run_id=void 0)}_setReplicaTraceRoot(e,t){const n=ec(this,Gs)??{};n[e]=t,Ww(this,Gs,n);for(const s of this.child_runs)s._setReplicaTraceRoot(e,t)}_remapForProject(e){const{projectName:t,runtimeEnv:n,excludeChildRuns:s=!0,reroot:a=!1,distributedParentId:i,apiUrl:o,apiKey:c,workspaceId:u}=e,l=this._convertToCreate(this,n,s);if(t===this.project_name)return{...l,session_name:t};if(a){if(i)this._sliceParentId(i,l);else if(l.parent_run_id=void 0,l.dotted_order){const b=l.dotted_order.split(".");b.length>0&&(l.dotted_order=b[b.length-1],l.trace_id=l.id)}const _=tc({projectName:t,apiUrl:o,apiKey:c,workspaceId:u});this._setReplicaTraceRoot(_,l.id)}let d;if(!a){const _=ec(this,Gs)??{},b=tc({projectName:t,apiUrl:o,apiKey:c,workspaceId:u});if(d=_[b],d&&(l.trace_id=d,l.dotted_order)){const v=l.dotted_order.split(".");let O=null;for(let x=0;x<v.length;x++)if(v[x].slice(-Dr)===d){O=x;break}if(O!==null){const x=v.slice(O);l.dotted_order=x.join(".")}}}const f=l.id,h=Br(`${f}:${t}`,zr);let m;l.trace_id?m=Br(`${l.trace_id}:${t}`,zr):m=h;let T;l.parent_run_id&&(T=Br(`${l.parent_run_id}:${t}`,zr));let w;return l.dotted_order&&(w=l.dotted_order.split(".").map(v=>{const O=v.slice(-Dr),x=Br(`${O}:${t}`,zr);return v.slice(0,-Dr)+x}).join(".")),{...l,id:h,trace_id:m,parent_run_id:T,dotted_order:w,session_name:t}}async postRun(e=!0){try{const t=Lu();if(this.replicas&&this.replicas.length>0)for(const{projectName:n,apiKey:s,apiUrl:a,workspaceId:i,reroot:o}of this.replicas){const c=this._remapForProject({projectName:n??this.project_name,runtimeEnv:t,excludeChildRuns:!0,reroot:o,distributedParentId:this.distributedParentId,apiUrl:a,apiKey:s,workspaceId:i});await this.client.createRun(c,{apiKey:s,apiUrl:a,workspaceId:i})}else{const n=this._convertToCreate(this,t,e);await this.client.createRun(n)}if(!e){la("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const n of this.child_runs)await n.postRun(!1)}}catch(t){console.error(`Error in postRun for run ${this.id}:`,t)}}async patchRun(e){var t;if(this.replicas&&this.replicas.length>0)for(const{projectName:n,apiKey:s,apiUrl:a,workspaceId:i,updates:o,reroot:c}of this.replicas){const u=this._remapForProject({projectName:n??this.project_name,runtimeEnv:void 0,excludeChildRuns:!0,reroot:c,distributedParentId:this.distributedParentId,apiUrl:a,apiKey:s,workspaceId:i}),l={id:u.id,name:u.name,run_type:u.run_type,start_time:u.start_time,outputs:u.outputs,error:u.error,parent_run_id:u.parent_run_id,session_name:u.session_name,reference_example_id:u.reference_example_id,end_time:u.end_time,dotted_order:u.dotted_order,trace_id:u.trace_id,events:u.events,tags:u.tags,extra:u.extra,attachments:this.attachments,...o};e!=null&&e.excludeInputs||(l.inputs=u.inputs),await this.client.updateRun(u.id,l,{apiKey:s,apiUrl:a,workspaceId:i})}else try{const n={name:this.name,run_type:this.run_type,start_time:this._serialized_start_time??this.start_time,end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:((t=this.parent_run)==null?void 0:t.id)??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};e!=null&&e.excludeInputs||(n.inputs=this.inputs),await this.client.updateRun(this.id,n)}catch(n){console.error(`Error in patchRun for run ${this.id}`,n)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),typeof e=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:e}):this.events.push({...e,time:e.time??new Date().toISOString()})}static fromRunnableConfig(e,t){var u,l,d,f;const n=e==null?void 0:e.callbacks;let s,a,i,o=Jw();if(n){const h=((u=n==null?void 0:n.getParentRunId)==null?void 0:u.call(n))??"",m=(l=n==null?void 0:n.handlers)==null?void 0:l.find(T=>(T==null?void 0:T.name)=="langchain_tracer");s=(d=m==null?void 0:m.getRun)==null?void 0:d.call(m,h),a=m==null?void 0:m.projectName,i=m==null?void 0:m.client,o=o||!!m}return s?new He({name:s.name,id:s.id,trace_id:s.trace_id,dotted_order:s.dotted_order,client:i,tracingEnabled:o,project_name:a,tags:[...new Set(((s==null?void 0:s.tags)??[]).concat((e==null?void 0:e.tags)??[]))],extra:{metadata:{...(f=s==null?void 0:s.extra)==null?void 0:f.metadata,...e==null?void 0:e.metadata}}}).createChild(t):new He({...t,client:i,tracingEnabled:o,project_name:a})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){var l;const n="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,s=n["langsmith-trace"];if(!s||typeof s!="string")return;const a=s.trim(),i=a.split(".").map(d=>{const[f,h]=d.split("Z");return{strTime:f,time:Date.parse(f+"Z"),uuid:h}}),o=i[0].uuid,c={...t,name:(t==null?void 0:t.name)??"parent",run_type:(t==null?void 0:t.run_type)??"chain",start_time:(t==null?void 0:t.start_time)??Date.now(),id:(l=i.at(-1))==null?void 0:l.uuid,trace_id:o,dotted_order:a};if(n.baggage&&typeof n.baggage=="string"){const d=Kn.fromHeader(n.baggage);c.metadata=d.metadata,c.tags=d.tags,c.project_name=d.project_name,c.replicas=d.replicas}const u=new He(c);return u.distributedParentId=u.id,u}toHeaders(e){var n;const t={"langsmith-trace":this.dotted_order,baggage:new Kn((n=this.extra)==null?void 0:n.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(const[s,a]of Object.entries(t))e.set(s,a);return t}}Object.defineProperty(He,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function Xw(r){return r!=null&&typeof r.createChild=="function"&&typeof r.postRun=="function"}function tl(r){return typeof r=="object"&&r!=null&&typeof r.name=="string"&&r.name==="langchain_tracer"}function rc(r){return Array.isArray(r)&&r.some(e=>tl(e))}function Yw(r){return typeof r=="object"&&r!=null&&Array.isArray(r.handlers)}function Qw(r){var e;return r!=null&&typeof r.callbacks=="object"&&(rc((e=r.callbacks)==null?void 0:e.handlers)||rc(r.callbacks))}function ev(){const r=St("LANGSMITH_RUNS_ENDPOINTS");if(!r)return[];try{const e=JSON.parse(r);if(Array.isArray(e)){const t=[];for(const n of e){if(typeof n!="object"||n===null){console.warn(`Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got ${typeof n}`);continue}if(typeof n.api_url!="string"){console.warn(`Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_url}`);continue}if(typeof n.api_key!="string"){console.warn(`Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_key}`);continue}t.push({apiUrl:n.api_url.replace(/\/$/,""),apiKey:n.api_key})}return t}else if(typeof e=="object"&&e!==null){rv(e);const t=[];for(const[n,s]of Object.entries(e)){const a=n.replace(/\/$/,"");if(typeof s=="string")t.push({apiUrl:a,apiKey:s});else{console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${n}: expected string, got ${typeof s}`);continue}}return t}else return console.warn(`Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got ${typeof e}`),[]}catch(e){if(Pw(e))throw e;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}function tv(r){return r?r.map(e=>Array.isArray(e)?{projectName:e[0],updates:e[1]}:e):ev()}function rv(r){if(Object.keys(r).length>0&&Ze("ENDPOINT"))throw new Nw}var nv={};he(nv,{BaseTracer:()=>Lr,isBaseTracer:()=>yr});const sv=r=>{if(r)return r.events=r.events??[],r.child_runs=r.child_runs??[],r};function ha(r,e){if(r)return new He({...r,start_time:r._serialized_start_time??r.start_time,parent_run:ha(e),child_runs:r.child_runs.map(t=>ha(t)).filter(t=>t!==void 0),extra:{...r.extra,runtime:Iu()},tracingEnabled:!1})}function qs(r,e){return r&&!Array.isArray(r)&&typeof r=="object"?r:{[e]:r}}function yr(r){return typeof r._addRunToRunMap=="function"}var Lr=class extends hn{constructor(e){super(...arguments);y(this,"runMap",new Map);y(this,"runTreeMap",new Map);y(this,"usesRunTreeMap",!1)}copy(){return this}getRunById(e){if(e!==void 0)return this.usesRunTreeMap?sv(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const{dottedOrder:t,microsecondPrecisionDatestring:n}=el(new Date(e.start_time).getTime(),e.id,e.execution_order),s={...e},a=this.getRunById(s.parent_run_id);if(s.parent_run_id!==void 0?a&&(this._addChildRun(a,s),a.child_execution_order=Math.max(a.child_execution_order,s.child_execution_order),s.trace_id=a.trace_id,a.dotted_order!==void 0&&(s.dotted_order=[a.dotted_order,t].join("."),s._serialized_start_time=n)):(s.trace_id=s.id,s.dotted_order=t,s._serialized_start_time=n),this.usesRunTreeMap){const i=ha(s,a);i!==void 0&&this.runTreeMap.set(s.id,i)}else this.runMap.set(s.id,s);return s}async _endTrace(e){var n;const t=e.parent_run_id!==void 0&&this.getRunById(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),await((n=this.onRunUpdate)==null?void 0:n.call(this,e)),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){const t=e!==void 0&&this.getRunById(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,n,s,a,i,o,c){const u=this._getExecutionOrder(s),l=Date.now(),d=o?{...a,metadata:o}:a,f={id:n,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:u,child_runs:[],child_execution_order:u,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(f)}async handleLLMStart(e,t,n,s,a,i,o,c){var l,d;const u=this.getRunById(n)??this._createRunForLLMStart(e,t,n,s,a,i,o,c);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onLLMStart)==null?void 0:d.call(this,u)),u}_createRunForChatModelStart(e,t,n,s,a,i,o,c){const u=this._getExecutionOrder(s),l=Date.now(),d=o?{...a,metadata:o}:a,f={id:n,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:u,child_runs:[],child_execution_order:u,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(f)}async handleChatModelStart(e,t,n,s,a,i,o,c){var l,d;const u=this.getRunById(n)??this._createRunForChatModelStart(e,t,n,s,a,i,o,c);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onLLMStart)==null?void 0:d.call(this,u)),u}async handleLLMEnd(e,t,n,s,a){var o;const i=this.getRunById(t);if(!i||(i==null?void 0:i.run_type)!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.outputs=e,i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...a},await((o=this.onLLMEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleLLMError(e,t,n,s,a){var o;const i=this.getRunById(t);if(!i||(i==null?void 0:i.run_type)!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...a},await((o=this.onLLMError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}_createRunForChainStart(e,t,n,s,a,i,o,c){const u=this._getExecutionOrder(s),l=Date.now(),d={id:n,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:u,child_execution_order:u,run_type:o??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(d)}async handleChainStart(e,t,n,s,a,i,o,c){var l,d;const u=this.getRunById(n)??this._createRunForChainStart(e,t,n,s,a,i,o,c);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onChainStart)==null?void 0:d.call(this,u)),u}async handleChainEnd(e,t,n,s,a){var o;const i=this.getRunById(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=qs(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(i.inputs=qs(a.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleChainError(e,t,n,s,a){var o;const i=this.getRunById(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(i.inputs=qs(a.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}_createRunForToolStart(e,t,n,s,a,i,o){const c=this._getExecutionOrder(s),u=Date.now(),l={id:n,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{input:t},execution_order:c,child_execution_order:c,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(l)}async handleToolStart(e,t,n,s,a,i,o){var u,l;const c=this.getRunById(n)??this._createRunForToolStart(e,t,n,s,a,i,o);return await((u=this.onRunCreate)==null?void 0:u.call(this,c)),await((l=this.onToolStart)==null?void 0:l.call(this,c)),c}async handleToolEnd(e,t){var s;const n=this.getRunById(t);if(!n||(n==null?void 0:n.run_type)!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await((s=this.onToolEnd)==null?void 0:s.call(this,n)),await this._endTrace(n),n}async handleToolError(e,t){var s;const n=this.getRunById(t);if(!n||(n==null?void 0:n.run_type)!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await((s=this.onToolError)==null?void 0:s.call(this,n)),await this._endTrace(n),n}async handleAgentAction(e,t){var a;const n=this.getRunById(t);if(!n||(n==null?void 0:n.run_type)!=="chain")return;const s=n;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((a=this.onAgentAction)==null?void 0:a.call(this,n))}async handleAgentEnd(e,t){var s;const n=this.getRunById(t);!n||(n==null?void 0:n.run_type)!=="chain"||(n.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentEnd)==null?void 0:s.call(this,n)))}_createRunForRetrieverStart(e,t,n,s,a,i,o){const c=this._getExecutionOrder(s),u=Date.now(),l={id:n,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{query:t},execution_order:c,child_execution_order:c,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,t,n,s,a,i,o){var u,l;const c=this.getRunById(n)??this._createRunForRetrieverStart(e,t,n,s,a,i,o);return await((u=this.onRunCreate)==null?void 0:u.call(this,c)),await((l=this.onRetrieverStart)==null?void 0:l.call(this,c)),c}async handleRetrieverEnd(e,t){var s;const n=this.getRunById(t);if(!n||(n==null?void 0:n.run_type)!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await((s=this.onRetrieverEnd)==null?void 0:s.call(this,n)),await this._endTrace(n),n}async handleRetrieverError(e,t){var s;const n=this.getRunById(t);if(!n||(n==null?void 0:n.run_type)!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await((s=this.onRetrieverError)==null?void 0:s.call(this,n)),await this._endTrace(n),n}async handleText(e,t){var s;const n=this.getRunById(t);!n||(n==null?void 0:n.run_type)!=="chain"||(n.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((s=this.onText)==null?void 0:s.call(this,n)))}async handleLLMNewToken(e,t,n,s,a,i){var c;const o=this.getRunById(n);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i==null?void 0:i.chunk}}),await((c=this.onLLMNewToken)==null?void 0:c.call(this,o,e,{chunk:i==null?void 0:i.chunk})),o}},pi={exports:{}};pi.exports;(function(r){const t=(a=0)=>i=>`\x1B[${38+a};5;${i}m`,n=(a=0)=>(i,o,c)=>`\x1B[${38+a};2;${i};${o};${c}m`;function s(){const a=new Map,i={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};i.color.gray=i.color.blackBright,i.bgColor.bgGray=i.bgColor.bgBlackBright,i.color.grey=i.color.blackBright,i.bgColor.bgGrey=i.bgColor.bgBlackBright;for(const[o,c]of Object.entries(i)){for(const[u,l]of Object.entries(c))i[u]={open:`\x1B[${l[0]}m`,close:`\x1B[${l[1]}m`},c[u]=i[u],a.set(l[0],l[1]);Object.defineProperty(i,o,{value:c,enumerable:!1})}return Object.defineProperty(i,"codes",{value:a,enumerable:!1}),i.color.close="\x1B[39m",i.bgColor.close="\x1B[49m",i.color.ansi256=t(),i.color.ansi16m=n(),i.bgColor.ansi256=t(10),i.bgColor.ansi16m=n(10),Object.defineProperties(i,{rgbToAnsi256:{value:(o,c,u)=>o===c&&c===u?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(c/255*5)+Math.round(u/255*5),enumerable:!1},hexToRgb:{value:o=>{const c=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!c)return[0,0,0];let{colorString:u}=c.groups;u.length===3&&(u=u.split("").map(d=>d+d).join(""));const l=Number.parseInt(u,16);return[l>>16&255,l>>8&255,l&255]},enumerable:!1},hexToAnsi256:{value:o=>i.rgbToAnsi256(...i.hexToRgb(o)),enumerable:!1}}),i}Object.defineProperty(r,"exports",{enumerable:!0,get:s})})(pi);var av=pi.exports;const rl=Oc(av);var iv={};he(iv,{ConsoleCallbackHandler:()=>pa});function Fe(r,e){return`${r.open}${e}${r.close}`}function et(r,e){try{return JSON.stringify(r,null,2)}catch{return e}}function nc(r){return typeof r=="string"?r.trim():r==null?r:et(r,r.toString())}function Ft(r){if(!r.end_time)return"";const e=r.end_time-r.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:qe}=rl;var pa=class extends Lr{constructor(){super(...arguments);y(this,"name","console_callback_handler")}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let n=e;for(;n.parent_run_id;){const s=this.runMap.get(n.parent_run_id);if(s)t.push(s),n=s;else break}return t}getBreadcrumbs(e){const n=[...this.getParents(e).reverse(),e].map((s,a,i)=>{const o=`${s.execution_order}:${s.run_type}:${s.name}`;return a===i.length-1?Fe(rl.bold,o):o}).join(" > ");return Fe(qe.grey,n)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${Fe(qe.green,"[chain/start]")} [${t}] Entering Chain run with input: ${et(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Fe(qe.cyan,"[chain/end]")} [${t}] [${Ft(e)}] Exiting Chain run with output: ${et(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${Fe(qe.red,"[chain/error]")} [${t}] [${Ft(e)}] Chain run errored with error: ${et(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${Fe(qe.green,"[llm/start]")} [${t}] Entering LLM run with input: ${et(n,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Fe(qe.cyan,"[llm/end]")} [${t}] [${Ft(e)}] Exiting LLM run with output: ${et(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${Fe(qe.red,"[llm/error]")} [${t}] [${Ft(e)}] LLM run errored with error: ${et(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${Fe(qe.green,"[tool/start]")} [${t}] Entering Tool run with input: "${nc(e.inputs.input)}"`)}onToolEnd(e){var n;const t=this.getBreadcrumbs(e);console.log(`${Fe(qe.cyan,"[tool/end]")} [${t}] [${Ft(e)}] Exiting Tool run with output: "${nc((n=e.outputs)==null?void 0:n.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${Fe(qe.red,"[tool/error]")} [${t}] [${Ft(e)}] Tool run errored with error: ${et(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${Fe(qe.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${et(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Fe(qe.cyan,"[retriever/end]")} [${t}] [${Ft(e)}] Exiting Retriever run with output: ${et(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${Fe(qe.red,"[retriever/error]")} [${t}] [${Ft(e)}] Retriever run errored with error: ${et(e.error,"[error]")}`)}onAgentAction(e){const t=e,n=this.getBreadcrumbs(e);console.log(`${Fe(qe.blue,"[agent/action]")} [${n}] Agent selected action: ${et(t.actions[t.actions.length-1],"[action]")}`)}};let Hs;const nl=()=>{if(Hs===void 0){const r=Ot("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};Hs=new tn(r)}return Hs};let ov=class{getStore(){}run(e,t){return t()}};const Vs=Symbol.for("ls:tracing_async_local_storage"),cv=new ov;let uv=class{getInstance(){return globalThis[Vs]??cv}initializeGlobalInstance(e){globalThis[Vs]===void 0&&(globalThis[Vs]=e)}};const lv=new uv;function dv(r=!1){const e=lv.getInstance().getStore();if(!r&&e===void 0)throw new Error(`Could not get the current run tree.

Please make sure you are calling this method within a traceable function and that tracing is enabled.`);return e}function mi(r){return typeof r=="function"&&"langsmith:traceable"in r}var fv={};he(fv,{LangChainTracer:()=>Un});var Un=class sl extends Lr{constructor(t={}){super(t);y(this,"name","langchain_tracer");y(this,"projectName");y(this,"exampleId");y(this,"client");y(this,"replicas");y(this,"usesRunTreeMap",!0);const{exampleId:n,projectName:s,client:a,replicas:i}=t;this.projectName=s??$u(),this.replicas=i,this.exampleId=n,this.client=a??nl();const o=sl.getTraceableRunTree();o&&this.updateFromRunTree(o)}async persistRun(t){}async onRunCreate(t){const n=this.getRunTreeWithTracingConfig(t.id);await(n==null?void 0:n.postRun())}async onRunUpdate(t){const n=this.getRunTreeWithTracingConfig(t.id);await(n==null?void 0:n.patchRun())}getRun(t){return this.runTreeMap.get(t)}updateFromRunTree(t){this.runTreeMap.set(t.id,t);let n=t;const s=new Set;for(;n.parent_run&&!(s.has(n.id)||(s.add(n.id),!n.parent_run));)n=n.parent_run;s.clear();const a=[n];for(;a.length>0;){const i=a.shift();!i||s.has(i.id)||(s.add(i.id),this.runTreeMap.set(i.id,i),i.child_runs&&a.push(...i.child_runs))}this.client=t.client??this.client,this.replicas=t.replicas??this.replicas,this.projectName=t.project_name??this.projectName,this.exampleId=t.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(t){const n=this.runTreeMap.get(t);if(n)return new He({...n,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return dv(!0)}catch{return}}};const al=Symbol.for("ls:tracing_async_local_storage"),Wr=Symbol.for("lc:context_variables"),hv=r=>{globalThis[al]=r},rn=()=>globalThis[al];let ar;function pv(){const r="default"in At?At.default:At;return new r({autoStart:!0,concurrency:1})}function mv(){return typeof ar>"u"&&(ar=pv()),ar}async function ke(r,e){if(e===!0){const t=rn();t!==void 0?await t.run(void 0,async()=>r()):await r()}else ar=mv(),ar.add(async()=>{const t=rn();t!==void 0?await t.run(void 0,async()=>r()):await r()})}async function gv(){const r=nl();await Promise.allSettled([typeof ar<"u"?ar.onIdle():Promise.resolve(),r.awaitPendingTraceBatches()])}var yv={};he(yv,{awaitAllCallbacks:()=>gv,consumeCallback:()=>ke});const _v=r=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>Ot(t)==="true");function il(r){var n;const e=rn();if(e===void 0)return;const t=e.getStore();return(n=t==null?void 0:t[Wr])==null?void 0:n[r]}const wv=Symbol("lc:configure_hooks"),vv=()=>il(wv)||[];var bv={};he(bv,{BaseCallbackManager:()=>ol,BaseRunManager:()=>mn,CallbackManager:()=>Tt,CallbackManagerForChainRun:()=>ul,CallbackManagerForLLMRun:()=>ma,CallbackManagerForRetrieverRun:()=>cl,CallbackManagerForToolRun:()=>ll,ensureHandler:()=>nn,parseCallbackConfigArg:()=>Ev});function Ev(r){return r?Array.isArray(r)||"name"in r?{callbacks:r}:r:{}}var ol=class{setHandler(r){return this.setHandlers([r])}},mn=class{constructor(r,e,t,n,s,a,i,o){this.runId=r,this.handlers=e,this.inheritableHandlers=t,this.tags=n,this.inheritableTags=s,this.metadata=a,this.inheritableMetadata=i,this._parentRunId=o}get parentRunId(){return this._parentRunId}async handleText(r){await Promise.all(this.handlers.map(e=>ke(async()=>{var t;try{await((t=e.handleText)==null?void 0:t.call(e,r,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleText: ${n}`),e.raiseError)throw n}},e.awaitHandlers)))}async handleCustomEvent(r,e,t,n,s){await Promise.all(this.handlers.map(a=>ke(async()=>{var i;try{await((i=a.handleCustomEvent)==null?void 0:i.call(a,r,e,this.runId,this.tags,this.metadata))}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleCustomEvent: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}},cl=class extends mn{getChild(r){const e=new Tt(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),r&&e.addTags([r],!1),e}async handleRetrieverEnd(r){await Promise.all(this.handlers.map(e=>ke(async()=>{var t;if(!e.ignoreRetriever)try{await((t=e.handleRetrieverEnd)==null?void 0:t.call(e,r,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetriever`),e.raiseError)throw n}},e.awaitHandlers)))}async handleRetrieverError(r){await Promise.all(this.handlers.map(e=>ke(async()=>{var t;if(!e.ignoreRetriever)try{await((t=e.handleRetrieverError)==null?void 0:t.call(e,r,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetrieverError: ${n}`),e.raiseError)throw r}},e.awaitHandlers)))}},ma=class extends mn{async handleLLMNewToken(r,e,t,n,s,a){await Promise.all(this.handlers.map(i=>ke(async()=>{var o;if(!i.ignoreLLM)try{await((o=i.handleLLMNewToken)==null?void 0:o.call(i,r,e??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,a))}catch(c){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMNewToken: ${c}`),i.raiseError)throw c}},i.awaitHandlers)))}async handleLLMError(r,e,t,n,s){await Promise.all(this.handlers.map(a=>ke(async()=>{var i;if(!a.ignoreLLM)try{await((i=a.handleLLMError)==null?void 0:i.call(a,r,this.runId,this._parentRunId,this.tags,s))}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMError: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}async handleLLMEnd(r,e,t,n,s){await Promise.all(this.handlers.map(a=>ke(async()=>{var i;if(!a.ignoreLLM)try{await((i=a.handleLLMEnd)==null?void 0:i.call(a,r,this.runId,this._parentRunId,this.tags,s))}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMEnd: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}},ul=class extends mn{getChild(r){const e=new Tt(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),r&&e.addTags([r],!1),e}async handleChainError(r,e,t,n,s){await Promise.all(this.handlers.map(a=>ke(async()=>{var i;if(!a.ignoreChain)try{await((i=a.handleChainError)==null?void 0:i.call(a,r,this.runId,this._parentRunId,this.tags,s))}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainError: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}async handleChainEnd(r,e,t,n,s){await Promise.all(this.handlers.map(a=>ke(async()=>{var i;if(!a.ignoreChain)try{await((i=a.handleChainEnd)==null?void 0:i.call(a,r,this.runId,this._parentRunId,this.tags,s))}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainEnd: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}async handleAgentAction(r){await Promise.all(this.handlers.map(e=>ke(async()=>{var t;if(!e.ignoreAgent)try{await((t=e.handleAgentAction)==null?void 0:t.call(e,r,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentAction: ${n}`),e.raiseError)throw n}},e.awaitHandlers)))}async handleAgentEnd(r){await Promise.all(this.handlers.map(e=>ke(async()=>{var t;if(!e.ignoreAgent)try{await((t=e.handleAgentEnd)==null?void 0:t.call(e,r,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentEnd: ${n}`),e.raiseError)throw n}},e.awaitHandlers)))}},ll=class extends mn{getChild(r){const e=new Tt(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),r&&e.addTags([r],!1),e}async handleToolError(r){await Promise.all(this.handlers.map(e=>ke(async()=>{var t;if(!e.ignoreAgent)try{await((t=e.handleToolError)==null?void 0:t.call(e,r,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolError: ${n}`),e.raiseError)throw n}},e.awaitHandlers)))}async handleToolEnd(r){await Promise.all(this.handlers.map(e=>ke(async()=>{var t;if(!e.ignoreAgent)try{await((t=e.handleToolEnd)==null?void 0:t.call(e,r,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolEnd: ${n}`),e.raiseError)throw n}},e.awaitHandlers)))}},Tt=class Gr extends ol{constructor(t,n){super();y(this,"handlers",[]);y(this,"inheritableHandlers",[]);y(this,"tags",[]);y(this,"inheritableTags",[]);y(this,"metadata",{});y(this,"inheritableMetadata",{});y(this,"name","callback_manager");y(this,"_parentRunId");this.handlers=(n==null?void 0:n.handlers)??this.handlers,this.inheritableHandlers=(n==null?void 0:n.inheritableHandlers)??this.inheritableHandlers,this.tags=(n==null?void 0:n.tags)??this.tags,this.inheritableTags=(n==null?void 0:n.inheritableTags)??this.inheritableTags,this.metadata=(n==null?void 0:n.metadata)??this.metadata,this.inheritableMetadata=(n==null?void 0:n.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=t}getParentRunId(){return this._parentRunId}async handleLLMStart(t,n,s=void 0,a=void 0,i=void 0,o=void 0,c=void 0,u=void 0){return Promise.all(n.map(async(l,d)=>{const f=d===0&&s?s:Ve();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return yr(h)&&h._createRunForLLMStart(t,[l],f,this._parentRunId,i,this.tags,this.metadata,u),ke(async()=>{var m;try{await((m=h.handleLLMStart)==null?void 0:m.call(h,t,[l],f,this._parentRunId,i,this.tags,this.metadata,u))}catch(T){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${T}`),h.raiseError)throw T}},h.awaitHandlers)})),new ma(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(t,n,s=void 0,a=void 0,i=void 0,o=void 0,c=void 0,u=void 0){return Promise.all(n.map(async(l,d)=>{const f=d===0&&s?s:Ve();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return yr(h)&&h._createRunForChatModelStart(t,[l],f,this._parentRunId,i,this.tags,this.metadata,u),ke(async()=>{var m,T;try{if(h.handleChatModelStart)await((m=h.handleChatModelStart)==null?void 0:m.call(h,t,[l],f,this._parentRunId,i,this.tags,this.metadata,u));else if(h.handleLLMStart){const w=ei(l);await((T=h.handleLLMStart)==null?void 0:T.call(h,t,[w],f,this._parentRunId,i,this.tags,this.metadata,u))}}catch(w){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${w}`),h.raiseError)throw w}},h.awaitHandlers)})),new ma(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(t,n,s=Ve(),a=void 0,i=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreChain)return yr(u)&&u._createRunForChainStart(t,n,s,this._parentRunId,this.tags,this.metadata,a,c),ke(async()=>{var l;try{await((l=u.handleChainStart)==null?void 0:l.call(u,t,n,s,this._parentRunId,this.tags,this.metadata,a,c))}catch(d){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleChainStart: ${d}`),u.raiseError)throw d}},u.awaitHandlers)})),new ul(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(t,n,s=Ve(),a=void 0,i=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreAgent)return yr(u)&&u._createRunForToolStart(t,n,s,this._parentRunId,this.tags,this.metadata,c),ke(async()=>{var l;try{await((l=u.handleToolStart)==null?void 0:l.call(u,t,n,s,this._parentRunId,this.tags,this.metadata,c))}catch(d){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleToolStart: ${d}`),u.raiseError)throw d}},u.awaitHandlers)})),new ll(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(t,n,s=Ve(),a=void 0,i=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreRetriever)return yr(u)&&u._createRunForRetrieverStart(t,n,s,this._parentRunId,this.tags,this.metadata,c),ke(async()=>{var l;try{await((l=u.handleRetrieverStart)==null?void 0:l.call(u,t,n,s,this._parentRunId,this.tags,this.metadata,c))}catch(d){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${d}`),u.raiseError)throw d}},u.awaitHandlers)})),new cl(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(t,n,s,a,i){await Promise.all(this.handlers.map(o=>ke(async()=>{var c;if(!o.ignoreCustomEvent)try{await((c=o.handleCustomEvent)==null?void 0:c.call(o,t,n,s,this.tags,this.metadata))}catch(u){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleCustomEvent: ${u}`),o.raiseError)throw u}},o.awaitHandlers)))}addHandler(t,n=!0){this.handlers.push(t),n&&this.inheritableHandlers.push(t)}removeHandler(t){this.handlers=this.handlers.filter(n=>n!==t),this.inheritableHandlers=this.inheritableHandlers.filter(n=>n!==t)}setHandlers(t,n=!0){this.handlers=[],this.inheritableHandlers=[];for(const s of t)this.addHandler(s,n)}addTags(t,n=!0){this.removeTags(t),this.tags.push(...t),n&&this.inheritableTags.push(...t)}removeTags(t){this.tags=this.tags.filter(n=>!t.includes(n)),this.inheritableTags=this.inheritableTags.filter(n=>!t.includes(n))}addMetadata(t,n=!0){this.metadata={...this.metadata,...t},n&&(this.inheritableMetadata={...this.inheritableMetadata,...t})}removeMetadata(t){for(const n of Object.keys(t))delete this.metadata[n],delete this.inheritableMetadata[n]}copy(t=[],n=!0){const s=new Gr(this._parentRunId);for(const a of this.handlers){const i=this.inheritableHandlers.includes(a);s.addHandler(a,i)}for(const a of this.tags){const i=this.inheritableTags.includes(a);s.addTags([a],i)}for(const a of Object.keys(this.metadata)){const i=Object.keys(this.inheritableMetadata).includes(a);s.addMetadata({[a]:this.metadata[a]},i)}for(const a of t)s.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===a.name)||s.addHandler(a,n);return s}static fromHandlers(t){class n extends hn{constructor(){super();y(this,"name",Ve());Object.assign(this,t)}}const s=new this;return s.addHandler(new n),s}static configure(t,n,s,a,i,o,c){return this._configureSync(t,n,s,a,i,o,c)}static _configureSync(t,n,s,a,i,o,c){var h;let u;(t||n)&&(Array.isArray(t)||!t?(u=new Gr,u.setHandlers((t==null?void 0:t.map(nn))??[],!0)):u=t,u=u.copy(Array.isArray(n)?n.map(nn):n==null?void 0:n.handlers,!1));const l=Ot("LANGCHAIN_VERBOSE")==="true"||(c==null?void 0:c.verbose),d=((h=Un.getTraceableRunTree())==null?void 0:h.tracingEnabled)||_v(),f=d||(Ot("LANGCHAIN_TRACING")??!1);if(l||f){if(u||(u=new Gr),l&&!u.handlers.some(m=>m.name===pa.prototype.name)){const m=new pa;u.addHandler(m,!0)}if(f&&!u.handlers.some(m=>m.name==="langchain_tracer")&&d){const m=new Un;u.addHandler(m,!0)}if(d){const m=Un.getTraceableRunTree();if(m&&u._parentRunId===void 0){u._parentRunId=m.id;const T=u.handlers.find(w=>w.name==="langchain_tracer");T==null||T.updateFromRunTree(m)}}}for(const{contextVar:m,inheritable:T=!0,handlerClass:w,envVar:_}of vv()){const b=_&&Ot(_)==="true"&&w;let v;const O=m!==void 0?il(m):void 0;O&&ku(O)?v=O:b&&(v=new w({})),v!==void 0&&(u||(u=new Gr),u.handlers.some(x=>x.name===v.name)||u.addHandler(v,T))}return(s||a)&&u&&(u.addTags(s??[]),u.addTags(a??[],!1)),(i||o)&&u&&(u.addMetadata(i??{}),u.addMetadata(o??{},!1)),u}};function nn(r){return"name"in r?r:hn.fromMethods(r)}var dl=class{getStore(){}run(r,e){return e()}enterWith(r){}};const Tv=new dl,sc=Symbol.for("lc:child_config");var Sv=class{getInstance(){return rn()??Tv}getRunnableConfig(){var e,t;return(t=(e=this.getInstance().getStore())==null?void 0:e.extra)==null?void 0:t[sc]}runWithConfig(r,e,t){var u;const n=Tt._configureSync(r==null?void 0:r.callbacks,void 0,r==null?void 0:r.tags,void 0,r==null?void 0:r.metadata),s=this.getInstance(),a=s.getStore(),i=n==null?void 0:n.getParentRunId(),o=(u=n==null?void 0:n.handlers)==null?void 0:u.find(l=>(l==null?void 0:l.name)==="langchain_tracer");let c;return o&&i?c=o.getRunTreeWithTracingConfig(i):t||(c=new He({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[sc]:r}),a!==void 0&&a[Wr]!==void 0&&(c===void 0&&(c={}),c[Wr]=a[Wr]),s.run(c,e)}initializeGlobalInstance(r){rn()===void 0&&hv(r)}};const Lt=new Sv;var xv={};he(xv,{AsyncLocalStorageProviderSingleton:()=>Lt,MockAsyncLocalStorage:()=>dl,_CONTEXT_VARIABLES_KEY:()=>Wr});const Zs=25;async function Ke(r){return Tt._configureSync(r==null?void 0:r.callbacks,void 0,r==null?void 0:r.tags,void 0,r==null?void 0:r.metadata)}function ga(...r){const e={};for(const t of r.filter(n=>!!n))for(const n of Object.keys(t))if(n==="metadata")e[n]={...e[n],...t[n]};else if(n==="tags"){const s=e[n]??[];e[n]=[...new Set(s.concat(t[n]??[]))]}else if(n==="configurable")e[n]={...e[n],...t[n]};else if(n==="timeout")e.timeout===void 0?e.timeout=t.timeout:t.timeout!==void 0&&(e.timeout=Math.min(e.timeout,t.timeout));else if(n==="signal")e.signal===void 0?e.signal=t.signal:t.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,t.signal]):e.signal=t.signal);else if(n==="callbacks"){const s=e.callbacks,a=t.callbacks;if(Array.isArray(a))if(!s)e.callbacks=a;else if(Array.isArray(s))e.callbacks=s.concat(a);else{const i=s.copy();for(const o of a)i.addHandler(nn(o),!0);e.callbacks=i}else if(a)if(!s)e.callbacks=a;else if(Array.isArray(s)){const i=a.copy();for(const o of s)i.addHandler(nn(o),!0);e.callbacks=i}else e.callbacks=new Tt(a._parentRunId,{handlers:s.handlers.concat(a.handlers),inheritableHandlers:s.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(a.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(a.inheritableTags))),metadata:{...s.metadata,...a.metadata}})}else{const s=n;e[s]=t[s]??e[s]}return e}const Iv=new Set(["string","number","boolean"]);function de(r){var n;const e=Lt.getRunnableConfig();let t={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){const{runId:s,runName:a,...i}=e;t=Object.entries(i).reduce((o,[c,u])=>(u!==void 0&&(o[c]=u),o),t)}if(r&&(t=Object.entries(r).reduce((s,[a,i])=>(i!==void 0&&(s[a]=i),s),t)),t!=null&&t.configurable)for(const s of Object.keys(t.configurable))Iv.has(typeof t.configurable[s])&&!((n=t.metadata)!=null&&n[s])&&(t.metadata||(t.metadata={}),t.metadata[s]=t.configurable[s]);if(t.timeout!==void 0){if(t.timeout<=0)throw new Error("Timeout must be a positive number");const s=AbortSignal.timeout(t.timeout);t.signal!==void 0?"any"in AbortSignal&&(t.signal=AbortSignal.any([t.signal,s])):t.signal=s,delete t.timeout}return t}function be(r={},{callbacks:e,maxConcurrency:t,recursionLimit:n,runName:s,configurable:a,runId:i}={}){const o=de(r);return e!==void 0&&(delete o.runName,o.callbacks=e),n!==void 0&&(o.recursionLimit=n),t!==void 0&&(o.maxConcurrency=t),s!==void 0&&(o.runName=s),a!==void 0&&(o.configurable={...o.configurable,...a}),i!==void 0&&delete o.runId,o}function ur(r){if(r)return{configurable:r.configurable,recursionLimit:r.recursionLimit,callbacks:r.callbacks,tags:r.tags,metadata:r.metadata,maxConcurrency:r.maxConcurrency,timeout:r.timeout,signal:r.signal,store:r.store}}async function jt(r,e){if(e===void 0)return r;let t;return Promise.race([r.catch(n=>{if(!(e!=null&&e.aborted))throw n}),new Promise((n,s)=>{t=()=>{s(Xn(e))},e.addEventListener("abort",t),e.aborted&&s(Xn(e))})]).finally(()=>e.removeEventListener("abort",t))}function Xn(r){return(r==null?void 0:r.reason)instanceof Error?r.reason:typeof(r==null?void 0:r.reason)=="string"?new Error(r.reason):new Error("Aborted")}var Ov={};he(Ov,{AsyncGeneratorWithSetup:()=>hr,IterableReadableStream:()=>ft,atee:()=>gi,concat:()=>lr,pipeGeneratorWithSetup:()=>fl});var ft=class ya extends ReadableStream{constructor(){super(...arguments);y(this,"reader")}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const t=await this.reader.read();return t.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:t.value}}catch(t){throw this.reader.releaseLock(),t}}async return(){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}return{done:!0,value:void 0}}async throw(t){if(this.ensureReader(),this.locked){const n=this.reader.cancel();this.reader.releaseLock(),await n}throw t}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(t){const n=t.getReader();return new ya({start(s){return a();function a(){return n.read().then(({done:i,value:o})=>{if(i){s.close();return}return s.enqueue(o),a()})}},cancel(){n.releaseLock()}})}static fromAsyncGenerator(t){return new ya({async pull(n){const{value:s,done:a}=await t.next();a&&n.close(),n.enqueue(s)},async cancel(n){await t.return(n)}})}};function gi(r,e=2){const t=Array.from({length:e},()=>[]);return t.map(async function*(s){for(;;)if(s.length===0){const a=await r.next();for(const i of t)i.push(a)}else{if(s[0].done)return;yield s.shift().value}})}function lr(r,e){if(Array.isArray(r)&&Array.isArray(e))return r.concat(e);if(typeof r=="string"&&typeof e=="string")return r+e;if(typeof r=="number"&&typeof e=="number")return r+e;if("concat"in r&&typeof r.concat=="function")return r.concat(e);if(typeof r=="object"&&typeof e=="object"){const t={...r};for(const[n,s]of Object.entries(e))n in t&&!Array.isArray(t[n])?t[n]=lr(t[n],s):t[n]=s;return t}else throw new Error(`Cannot concat ${typeof r} and ${typeof e}`)}var hr=class{constructor(r){y(this,"generator");y(this,"setup");y(this,"config");y(this,"signal");y(this,"firstResult");y(this,"firstResultUsed",!1);var e;this.generator=r.generator,this.config=r.config,this.signal=r.signal??((e=this.config)==null?void 0:e.signal),this.setup=new Promise((t,n)=>{Lt.runWithConfig(ur(r.config),async()=>{this.firstResult=r.generator.next(),r.startSetup?this.firstResult.then(r.startSetup).then(t,n):this.firstResult.then(s=>t(void 0),n)},!0)})}async next(...r){var e;return(e=this.signal)==null||e.throwIfAborted(),this.firstResultUsed?Lt.runWithConfig(ur(this.config),this.signal?async()=>jt(this.generator.next(...r),this.signal):async()=>this.generator.next(...r),!0):(this.firstResultUsed=!0,this.firstResult)}async return(r){return this.generator.return(r)}async throw(r){return this.generator.throw(r)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}};async function fl(r,e,t,n,...s){const a=new hr({generator:e,startSetup:t,signal:n}),i=await a.setup;return{output:r(a,i,...s),setup:i}}var Av={};he(Av,{ChatGenerationChunk:()=>an,GenerationChunk:()=>sn,RUN_KEY:()=>_a});const _a="__run";var sn=class hl{constructor(e){y(this,"text");y(this,"generationInfo");this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new hl({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},an=class pl extends sn{constructor(t){super(t);y(this,"message");this.message=t.message}concat(t){return new pl({text:this.text+t.text,generationInfo:{...this.generationInfo,...t.generationInfo},message:this.message.concat(t.message)})}};/*!
* https://github.com/Starcounter-Jack/JSON-Patch
* (c) 2017-2022 Joachim Wester
* MIT licensed
*/const kv=Object.prototype.hasOwnProperty;function wa(r,e){return kv.call(r,e)}function va(r){if(Array.isArray(r)){const t=new Array(r.length);for(let n=0;n<t.length;n++)t[n]=""+n;return t}if(Object.keys)return Object.keys(r);let e=[];for(let t in r)wa(r,t)&&e.push(t);return e}function tt(r){switch(typeof r){case"object":return JSON.parse(JSON.stringify(r));case"undefined":return null;default:return r}}function ba(r){let e=0;const t=r.length;let n;for(;e<t;){if(n=r.charCodeAt(e),n>=48&&n<=57){e++;continue}return!1}return!0}function rr(r){return r.indexOf("/")===-1&&r.indexOf("~")===-1?r:r.replace(/~/g,"~0").replace(/\//g,"~1")}function ml(r){return r.replace(/~1/g,"/").replace(/~0/g,"~")}function Ea(r){if(r===void 0)return!0;if(r){if(Array.isArray(r)){for(let t=0,n=r.length;t<n;t++)if(Ea(r[t]))return!0}else if(typeof r=="object"){const t=va(r),n=t.length;for(var e=0;e<n;e++)if(Ea(r[t[e]]))return!0}}return!1}function ac(r,e){const t=[r];for(const n in e){const s=typeof e[n]=="object"?JSON.stringify(e[n],null,2):e[n];typeof s<"u"&&t.push(`${n}: ${s}`)}return t.join(`
`)}var gl=class extends Error{constructor(r,e,t,n,s){super(ac(r,{name:e,index:t,operation:n,tree:s})),this.name=e,this.index=t,this.operation=n,this.tree=s,Object.setPrototypeOf(this,new.target.prototype),this.message=ac(r,{name:e,index:t,operation:n,tree:s})}},yl={};he(yl,{JsonPatchError:()=>Se,_areEquals:()=>on,applyOperation:()=>ir,applyPatch:()=>kr,applyReducer:()=>Cv,deepClone:()=>Rv,getValueByPointer:()=>Yn,validate:()=>_l,validator:()=>Qn});const Se=gl,Rv=tt,vr={add:function(r,e,t){return r[e]=this.value,{newDocument:t}},remove:function(r,e,t){var n=r[e];return delete r[e],{newDocument:t,removed:n}},replace:function(r,e,t){var n=r[e];return r[e]=this.value,{newDocument:t,removed:n}},move:function(r,e,t){let n=Yn(t,this.path);n&&(n=tt(n));const s=ir(t,{op:"remove",path:this.from}).removed;return ir(t,{op:"add",path:this.path,value:s}),{newDocument:t,removed:n}},copy:function(r,e,t){const n=Yn(t,this.from);return ir(t,{op:"add",path:this.path,value:tt(n)}),{newDocument:t}},test:function(r,e,t){return{newDocument:t,test:on(r[e],this.value)}},_get:function(r,e,t){return this.value=r[e],{newDocument:t}}};var $v={add:function(r,e,t){return ba(e)?r.splice(e,0,this.value):r[e]=this.value,{newDocument:t,index:e}},remove:function(r,e,t){var n=r.splice(e,1);return{newDocument:t,removed:n[0]}},replace:function(r,e,t){var n=r[e];return r[e]=this.value,{newDocument:t,removed:n}},move:vr.move,copy:vr.copy,test:vr.test,_get:vr._get};function Yn(r,e){if(e=="")return r;var t={op:"_get",path:e};return ir(r,t),t.value}function ir(r,e,t=!1,n=!0,s=!0,a=0){if(t&&(typeof t=="function"?t(e,0,r,e.path):Qn(e,0)),e.path===""){let i={newDocument:r};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=r,i;if(e.op==="move"||e.op==="copy")return i.newDocument=Yn(r,e.from),e.op==="move"&&(i.removed=r),i;if(e.op==="test"){if(i.test=on(r,e.value),i.test===!1)throw new Se("Test operation failed","TEST_OPERATION_FAILED",a,e,r);return i.newDocument=r,i}else{if(e.op==="remove")return i.removed=r,i.newDocument=null,i;if(e.op==="_get")return e.value=r,i;if(t)throw new Se("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,e,r);return i}}else{n||(r=tt(r));const o=(e.path||"").split("/");let c=r,u=1,l=o.length,d,f,h;for(typeof t=="function"?h=t:h=Qn;;){if(f=o[u],f&&f.indexOf("~")!=-1&&(f=ml(f)),s&&(f=="__proto__"||f=="prototype"&&u>0&&o[u-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(c[f]===void 0?d=o.slice(0,u).join("/"):u==l-1&&(d=e.path),d!==void 0&&h(e,0,r,d)),u++,Array.isArray(c)){if(f==="-")f=c.length;else{if(t&&!ba(f))throw new Se("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,e,r);ba(f)&&(f=~~f)}if(u>=l){if(t&&e.op==="add"&&f>c.length)throw new Se("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,e,r);const m=$v[e.op].call(e,c,f,r);if(m.test===!1)throw new Se("Test operation failed","TEST_OPERATION_FAILED",a,e,r);return m}}else if(u>=l){const m=vr[e.op].call(e,c,f,r);if(m.test===!1)throw new Se("Test operation failed","TEST_OPERATION_FAILED",a,e,r);return m}if(c=c[f],t&&u<l&&(!c||typeof c!="object"))throw new Se("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,e,r)}}}function kr(r,e,t,n=!0,s=!0){if(t&&!Array.isArray(e))throw new Se("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(r=tt(r));const a=new Array(e.length);for(let i=0,o=e.length;i<o;i++)a[i]=ir(r,e[i],t,!0,s,i),r=a[i].newDocument;return a.newDocument=r,a}function Cv(r,e,t){const n=ir(r,e);if(n.test===!1)throw new Se("Test operation failed","TEST_OPERATION_FAILED",t,e,r);return n.newDocument}function Qn(r,e,t,n){if(typeof r!="object"||r===null||Array.isArray(r))throw new Se("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,r,t);if(vr[r.op]){if(typeof r.path!="string")throw new Se("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,r,t);if(r.path.indexOf("/")!==0&&r.path.length>0)throw new Se('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,r,t);if((r.op==="move"||r.op==="copy")&&typeof r.from!="string")throw new Se("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,r,t);if((r.op==="add"||r.op==="replace"||r.op==="test")&&r.value===void 0)throw new Se("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,r,t);if((r.op==="add"||r.op==="replace"||r.op==="test")&&Ea(r.value))throw new Se("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,r,t);if(t){if(r.op=="add"){var s=r.path.split("/").length,a=n.split("/").length;if(s!==a+1&&s!==a)throw new Se("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,r,t)}else if(r.op==="replace"||r.op==="remove"||r.op==="_get"){if(r.path!==n)throw new Se("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,r,t)}else if(r.op==="move"||r.op==="copy"){var i={op:"_get",path:r.from,value:void 0},o=_l([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new Se("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,r,t)}}}else throw new Se("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,r,t)}function _l(r,e,t){try{if(!Array.isArray(r))throw new Se("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)kr(tt(e),tt(r),t||!0);else{t=t||Qn;for(var n=0;n<r.length;n++)t(r[n],n,e,void 0)}}catch(s){if(s instanceof Se)return s;throw s}}function on(r,e){if(r===e)return!0;if(r&&e&&typeof r=="object"&&typeof e=="object"){var t=Array.isArray(r),n=Array.isArray(e),s,a,i;if(t&&n){if(a=r.length,a!=e.length)return!1;for(s=a;s--!==0;)if(!on(r[s],e[s]))return!1;return!0}if(t!=n)return!1;var o=Object.keys(r);if(a=o.length,a!==Object.keys(e).length)return!1;for(s=a;s--!==0;)if(!e.hasOwnProperty(o[s]))return!1;for(s=a;s--!==0;)if(i=o[s],!on(r[i],e[i]))return!1;return!0}return r!==r&&e!==e}function wl(r,e,t,n,s){if(e!==r){typeof e.toJSON=="function"&&(e=e.toJSON());for(var a=va(e),i=va(r),o=!1,c=i.length-1;c>=0;c--){var u=i[c],l=r[u];if(wa(e,u)&&!(e[u]===void 0&&l!==void 0&&Array.isArray(e)===!1)){var d=e[u];typeof l=="object"&&l!=null&&typeof d=="object"&&d!=null&&Array.isArray(l)===Array.isArray(d)?wl(l,d,t,n+"/"+rr(u),s):l!==d&&(s&&t.push({op:"test",path:n+"/"+rr(u),value:tt(l)}),t.push({op:"replace",path:n+"/"+rr(u),value:tt(d)}))}else Array.isArray(r)===Array.isArray(e)?(s&&t.push({op:"test",path:n+"/"+rr(u),value:tt(l)}),t.push({op:"remove",path:n+"/"+rr(u)}),o=!0):(s&&t.push({op:"test",path:n,value:r}),t.push({op:"replace",path:n,value:e}))}if(!(!o&&a.length==i.length))for(var c=0;c<a.length;c++){var u=a[c];!wa(r,u)&&e[u]!==void 0&&t.push({op:"add",path:n+"/"+rr(u),value:tt(e[u])})}}}function yi(r,e,t=!1){var n=[];return wl(r,e,n,"",t),n}({...yl});var Nv={};he(Nv,{LogStreamCallbackHandler:()=>Sa,RunLog:()=>_i,RunLogPatch:()=>It,isLogStreamHandler:()=>vl});var It=class{constructor(r){y(this,"ops");this.ops=r.ops??[]}concat(r){const e=this.ops.concat(r.ops),t=kr({},e);return new _i({ops:e,state:t[t.length-1].newDocument})}},_i=class Ta extends It{constructor(t){super(t);y(this,"state");this.state=t.state}concat(t){const n=this.ops.concat(t.ops),s=kr(this.state,t.ops);return new Ta({ops:n,state:s[s.length-1].newDocument})}static fromRunLogPatch(t){const n=kr({},t.ops);return new Ta({ops:t.ops,state:n[n.length-1].newDocument})}};const vl=r=>r.name==="log_stream_tracer";async function ic(r,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:t}=r;if(["retriever","llm","prompt"].includes(r.run_type))return t;if(!(Object.keys(t).length===1&&(t==null?void 0:t.input)===""))return t.input}async function oc(r,e){const{outputs:t}=r;return e==="original"||["retriever","llm","prompt"].includes(r.run_type)?t:t!==void 0&&Object.keys(t).length===1&&(t==null?void 0:t.output)!==void 0?t.output:t}function Pv(r){return r!==void 0&&r.message!==void 0}var Sa=class extends Lr{constructor(e){super({_awaitHandler:!0,...e});y(this,"autoClose",!0);y(this,"includeNames");y(this,"includeTypes");y(this,"includeTags");y(this,"excludeNames");y(this,"excludeTypes");y(this,"excludeTags");y(this,"_schemaFormat","original");y(this,"rootId");y(this,"keyMapByRunId",{});y(this,"counterMapByRunName",{});y(this,"transformStream");y(this,"writer");y(this,"receiveStream");y(this,"name","log_stream_tracer");y(this,"lc_prefer_streaming",!0);this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(e==null?void 0:e._schemaFormat)??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=ft.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let n=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(n=n||t.find(s=>{var a;return(a=this.includeTags)==null?void 0:a.includes(s)})!==void 0),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(n=n&&t.every(s=>{var a;return!((a=this.excludeTags)!=null&&a.includes(s))})),n}async*tapOutputIterable(e,t){for await(const n of t){if(e!==this.rootId){const s=this.keyMapByRunId[e];s&&await this.writer.write(new It({ops:[{op:"add",path:`/logs/${s}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){var s;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new It({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(n.inputs=await ic(e,this._schemaFormat)),await this.writer.write(new It({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const n=[];this._schemaFormat==="streaming_events"&&n.push({op:"replace",path:`/logs/${t}/inputs`,value:await ic(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${t}/final_output`,value:await oc(e,this._schemaFormat)}),e.end_time!==void 0&&n.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const s=new It({ops:n});await this.writer.write(s)}finally{if(e.id===this.rootId){const t=new It({ops:[{op:"replace",path:"/final_output",value:await oc(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,n){const s=this.keyMapByRunId[e.id];if(s===void 0)return;const a=e.inputs.messages!==void 0;let i;a?Pv(n==null?void 0:n.chunk)?i=n==null?void 0:n.chunk:i=new Dt({id:`run-${e.id}`,content:t}):i=t;const o=new It({ops:[{op:"add",path:`/logs/${s}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${s}/streamed_output/-`,value:i}]});await this.writer.write(o)}};function Cn({name:r,serialized:e}){return r!==void 0?r:(e==null?void 0:e.name)!==void 0?e.name:(e==null?void 0:e.id)!==void 0&&Array.isArray(e==null?void 0:e.id)?e.id[e.id.length-1]:"Unnamed"}const Lv=r=>r.name==="event_stream_tracer";var jv=class extends Lr{constructor(e){super({_awaitHandler:!0,...e});y(this,"autoClose",!0);y(this,"includeNames");y(this,"includeTypes");y(this,"includeTags");y(this,"excludeNames");y(this,"excludeTypes");y(this,"excludeTags");y(this,"runInfoMap",new Map);y(this,"tappedPromises",new Map);y(this,"transformStream");y(this,"writer");y(this,"receiveStream");y(this,"name","event_stream_tracer");y(this,"lc_prefer_streaming",!0);this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=ft.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let n=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(n=n||t.find(s=>{var a;return(a=this.includeTags)==null?void 0:a.includes(s)})!==void 0),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(n=n&&t.every(s=>{var a;return!((a=this.excludeTags)!=null&&a.includes(s))})),n}async*tapOutputIterable(e,t){const n=await t.next();if(n.done)return;const s=this.runInfoMap.get(e);if(s===void 0){yield n.value;return}function a(o,c){return o==="llm"&&typeof c=="string"?new sn({text:c}):c}let i=this.tappedPromises.get(e);if(i===void 0){let o;i=new Promise(c=>{o=c}),this.tappedPromises.set(e,i);try{const c={event:`on_${s.runType}_stream`,run_id:e,name:s.name,tags:s.tags,metadata:s.metadata,data:{}};await this.send({...c,data:{chunk:a(s.runType,n.value)}},s),yield n.value;for await(const u of t)s.runType!=="tool"&&s.runType!=="retriever"&&await this.send({...c,data:{chunk:a(s.runType,u)}},s),yield u}finally{o==null||o()}}else{yield n.value;for await(const o of t)yield o}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const n=this.tappedPromises.get(e.run_id);n!==void 0?n.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){var i,o;const t=Cn(e),n=e.inputs.messages!==void 0?"chat_model":"llm",s={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:t,runType:n,inputs:e.inputs};this.runInfoMap.set(e.id,s);const a=`on_${n}_start`;await this.send({event:a,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onLLMNewToken(e,t,n){const s=this.runInfoMap.get(e.id);let a,i;if(s===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(s.runType==="chat_model")i="on_chat_model_stream",(n==null?void 0:n.chunk)===void 0?a=new Dt({content:t,id:`run-${e.id}`}):a=n.chunk.message;else if(s.runType==="llm")i="on_llm_stream",(n==null?void 0:n.chunk)===void 0?a=new sn({text:t}):a=n.chunk;else throw new Error(`Unexpected run type ${s.runType}`);await this.send({event:i,data:{chunk:a},run_id:e.id,name:s.name,tags:s.tags,metadata:s.metadata},s)}}async onLLMEnd(e){var i,o,c;const t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let n;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const s=(i=e.outputs)==null?void 0:i.generations;let a;if(t.runType==="chat_model"){for(const u of s??[]){if(a!==void 0)break;a=(o=u[0])==null?void 0:o.message}n="on_chat_model_end"}else if(t.runType==="llm")a={generations:s==null?void 0:s.map(u=>u.map(l=>({text:l.text,generationInfo:l.generationInfo}))),llmOutput:((c=e.outputs)==null?void 0:c.llmOutput)??{}},n="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:n,data:{output:a,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){var i,o;const t=Cn(e),n=e.run_type??"chain",s={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:t,runType:e.run_type};let a={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(a={},s.inputs={}):e.inputs.input!==void 0?(a.input=e.inputs.input,s.inputs=e.inputs.input):(a.input=e.inputs,s.inputs=e.inputs),this.runInfoMap.set(e.id,s),await this.send({event:`on_${n}_start`,data:a,name:t,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onChainEnd(e){var o;const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const n=`on_${e.run_type}_end`,s=e.inputs??t.inputs??{},i={output:((o=e.outputs)==null?void 0:o.output)??e.outputs,input:s};s.input&&Object.keys(s).length===1&&(i.input=s.input,t.inputs=s.input),await this.sendEndEvent({event:n,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){var s,a;const t=Cn(e),n={tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,n),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{}},n)}async onToolEnd(e){var s;const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const n=((s=e.outputs)==null?void 0:s.output)===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:n,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){var a,i;const t=Cn(e),s={tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,s),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:((i=e.extra)==null?void 0:i.metadata)??{}},s)}async onRetrieverEnd(e){var n;const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:((n=e.outputs)==null?void 0:n.documents)??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,n){const s=this.runInfoMap.get(n);if(s===void 0)throw new Error(`handleCustomEvent: Run ID ${n} not found in run map.`);await this.send({event:"on_custom_event",run_id:n,name:e,tags:s.tags,metadata:s.metadata,data:t},s)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}};const Mv=Object.prototype.toString,Dv=r=>Mv.call(r)==="[object Error]",Uv=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function Fv(r){if(!(r&&Dv(r)&&r.name==="TypeError"&&typeof r.message=="string"))return!1;const{message:t,stack:n}=r;return t==="Load failed"?n===void 0||"__sentry_captured__"in r:t.startsWith("error sending request for url")?!0:Uv.has(t)}function Bv(r){if(typeof r=="number"){if(r<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(r))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(r!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function Nn(r,e,{min:t=0,allowInfinity:n=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${r}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(e))throw new TypeError(`Expected \`${r}\` to be a finite number.`);if(e<t)throw new TypeError(`Expected \`${r}\` to be  ${t}.`)}}class zv extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}function Gv(r,e){const t=Math.max(1,r+1),n=e.randomize?Math.random()+1:1;let s=Math.round(n*e.minTimeout*e.factor**(t-1));return s=Math.min(s,e.maxTimeout),s}function cc(r,e){return Number.isFinite(e)?e-(performance.now()-r):e}async function qv({error:r,attemptNumber:e,retriesConsumed:t,startTime:n,options:s}){var h,m,T;const a=r instanceof Error?r:new TypeError(`Non-error was thrown: "${r}". You should only throw errors.`);if(a instanceof zv)throw a.originalError;const i=Number.isFinite(s.retries)?Math.max(0,s.retries-t):s.retries,o=s.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:a,attemptNumber:e,retriesLeft:i,retriesConsumed:t});if(await s.onFailedAttempt(c),cc(n,o)<=0)throw a;const u=await s.shouldConsumeRetry(c),l=cc(n,o);if(l<=0||i<=0)throw a;if(a instanceof TypeError&&!Fv(a)){if(u)throw a;return(h=s.signal)==null||h.throwIfAborted(),!1}if(!await s.shouldRetry(c))throw a;if(!u)return(m=s.signal)==null||m.throwIfAborted(),!1;const d=Gv(t,s),f=Math.min(d,l);return f>0&&await new Promise((w,_)=>{var O,x;const b=()=>{var A;clearTimeout(v),(A=s.signal)==null||A.removeEventListener("abort",b),_(s.signal.reason)},v=setTimeout(()=>{var A;(A=s.signal)==null||A.removeEventListener("abort",b),w()},f);s.unref&&((O=v.unref)==null||O.call(v)),(x=s.signal)==null||x.addEventListener("abort",b,{once:!0})}),(T=s.signal)==null||T.throwIfAborted(),!0}async function xa(r,e={}){var a,i,o;if(e={...e},Bv(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??(e.retries=10),e.factor??(e.factor=2),e.minTimeout??(e.minTimeout=1e3),e.maxTimeout??(e.maxTimeout=Number.POSITIVE_INFINITY),e.maxRetryTime??(e.maxRetryTime=Number.POSITIVE_INFINITY),e.randomize??(e.randomize=!1),e.onFailedAttempt??(e.onFailedAttempt=()=>{}),e.shouldRetry??(e.shouldRetry=()=>!0),e.shouldConsumeRetry??(e.shouldConsumeRetry=()=>!0),Nn("factor",e.factor,{min:0,allowInfinity:!1}),Nn("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),Nn("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),Nn("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),(a=e.signal)==null||a.throwIfAborted();let t=0,n=0;const s=performance.now();for(;!Number.isFinite(e.retries)||n<=e.retries;){t++;try{(i=e.signal)==null||i.throwIfAborted();const c=await r(t);return(o=e.signal)==null||o.throwIfAborted(),c}catch(c){await qv({error:c,attemptNumber:t,retriesConsumed:n,startTime:s,options:e})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}var Hv={};he(Hv,{AsyncCaller:()=>ms});const Vv=[400,401,402,403,404,405,406,407,409],Zv=r=>{var t,n;if(r.message.startsWith("Cancel")||r.message.startsWith("AbortError")||r.name==="AbortError"||(r==null?void 0:r.code)==="ECONNABORTED")throw r;const e=((t=r==null?void 0:r.response)==null?void 0:t.status)??(r==null?void 0:r.status);if(e&&Vv.includes(+e))throw r;if(((n=r==null?void 0:r.error)==null?void 0:n.code)==="insufficient_quota"){const s=new Error(r==null?void 0:r.message);throw s.name="InsufficientQuotaError",s}};var ms=class{constructor(r){y(this,"maxConcurrency");y(this,"maxRetries");y(this,"onFailedAttempt");y(this,"queue");this.maxConcurrency=r.maxConcurrency??1/0,this.maxRetries=r.maxRetries??6,this.onFailedAttempt=r.onFailedAttempt??Zv;const e="default"in At?At.default:At;this.queue=new e({concurrency:this.maxConcurrency})}call(r,...e){return this.queue.add(()=>xa(()=>r(...e).catch(t=>{throw t instanceof Error?t:new Error(t)}),{onFailedAttempt:({error:t})=>{var n;return(n=this.onFailedAttempt)==null?void 0:n.call(this,t)},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(r,e,...t){if(r.signal){let n;return Promise.race([this.call(e,...t),new Promise((s,a)=>{var i;n=()=>{a(Xn(r.signal))},(i=r.signal)==null||i.addEventListener("abort",n)})]).finally(()=>{r.signal&&n&&r.signal.removeEventListener("abort",n)})}return this.call(e,...t)}fetch(...r){return this.call(()=>fetch(...r).then(e=>e.ok?e:Promise.reject(e)))}},bl=class extends Lr{constructor({config:e,onStart:t,onEnd:n,onError:s}){super({_awaitHandler:!0});y(this,"name","RootListenersTracer");y(this,"rootId");y(this,"config");y(this,"argOnStart");y(this,"argOnEnd");y(this,"argOnError");this.config=e,this.argOnStart=t,this.argOnEnd=n,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}};function wi(r){return r?r.lc_runnable:!1}var Jv=class{constructor(r){y(this,"includeNames");y(this,"includeTypes");y(this,"includeTags");y(this,"excludeNames");y(this,"excludeTypes");y(this,"excludeTags");this.includeNames=r.includeNames,this.includeTypes=r.includeTypes,this.includeTags=r.includeTags,this.excludeNames=r.excludeNames,this.excludeTypes=r.excludeTypes,this.excludeTags=r.excludeTags}includeEvent(r,e){let t=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const n=r.tags??[];return this.includeNames!==void 0&&(t=t||this.includeNames.includes(r.name)),this.includeTypes!==void 0&&(t=t||this.includeTypes.includes(e)),this.includeTags!==void 0&&(t=t||n.some(s=>{var a;return(a=this.includeTags)==null?void 0:a.includes(s)})),this.excludeNames!==void 0&&(t=t&&!this.excludeNames.includes(r.name)),this.excludeTypes!==void 0&&(t=t&&!this.excludeTypes.includes(e)),this.excludeTags!==void 0&&(t=t&&n.every(s=>{var a;return!((a=this.excludeTags)!=null&&a.includes(s))})),t}};function Js(r){return r.replace(/[^a-zA-Z-_0-9]/g,"_")}const Wv=["*","_","`"];function Kv(r){let e="";for(const[t,n]of Object.entries(r))e+=`	classDef ${t} ${n};
`;return e}function Xv(r,e,t){const{firstNode:n,lastNode:s,nodeColors:a,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:c=9}=t??{};let u=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(i){const h="default",m={[h]:"{0}({1})"};n!==void 0&&(m[n]="{0}([{1}]):::first"),s!==void 0&&(m[s]="{0}([{1}]):::last");for(const[T,w]of Object.entries(r)){const _=w.name.split(":").pop()??"";let v=Wv.some(x=>_.startsWith(x)&&_.endsWith(x))?`<p>${_}</p>`:_;Object.keys(w.metadata??{}).length&&(v+=`<hr/><small><em>${Object.entries(w.metadata??{}).map(([x,A])=>`${x} = ${A}`).join(`
`)}</em></small>`);const O=(m[T]??m[h]).replace("{0}",Js(T)).replace("{1}",v);u+=`	${O}
`}}const l={};for(const h of e){const m=h.source.split(":"),T=h.target.split(":"),w=m.filter((_,b)=>_===T[b]).join(":");l[w]||(l[w]=[]),l[w].push(h)}const d=new Set;function f(h,m){const T=h.length===1&&h[0].source===h[0].target;if(m&&!T){const w=m.split(":").pop();if(d.has(w))throw new Error(`Found duplicate subgraph '${w}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(w),u+=`	subgraph ${w}
`}for(const w of h){const{source:_,target:b,data:v,conditional:O}=w;let x="";if(v!==void 0){let A=v;const J=A.split(" ");J.length>c&&(A=Array.from({length:Math.ceil(J.length/c)},(E,ye)=>J.slice(ye*c,(ye+1)*c).join(" ")).join("&nbsp;<br>&nbsp;")),x=O?` -. &nbsp;${A}&nbsp; .-> `:` -- &nbsp;${A}&nbsp; --> `}else x=O?" -.-> ":" --> ";u+=`	${Js(_)}${x}${Js(b)};
`}for(const w in l)w.startsWith(`${m}:`)&&w!==m&&f(l[w],w);m&&!T&&(u+=`	end
`)}f(l[""]??[],"");for(const h in l)!h.includes(":")&&h!==""&&f(l[h],h);return i&&(u+=Kv(a??{})),u}async function Yv(r,e){let t=(e==null?void 0:e.backgroundColor)??"white";const n=(e==null?void 0:e.imageType)??"png",s=btoa(r);t!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(t)||(t=`!${t}`));const a=`https://mermaid.ink/img/${s}?bgColor=${t}&type=${n}`,i=await fetch(a);if(!i.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${i.status}`,`Status text: ${i.statusText}`].join(`
`));return await i.blob()}var Qv={};he(Qv,{Graph:()=>vi});function e0(r,e){if(r!==void 0&&!Zr(r))return r;if(wi(e))try{let t=e.getName();return t=t.startsWith("Runnable")?t.slice(8):t,t}catch{return e.getName()}else return e.name??"UnknownSchema"}function t0(r){return wi(r.data)?{type:"runnable",data:{id:r.data.lc_id,name:r.data.getName()}}:{type:"schema",data:{...Wt(r.data.schema),title:r.data.name}}}var vi=class El{constructor(e){y(this,"nodes",{});y(this,"edges",[]);this.nodes=(e==null?void 0:e.nodes)??this.nodes,this.edges=(e==null?void 0:e.edges)??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((t,n)=>{e[t.id]=Zr(t.id)?n:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...t0(t)})),edges:this.edges.map(t=>{const n={source:e[t.source],target:e[t.target]};return typeof t.data<"u"&&(n.data=t.data),typeof t.conditional<"u"&&(n.conditional=t.conditional),n})}}addNode(e,t,n){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);const s=t??Ve(),a={id:s,data:e,name:e0(t,e),metadata:n};return this.nodes[s]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,n,s){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);const a={source:e.id,target:t.id,data:n,conditional:s};return this.edges.push(a),a}firstNode(){return uc(this)}lastNode(){return lc(this)}extend(e,t=""){let n=t;Object.values(e.nodes).map(u=>u.id).every(Zr)&&(n="");const a=u=>n?`${n}:${u}`:u;Object.entries(e.nodes).forEach(([u,l])=>{this.nodes[a(u)]={...l,id:a(u)}});const i=e.edges.map(u=>({...u,source:a(u.source),target:a(u.target)}));this.edges=[...this.edges,...i];const o=e.firstNode(),c=e.lastNode();return[o?{id:a(o.id),data:o.data}:void 0,c?{id:a(c.id),data:c.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&uc(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&lc(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(s=>[s.id,s.name])),t=new Map;Object.values(e).forEach(s=>{t.set(s,(t.get(s)||0)+1)});const n=s=>{const a=e[s];return Zr(s)&&t.get(a)===1?a:s};return new El({nodes:Object.fromEntries(Object.entries(this.nodes).map(([s,a])=>[n(s),{...a,id:n(s)}])),edges:this.edges.map(s=>({...s,source:n(s.source),target:n(s.target)}))})}drawMermaid(e){const{withStyles:t,curveStyle:n,nodeColors:s={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:a}=e??{},i=this.reid(),o=i.firstNode(),c=i.lastNode();return Xv(i.nodes,i.edges,{firstNode:o==null?void 0:o.id,lastNode:c==null?void 0:c.id,withStyles:t,curveStyle:n,nodeColors:s,wrapLabelNWords:a})}async drawMermaidPng(e){const t=this.drawMermaid(e);return Yv(t,{backgroundColor:e==null?void 0:e.backgroundColor})}};function uc(r,e=[]){const t=new Set(r.edges.filter(s=>!e.includes(s.source)).map(s=>s.target)),n=[];for(const s of Object.values(r.nodes))!e.includes(s.id)&&!t.has(s.id)&&n.push(s);return n.length===1?n[0]:void 0}function lc(r,e=[]){const t=new Set(r.edges.filter(s=>!e.includes(s.target)).map(s=>s.source)),n=[];for(const s of Object.values(r.nodes))!e.includes(s.id)&&!t.has(s.id)&&n.push(s);return n.length===1?n[0]:void 0}function r0(r){const e=new TextEncoder,t=new ReadableStream({async start(n){for await(const s of r)n.enqueue(e.encode(`event: data
data: ${JSON.stringify(s)}

`));n.enqueue(e.encode(`event: end

`)),n.close()}});return ft.fromReadableStream(t)}function dc(r){return typeof r=="object"&&r!==null&&typeof r[Symbol.iterator]=="function"&&typeof r.next=="function"}const n0=r=>r!=null&&typeof r=="object"&&"next"in r&&typeof r.next=="function";function Ia(r){return typeof r=="object"&&r!==null&&typeof r[Symbol.asyncIterator]=="function"}function*fc(r,e){for(;;){const{value:t,done:n}=Lt.runWithConfig(ur(r),e.next.bind(e),!0);if(n)break;yield t}}async function*Oa(r,e){const t=e[Symbol.asyncIterator]();for(;;){const{value:n,done:s}=await Lt.runWithConfig(ur(r),t.next.bind(e),!0);if(s)break;yield n}}function $e(r,e){return r&&!Array.isArray(r)&&!(r instanceof Date)&&typeof r=="object"?r:{[e]:r}}var Ie=class extends Ar{constructor(){super(...arguments);y(this,"lc_runnable",!0);y(this,"name")}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}withRetry(e){return new bi({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new Rr({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new Al({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(de);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const n=Object.fromEntries(Object.entries(e).filter(([s])=>s!=="runId"));return Array.from({length:t},(s,a)=>de(a===0?e:n))}return Array.from({length:t},()=>de(e))}async batch(e,t,n){var c;const s=this._getOptionsList(t??{},e.length),a=((c=s[0])==null?void 0:c.maxConcurrency)??(n==null?void 0:n.maxConcurrency),i=new ms({maxConcurrency:a,onFailedAttempt:u=>{throw u}}),o=e.map((u,l)=>i.call(async()=>{try{return await this.invoke(u,s[l])}catch(d){if(n!=null&&n.returnExceptions)return d;throw d}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const n=de(t),s=new hr({generator:this._streamIterator(e,n),config:n});return await s.setup,ft.fromAsyncGenerator(s)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=de(e):t=de({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,delete n.runId,delete n.timeout,delete n.signal,[t,n]}async _callWithConfig(e,t,n){const s=de(n),a=await Ke(s),i=await(a==null?void 0:a.handleChainStart(this.toJSON(),$e(t,"input"),s.runId,s==null?void 0:s.runType,void 0,void 0,(s==null?void 0:s.runName)??this.getName()));delete s.runId;let o;try{const c=e.call(this,t,s,i);o=await jt(c,n==null?void 0:n.signal)}catch(c){throw await(i==null?void 0:i.handleChainError(c)),c}return await(i==null?void 0:i.handleChainEnd($e(o,"output"))),o}async _batchWithConfig(e,t,n,s){var u;const a=this._getOptionsList(n??{},t.length),i=await Promise.all(a.map(Ke)),o=await Promise.all(i.map(async(l,d)=>{const f=await(l==null?void 0:l.handleChainStart(this.toJSON(),$e(t[d],"input"),a[d].runId,a[d].runType,void 0,void 0,a[d].runName??this.getName()));return delete a[d].runId,f}));let c;try{const l=e.call(this,t,a,o,s);c=await jt(l,(u=a==null?void 0:a[0])==null?void 0:u.signal)}catch(l){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(l))),l}return await Promise.all(o.map(l=>l==null?void 0:l.handleChainEnd($e(c,"output")))),c}_concatOutputChunks(e,t){return lr(e,t)}async*_transformStreamWithConfig(e,t,n){let s,a=!0,i,o=!0;const c=de(n),u=await Ke(c),l=this;async function*d(){for await(const h of e){if(a)if(s===void 0)s=h;else try{s=l._concatOutputChunks(s,h)}catch{s=void 0,a=!1}yield h}}let f;try{const h=await fl(t.bind(this),d(),async()=>u==null?void 0:u.handleChainStart(this.toJSON(),{input:""},c.runId,c.runType,void 0,void 0,c.runName??this.getName()),n==null?void 0:n.signal,c);delete c.runId,f=h.setup;const m=f==null?void 0:f.handlers.find(Lv);let T=h.output;m!==void 0&&f!==void 0&&(T=m.tapOutputIterable(f.runId,T));const w=f==null?void 0:f.handlers.find(vl);w!==void 0&&f!==void 0&&(T=w.tapOutputIterable(f.runId,T));for await(const _ of T)if(yield _,o)if(i===void 0)i=_;else try{i=this._concatOutputChunks(i,_)}catch{i=void 0,o=!1}}catch(h){throw await(f==null?void 0:f.handleChainError(h,void 0,void 0,void 0,{inputs:$e(s,"input")})),h}await(f==null?void 0:f.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:$e(s,"input")}))}getGraph(e){const t=new vi,n=t.addNode({name:`${this.getName()}Input`,schema:eo()}),s=t.addNode(this),a=t.addNode({name:`${this.getName()}Output`,schema:eo()});return t.addEdge(n,s),t.addEdge(s,a),t}pipe(e){return new gn({first:this,last:lt(e)})}pick(e){return this.pipe(new kl(e))}assign(e){return this.pipe(new Ei(new jr({steps:e})))}async*transform(e,t){let n;for await(const s of e)n===void 0?n=s:n=this._concatOutputChunks(n,s);yield*this._streamIterator(n,de(t))}async*streamLog(e,t,n){const s=new Sa({...n,autoClose:!1,_schemaFormat:"original"}),a=de(t);yield*this._streamLog(e,s,a)}async*_streamLog(e,t,n){const{callbacks:s}=n;if(s===void 0)n.callbacks=[t];else if(Array.isArray(s))n.callbacks=s.concat([t]);else{const c=s.copy();c.addHandler(t,!0),n.callbacks=c}const a=this.stream(e,n);async function i(){try{const c=await a;for await(const u of c){const l=new It({ops:[{op:"add",path:"/streamed_output/-",value:u}]});await t.writer.write(l)}}finally{await t.writer.close()}}const o=i();try{for await(const c of t)yield c}finally{await o}}streamEvents(e,t,n){let s;if(t.version==="v1")s=this._streamEventsV1(e,t,n);else if(t.version==="v2")s=this._streamEventsV2(e,t,n);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?r0(s):ft.fromAsyncGenerator(s)}async*_streamEventsV2(e,t,n){var m;const s=new jv({...n,autoClose:!1}),a=de(t),i=a.runId??Ve();a.runId=i;const o=a.callbacks;if(o===void 0)a.callbacks=[s];else if(Array.isArray(o))a.callbacks=o.concat(s);else{const T=o.copy();T.addHandler(s,!0),a.callbacks=T}const c=new AbortController,u=this;async function l(){let T,w=null;try{t!=null&&t.signal?"any"in AbortSignal?T=AbortSignal.any([c.signal,t.signal]):(T=t.signal,w=()=>{c.abort()},t.signal.addEventListener("abort",w,{once:!0})):T=c.signal;const _=await u.stream(e,{...a,signal:T}),b=s.tapOutputIterable(i,_);for await(const v of b)if(c.signal.aborted)break}finally{await s.finish(),T&&w&&T.removeEventListener("abort",w)}}const d=l();let f=!1,h;try{for await(const T of s){if(!f){T.data.input=e,f=!0,h=T.run_id,yield T;continue}T.run_id===h&&T.event.endsWith("_end")&&(m=T.data)!=null&&m.input&&delete T.data.input,yield T}}finally{c.abort(),await d}}async*_streamEventsV1(e,t,n){let s,a=!1;const i=de(t),o=i.tags??[],c=i.metadata??{},u=i.runName??this.getName(),l=new Sa({...n,autoClose:!1,_schemaFormat:"streaming_events"}),d=new Jv({...n}),f=this._streamLog(e,l,i);for await(const m of f){if(s?s=s.concat(m):s=_i.fromRunLogPatch(m),s.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;const b={...s.state},v={run_id:b.id,event:`on_${b.type}_start`,name:u,tags:o,metadata:c,data:{input:e}};d.includeEvent(v,b.type)&&(yield v)}const T=m.ops.filter(b=>b.path.startsWith("/logs/")).map(b=>b.path.split("/")[2]),w=[...new Set(T)];for(const b of w){let v,O={};const x=s.state.logs[b];if(x.end_time===void 0?x.streamed_output.length>0?v="stream":v="start":v="end",v==="start")x.inputs!==void 0&&(O.input=x.inputs);else if(v==="end")x.inputs!==void 0&&(O.input=x.inputs),O.output=x.final_output;else if(v==="stream"){const A=x.streamed_output.length;if(A!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${A} instead. Encountered in: "${x.name}"`);O={chunk:x.streamed_output[0]},x.streamed_output=[]}yield{event:`on_${x.type}_${v}`,name:x.name,run_id:x.id,tags:x.tags,metadata:x.metadata,data:O}}const{state:_}=s;if(_.streamed_output.length>0){const b=_.streamed_output.length;if(b!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${b} instead. Encountered in: "${_.name}"`);const v={chunk:_.streamed_output[0]};_.streamed_output=[];const O={event:`on_${_.type}_stream`,run_id:_.id,tags:o,metadata:c,name:u,data:v};d.includeEvent(O,_.type)&&(yield O)}}const h=s==null?void 0:s.state;if(h!==void 0){const m={event:`on_${h.type}_end`,name:u,run_id:h.id,tags:o,metadata:c,data:{output:h.final_output}};d.includeEvent(m,h.type)&&(yield m)}}static isRunnable(e){return wi(e)}withListeners({onStart:e,onEnd:t,onError:n}){return new Rr({bound:this,config:{},configFactories:[s=>({callbacks:[new bl({config:s,onStart:e,onEnd:t,onError:n})]})]})}asTool(e){return c0(this,e)}},Rr=class Tl extends Ie{constructor(t){super(t);y(this,"lc_namespace",["langchain_core","runnables"]);y(this,"lc_serializable",!0);y(this,"bound");y(this,"config");y(this,"kwargs");y(this,"configFactories");this.bound=t.bound,this.kwargs=t.kwargs,this.config=t.config,this.configFactories=t.configFactories}static lc_name(){return"RunnableBinding"}getName(t){return this.bound.getName(t)}async _mergeConfig(...t){const n=ga(this.config,...t);return ga(n,...this.configFactories?await Promise.all(this.configFactories.map(async s=>await s(n))):[])}withConfig(t){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...t}})}withRetry(t){return new bi({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:t==null?void 0:t.stopAfterAttempt,...t})}async invoke(t,n){return this.bound.invoke(t,await this._mergeConfig(n,this.kwargs))}async batch(t,n,s){const a=Array.isArray(n)?await Promise.all(n.map(async i=>this._mergeConfig(de(i),this.kwargs))):await this._mergeConfig(de(n),this.kwargs);return this.bound.batch(t,a,s)}_concatOutputChunks(t,n){return this.bound._concatOutputChunks(t,n)}async*_streamIterator(t,n){yield*this.bound._streamIterator(t,await this._mergeConfig(de(n),this.kwargs))}async stream(t,n){return this.bound.stream(t,await this._mergeConfig(de(n),this.kwargs))}async*transform(t,n){yield*this.bound.transform(t,await this._mergeConfig(de(n),this.kwargs))}streamEvents(t,n,s){const a=this,i=async function*(){yield*a.bound.streamEvents(t,{...await a._mergeConfig(de(n),a.kwargs),version:n.version},s)};return ft.fromAsyncGenerator(i())}static isRunnableBinding(t){return t.bound&&Ie.isRunnable(t.bound)}withListeners({onStart:t,onEnd:n,onError:s}){return new Tl({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new bl({config:a,onStart:t,onEnd:n,onError:s})]})]})}},s0=class Sl extends Ie{constructor(t){super(t);y(this,"lc_serializable",!0);y(this,"lc_namespace",["langchain_core","runnables"]);y(this,"bound");this.bound=t.bound}static lc_name(){return"RunnableEach"}async invoke(t,n){return this._callWithConfig(this._invoke.bind(this),t,n)}async _invoke(t,n,s){return this.bound.batch(t,be(n,{callbacks:s==null?void 0:s.getChild()}))}withListeners({onStart:t,onEnd:n,onError:s}){return new Sl({bound:this.bound.withListeners({onStart:t,onEnd:n,onError:s})})}},bi=class extends Rr{constructor(e){super(e);y(this,"lc_namespace",["langchain_core","runnables"]);y(this,"maxAttemptNumber",3);y(this,"onFailedAttempt",()=>{});this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}static lc_name(){return"RunnableRetry"}_patchConfigForRetry(e,t,n){const s=e>1?`retry:attempt:${e}`:void 0;return be(t,{callbacks:n==null?void 0:n.getChild(s)})}async _invoke(e,t,n){return xa(s=>super.invoke(e,this._patchConfigForRetry(s,t,n)),{onFailedAttempt:({error:s})=>this.onFailedAttempt(s,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,n,s){const a={};try{await xa(async i=>{const o=e.map((f,h)=>h).filter(f=>a[f.toString()]===void 0||a[f.toString()]instanceof Error),c=o.map(f=>e[f]),u=o.map(f=>this._patchConfigForRetry(i,t==null?void 0:t[f],n==null?void 0:n[f])),l=await super.batch(c,u,{...s,returnExceptions:!0});let d;for(let f=0;f<l.length;f+=1){const h=l[f],m=o[f];h instanceof Error&&d===void 0&&(d=h,d.input=c[f]),a[m.toString()]=h}if(d)throw d;return l},{onFailedAttempt:({error:i})=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if((s==null?void 0:s.returnExceptions)!==!0)throw i}return Object.keys(a).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>a[parseInt(i,10)])}async batch(e,t,n){return this._batchWithConfig(this._batch.bind(this),e,t,n)}},gn=class qr extends Ie{constructor(t){super(t);y(this,"first");y(this,"middle",[]);y(this,"last");y(this,"omitSequenceTags",!1);y(this,"lc_serializable",!0);y(this,"lc_namespace",["langchain_core","runnables"]);this.first=t.first,this.middle=t.middle??this.middle,this.last=t.last,this.name=t.name,this.omitSequenceTags=t.omitSequenceTags??this.omitSequenceTags}static lc_name(){return"RunnableSequence"}get steps(){return[this.first,...this.middle,this.last]}async invoke(t,n){var u;const s=de(n),a=await Ke(s),i=await(a==null?void 0:a.handleChainStart(this.toJSON(),$e(t,"input"),s.runId,void 0,void 0,void 0,s==null?void 0:s.runName));delete s.runId;let o=t,c;try{const l=[this.first,...this.middle];for(let d=0;d<l.length;d+=1){const h=l[d].invoke(o,be(s,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:`seq:step:${d+1}`)}));o=await jt(h,n==null?void 0:n.signal)}if((u=n==null?void 0:n.signal)!=null&&u.aborted)throw Xn(n.signal);c=await this.last.invoke(o,be(s,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(l){throw await(i==null?void 0:i.handleChainError(l)),l}return await(i==null?void 0:i.handleChainEnd($e(c,"output"))),c}async batch(t,n,s){var u;const a=this._getOptionsList(n??{},t.length),i=await Promise.all(a.map(Ke)),o=await Promise.all(i.map(async(l,d)=>{const f=await(l==null?void 0:l.handleChainStart(this.toJSON(),$e(t[d],"input"),a[d].runId,void 0,void 0,void 0,a[d].runName));return delete a[d].runId,f}));let c=t;try{for(let l=0;l<this.steps.length;l+=1){const f=this.steps[l].batch(c,o.map((h,m)=>{const T=h==null?void 0:h.getChild(this.omitSequenceTags?void 0:`seq:step:${l+1}`);return be(a[m],{callbacks:T})}),s);c=await jt(f,(u=a[0])==null?void 0:u.signal)}}catch(l){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(l))),l}return await Promise.all(o.map(l=>l==null?void 0:l.handleChainEnd($e(c,"output")))),c}_concatOutputChunks(t,n){return this.last._concatOutputChunks(t,n)}async*_streamIterator(t,n){var f;const s=await Ke(n),{runId:a,...i}=n??{},o=await(s==null?void 0:s.handleChainStart(this.toJSON(),$e(t,"input"),a,void 0,void 0,void 0,i==null?void 0:i.runName)),c=[this.first,...this.middle,this.last];let u=!0,l;async function*d(){yield t}try{let h=c[0].transform(d(),be(i,{callbacks:o==null?void 0:o.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let m=1;m<c.length;m+=1)h=await c[m].transform(h,be(i,{callbacks:o==null?void 0:o.getChild(this.omitSequenceTags?void 0:`seq:step:${m+1}`)}));for await(const m of h)if((f=n==null?void 0:n.signal)==null||f.throwIfAborted(),yield m,u)if(l===void 0)l=m;else try{l=this._concatOutputChunks(l,m)}catch{l=void 0,u=!1}}catch(h){throw await(o==null?void 0:o.handleChainError(h)),h}await(o==null?void 0:o.handleChainEnd($e(l,"output")))}getGraph(t){const n=new vi;let s=null;return this.steps.forEach((a,i)=>{const o=a.getGraph(t);i!==0&&o.trimFirstNode(),i!==this.steps.length-1&&o.trimLastNode(),n.extend(o);const c=o.firstNode();if(!c)throw new Error(`Runnable ${a} has no first node`);s&&n.addEdge(s,c),s=o.lastNode()}),n}pipe(t){return qr.isRunnableSequence(t)?new qr({first:this.first,middle:this.middle.concat([this.last,t.first,...t.middle]),last:t.last,name:this.name??t.name}):new qr({first:this.first,middle:[...this.middle,this.last],last:lt(t),name:this.name})}static isRunnableSequence(t){return Array.isArray(t.middle)&&Ie.isRunnable(t)}static from([t,...n],s){let a={};return typeof s=="string"?a.name=s:s!==void 0&&(a=s),new qr({...a,first:lt(t),middle:n.slice(0,-1).map(lt),last:lt(n[n.length-1])})}},jr=class xl extends Ie{constructor(t){super(t);y(this,"lc_namespace",["langchain_core","runnables"]);y(this,"lc_serializable",!0);y(this,"steps");this.steps={};for(const[n,s]of Object.entries(t.steps))this.steps[n]=lt(s)}static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}static from(t){return new xl({steps:t})}async invoke(t,n){const s=de(n),a=await Ke(s),i=await(a==null?void 0:a.handleChainStart(this.toJSON(),{input:t},s.runId,void 0,void 0,void 0,s==null?void 0:s.runName));delete s.runId;const o={};try{const c=Object.entries(this.steps).map(async([u,l])=>{o[u]=await l.invoke(t,be(s,{callbacks:i==null?void 0:i.getChild(`map:key:${u}`)}))});await jt(Promise.all(c),n==null?void 0:n.signal)}catch(c){throw await(i==null?void 0:i.handleChainError(c)),c}return await(i==null?void 0:i.handleChainEnd(o)),o}async*_transform(t,n,s){const a={...this.steps},i=gi(t,Object.keys(a).length),o=new Map(Object.entries(a).map(([c,u],l)=>{const d=u.transform(i[l],be(s,{callbacks:n==null?void 0:n.getChild(`map:key:${c}`)}));return[c,d.next().then(f=>({key:c,gen:d,result:f}))]}));for(;o.size;){const c=Promise.race(o.values()),{key:u,result:l,gen:d}=await jt(c,s==null?void 0:s.signal);o.delete(u),l.done||(yield{[u]:l.value},o.set(u,d.next().then(f=>({key:u,gen:d,result:f}))))}}transform(t,n){return this._transformStreamWithConfig(t,this._transform.bind(this),n)}async stream(t,n){async function*s(){yield t}const a=de(n),i=new hr({generator:this.transform(s(),a),config:a});return await i.setup,ft.fromAsyncGenerator(i)}},a0=class Il extends Ie{constructor(t){super(t);y(this,"lc_serializable",!1);y(this,"lc_namespace",["langchain_core","runnables"]);y(this,"func");if(!mi(t.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=t.func}async invoke(t,n){const[s]=this._getOptionsList(n??{},1),a=await Ke(s),i=this.func(be(s,{callbacks:a}),t);return jt(i,s==null?void 0:s.signal)}async*_streamIterator(t,n){var i,o;const[s]=this._getOptionsList(n??{},1),a=await this.invoke(t,n);if(Ia(a)){for await(const c of a)(i=s==null?void 0:s.signal)==null||i.throwIfAborted(),yield c;return}if(n0(a)){for(;;){(o=s==null?void 0:s.signal)==null||o.throwIfAborted();const c=a.next();if(c.done)break;yield c.value}return}yield a}static from(t){return new Il({func:t})}};function i0(r){if(mi(r))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var Qt=class Ol extends Ie{constructor(t){if(mi(t.func))return a0.from(t.func);super(t);y(this,"lc_namespace",["langchain_core","runnables"]);y(this,"func");i0(t.func),this.func=t.func}static lc_name(){return"RunnableLambda"}static from(t){return new Ol({func:t})}async _invoke(t,n,s){return new Promise((a,i)=>{const o=be(n,{callbacks:s==null?void 0:s.getChild(),recursionLimit:((n==null?void 0:n.recursionLimit)??Zs)-1});Lt.runWithConfig(ur(o),async()=>{var c,u;try{let l=await this.func(t,{...o});if(l&&Ie.isRunnable(l)){if((n==null?void 0:n.recursionLimit)===0)throw new Error("Recursion limit reached.");l=await l.invoke(t,{...o,recursionLimit:(o.recursionLimit??Zs)-1})}else if(Ia(l)){let d;for await(const f of Oa(o,l))if((c=n==null?void 0:n.signal)==null||c.throwIfAborted(),d===void 0)d=f;else try{d=this._concatOutputChunks(d,f)}catch{d=f}l=d}else if(dc(l)){let d;for(const f of fc(o,l))if((u=n==null?void 0:n.signal)==null||u.throwIfAborted(),d===void 0)d=f;else try{d=this._concatOutputChunks(d,f)}catch{d=f}l=d}a(l)}catch(l){i(l)}})})}async invoke(t,n){return this._callWithConfig(this._invoke.bind(this),t,n)}async*_transform(t,n,s){var c,u;let a;for await(const l of t)if(a===void 0)a=l;else try{a=this._concatOutputChunks(a,l)}catch{a=l}const i=be(s,{callbacks:n==null?void 0:n.getChild(),recursionLimit:((s==null?void 0:s.recursionLimit)??Zs)-1}),o=await new Promise((l,d)=>{Lt.runWithConfig(ur(i),async()=>{try{const f=await this.func(a,{...i,config:i});l(f)}catch(f){d(f)}})});if(o&&Ie.isRunnable(o)){if((s==null?void 0:s.recursionLimit)===0)throw new Error("Recursion limit reached.");const l=await o.stream(a,i);for await(const d of l)yield d}else if(Ia(o))for await(const l of Oa(i,o))(c=s==null?void 0:s.signal)==null||c.throwIfAborted(),yield l;else if(dc(o))for(const l of fc(i,o))(u=s==null?void 0:s.signal)==null||u.throwIfAborted(),yield l;else yield o}transform(t,n){return this._transformStreamWithConfig(t,this._transform.bind(this),n)}async stream(t,n){async function*s(){yield t}const a=de(n),i=new hr({generator:this.transform(s(),a),config:a});return await i.setup,ft.fromAsyncGenerator(i)}},o0=class extends jr{},Al=class extends Ie{constructor(e){super(e);y(this,"lc_namespace",["langchain_core","runnables"]);y(this,"lc_serializable",!0);y(this,"runnable");y(this,"fallbacks");this.runnable=e.runnable,this.fallbacks=e.fallbacks}static lc_name(){return"RunnableWithFallbacks"}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const n=de(t),s=await Ke(n),{runId:a,...i}=n,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),$e(e,"input"),a,void 0,void 0,void 0,i==null?void 0:i.runName)),c=be(i,{callbacks:o==null?void 0:o.getChild()});return await Lt.runWithConfig(c,async()=>{var d;let l;for(const f of this.runnables()){(d=n==null?void 0:n.signal)==null||d.throwIfAborted();try{const h=await f.invoke(e,c);return await(o==null?void 0:o.handleChainEnd($e(h,"output"))),h}catch(h){l===void 0&&(l=h)}}throw l===void 0?new Error("No error stored at end of fallback."):(await(o==null?void 0:o.handleChainError(l)),l)})}async*_streamIterator(e,t){var d;const n=de(t),s=await Ke(n),{runId:a,...i}=n,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),$e(e,"input"),a,void 0,void 0,void 0,i==null?void 0:i.runName));let c,u;for(const f of this.runnables()){(d=n==null?void 0:n.signal)==null||d.throwIfAborted();const h=be(i,{callbacks:o==null?void 0:o.getChild()});try{const m=await f.stream(e,h);u=Oa(h,m);break}catch(m){c===void 0&&(c=m)}}if(u===void 0){const f=c??new Error("No error stored at end of fallback.");throw await(o==null?void 0:o.handleChainError(f)),f}let l;try{for await(const f of u){yield f;try{l=l===void 0?l:this._concatOutputChunks(l,f)}catch{l=void 0}}}catch(f){throw await(o==null?void 0:o.handleChainError(f)),f}await(o==null?void 0:o.handleChainEnd($e(l,"output")))}async batch(e,t,n){var c;if(n!=null&&n.returnExceptions)throw new Error("Not implemented.");const s=this._getOptionsList(t??{},e.length),a=await Promise.all(s.map(u=>Ke(u))),i=await Promise.all(a.map(async(u,l)=>{const d=await(u==null?void 0:u.handleChainStart(this.toJSON(),$e(e[l],"input"),s[l].runId,void 0,void 0,void 0,s[l].runName));return delete s[l].runId,d}));let o;for(const u of this.runnables()){(c=s[0].signal)==null||c.throwIfAborted();try{const l=await u.batch(e,i.map((d,f)=>be(s[f],{callbacks:d==null?void 0:d.getChild()})),n);return await Promise.all(i.map((d,f)=>d==null?void 0:d.handleChainEnd($e(l[f],"output")))),l}catch(l){o===void 0&&(o=l)}}throw o?(await Promise.all(i.map(u=>u==null?void 0:u.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};function lt(r){if(typeof r=="function")return new Qt({func:r});if(Ie.isRunnable(r))return r;if(!Array.isArray(r)&&typeof r=="object"){const e={};for(const[t,n]of Object.entries(r))e[t]=lt(n);return new jr({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var Ei=class extends Ie{constructor(e){e instanceof jr&&(e={mapper:e});super(e);y(this,"lc_namespace",["langchain_core","runnables"]);y(this,"lc_serializable",!0);y(this,"mapper");this.mapper=e.mapper}static lc_name(){return"RunnableAssign"}async invoke(e,t){const n=await this.mapper.invoke(e,t);return{...e,...n}}async*_transform(e,t,n){const s=this.mapper.getStepsKeys(),[a,i]=gi(e),o=this.mapper.transform(i,be(n,{callbacks:t==null?void 0:t.getChild()})),c=o.next();for await(const u of a){if(typeof u!="object"||Array.isArray(u))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof u}`);const l=Object.fromEntries(Object.entries(u).filter(([d])=>!s.includes(d)));Object.keys(l).length>0&&(yield l)}yield(await c).value;for await(const u of o)yield u}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}const s=de(t),a=new hr({generator:this.transform(n(),s),config:s});return await a.setup,ft.fromAsyncGenerator(a)}},kl=class extends Ie{constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e});super(e);y(this,"lc_namespace",["langchain_core","runnables"]);y(this,"lc_serializable",!0);y(this,"keys");this.keys=e.keys}static lc_name(){return"RunnablePick"}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(n=>[n,e[n]]).filter(n=>n[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const n=await this._pick(t);n!==void 0&&(yield n)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}const s=de(t),a=new hr({generator:this.transform(n(),s),config:s});return await a.setup,ft.fromAsyncGenerator(a)}},Aa=class extends Rr{constructor(e){const t=gn.from([Qt.from(async n=>{let s;if(vu(n))try{s=await Fa(this.schema,n.args)}catch{throw new sm("Received tool input did not match expected schema",JSON.stringify(n.args))}else s=n;return s}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}});y(this,"name");y(this,"description");y(this,"schema");this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};function c0(r,e){const t=e.name??r.getName(),n=e.description??Ba(e.schema);return Dc(e.schema)?new Aa({name:t,description:n,schema:Ha({input:qa()}).transform(s=>s.input),bound:r}):new Aa({name:t,description:n,schema:e.schema,bound:r})}const es=(r,e)=>{const t=[...new Set(e==null?void 0:e.map(s=>{if(typeof s=="string")return s;const a=new s({});if(!("getType"in a)||typeof a.getType!="function")throw new Error("Invalid type provided.");return a.getType()}))],n=r.getType();return t.some(s=>s===n)};function u0(r,e){return Array.isArray(r)?hc(r,e):Qt.from(t=>hc(t,r))}function hc(r,e={}){const{includeNames:t,excludeNames:n,includeTypes:s,excludeTypes:a,includeIds:i,excludeIds:o}=e,c=[];for(const u of r)if(!(n&&u.name&&n.includes(u.name))){{if(a&&es(u,a))continue;if(o&&u.id&&o.includes(u.id))continue}s||i||t?(t&&u.name&&t.some(l=>l===u.name)||s&&es(u,s)||i&&u.id&&i.some(l=>l===u.id))&&c.push(u):c.push(u)}return c}function l0(r){return Array.isArray(r)?pc(r):Qt.from(pc)}function pc(r){if(!r.length)return[];const e=[];for(const t of r){const n=t,s=e.pop();if(!s)e.push(n);else if(n.getType()==="tool"||n.getType()!==s.getType())e.push(s,n);else{const a=Jn(s),i=Jn(n),o=a.concat(i);typeof a.content=="string"&&typeof i.content=="string"&&(o.content=`${a.content}
${i.content}`),e.push(h0(o))}}return e}function d0(r,e){if(Array.isArray(r)){const t=r;if(!e)throw new Error("Options parameter is required when providing messages.");return mc(t,e)}else{const t=r;return Qt.from(n=>mc(n,t)).withConfig({runName:"trim_messages"})}}async function mc(r,e){const{maxTokens:t,tokenCounter:n,strategy:s="last",allowPartial:a=!1,endOn:i,startOn:o,includeSystem:c=!1,textSplitter:u}=e;if(o&&s==="first")throw new Error("`startOn` should only be specified if `strategy` is 'last'.");if(c&&s==="first")throw new Error("`includeSystem` should only be specified if `strategy` is 'last'.");let l;"getNumTokens"in n?l=async f=>(await Promise.all(f.map(m=>n.getNumTokens(m.content)))).reduce((m,T)=>m+T,0):l=async f=>n(f);let d=$l;if(u&&("splitText"in u?d=u.splitText:d=async f=>u(f)),s==="first")return Rl(r,{maxTokens:t,tokenCounter:l,textSplitter:d,partialStrategy:a?"first":void 0,endOn:i});if(s==="last")return f0(r,{maxTokens:t,tokenCounter:l,textSplitter:d,allowPartial:a,includeSystem:c,startOn:o,endOn:i});throw new Error(`Unrecognized strategy: '${s}'. Must be one of 'first' or 'last'.`)}async function Rl(r,e){const{maxTokens:t,tokenCounter:n,textSplitter:s,partialStrategy:a,endOn:i}=e;let o=[...r],c=0;for(let u=0;u<o.length;u+=1){const l=u>0?o.slice(0,-u):o;if(await n(l)<=t){c=o.length-u;break}}if(c<o.length&&a){let u=!1;if(Array.isArray(o[c].content)){const l=o[c];if(typeof l.content=="string")throw new Error("Expected content to be an array.");const d=l.content.length,f=a==="last"?[...l.content].reverse():l.content;for(let h=1;h<=d;h+=1){const m=a==="first"?f.slice(0,h):f.slice(-h),T=Object.fromEntries(Object.entries(l).filter(([b])=>b!=="type"&&!b.startsWith("lc_"))),w=Ti(l.getType(),{...T,content:m}),_=[...o.slice(0,c),w];if(await n(_)<=t)o=_,c+=1,u=!0;else break}u&&a==="last"&&(l.content=[...f].reverse())}if(!u){const l=o[c];let d;if(Array.isArray(l.content)&&l.content.some(f=>typeof f=="string"||f.type==="text")){const f=l.content.find(h=>h.type==="text"&&h.text);d=f==null?void 0:f.text}else typeof l.content=="string"&&(d=l.content);if(d){const f=await s(d),h=f.length;a==="last"&&f.reverse();for(let m=0;m<h-1;m+=1)if(f.pop(),l.content=f.join(""),await n([...o.slice(0,c),l])<=t){a==="last"&&(l.content=[...f].reverse().join("")),o=[...o.slice(0,c),l],c+=1;break}}}}if(i){const u=Array.isArray(i)?i:[i];for(;c>0&&!es(o[c-1],u);)c-=1}return o.slice(0,c)}async function f0(r,e){var l;const{allowPartial:t=!1,includeSystem:n=!1,endOn:s,startOn:a,...i}=e;let o=r.map(d=>{const f=Object.fromEntries(Object.entries(d).filter(([h])=>h!=="type"&&!h.startsWith("lc_")));return Ti(d.getType(),f,Xa(d))});if(s){const d=Array.isArray(s)?s:[s];for(;o.length>0&&!es(o[o.length-1],d);)o=o.slice(0,-1)}const c=n&&((l=o[0])==null?void 0:l.getType())==="system";let u=c?o.slice(0,1).concat(o.slice(1).reverse()):o.reverse();return u=await Rl(u,{...i,partialStrategy:t?"last":void 0,endOn:a}),c?[u[0],...u.slice(1).reverse()]:u.reverse()}const gc={human:{message:xt,messageChunk:fn},ai:{message:Nt,messageChunk:Dt},system:{message:Pt,messageChunk:Xt},developer:{message:Pt,messageChunk:Xt},tool:{message:Nr,messageChunk:un},function:{message:os,messageChunk:dn},generic:{message:fr,messageChunk:ln},remove:{message:Zn,messageChunk:Zn}};function Ti(r,e,t){var a;let n,s;switch(r){case"human":t?n=new fn(e):s=new xt(e);break;case"ai":if(t){let i={...e};"tool_calls"in i&&(i={...i,tool_call_chunks:(a=i.tool_calls)==null?void 0:a.map(o=>({...o,type:"tool_call_chunk",index:void 0,args:JSON.stringify(o.args)}))}),n=new Dt(i)}else s=new Nt(e);break;case"system":t?n=new Xt(e):s=new Pt(e);break;case"developer":t?n=new Xt({...e,additional_kwargs:{...e.additional_kwargs,__openai_role__:"developer"}}):s=new Pt({...e,additional_kwargs:{...e.additional_kwargs,__openai_role__:"developer"}});break;case"tool":if("tool_call_id"in e)t?n=new un(e):s=new Nr(e);else throw new Error("Can not convert ToolMessage to ToolMessageChunk if 'tool_call_id' field is not defined.");break;case"function":if(t)n=new dn(e);else{if(!e.name)throw new Error("FunctionMessage must have a 'name' field");s=new os(e)}break;case"generic":if("role"in e)t?n=new ln(e):s=new fr(e);else throw new Error("Can not convert ChatMessage to ChatMessageChunk if 'role' field is not defined.");break;default:throw new Error(`Unrecognized message type ${r}`)}if(t&&n)return n;if(s)return s;throw new Error(`Unrecognized message type ${r}`)}function h0(r){const e=r.getType();let t;const n=Object.fromEntries(Object.entries(r).filter(([s])=>!["type","tool_call_chunks"].includes(s)&&!s.startsWith("lc_")));if(e in gc&&(t=Ti(e,n)),!t)throw new Error(`Unrecognized message chunk class ${e}. Supported classes are ${Object.keys(gc)}`);return t}function $l(r){const e=r.split(`
`);return Promise.resolve([...e.slice(0,-1).map(t=>`${t}
`),e[e.length-1]])}const p0=["tool_call","tool_call_chunk","invalid_tool_call","server_tool_call","server_tool_call_chunk","server_tool_call_result"],m0=["image","video","audio","text-plain","file"],g0=["text","reasoning",...p0,...m0];var y0={};he(y0,{AIMessage:()=>Nt,AIMessageChunk:()=>Dt,BaseMessage:()=>Mt,BaseMessageChunk:()=>Yt,ChatMessage:()=>fr,ChatMessageChunk:()=>ln,FunctionMessage:()=>os,FunctionMessageChunk:()=>dn,HumanMessage:()=>xt,HumanMessageChunk:()=>fn,KNOWN_BLOCK_TYPES:()=>g0,RemoveMessage:()=>Zn,SystemMessage:()=>Pt,SystemMessageChunk:()=>Xt,ToolMessage:()=>Nr,ToolMessageChunk:()=>un,_isMessageFieldWithRole:()=>lu,_mergeDicts:()=>je,_mergeLists:()=>cn,_mergeObj:()=>cu,_mergeStatus:()=>ou,coerceMessageLikeToMessage:()=>Vr,convertToChunk:()=>Jn,convertToOpenAIImageBlock:()=>Yc,convertToProviderContentBlock:()=>dp,defaultTextSplitter:()=>$l,defaultToolCallParser:()=>Qa,filterMessages:()=>u0,getBufferString:()=>ei,iife:()=>am,isAIMessage:()=>is,isAIMessageChunk:()=>ua,isBase64ContentBlock:()=>Za,isBaseMessage:()=>qt,isBaseMessageChunk:()=>Xa,isChatMessage:()=>Kp,isChatMessageChunk:()=>Xp,isDataContentBlock:()=>Kt,isDirectToolOutput:()=>mu,isFunctionMessage:()=>Yp,isFunctionMessageChunk:()=>Qp,isHumanMessage:()=>em,isHumanMessageChunk:()=>tm,isIDContentBlock:()=>Xc,isMessage:()=>iu,isOpenAIToolCallArray:()=>Fp,isPlainTextContentBlock:()=>up,isSystemMessage:()=>rm,isSystemMessageChunk:()=>nm,isToolMessage:()=>gu,isToolMessageChunk:()=>yu,isURLContentBlock:()=>Va,mapChatMessagesToStoredMessages:()=>lm,mapStoredMessageToChatMessage:()=>ti,mapStoredMessagesToChatMessages:()=>um,mergeContent:()=>Ct,mergeMessageRuns:()=>l0,mergeResponseMetadata:()=>fu,mergeUsageMetadata:()=>pu,parseBase64DataUrl:()=>oa,parseMimeType:()=>lp,trimMessages:()=>d0});var _0={};he(_0,{BasePromptValue:()=>gs,ChatPromptValue:()=>Nl,ImagePromptValue:()=>w0,StringPromptValue:()=>Cl});var gs=class extends Ar{},Cl=class extends gs{constructor(e){super({value:e});y(this,"lc_namespace",["langchain_core","prompt_values"]);y(this,"lc_serializable",!0);y(this,"value");this.value=e}static lc_name(){return"StringPromptValue"}toString(){return this.value}toChatMessages(){return[new xt(this.value)]}},Nl=class extends gs{constructor(e){Array.isArray(e)&&(e={messages:e});super(e);y(this,"lc_namespace",["langchain_core","prompt_values"]);y(this,"lc_serializable",!0);y(this,"messages");this.messages=e.messages}static lc_name(){return"ChatPromptValue"}toString(){return ei(this.messages)}toChatMessages(){return this.messages}},w0=class extends gs{constructor(e){"imageUrl"in e||(e={imageUrl:e});super(e);y(this,"lc_namespace",["langchain_core","prompt_values"]);y(this,"lc_serializable",!0);y(this,"imageUrl");y(this,"value");this.imageUrl=e.imageUrl}static lc_name(){return"ImagePromptValue"}toString(){return this.imageUrl.url}toChatMessages(){return[new xt({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}},U="0123456789abcdef".split(""),v0=[-2147483648,8388608,32768,128],ot=[24,16,8,0],Pn=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],Ne=[];function ht(r,e){e?(Ne[0]=Ne[16]=Ne[1]=Ne[2]=Ne[3]=Ne[4]=Ne[5]=Ne[6]=Ne[7]=Ne[8]=Ne[9]=Ne[10]=Ne[11]=Ne[12]=Ne[13]=Ne[14]=Ne[15]=0,this.blocks=Ne):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],r?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=r}ht.prototype.update=function(r){if(!this.finalized){var e,t=typeof r;if(t!=="string"){if(t==="object"){if(r===null)throw new Error(ERROR);if(ARRAY_BUFFER&&r.constructor===ArrayBuffer)r=new Uint8Array(r);else if(!Array.isArray(r)&&(!ARRAY_BUFFER||!ArrayBuffer.isView(r)))throw new Error(ERROR)}else throw new Error(ERROR);e=!0}for(var n,s=0,a,i=r.length,o=this.blocks;s<i;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,this.block=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),e)for(a=this.start;s<i&&a<64;++s)o[a>>>2]|=r[s]<<ot[a++&3];else for(a=this.start;s<i&&a<64;++s)n=r.charCodeAt(s),n<128?o[a>>>2]|=n<<ot[a++&3]:n<2048?(o[a>>>2]|=(192|n>>>6)<<ot[a++&3],o[a>>>2]|=(128|n&63)<<ot[a++&3]):n<55296||n>=57344?(o[a>>>2]|=(224|n>>>12)<<ot[a++&3],o[a>>>2]|=(128|n>>>6&63)<<ot[a++&3],o[a>>>2]|=(128|n&63)<<ot[a++&3]):(n=65536+((n&1023)<<10|r.charCodeAt(++s)&1023),o[a>>>2]|=(240|n>>>18)<<ot[a++&3],o[a>>>2]|=(128|n>>>12&63)<<ot[a++&3],o[a>>>2]|=(128|n>>>6&63)<<ot[a++&3],o[a>>>2]|=(128|n&63)<<ot[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=o[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};ht.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var r=this.blocks,e=this.lastByteIndex;r[16]=this.block,r[e>>>2]|=v0[e&3],this.block=r[16],e>=56&&(this.hashed||this.hash(),r[0]=this.block,r[16]=r[1]=r[2]=r[3]=r[4]=r[5]=r[6]=r[7]=r[8]=r[9]=r[10]=r[11]=r[12]=r[13]=r[14]=r[15]=0),r[14]=this.hBytes<<3|this.bytes>>>29,r[15]=this.bytes<<3,this.hash()}};ht.prototype.hash=function(){var r=this.h0,e=this.h1,t=this.h2,n=this.h3,s=this.h4,a=this.h5,i=this.h6,o=this.h7,c=this.blocks,u,l,d,f,h,m,T,w,_,b,v;for(u=16;u<64;++u)h=c[u-15],l=(h>>>7|h<<25)^(h>>>18|h<<14)^h>>>3,h=c[u-2],d=(h>>>17|h<<15)^(h>>>19|h<<13)^h>>>10,c[u]=c[u-16]+l+c[u-7]+d<<0;for(v=e&t,u=0;u<64;u+=4)this.first?(this.is224?(w=300032,h=c[0]-1413257819,o=h-150054599<<0,n=h+24177077<<0):(w=704751109,h=c[0]-210244248,o=h-1521486534<<0,n=h+143694565<<0),this.first=!1):(l=(r>>>2|r<<30)^(r>>>13|r<<19)^(r>>>22|r<<10),d=(s>>>6|s<<26)^(s>>>11|s<<21)^(s>>>25|s<<7),w=r&e,f=w^r&t^v,T=s&a^~s&i,h=o+d+T+Pn[u]+c[u],m=l+f,o=n+h<<0,n=h+m<<0),l=(n>>>2|n<<30)^(n>>>13|n<<19)^(n>>>22|n<<10),d=(o>>>6|o<<26)^(o>>>11|o<<21)^(o>>>25|o<<7),_=n&r,f=_^n&e^w,T=i&o^~i&s,h=a+d+T+Pn[u+1]+c[u+1],m=l+f,i=t+h<<0,t=h+m<<0,l=(t>>>2|t<<30)^(t>>>13|t<<19)^(t>>>22|t<<10),d=(i>>>6|i<<26)^(i>>>11|i<<21)^(i>>>25|i<<7),b=t&n,f=b^t&r^_,T=a&i^~a&o,h=s+d+T+Pn[u+2]+c[u+2],m=l+f,a=e+h<<0,e=h+m<<0,l=(e>>>2|e<<30)^(e>>>13|e<<19)^(e>>>22|e<<10),d=(a>>>6|a<<26)^(a>>>11|a<<21)^(a>>>25|a<<7),v=e&t,f=v^e&n^b,T=a&i^~a&o,h=s+d+T+Pn[u+3]+c[u+3],m=l+f,s=r+h<<0,r=h+m<<0,this.chromeBugWorkAround=!0;this.h0=this.h0+r<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+n<<0,this.h4=this.h4+s<<0,this.h5=this.h5+a<<0,this.h6=this.h6+i<<0,this.h7=this.h7+o<<0};ht.prototype.hex=function(){this.finalize();var r=this.h0,e=this.h1,t=this.h2,n=this.h3,s=this.h4,a=this.h5,i=this.h6,o=this.h7,c=U[r>>>28&15]+U[r>>>24&15]+U[r>>>20&15]+U[r>>>16&15]+U[r>>>12&15]+U[r>>>8&15]+U[r>>>4&15]+U[r&15]+U[e>>>28&15]+U[e>>>24&15]+U[e>>>20&15]+U[e>>>16&15]+U[e>>>12&15]+U[e>>>8&15]+U[e>>>4&15]+U[e&15]+U[t>>>28&15]+U[t>>>24&15]+U[t>>>20&15]+U[t>>>16&15]+U[t>>>12&15]+U[t>>>8&15]+U[t>>>4&15]+U[t&15]+U[n>>>28&15]+U[n>>>24&15]+U[n>>>20&15]+U[n>>>16&15]+U[n>>>12&15]+U[n>>>8&15]+U[n>>>4&15]+U[n&15]+U[s>>>28&15]+U[s>>>24&15]+U[s>>>20&15]+U[s>>>16&15]+U[s>>>12&15]+U[s>>>8&15]+U[s>>>4&15]+U[s&15]+U[a>>>28&15]+U[a>>>24&15]+U[a>>>20&15]+U[a>>>16&15]+U[a>>>12&15]+U[a>>>8&15]+U[a>>>4&15]+U[a&15]+U[i>>>28&15]+U[i>>>24&15]+U[i>>>20&15]+U[i>>>16&15]+U[i>>>12&15]+U[i>>>8&15]+U[i>>>4&15]+U[i&15];return this.is224||(c+=U[o>>>28&15]+U[o>>>24&15]+U[o>>>20&15]+U[o>>>16&15]+U[o>>>12&15]+U[o>>>8&15]+U[o>>>4&15]+U[o&15]),c};ht.prototype.toString=ht.prototype.hex;ht.prototype.digest=function(){this.finalize();var r=this.h0,e=this.h1,t=this.h2,n=this.h3,s=this.h4,a=this.h5,i=this.h6,o=this.h7,c=[r>>>24&255,r>>>16&255,r>>>8&255,r&255,e>>>24&255,e>>>16&255,e>>>8&255,e&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255,n>>>24&255,n>>>16&255,n>>>8&255,n&255,s>>>24&255,s>>>16&255,s>>>8&255,s&255,a>>>24&255,a>>>16&255,a>>>8&255,a&255,i>>>24&255,i>>>16&255,i>>>8&255,i&255];return this.is224||c.push(o>>>24&255,o>>>16&255,o>>>8&255,o&255),c};ht.prototype.array=ht.prototype.digest;ht.prototype.arrayBuffer=function(){this.finalize();var r=new ArrayBuffer(this.is224?28:32),e=new DataView(r);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),e.setUint32(20,this.h5),e.setUint32(24,this.h6),this.is224||e.setUint32(28,this.h7),r};const Pl=(...r)=>new ht(!1,!0).update(r.join("")).hex();var b0={};he(b0,{sha256:()=>Pl});var E0={};he(E0,{BaseCache:()=>jl,InMemoryCache:()=>Ml,defaultHashKeyEncoder:()=>Ll,deserializeStoredGeneration:()=>T0,serializeGeneration:()=>S0});const Ll=(...r)=>Pl(r.join("_"));function T0(r){return r.message!==void 0?{text:r.text,message:ti(r.message)}:{text:r.text}}function S0(r){const e={text:r.text};return r.message!==void 0&&(e.message=r.message.toDict()),e}var jl=class{constructor(){y(this,"keyEncoder",Ll)}makeDefaultKeyEncoder(r){this.keyEncoder=r}};const x0=new Map;var Ml=class Dl extends jl{constructor(t){super();y(this,"cache");this.cache=t??new Map}lookup(t,n){return Promise.resolve(this.cache.get(this.keyEncoder(t,n))??null)}async update(t,n,s){this.cache.set(this.keyEncoder(t,n),s)}static global(){return new Dl(x0)}},I0=Object.defineProperty,O0=(r,e,t)=>e in r?I0(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,A0=(r,e,t)=>(O0(r,e+"",t),t);function k0(r,e){let t=Array.from({length:r.length},(n,s)=>({start:s,end:s+1}));for(;t.length>1;){let n=null;for(let s=0;s<t.length-1;s++){const a=r.slice(t[s].start,t[s+1].end),i=e.get(a.join(","));i!=null&&(n==null||i<n[0])&&(n=[i,s])}if(n!=null){const s=n[1];t[s]={start:t[s].start,end:t[s+1].end},t.splice(s+1,1)}else break}return t}function R0(r,e){return r.length===1?[e.get(r.join(","))]:k0(r,e).map(t=>e.get(r.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function $0(r){return r.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var ka=class{constructor(r,e){y(this,"specialTokens");y(this,"inverseSpecialTokens");y(this,"patStr");y(this,"textEncoder",new TextEncoder);y(this,"textDecoder",new TextDecoder("utf-8"));y(this,"rankMap",new Map);y(this,"textMap",new Map);this.patStr=r.pat_str;const t=r.bpe_ranks.split(`
`).filter(Boolean).reduce((n,s)=>{const[a,i,...o]=s.split(" "),c=Number.parseInt(i,10);return o.forEach((u,l)=>n[u]=c+l),n},{});for(const[n,s]of Object.entries(t)){const a=jd.toByteArray(n);this.rankMap.set(a.join(","),s),this.textMap.set(s,a)}this.specialTokens={...r.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((n,[s,a])=>(n[a]=this.textEncoder.encode(s),n),{})}encode(r,e=[],t="all"){const n=new RegExp(this.patStr,"ug"),s=ka.specialTokenRegex(Object.keys(this.specialTokens)),a=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(u=>!i.has(u)):t);if(o.size>0){const u=ka.specialTokenRegex([...o]),l=r.match(u);if(l!=null)throw new Error(`The text contains a special token that is not allowed: ${l[0]}`)}let c=0;for(;;){let u=null,l=c;for(;s.lastIndex=l,u=s.exec(r),!(u==null||i.has(u[0]));)l=u.index+1;const d=(u==null?void 0:u.index)??r.length;for(const h of r.substring(c,d).matchAll(n)){const m=this.textEncoder.encode(h[0]),T=this.rankMap.get(m.join(","));if(T!=null){a.push(T);continue}a.push(...R0(m,this.rankMap))}if(u==null)break;let f=this.specialTokens[u[0]];a.push(f),c=u.index+u[0].length}return a}decode(r){const e=[];let t=0;for(let a=0;a<r.length;++a){const i=r[a],o=this.textMap.get(i)??this.inverseSpecialTokens[i];o!=null&&(e.push(o),t+=o.length)}const n=new Uint8Array(t);let s=0;for(const a of e)n.set(a,s),s+=a.length;return this.textDecoder.decode(n)}},Ul=ka;A0(Ul,"specialTokenRegex",r=>new RegExp(r.map(e=>$0(e)).join("|"),"g"));function C0(r){switch(r){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw new Error("Unknown model")}}var N0={};he(N0,{encodingForModel:()=>Si,getEncoding:()=>Fl});const Ln={},P0=new ms({});async function Fl(r){return r in Ln||(Ln[r]=P0.fetch(`https://tiktoken.pages.dev/js/${r}.json`).then(e=>e.json()).then(e=>new Ul(e)).catch(e=>{throw delete Ln[r],e})),await Ln[r]}async function Si(r){return Fl(C0(r))}var L0={};he(L0,{BaseLangChain:()=>zl,BaseLanguageModel:()=>Gl,calculateMaxTokens:()=>D0,getEmbeddingContextSize:()=>j0,getModelContextSize:()=>Bl,getModelNameForTiktoken:()=>ys,isOpenAITool:()=>M0});const ys=r=>r.startsWith("gpt-5")?"gpt-5":r.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":r.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":r.startsWith("gpt-4-32k")?"gpt-4-32k":r.startsWith("gpt-4-")?"gpt-4":r.startsWith("gpt-4o")?"gpt-4o":r,j0=r=>{switch(r){case"text-embedding-ada-002":return 8191;default:return 2046}},Bl=r=>{switch(ys(r)){case"gpt-5":case"gpt-5-turbo":case"gpt-5-turbo-preview":return 4e5;case"gpt-4o":case"gpt-4o-mini":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":return 128e3;case"gpt-4-turbo":case"gpt-4-turbo-preview":case"gpt-4-turbo-2024-04-09":case"gpt-4-0125-preview":case"gpt-4-1106-preview":return 128e3;case"gpt-4-32k":case"gpt-4-32k-0314":case"gpt-4-32k-0613":return 32768;case"gpt-4":case"gpt-4-0314":case"gpt-4-0613":return 8192;case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-16k-0613":return 16384;case"gpt-3.5-turbo":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-1106":case"gpt-3.5-turbo-0125":return 4096;case"text-davinci-003":case"text-davinci-002":return 4097;case"text-davinci-001":return 2049;case"text-curie-001":case"text-babbage-001":case"text-ada-001":return 2048;case"code-davinci-002":case"code-davinci-001":return 8e3;case"code-cushman-001":return 2048;case"claude-3-5-sonnet-20241022":case"claude-3-5-sonnet-20240620":case"claude-3-opus-20240229":case"claude-3-sonnet-20240229":case"claude-3-haiku-20240307":case"claude-2.1":return 2e5;case"claude-2.0":case"claude-instant-1.2":return 1e5;case"gemini-1.5-pro":case"gemini-1.5-pro-latest":case"gemini-1.5-flash":case"gemini-1.5-flash-latest":return 1e6;case"gemini-pro":case"gemini-pro-vision":return 32768;default:return 4097}};function M0(r){return typeof r!="object"||!r?!1:!!("type"in r&&r.type==="function"&&"function"in r&&typeof r.function=="object"&&r.function&&"name"in r.function&&"parameters"in r.function)}const D0=async({prompt:r,modelName:e})=>{let t;try{t=(await Si(ys(e))).encode(r).length}catch{console.warn("Failed to calculate number of tokens, falling back to approximate count"),t=Math.ceil(r.length/4)}return Bl(e)-t},U0=()=>!1;var zl=class extends Ie{constructor(e){super(e);y(this,"verbose");y(this,"callbacks");y(this,"tags");y(this,"metadata");this.verbose=e.verbose??U0(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}get lc_attributes(){return{callbacks:void 0,verbose:void 0}}},Gl=class extends zl{constructor({callbacks:e,callbackManager:t,...n}){const{cache:s,...a}=n;super({callbacks:e??t,...a});y(this,"caller");y(this,"cache");y(this,"_encoding");typeof s=="object"?this.cache=s:s?this.cache=Ml.global():this.cache=void 0,this.caller=new ms(n??{})}get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}async getNumTokens(e){let t;typeof e=="string"?t=e:t=e.map(s=>typeof s=="string"?s:s.type==="text"&&"text"in s?s.text:"").join("");let n=Math.ceil(t.length/4);if(!this._encoding)try{this._encoding=await Si("modelName"in this?ys(this.modelName):"gpt2")}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}if(this._encoding)try{n=this._encoding.encode(t).length}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}return n}static _convertInputToPromptValue(e){return typeof e=="string"?new Cl(e):Array.isArray(e)?new Nl(e.map(Vr)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const n={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(n).filter(([i,o])=>o!==void 0).map(([i,o])=>`${i}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}get profile(){return{}}},$r=class extends Ie{constructor(e){super(e);y(this,"lc_namespace",["langchain_core","runnables"]);y(this,"lc_serializable",!0);y(this,"func");e&&(this.func=e.func)}static lc_name(){return"RunnablePassthrough"}async invoke(e,t){const n=de(t);return this.func&&await this.func(e,n),this._callWithConfig(s=>Promise.resolve(s),e,n)}async*transform(e,t){const n=de(t);let s,a=!0;for await(const i of this._transformStreamWithConfig(e,o=>o,n))if(yield i,a)if(s===void 0)s=i;else try{s=lr(s,i)}catch{s=void 0,a=!1}this.func&&s!==void 0&&await this.func(s,n)}static assign(e){return new Ei(new jr({steps:e}))}};const F0=r=>r();function Ws(r){const e=r.constructor;return new e({...r,content:r.contentBlocks,response_metadata:{...r.response_metadata,output_version:"v1"}})}var B0={};he(B0,{BaseChatModel:()=>xi,SimpleChatModel:()=>z0});function Ks(r){const e=[];for(const t of r){let n=t;if(Array.isArray(t.content))for(let s=0;s<t.content.length;s++){const a=t.content[s];(Va(a)||Za(a))&&n===t&&(n=new t.constructor({...n,content:[...t.content.slice(0,s),Yc(a),...t.content.slice(s+1)]}))}e.push(n)}return e}var xi=class nr extends Gl{constructor(t){super(t);y(this,"lc_namespace",["langchain","chat_models",this._llmType()]);y(this,"disableStreaming",!1);y(this,"outputVersion");this.outputVersion=F0(()=>{const n=t.outputVersion??Ot("LC_OUTPUT_VERSION");return n&&["v0","v1"].includes(n)?n:"v0"})}get callKeys(){return[...super.callKeys,"outputVersion"]}_separateRunnableConfigFromCallOptionsCompat(t){const[n,s]=super._separateRunnableConfigFromCallOptions(t);return s.signal=n.signal,[n,s]}async invoke(t,n){const s=nr._convertInputToPromptValue(t);return(await this.generatePrompt([s],n,n==null?void 0:n.callbacks)).generations[0][0].message}async*_streamResponseChunks(t,n,s){throw new Error("Not implemented.")}async*_streamIterator(t,n){var s;if(this._streamResponseChunks===nr.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(t,n);else{const i=nr._convertInputToPromptValue(t).toChatMessages(),[o,c]=this._separateRunnableConfigFromCallOptionsCompat(n),u={...o.metadata,...this.getLsParams(c)},l=await Tt.configure(o.callbacks,this.callbacks,o.tags,this.tags,u,this.metadata,{verbose:this.verbose}),d={options:c,invocation_params:this==null?void 0:this.invocationParams(c),batch_size:1},f=c.outputVersion??this.outputVersion,h=await(l==null?void 0:l.handleChatModelStart(this.toJSON(),[Ks(i)],o.runId,void 0,d,void 0,void 0,o.runName));let m,T;try{for await(const w of this._streamResponseChunks(i,c,h==null?void 0:h[0])){if(w.message.id==null){const _=(s=h==null?void 0:h.at(0))==null?void 0:s.runId;_!=null&&w.message._updateId(`run-${_}`)}w.message.response_metadata={...w.generationInfo,...w.message.response_metadata},f==="v1"?yield Ws(w.message):yield w.message,m?m=m.concat(w):m=w,ua(w.message)&&w.message.usage_metadata!==void 0&&(T={tokenUsage:{promptTokens:w.message.usage_metadata.input_tokens,completionTokens:w.message.usage_metadata.output_tokens,totalTokens:w.message.usage_metadata.total_tokens}})}}catch(w){throw await Promise.all((h??[]).map(_=>_==null?void 0:_.handleLLMError(w))),w}await Promise.all((h??[]).map(w=>w==null?void 0:w.handleLLMEnd({generations:[[m]],llmOutput:T})))}}getLsParams(t){const n=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:t.stop,ls_provider:n}}async _generateUncached(t,n,s,a){var h,m;const i=t.map(T=>T.map(Vr));let o;if(a!==void 0&&a.length===i.length)o=a;else{const T={...s.metadata,...this.getLsParams(n)},w=await Tt.configure(s.callbacks,this.callbacks,s.tags,this.tags,T,this.metadata,{verbose:this.verbose}),_={options:n,invocation_params:this==null?void 0:this.invocationParams(n),batch_size:1};o=await(w==null?void 0:w.handleChatModelStart(this.toJSON(),i.map(Ks),s.runId,void 0,_,void 0,void 0,s.runName))}const c=n.outputVersion??this.outputVersion,u=[],l=[];if(!!(o!=null&&o[0].handlers.find(Au))&&!this.disableStreaming&&i.length===1&&this._streamResponseChunks!==nr.prototype._streamResponseChunks)try{const T=await this._streamResponseChunks(i[0],n,o==null?void 0:o[0]);let w,_;for await(const b of T){if(b.message.id==null){const v=(h=o==null?void 0:o.at(0))==null?void 0:h.runId;v!=null&&b.message._updateId(`run-${v}`)}w===void 0?w=b:w=lr(w,b),ua(b.message)&&b.message.usage_metadata!==void 0&&(_={tokenUsage:{promptTokens:b.message.usage_metadata.input_tokens,completionTokens:b.message.usage_metadata.output_tokens,totalTokens:b.message.usage_metadata.total_tokens}})}if(w===void 0)throw new Error("Received empty response from chat model call.");u.push([w]),await(o==null?void 0:o[0].handleLLMEnd({generations:u,llmOutput:_}))}catch(T){throw await(o==null?void 0:o[0].handleLLMError(T)),T}else{const T=await Promise.allSettled(i.map(async(w,_)=>{const b=await this._generate(w,{...n,promptIndex:_},o==null?void 0:o[_]);if(c==="v1")for(const v of b.generations)v.message=Ws(v.message);return b}));await Promise.all(T.map(async(w,_)=>{var b,v,O;if(w.status==="fulfilled"){const x=w.value;for(const A of x.generations){if(A.message.id==null){const J=(b=o==null?void 0:o.at(0))==null?void 0:b.runId;J!=null&&A.message._updateId(`run-${J}`)}A.message.response_metadata={...A.generationInfo,...A.message.response_metadata}}return x.generations.length===1&&(x.generations[0].message.response_metadata={...x.llmOutput,...x.generations[0].message.response_metadata}),u[_]=x.generations,l[_]=x.llmOutput,(v=o==null?void 0:o[_])==null?void 0:v.handleLLMEnd({generations:[x.generations],llmOutput:x.llmOutput})}else return await((O=o==null?void 0:o[_])==null?void 0:O.handleLLMError(w.reason)),Promise.reject(w.reason)}))}const f={generations:u,llmOutput:l.length?(m=this._combineLLMOutput)==null?void 0:m.call(this,...l):void 0};return Object.defineProperty(f,_a,{value:o?{runIds:o==null?void 0:o.map(T=>T.runId)}:void 0,configurable:!0}),f}async _generateCached({messages:t,cache:n,llmStringKey:s,parsedOptions:a,handledOptions:i}){const o=t.map(b=>b.map(Vr)),c={...i.metadata,...this.getLsParams(a)},u=await Tt.configure(i.callbacks,this.callbacks,i.tags,this.tags,c,this.metadata,{verbose:this.verbose}),l={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1},d=await(u==null?void 0:u.handleChatModelStart(this.toJSON(),o.map(Ks),i.runId,void 0,l,void 0,void 0,i.runName)),f=[],m=(await Promise.allSettled(o.map(async(b,v)=>{const O=nr._convertInputToPromptValue(b).toString(),x=await n.lookup(O,s);return x==null&&f.push(v),x}))).map((b,v)=>({result:b,runManager:d==null?void 0:d[v]})).filter(({result:b})=>b.status==="fulfilled"&&b.value!=null||b.status==="rejected"),T=a.outputVersion??this.outputVersion,w=[];await Promise.all(m.map(async({result:b,runManager:v},O)=>{if(b.status==="fulfilled"){const x=b.value;return w[O]=x.map(A=>("message"in A&&qt(A.message)&&is(A.message)&&(A.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0},T==="v1"&&(A.message=Ws(A.message))),A.generationInfo={...A.generationInfo,tokenUsage:{}},A)),x.length&&await(v==null?void 0:v.handleLLMNewToken(x[0].text)),v==null?void 0:v.handleLLMEnd({generations:[x]},void 0,void 0,void 0,{cached:!0})}else return await(v==null?void 0:v.handleLLMError(b.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(b.reason)}));const _={generations:w,missingPromptIndices:f,startedRunManagers:d};return Object.defineProperty(_,_a,{value:d?{runIds:d==null?void 0:d.map(b=>b.runId)}:void 0,configurable:!0}),_}async generate(t,n,s){let a;Array.isArray(n)?a={stop:n}:a=n;const i=t.map(T=>T.map(Vr)),[o,c]=this._separateRunnableConfigFromCallOptionsCompat(a);if(o.callbacks=o.callbacks??s,!this.cache)return this._generateUncached(i,c,o);const{cache:u}=this,l=this._getSerializedCacheKeyParametersForCall(c),{generations:d,missingPromptIndices:f,startedRunManagers:h}=await this._generateCached({messages:i,cache:u,llmStringKey:l,parsedOptions:c,handledOptions:o});let m={};if(f.length>0){const T=await this._generateUncached(f.map(w=>i[w]),c,o,h!==void 0?f.map(w=>h==null?void 0:h[w]):void 0);await Promise.all(T.generations.map(async(w,_)=>{const b=f[_];d[b]=w;const v=nr._convertInputToPromptValue(i[b]).toString();return u.update(v,l,w)})),m=T.llmOutput??{}}return{generations:d,llmOutput:m}}invocationParams(t){return{}}_modelType(){return"base_chat_model"}async generatePrompt(t,n,s){const a=t.map(i=>i.toChatMessages());return this.generate(a,n,s)}withStructuredOutput(t,n){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(n!=null&&n.strict)throw new Error('"strict" mode is not supported for this model by default.');const s=t,a=n==null?void 0:n.name,i=Ba(s)??"A function available to call.",o=n==null?void 0:n.method,c=n==null?void 0:n.includeRaw;if(o==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let u=a??"extract",l;or(s)?l=[{type:"function",function:{name:u,description:i,parameters:Wt(s)}}]:("name"in s&&(u=s.name),l=[{type:"function",function:{name:u,description:i,parameters:s}}]);const d=this.bindTools(l),f=Qt.from(w=>{if(!Dt.isInstance(w))throw new Error("Input is not an AIMessageChunk.");if(!w.tool_calls||w.tool_calls.length===0)throw new Error("No tool calls found in the response.");const _=w.tool_calls.find(b=>b.name===u);if(!_)throw new Error(`No tool call found with name ${u}.`);return _.args});if(!c)return d.pipe(f).withConfig({runName:"StructuredOutput"});const h=$r.assign({parsed:(w,_)=>f.invoke(w.raw,_)}),m=$r.assign({parsed:()=>null}),T=h.withFallbacks({fallbacks:[m]});return gn.from([{raw:d},T]).withConfig({runName:"StructuredOutputRunnable"})}},z0=class extends xi{async _generate(r,e,t){const n=await this._call(r,e,t),s=new Nt(n);if(typeof s.content!="string")throw new Error("Cannot generate with a simple chat model when output is not a string.");return{generations:[{text:s.content,message:s}]}}},G0={};he(G0,{extendInteropZodObject:()=>pf,getInteropZodDefaultGetter:()=>gf,getInteropZodObjectShape:()=>Qs,getSchemaDescription:()=>Ba,interopParse:()=>df,interopParseAsync:()=>Fa,interopSafeParse:()=>lf,interopSafeParseAsync:()=>Mc,interopZodObjectMakeFieldsOptional:()=>wf,interopZodObjectPartial:()=>mf,interopZodObjectPassthrough:()=>ea,interopZodObjectStrict:()=>Fn,interopZodTransformInputSchema:()=>Uc,isInteropZodError:()=>vf,isInteropZodLiteral:()=>uf,isInteropZodObject:()=>hf,isInteropZodSchema:()=>or,isShapelessZodSchema:()=>ff,isSimpleStringZodSchema:()=>Dc,isZodArrayV4:()=>ss,isZodLiteralV3:()=>Lc,isZodLiteralV4:()=>jc,isZodObjectV3:()=>za,isZodObjectV4:()=>vt,isZodSchema:()=>cf,isZodSchemaV3:()=>Ce,isZodSchemaV4:()=>Oe});const _r="0.19.0";let yc=!1,Kr,ql,Hl,Ra,Vl,Zl,Jl,Wl,Kl;function q0(r,e={auto:!1}){if(yc)throw new Error(`you must \`import 'groq-sdk/shims/${r.kind}'\` before importing anything else from groq-sdk`);if(Kr)throw new Error(`can't \`import 'groq-sdk/shims/${r.kind}'\` after \`import 'groq-sdk/shims/${Kr}'\``);yc=e.auto,Kr=r.kind,ql=r.fetch,Hl=r.FormData,Ra=r.File,Vl=r.ReadableStream,Zl=r.getMultipartRequestOptions,Jl=r.getDefaultAgent,Wl=r.fileFromPath,Kl=r.isFsReadStream}class H0{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function V0({manuallyImported:r}={}){const e=r?"You may need to use polyfills":"Add one of these imports before your first `import  from 'groq-sdk'`:\n- `import 'groq-sdk/shims/node'` (if you're running on Node)\n- `import 'groq-sdk/shims/web'` (otherwise)\n";let t,n,s,a;try{t=fetch,n=Request,s=Response,a=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:n,Response:s,Headers:a,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new H0(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/groq/groq-typescript#file-uploads")},isFsReadStream:i=>!1}}const Xl=()=>{Kr||q0(V0(),{auto:!0})};Xl();class dt extends Error{}class Me extends dt{constructor(e,t,n,s){super(`${Me.makeMessage(e,t,n)}`),this.status=e,this.headers=s,this.error=t}static makeMessage(e,t,n){const s=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,n,s){if(!e||!s)return new _s({message:n,cause:Na(t)});const a=t;return e===400?new Ql(e,a,n,s):e===401?new ed(e,a,n,s):e===403?new td(e,a,n,s):e===404?new rd(e,a,n,s):e===409?new nd(e,a,n,s):e===422?new sd(e,a,n,s):e===429?new ad(e,a,n,s):e>=500?new id(e,a,n,s):new Me(e,a,n,s)}}class $a extends Me{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class _s extends Me{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class Yl extends _s{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Ql extends Me{}class ed extends Me{}class td extends Me{}class rd extends Me{}class nd extends Me{}class sd extends Me{}class ad extends Me{}class id extends Me{}class br{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;const s=new Z0;async function*a(){if(!e.body)throw t.abort(),new dt("Attempted to iterate over a response with no body");const o=new dr,c=_c(e.body);for await(const u of c)for(const l of o.decode(u)){const d=s.decode(l);d&&(yield d)}for(const u of o.flush()){const l=s.decode(u);l&&(yield l)}}async function*i(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let o=!1;try{for await(const c of a())if(!o){if(c.data.startsWith("[DONE]")){o=!0;continue}if(c.event===null||c.event==="error"){let u;try{u=JSON.parse(c.data)}catch(l){throw console.error("Could not parse message into JSON:",c.data),console.error("From chunk:",c.raw),l}if(u&&u.error)throw new Me(u.error.status_code,u.error,u.error.message,void 0);yield u}}o=!0}catch(c){if(c instanceof Error&&c.name==="AbortError")return;throw c}finally{o||t.abort()}}return new br(i,t)}static fromReadableStream(e,t){let n=!1;async function*s(){const i=new dr,o=_c(e);for await(const c of o)for(const u of i.decode(c))yield u;for(const c of i.flush())yield c}async function*a(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let i=!1;try{for await(const o of s())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new br(a,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),s=a=>({next:()=>{if(a.length===0){const i=n.next();e.push(i),t.push(i)}return a.shift()}});return[new br(()=>s(e),this.controller),new br(()=>s(t),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new Vl({async start(){t=e[Symbol.asyncIterator]()},async pull(s){try{const{value:a,done:i}=await t.next();if(i)return s.close();const o=n.encode(JSON.stringify(a)+`
`);s.enqueue(o)}catch(a){s.error(a)}},async cancel(){var s;await((s=t.return)==null?void 0:s.call(t))}})}}class Z0{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,s]=J0(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}}class dr{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const n=dr.NEWLINE_CHARS.has(t[t.length-1]||"");let s=t.split(dr.NEWLINE_REGEXP);return s.length===1&&!n?(this.buffer.push(s[0]),[]):(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),n||(this.buffer=[s.pop()||""]),s)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new dt(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new dt(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new dt("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}dr.NEWLINE_CHARS=new Set([`
`,"\r","\v","\f","","","","","\u2028","\u2029"]);dr.NEWLINE_REGEXP=/\r\n|[\n\r\x0b\x0c\x1c\x1d\x1e\x85\u2028\u2029]/g;function J0(r,e){const t=r.indexOf(e);return t!==-1?[r.substring(0,t),e,r.substring(t+e.length)]:[r,"",""]}function _c(r){if(r[Symbol.asyncIterator])return r;const e=r.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const od=r=>r!=null&&typeof r=="object"&&typeof r.url=="string"&&typeof r.blob=="function",cd=r=>r!=null&&typeof r=="object"&&typeof r.name=="string"&&typeof r.lastModified=="number"&&ws(r),ws=r=>r!=null&&typeof r=="object"&&typeof r.size=="number"&&typeof r.type=="string"&&typeof r.text=="function"&&typeof r.slice=="function"&&typeof r.arrayBuffer=="function",W0=r=>cd(r)||od(r)||Kl(r);async function ud(r,e,t){var s;if(r=await r,cd(r))return r;if(od(r)){const a=await r.blob();e||(e=new URL(r.url).pathname.split(/[\\/]/).pop()??"unknown_file");const i=ws(a)?[await a.arrayBuffer()]:[a];return new Ra(i,e,t)}const n=await K0(r);if(e||(e=Y0(r)??"unknown_file"),!(t!=null&&t.type)){const a=(s=n[0])==null?void 0:s.type;typeof a=="string"&&(t={...t,type:a})}return new Ra(n,e,t)}async function K0(r){var t;let e=[];if(typeof r=="string"||ArrayBuffer.isView(r)||r instanceof ArrayBuffer)e.push(r);else if(ws(r))e.push(await r.arrayBuffer());else if(Q0(r))for await(const n of r)e.push(n);else throw new Error(`Unexpected data type: ${typeof r}; constructor: ${(t=r==null?void 0:r.constructor)==null?void 0:t.name}; props: ${X0(r)}`);return e}function X0(r){return`[${Object.getOwnPropertyNames(r).map(t=>`"${t}"`).join(", ")}]`}function Y0(r){var e;return Xs(r.name)||Xs(r.filename)||((e=Xs(r.path))==null?void 0:e.split(/[\\/]/).pop())}const Xs=r=>{if(typeof r=="string")return r;if(typeof Buffer<"u"&&r instanceof Buffer)return String(r)},Q0=r=>r!=null&&typeof r=="object"&&typeof r[Symbol.asyncIterator]=="function",wc=r=>r&&typeof r=="object"&&r.body&&r[Symbol.toStringTag]==="MultipartBody",Ii=async r=>{const e=await eb(r.body);return Zl(e,r)},eb=async r=>{const e=new Hl;return await Promise.all(Object.entries(r||{}).map(([t,n])=>Ca(e,t,n))),e},Ca=async(r,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")r.append(e,String(t));else if(W0(t)){const n=await ud(t);r.append(e,n)}else if(Array.isArray(t))await Promise.all(t.map(n=>Ca(r,e+"[]",n)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([n,s])=>Ca(r,`${e}[${n}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Er={};Xl();async function ld(r){var i;const{response:e}=r;if(r.options.stream)return Tr("response",e.status,e.url,e.headers,e.body),r.options.__streamClass?r.options.__streamClass.fromSSEResponse(e,r.controller):br.fromSSEResponse(e,r.controller);if(e.status===204)return null;if(r.options.__binaryResponse)return e;const t=e.headers.get("content-type"),n=(i=t==null?void 0:t.split(";")[0])==null?void 0:i.trim();if((n==null?void 0:n.includes("application/json"))||(n==null?void 0:n.endsWith("+json"))){const o=await e.json();return Tr("response",e.status,e.url,e.headers,o),o}const a=await e.text();return Tr("response",e.status,e.url,e.headers,a),a}class vs extends Promise{constructor(e,t=ld){super(n=>{n(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new vs(this.responsePromise,async t=>e(await this.parseResponse(t),t))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class tb{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e4,httpAgent:s,fetch:a}){this.baseURL=e,this.maxRetries=Ys("maxRetries",t),this.timeout=Ys("timeout",n),this.httpAgent=s,this.fetch=a??ql}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...ib(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${hb()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(async s=>{const a=s&&ws(s==null?void 0:s.body)?new DataView(await s.body.arrayBuffer()):(s==null?void 0:s.body)instanceof DataView?s.body:(s==null?void 0:s.body)instanceof ArrayBuffer?new DataView(s.body):s&&ArrayBuffer.isView(s==null?void 0:s.body)?new DataView(s.body.buffer):s==null?void 0:s.body;return{method:e,path:t,...s,body:a}}))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){var m;e={...e};const{method:n,path:s,query:a,headers:i={}}=e,o=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:wc(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,c=this.calculateContentLength(o),u=this.buildURL(s,a);"timeout"in e&&Ys("timeout",e.timeout),e.timeout=e.timeout??this.timeout;const l=e.httpAgent??this.httpAgent??Jl(u),d=e.timeout+1e3;typeof((m=l==null?void 0:l.options)==null?void 0:m.timeout)=="number"&&d>(l.options.timeout??0)&&(l.options.timeout=d),this.idempotencyHeader&&n!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const f=this.buildHeaders({options:e,headers:i,contentLength:c,retryCount:t});return{req:{method:n,...o&&{body:o},headers:f,...l&&{agent:l},signal:e.signal??null},url:u,timeout:e.timeout}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:s}){const a={};n&&(a["content-length"]=n);const i=this.defaultHeaders(e);return Sc(a,i),Sc(a,t),wc(e.body)&&Kr!=="node"&&delete a["content-type"],jn(i,"x-stainless-retry-count")===void 0&&jn(t,"x-stainless-retry-count")===void 0&&(a["x-stainless-retry-count"]=String(s)),jn(i,"x-stainless-timeout")===void 0&&jn(t,"x-stainless-timeout")===void 0&&e.timeout&&(a["x-stainless-timeout"]=String(e.timeout)),this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,n,s){return Me.generate(e,t,n,s)}request(e,t=null){return new vs(this.makeRequest(e,t))}async makeRequest(e,t){var d,f;const n=await e,s=n.maxRetries??this.maxRetries;t==null&&(t=s),await this.prepareOptions(n);const{req:a,url:i,timeout:o}=this.buildRequest(n,{retryCount:s-t});if(await this.prepareRequest(a,{url:i,options:n}),Tr("request",i,n,a.headers),(d=n.signal)!=null&&d.aborted)throw new $a;const c=new AbortController,u=await this.fetchWithTimeout(i,a,o,c).catch(Na);if(u instanceof Error){if((f=n.signal)!=null&&f.aborted)throw new $a;if(t)return this.retryRequest(n,t);throw u.name==="AbortError"?new Yl:new _s({cause:u})}const l=nb(u.headers);if(!u.ok){if(t&&this.shouldRetry(u)){const b=`retrying, ${t} attempts remaining`;return Tr(`response (error; ${b})`,u.status,i,l),this.retryRequest(n,t,l)}const h=await u.text().catch(b=>Na(b).message),m=ob(h),T=m?void 0:h;throw Tr(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,u.status,i,l,T),this.makeStatusError(u.status,m,T,l)}return{response:u,options:n,controller:c}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new rb(this,n,e)}buildURL(e,t){const n=ub(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return db(s)||(t={...s,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,n])=>typeof n<"u").map(([t,n])=>{if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(n)}`;if(n===null)return`${encodeURIComponent(t)}=`;throw new dt(`Cannot stringify type ${typeof n}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,n,s){const{signal:a,...i}=t||{};a&&a.addEventListener("abort",()=>s.abort());const o=setTimeout(()=>s.abort(),n),c={signal:s.signal,...i};return c.method&&(c.method=c.method.toUpperCase()),this.fetch.call(void 0,e,c).finally(()=>{clearTimeout(o)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,n){let s;const a=n==null?void 0:n["retry-after-ms"];if(a){const o=parseFloat(a);Number.isNaN(o)||(s=o)}const i=n==null?void 0:n["retry-after"];if(i&&!s){const o=parseFloat(i);Number.isNaN(o)?s=Date.parse(i)-Date.now():s=o*1e3}if(!(s&&0<=s&&s<60*1e3)){const o=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,o)}return await lb(s),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const a=t-e,i=Math.min(.5*Math.pow(2,a),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${_r}`}}class rb extends vs{constructor(e,t,n){super(t,async s=>new n(e,s.response,await ld(s),s.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const nb=r=>new Proxy(Object.fromEntries(r.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),sb=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":_r,"X-Stainless-OS":bc(Deno.build.os),"X-Stainless-Arch":vc(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":_r,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":_r,"X-Stainless-OS":bc(process.platform),"X-Stainless-Arch":vc(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const r=ab();return r?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":_r,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${r.browser}`,"X-Stainless-Runtime-Version":r.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":_r,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function ab(){if(typeof navigator>"u"||!navigator)return null;const r=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of r){const n=t.exec(navigator.userAgent);if(n){const s=n[1]||0,a=n[2]||0,i=n[3]||0;return{browser:e,version:`${s}.${a}.${i}`}}}return null}const vc=r=>r==="x32"?"x32":r==="x86_64"||r==="x64"?"x64":r==="arm"?"arm":r==="aarch64"||r==="arm64"?"arm64":r?`other:${r}`:"unknown",bc=r=>(r=r.toLowerCase(),r.includes("ios")?"iOS":r==="android"?"Android":r==="darwin"?"MacOS":r==="win32"?"Windows":r==="freebsd"?"FreeBSD":r==="openbsd"?"OpenBSD":r==="linux"?"Linux":r?`Other:${r}`:"Unknown");let Ec;const ib=()=>Ec??(Ec=sb()),ob=r=>{try{return JSON.parse(r)}catch{return}},cb=/^[a-z][a-z0-9+.-]*:/i,ub=r=>cb.test(r),lb=r=>new Promise(e=>setTimeout(e,r)),Ys=(r,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new dt(`${r} must be an integer`);if(e<0)throw new dt(`${r} must be a positive integer`);return e},Na=r=>{if(r instanceof Error)return r;if(typeof r=="object"&&r!==null)try{return new Error(JSON.stringify(r))}catch{}return new Error(r)},Tc=r=>{var e,t,n,s;if(typeof process<"u")return((e=Er==null?void 0:Er[r])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(s=(n=(t=Deno.env)==null?void 0:t.get)==null?void 0:n.call(t,r))==null?void 0:s.trim()};function db(r){if(!r)return!0;for(const e in r)return!1;return!0}function fb(r,e){return Object.prototype.hasOwnProperty.call(r,e)}function Sc(r,e){for(const t in e){if(!fb(e,t))continue;const n=t.toLowerCase();if(!n)continue;const s=e[t];s===null?delete r[n]:s!==void 0&&(r[n]=s)}}function Tr(r,...e){typeof process<"u"&&(Er==null?void 0:Er.DEBUG)==="true"&&console.log(`Groq:DEBUG:${r}`,...e)}const hb=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{const e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)}),pb=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",mb=r=>typeof(r==null?void 0:r.get)=="function",jn=(r,e)=>{var n;const t=e.toLowerCase();if(mb(r)){const s=((n=e[0])==null?void 0:n.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(a,i,o)=>i+o.toUpperCase());for(const a of[e,t,e.toUpperCase(),s]){const i=r.get(a);if(i)return i}}for(const[s,a]of Object.entries(r))if(s.toLowerCase()===t)return Array.isArray(a)?(a.length<=1||console.warn(`Received ${a.length} entries for the ${e} header, using the first entry.`),a[0]):a};class gt{constructor(e){this._client=e}}class dd extends gt{create(e,t){return this._client.post("/openai/v1/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t==null?void 0:t.headers},__binaryResponse:!0})}}class fd extends gt{create(e,t){return this._client.post("/openai/v1/audio/transcriptions",Ii({body:e,...t}))}}class hd extends gt{create(e,t){return this._client.post("/openai/v1/audio/translations",Ii({body:e,...t}))}}class yn extends gt{constructor(){super(...arguments),this.speech=new dd(this._client),this.transcriptions=new fd(this._client),this.translations=new hd(this._client)}}yn.Speech=dd;yn.Transcriptions=fd;yn.Translations=hd;class pd extends gt{create(e,t){return this._client.post("/openai/v1/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/openai/v1/batches/${e}`,t)}list(e){return this._client.get("/openai/v1/batches",e)}cancel(e,t){return this._client.post(`/openai/v1/batches/${e}/cancel`,t)}}let md=class extends gt{create(e,t){return this._client.post("/openai/v1/chat/completions",{body:e,...t,stream:e.stream??!1})}};class Oi extends gt{constructor(){super(...arguments),this.completions=new md(this._client)}}Oi.Completions=md;class gd extends gt{}class yd extends gt{create(e,t){return this._client.post("/openai/v1/embeddings",{body:e,...t})}}class _d extends gt{create(e,t){return this._client.post("/openai/v1/files",Ii({body:e,...t}))}list(e){return this._client.get("/openai/v1/files",e)}delete(e,t){return this._client.delete(`/openai/v1/files/${e}`,t)}content(e,t){return this._client.get(`/openai/v1/files/${e}/content`,t)}info(e,t){return this._client.get(`/openai/v1/files/${e}`,t)}}class wd extends gt{retrieve(e,t){return this._client.get(`/openai/v1/models/${e}`,t)}list(e){return this._client.get("/openai/v1/models",e)}delete(e,t){return this._client.delete(`/openai/v1/models/${e}`,t)}}var vd;class _e extends tb{constructor({baseURL:e=Tc("GROQ_BASE_URL"),apiKey:t=Tc("GROQ_API_KEY"),...n}={}){if(t===void 0)throw new dt("The GROQ_API_KEY environment variable is missing or empty; either provide it, or instantiate the Groq client with an apiKey option, like new Groq({ apiKey: 'My API Key' }).");const s={apiKey:t,...n,baseURL:e||"https://api.groq.com"};if(!s.dangerouslyAllowBrowser&&pb())throw new dt(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Groq({ apiKey, dangerouslyAllowBrowser: true })`);super({baseURL:s.baseURL,timeout:s.timeout??6e4,httpAgent:s.httpAgent,maxRetries:s.maxRetries,fetch:s.fetch}),this.completions=new gd(this),this.chat=new Oi(this),this.embeddings=new yd(this),this.audio=new yn(this),this.models=new wd(this),this.batches=new pd(this),this.files=new _d(this),this._options=s,this.apiKey=t}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}}vd=_e;_e.Groq=vd;_e.DEFAULT_TIMEOUT=6e4;_e.GroqError=dt;_e.APIError=Me;_e.APIConnectionError=_s;_e.APIConnectionTimeoutError=Yl;_e.APIUserAbortError=$a;_e.NotFoundError=rd;_e.ConflictError=nd;_e.RateLimitError=ad;_e.BadRequestError=Ql;_e.AuthenticationError=ed;_e.InternalServerError=id;_e.PermissionDeniedError=td;_e.UnprocessableEntityError=sd;_e.toFile=ud;_e.fileFromPath=Wl;_e.Completions=gd;_e.Chat=Oi;_e.Embeddings=yd;_e.Audio=yn;_e.Models=wd;_e.Batches=pd;_e.Files=_d;var gb=class extends Ie{constructor(e){super(e);y(this,"lc_namespace",["langchain_core","runnables"]);y(this,"lc_serializable",!0);y(this,"runnables");this.runnables=e.runnables}static lc_name(){return"RouterRunnable"}async invoke(e,t){const{key:n,input:s}=e,a=this.runnables[n];if(a===void 0)throw new Error(`No runnable associated with key "${n}".`);return a.invoke(s,de(t))}async batch(e,t,n){var f;const s=e.map(h=>h.key),a=e.map(h=>h.input);if(s.find(h=>this.runnables[h]===void 0)!==void 0)throw new Error("One or more keys do not have a corresponding runnable.");const o=s.map(h=>this.runnables[h]),c=this._getOptionsList(t??{},e.length),u=((f=c[0])==null?void 0:f.maxConcurrency)??(n==null?void 0:n.maxConcurrency),l=u&&u>0?u:e.length,d=[];for(let h=0;h<a.length;h+=l){const m=a.slice(h,h+l).map((w,_)=>o[_].invoke(w,c[_])),T=await Promise.all(m);d.push(T)}return d.flat()}async stream(e,t){const{key:n,input:s}=e,a=this.runnables[n];if(a===void 0)throw new Error(`No runnable associated with key "${n}".`);return a.stream(s,t)}},yb=class extends Ie{constructor(e){super(e);y(this,"lc_namespace",["langchain_core","runnables"]);y(this,"lc_serializable",!0);y(this,"default");y(this,"branches");this.branches=e.branches,this.default=e.default}static lc_name(){return"RunnableBranch"}static from(e){if(e.length<1)throw new Error("RunnableBranch requires at least one branch");const n=e.slice(0,-1).map(([a,i])=>[lt(a),lt(i)]),s=lt(e[e.length-1]);return new this({branches:n,default:s})}async _invoke(e,t,n){let s;for(let a=0;a<this.branches.length;a+=1){const[i,o]=this.branches[a];if(await i.invoke(e,be(t,{callbacks:n==null?void 0:n.getChild(`condition:${a+1}`)}))){s=await o.invoke(e,be(t,{callbacks:n==null?void 0:n.getChild(`branch:${a+1}`)}));break}}return s||(s=await this.default.invoke(e,be(t,{callbacks:n==null?void 0:n.getChild("branch:default")}))),s}async invoke(e,t={}){return this._callWithConfig(this._invoke,e,t)}async*_streamIterator(e,t){const n=await Ke(t),s=await(n==null?void 0:n.handleChainStart(this.toJSON(),$e(e,"input"),t==null?void 0:t.runId,void 0,void 0,void 0,t==null?void 0:t.runName));let a,i=!0,o;try{for(let c=0;c<this.branches.length;c+=1){const[u,l]=this.branches[c];if(await u.invoke(e,be(t,{callbacks:s==null?void 0:s.getChild(`condition:${c+1}`)}))){o=await l.stream(e,be(t,{callbacks:s==null?void 0:s.getChild(`branch:${c+1}`)}));for await(const f of o)if(yield f,i)if(a===void 0)a=f;else try{a=lr(a,f)}catch{a=void 0,i=!1}break}}if(o===void 0){o=await this.default.stream(e,be(t,{callbacks:s==null?void 0:s.getChild("branch:default")}));for await(const c of o)if(yield c,i)if(a===void 0)a=c;else try{a=lr(a,c)}catch{a=void 0,i=!1}}}catch(c){throw await(s==null?void 0:s.handleChainError(c)),c}await(s==null?void 0:s.handleChainEnd(a??{}))}},_b=class extends Rr{constructor(e){let t=Qt.from((i,o)=>this._enterHistory(i,o??{})).withConfig({runName:"loadHistory"});const n=e.historyMessagesKey??e.inputMessagesKey;n&&(t=$r.assign({[n]:t}).withConfig({runName:"insertHistory"}));const s=t.pipe(e.runnable.withListeners({onEnd:(i,o)=>this._exitHistory(i,o??{})})).withConfig({runName:"RunnableWithMessageHistory"}),a=e.config??{};super({...e,config:a,bound:s});y(this,"runnable");y(this,"inputMessagesKey");y(this,"outputMessagesKey");y(this,"historyMessagesKey");y(this,"getMessageHistory");this.runnable=e.runnable,this.getMessageHistory=e.getMessageHistory,this.inputMessagesKey=e.inputMessagesKey,this.outputMessagesKey=e.outputMessagesKey,this.historyMessagesKey=e.historyMessagesKey}_getInputMessages(e){let t;if(typeof e=="object"&&!Array.isArray(e)&&!qt(e)){let n;this.inputMessagesKey?n=this.inputMessagesKey:Object.keys(e).length===1?n=Object.keys(e)[0]:n="input",Array.isArray(e[n])&&Array.isArray(e[n][0])?t=e[n][0]:t=e[n]}else t=e;if(typeof t=="string")return[new xt(t)];if(Array.isArray(t))return t;if(qt(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages.
Got ${JSON.stringify(t,null,2)}`)}_getOutputMessages(e){let t;if(!Array.isArray(e)&&!qt(e)&&typeof e!="string"){let n;this.outputMessagesKey!==void 0?n=this.outputMessagesKey:Object.keys(e).length===1?n=Object.keys(e)[0]:n="output",e.generations!==void 0?t=e.generations[0][0].message:t=e[n]}else t=e;if(typeof t=="string")return[new Nt(t)];if(Array.isArray(t))return t;if(qt(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages. Received: ${JSON.stringify(t,null,2)}`)}async _enterHistory(e,t){var a;const s=await((a=t==null?void 0:t.configurable)==null?void 0:a.messageHistory).getMessages();return this.historyMessagesKey===void 0?s.concat(this._getInputMessages(e)):s}async _exitHistory(e,t){var c;const n=(c=t.configurable)==null?void 0:c.messageHistory;let s;Array.isArray(e.inputs)&&Array.isArray(e.inputs[0])?s=e.inputs[0]:s=e.inputs;let a=this._getInputMessages(s);if(this.historyMessagesKey===void 0){const u=await n.getMessages();a=a.slice(u.length)}const i=e.outputs;if(!i)throw new Error(`Output values from 'Run' undefined. Run: ${JSON.stringify(e,null,2)}`);const o=this._getOutputMessages(i);await n.addMessages([...a,...o])}async _mergeConfig(...e){const t=await super._mergeConfig(...e);if(!t.configurable||!t.configurable.sessionId){const s={[this.inputMessagesKey??"input"]:"foo"},a={configurable:{sessionId:"123"}};throw new Error(`sessionId is required. Pass it in as part of the config argument to .invoke() or .stream()
eg. chain.invoke(${JSON.stringify(s)}, ${JSON.stringify(a)})`)}const{sessionId:n}=t.configurable;return t.configurable.messageHistory=await this.getMessageHistory(n),t}},wb={};he(wb,{RouterRunnable:()=>gb,Runnable:()=>Ie,RunnableAssign:()=>Ei,RunnableBinding:()=>Rr,RunnableBranch:()=>yb,RunnableEach:()=>s0,RunnableLambda:()=>Qt,RunnableMap:()=>jr,RunnableParallel:()=>o0,RunnablePassthrough:()=>$r,RunnablePick:()=>kl,RunnableRetry:()=>bi,RunnableSequence:()=>gn,RunnableToolLike:()=>Aa,RunnableWithFallbacks:()=>Al,RunnableWithMessageHistory:()=>_b,_coerceToRunnable:()=>lt,ensureConfig:()=>de,getCallbackManagerForConfig:()=>Ke,mergeConfigs:()=>ga,patchConfig:()=>be,pickRunnableConfigKeys:()=>ur,raceWithSignal:()=>jt});var bd=class extends Ie{parseResultWithPrompt(r,e,t){return this.parseResult(r,t)}_baseMessageToString(r){return typeof r.content=="string"?r.content:this._baseMessageContentToString(r.content)}_baseMessageContentToString(r){return JSON.stringify(r)}async invoke(r,e){return typeof r=="string"?this._callWithConfig(async(t,n)=>this.parseResult([{text:t}],n==null?void 0:n.callbacks),r,{...e,runType:"parser"}):this._callWithConfig(async(t,n)=>this.parseResult([{message:t,text:this._baseMessageToString(t)}],n==null?void 0:n.callbacks),r,{...e,runType:"parser"})}},bs=class extends bd{parseResult(r,e){return this.parse(r[0].text,e)}async parseWithPrompt(r,e,t){return this.parse(r,t)}_type(){throw new Error("_type not implemented")}},kt=class extends Error{constructor(e,t,n,s=!1){super(e);y(this,"llmOutput");y(this,"observation");y(this,"sendToLLM");if(this.llmOutput=t,this.observation=n,this.sendToLLM=s,s&&(n===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");wu(this,"OUTPUT_PARSING_FAILURE")}},_n=class extends bs{async*_transform(r){for await(const e of r)typeof e=="string"?yield this.parseResult([{text:e}]):yield this.parseResult([{message:e,text:this._baseMessageToString(e)}])}async*transform(r,e){yield*this._transformStreamWithConfig(r,this._transform.bind(this),{...e,runType:"parser"})}},Es=class extends _n{constructor(e){super(e);y(this,"diff",!1);this.diff=(e==null?void 0:e.diff)??this.diff}async*_transform(e){let t,n;for await(const s of e){if(typeof s!="string"&&typeof s.content!="string")throw new Error("Cannot handle non-string output.");let a;if(Xa(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");a=new an({message:s,text:s.content})}else if(qt(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");a=new an({message:Jn(s),text:s.content})}else a=new sn({text:s});n===void 0?n=a:n=n.concat(a);const i=await this.parsePartialResult([n]);i!=null&&!sr(i,t)&&(this.diff?yield this._diff(t,i):yield i,t=i)}}getFormatInstructions(){return""}},vb={};he(vb,{applyPatch:()=>kr,compare:()=>yi});var Ed=class extends Es{constructor(){super(...arguments);y(this,"lc_namespace",["langchain_core","output_parsers"]);y(this,"lc_serializable",!0)}static lc_name(){return"JsonOutputParser"}_concatOutputChunks(e,t){return this.diff?super._concatOutputChunks(e,t):t}_diff(e,t){if(t)return e?yi(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return ca(e[0].text)}async parse(e){return ca(e,JSON.parse)}getFormatInstructions(){return""}},bb=class extends _n{constructor(){super(...arguments);y(this,"lc_namespace",["langchain_core","output_parsers","bytes"]);y(this,"lc_serializable",!0);y(this,"textEncoder",new TextEncoder)}static lc_name(){return"BytesOutputParser"}parse(e){return Promise.resolve(this.textEncoder.encode(e))}getFormatInstructions(){return""}},wn=class extends _n{constructor(){super(...arguments);y(this,"re")}async*_transform(e){let t="";for await(const n of e)if(typeof n=="string"?t+=n:t+=n.content,this.re){const s=[...t.matchAll(this.re)];if(s.length>1){let a=0;for(const i of s.slice(0,-1))yield[i[1]],a+=(i.index??0)+i[0].length;t=t.slice(a)}}else{const s=await this.parse(t);if(s.length>1){for(const a of s.slice(0,-1))yield[a];t=s[s.length-1]}}for(const n of await this.parse(t))yield[n]}},Eb=class extends wn{constructor(){super(...arguments);y(this,"lc_namespace",["langchain_core","output_parsers","list"]);y(this,"lc_serializable",!0)}static lc_name(){return"CommaSeparatedListOutputParser"}async parse(e){try{return e.trim().split(",").map(t=>t.trim())}catch{throw new kt(`Could not parse output: ${e}`,e)}}getFormatInstructions(){return"Your response should be a list of comma separated values, eg: `foo, bar, baz`"}},Tb=class extends wn{constructor({length:e,separator:t}){super(...arguments);y(this,"lc_namespace",["langchain_core","output_parsers","list"]);y(this,"length");y(this,"separator");this.length=e,this.separator=t||","}async parse(e){try{const t=e.trim().split(this.separator).map(n=>n.trim());if(this.length!==void 0&&t.length!==this.length)throw new kt(`Incorrect number of items. Expected ${this.length}, got ${t.length}.`);return t}catch(t){throw Object.getPrototypeOf(t)===kt.prototype?t:new kt(`Could not parse output: ${e}`)}}getFormatInstructions(){return`Your response should be a list of ${this.length===void 0?"":`${this.length} `}items separated by "${this.separator}" (eg: \`foo${this.separator} bar${this.separator} baz\`)`}},Sb=class extends wn{constructor(){super(...arguments);y(this,"lc_namespace",["langchain_core","output_parsers","list"]);y(this,"lc_serializable",!0);y(this,"re",/\d+\.\s([^\n]+)/g)}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(t=>t[1])}},xb=class extends wn{constructor(){super(...arguments);y(this,"lc_namespace",["langchain_core","output_parsers","list"]);y(this,"lc_serializable",!0);y(this,"re",/^\s*[-*]\s([^\n]+)$/gm)}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(t=>t[1])}},Ib=class extends _n{constructor(){super(...arguments);y(this,"lc_namespace",["langchain_core","output_parsers","string"]);y(this,"lc_serializable",!0)}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw new Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentToString(e){switch(e.type){case"text":case"text_delta":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw new Error(`Cannot coerce "${e.type}" message part into a string.`)}throw new Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce((t,n)=>t+this._messageContentToString(n),"")}},Ai=class extends bs{constructor(e){super(e);y(this,"lc_namespace",["langchain","output_parsers","structured"]);this.schema=e}static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){const t=Ha(Object.fromEntries(Object.entries(e).map(([n,s])=>[n,qa().describe(s)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Wt(this.schema))}
\`\`\`
`}async parse(e){var t,n;try{const s=e.trim(),i=(((t=s.match(/^```(?:json)?\s*([\s\S]*?)```/))==null?void 0:t[1])||((n=s.match(/```json\s*([\s\S]*?)```/))==null?void 0:n[1])||s).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(o,c)=>`"${c.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await Fa(this.schema,JSON.parse(i))}catch(s){throw new kt(`Failed to parse. Text: "${e}". Error: ${s}`,e)}}},Td=class extends Ai{static lc_name(){return"JsonMarkdownStructuredOutputParser"}getFormatInstructions(r){const e=(r==null?void 0:r.interpolationDepth)??1;if(e<1)throw new Error("f string interpolation depth must be at least 1");return`Return a markdown code snippet with a JSON object formatted to look like:
\`\`\`json
${this._schemaToInstruction(Wt(this.schema)).replaceAll("{","{".repeat(e)).replaceAll("}","}".repeat(e))}
\`\`\``}_schemaToInstruction(r,e=2){const t=r;if("type"in t){let n=!1,s;if(Array.isArray(t.type)){const o=t.type.findIndex(c=>c==="null");o!==-1&&(n=!0,t.type.splice(o,1)),s=t.type.join(" | ")}else s=t.type;if(t.type==="object"&&t.properties){const o=t.description?` // ${t.description}`:"";return`{
${Object.entries(t.properties).map(([u,l])=>{var f;const d=(f=t.required)!=null&&f.includes(u)?"":" (optional)";return`${" ".repeat(e)}"${u}": ${this._schemaToInstruction(l,e+2)}${d}`}).join(`
`)}
${" ".repeat(e-2)}}${o}`}if(t.type==="array"&&t.items){const o=t.description?` // ${t.description}`:"";return`array[
${" ".repeat(e)}${this._schemaToInstruction(t.items,e+2)}
${" ".repeat(e-2)}] ${o}`}const a=n?" (nullable)":"",i=t.description?` // ${t.description}`:"";return`${s}${i}${a}`}if("anyOf"in t)return t.anyOf.map(n=>this._schemaToInstruction(n,e)).join(`
${" ".repeat(e-2)}`);throw new Error("unsupported schema type")}static fromZodSchema(r){return new this(r)}static fromNamesAndDescriptions(r){const e=Ha(Object.fromEntries(Object.entries(r).map(([t,n])=>[t,qa().describe(n)])));return new this(e)}},Ob=class extends bs{constructor({inputSchema:e}){super(...arguments);y(this,"structuredInputParser");this.structuredInputParser=new Td(e)}async parse(e){let t;try{t=await this.structuredInputParser.parse(e)}catch(n){throw new kt(`Failed to parse. Text: "${e}". Error: ${n}`,e)}return this.outputProcessor(t)}getFormatInstructions(){return this.structuredInputParser.getFormatInstructions()}};const Ab=function(){const r={};r.parser=function(g,p){return new t(g,p)},r.SAXParser=t,r.SAXStream=u,r.createStream=c,r.MAX_BUFFER_LENGTH=64*1024;const e=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];r.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"];function t(g,p){if(!(this instanceof t))return new t(g,p);var I=this;s(I),I.q=I.c="",I.bufferCheckPosition=r.MAX_BUFFER_LENGTH,I.opt=p||{},I.opt.lowercase=I.opt.lowercase||I.opt.lowercasetags,I.looseCase=I.opt.lowercase?"toLowerCase":"toUpperCase",I.tags=[],I.closed=I.closedRoot=I.sawRoot=!1,I.tag=I.error=null,I.strict=!!g,I.noscript=!!(g||I.opt.noscript),I.state=E.BEGIN,I.strictEntities=I.opt.strictEntities,I.ENTITIES=I.strictEntities?Object.create(r.XML_ENTITIES):Object.create(r.ENTITIES),I.attribList=[],I.opt.xmlns&&(I.ns=Object.create(m)),I.trackPosition=I.opt.position!==!1,I.trackPosition&&(I.position=I.line=I.column=0),xe(I,"onready")}Object.create||(Object.create=function(g){function p(){}p.prototype=g;var I=new p;return I}),Object.keys||(Object.keys=function(g){var p=[];for(var I in g)g.hasOwnProperty(I)&&p.push(I);return p});function n(g){for(var p=Math.max(r.MAX_BUFFER_LENGTH,10),I=0,S=0,ie=e.length;S<ie;S++){var ge=g[e[S]].length;if(ge>p)switch(e[S]){case"textNode":De(g);break;case"cdata":ce(g,"oncdata",g.cdata),g.cdata="";break;case"script":ce(g,"onscript",g.script),g.script="";break;default:P(g,"Max buffer length exceeded: "+e[S])}I=Math.max(I,ge)}var we=r.MAX_BUFFER_LENGTH-I;g.bufferCheckPosition=we+g.position}function s(g){for(var p=0,I=e.length;p<I;p++)g[e[p]]=""}function a(g){De(g),g.cdata!==""&&(ce(g,"oncdata",g.cdata),g.cdata=""),g.script!==""&&(ce(g,"onscript",g.script),g.script="")}t.prototype={end:function(){$(this)},write:ue,resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){a(this)}};var i=ReadableStream;i||(i=function(){});var o=r.EVENTS.filter(function(g){return g!=="error"&&g!=="end"});function c(g,p){return new u(g,p)}function u(g,p){if(!(this instanceof u))return new u(g,p);i.apply(this),this._parser=new t(g,p),this.writable=!0,this.readable=!0;var I=this;this._parser.onend=function(){I.emit("end")},this._parser.onerror=function(S){I.emit("error",S),I._parser.error=null},this._decoder=null,o.forEach(function(S){Object.defineProperty(I,"on"+S,{get:function(){return I._parser["on"+S]},set:function(ie){if(!ie)return I.removeAllListeners(S),I._parser["on"+S]=ie,ie;I.on(S,ie)},enumerable:!0,configurable:!1})})}u.prototype=Object.create(i.prototype,{constructor:{value:u}}),u.prototype.write=function(g){return this._parser.write(g.toString()),this.emit("data",g),!0},u.prototype.end=function(g){return g&&g.length&&this.write(g),this._parser.end(),!0},u.prototype.on=function(g,p){var I=this;return!I._parser["on"+g]&&o.indexOf(g)!==-1&&(I._parser["on"+g]=function(){var S=arguments.length===1?[arguments[0]]:Array.apply(null,arguments);S.splice(0,0,g),I.emit.apply(I,S)}),i.prototype.on.call(I,g,p)};var l="[CDATA[",d="DOCTYPE",f="http://www.w3.org/XML/1998/namespace",h="http://www.w3.org/2000/xmlns/",m={xml:f,xmlns:h},T=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,w=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/,_=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,b=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;function v(g){return g===" "||g===`
`||g==="\r"||g==="	"}function O(g){return g==='"'||g==="'"}function x(g){return g===">"||v(g)}function A(g,p){return g.test(p)}function J(g,p){return!A(g,p)}var E=0;r.STATE={BEGIN:E++,BEGIN_WHITESPACE:E++,TEXT:E++,TEXT_ENTITY:E++,OPEN_WAKA:E++,SGML_DECL:E++,SGML_DECL_QUOTED:E++,DOCTYPE:E++,DOCTYPE_QUOTED:E++,DOCTYPE_DTD:E++,DOCTYPE_DTD_QUOTED:E++,COMMENT_STARTING:E++,COMMENT:E++,COMMENT_ENDING:E++,COMMENT_ENDED:E++,CDATA:E++,CDATA_ENDING:E++,CDATA_ENDING_2:E++,PROC_INST:E++,PROC_INST_BODY:E++,PROC_INST_ENDING:E++,OPEN_TAG:E++,OPEN_TAG_SLASH:E++,ATTRIB:E++,ATTRIB_NAME:E++,ATTRIB_NAME_SAW_WHITE:E++,ATTRIB_VALUE:E++,ATTRIB_VALUE_QUOTED:E++,ATTRIB_VALUE_CLOSED:E++,ATTRIB_VALUE_UNQUOTED:E++,ATTRIB_VALUE_ENTITY_Q:E++,ATTRIB_VALUE_ENTITY_U:E++,CLOSE_TAG:E++,CLOSE_TAG_SAW_WHITE:E++,SCRIPT:E++,SCRIPT_ENDING:E++},r.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},r.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(r.ENTITIES).forEach(function(g){var p=r.ENTITIES[g],I=typeof p=="number"?String.fromCharCode(p):p;r.ENTITIES[g]=I});for(var ye in r.STATE)r.STATE[r.STATE[ye]]=ye;E=r.STATE;function xe(g,p,I){g[p]&&g[p](I)}function ce(g,p,I){g.textNode&&De(g),xe(g,p,I)}function De(g){g.textNode=er(g.opt,g.textNode),g.textNode&&xe(g,"ontext",g.textNode),g.textNode=""}function er(g,p){return g.trim&&(p=p.trim()),g.normalize&&(p=p.replace(/\s+/g," ")),p}function P(g,p){return De(g),g.trackPosition&&(p+=`
Line: `+g.line+`
Column: `+g.column+`
Char: `+g.c),p=new Error(p),g.error=p,xe(g,"onerror",p),g}function $(g){return g.sawRoot&&!g.closedRoot&&C(g,"Unclosed root tag"),g.state!==E.BEGIN&&g.state!==E.BEGIN_WHITESPACE&&g.state!==E.TEXT&&P(g,"Unexpected end"),De(g),g.c="",g.closed=!0,xe(g,"onend"),t.call(g,g.strict,g.opt),g}function C(g,p){if(typeof g!="object"||!(g instanceof t))throw new Error("bad call to strictFail");g.strict&&P(g,p)}function G(g){g.strict||(g.tagName=g.tagName[g.looseCase]());var p=g.tags[g.tags.length-1]||g,I=g.tag={name:g.tagName,attributes:{}};g.opt.xmlns&&(I.ns=p.ns),g.attribList.length=0,ce(g,"onopentagstart",I)}function H(g,p){var I=g.indexOf(":"),S=I<0?["",g]:g.split(":"),ie=S[0],ge=S[1];return p&&g==="xmlns"&&(ie="xmlns",ge=""),{prefix:ie,local:ge}}function B(g){if(g.strict||(g.attribName=g.attribName[g.looseCase]()),g.attribList.indexOf(g.attribName)!==-1||g.tag.attributes.hasOwnProperty(g.attribName)){g.attribName=g.attribValue="";return}if(g.opt.xmlns){var p=H(g.attribName,!0),I=p.prefix,S=p.local;if(I==="xmlns")if(S==="xml"&&g.attribValue!==f)C(g,"xml: prefix must be bound to "+f+`
Actual: `+g.attribValue);else if(S==="xmlns"&&g.attribValue!==h)C(g,"xmlns: prefix must be bound to "+h+`
Actual: `+g.attribValue);else{var ie=g.tag,ge=g.tags[g.tags.length-1]||g;ie.ns===ge.ns&&(ie.ns=Object.create(ge.ns)),ie.ns[S]=g.attribValue}g.attribList.push([g.attribName,g.attribValue])}else g.tag.attributes[g.attribName]=g.attribValue,ce(g,"onattribute",{name:g.attribName,value:g.attribValue});g.attribName=g.attribValue=""}function W(g,p){if(g.opt.xmlns){var I=g.tag,S=H(g.tagName);I.prefix=S.prefix,I.local=S.local,I.uri=I.ns[S.prefix]||"",I.prefix&&!I.uri&&(C(g,"Unbound namespace prefix: "+JSON.stringify(g.tagName)),I.uri=S.prefix);var ie=g.tags[g.tags.length-1]||g;I.ns&&ie.ns!==I.ns&&Object.keys(I.ns).forEach(function(tr){ce(g,"onopennamespace",{prefix:tr,uri:I.ns[tr]})});for(var ge=0,we=g.attribList.length;ge<we;ge++){var Ae=g.attribList[ge],Pe=Ae[0],nt=Ae[1],Ee=H(Pe,!0),Qe=Ee.prefix,pr=Ee.local,vn=Qe===""?"":I.ns[Qe]||"",L={name:Pe,value:nt,prefix:Qe,local:pr,uri:vn};Qe&&Qe!=="xmlns"&&!vn&&(C(g,"Unbound namespace prefix: "+JSON.stringify(Qe)),L.uri=Qe),g.tag.attributes[Pe]=L,ce(g,"onattribute",L)}g.attribList.length=0}g.tag.isSelfClosing=!!p,g.sawRoot=!0,g.tags.push(g.tag),ce(g,"onopentag",g.tag),p||(!g.noscript&&g.tagName.toLowerCase()==="script"?g.state=E.SCRIPT:g.state=E.TEXT,g.tag=null,g.tagName=""),g.attribName=g.attribValue="",g.attribList.length=0}function se(g){if(!g.tagName){C(g,"Weird empty close tag."),g.textNode+="</>",g.state=E.TEXT;return}if(g.script){if(g.tagName!=="script"){g.script+="</"+g.tagName+">",g.tagName="",g.state=E.SCRIPT;return}ce(g,"onscript",g.script),g.script=""}var p=g.tags.length,I=g.tagName;g.strict||(I=I[g.looseCase]());for(var S=I;p--;){var ie=g.tags[p];if(ie.name!==S)C(g,"Unexpected close tag");else break}if(p<0){C(g,"Unmatched closing tag: "+g.tagName),g.textNode+="</"+g.tagName+">",g.state=E.TEXT;return}g.tagName=I;for(var ge=g.tags.length;ge-- >p;){var we=g.tag=g.tags.pop();g.tagName=g.tag.name,ce(g,"onclosetag",g.tagName);var Ae={};for(var Pe in we.ns)Ae[Pe]=we.ns[Pe];var nt=g.tags[g.tags.length-1]||g;g.opt.xmlns&&we.ns!==nt.ns&&Object.keys(we.ns).forEach(function(Ee){var Qe=we.ns[Ee];ce(g,"onclosenamespace",{prefix:Ee,uri:Qe})})}p===0&&(g.closedRoot=!0),g.tagName=g.attribValue=g.attribName="",g.attribList.length=0,g.state=E.TEXT}function ne(g){var p=g.entity,I=p.toLowerCase(),S,ie="";return g.ENTITIES[p]?g.ENTITIES[p]:g.ENTITIES[I]?g.ENTITIES[I]:(p=I,p.charAt(0)==="#"&&(p.charAt(1)==="x"?(p=p.slice(2),S=parseInt(p,16),ie=S.toString(16)):(p=p.slice(1),S=parseInt(p,10),ie=S.toString(10))),p=p.replace(/^0+/,""),isNaN(S)||ie.toLowerCase()!==p?(C(g,"Invalid character entity"),"&"+g.entity+";"):String.fromCodePoint(S))}function pe(g,p){p==="<"?(g.state=E.OPEN_WAKA,g.startTagPosition=g.position):v(p)||(C(g,"Non-whitespace before first tag."),g.textNode=p,g.state=E.TEXT)}function Re(g,p){var I="";return p<g.length&&(I=g.charAt(p)),I}function ue(g){var p=this;if(this.error)throw this.error;if(p.closed)return P(p,"Cannot write after close. Assign an onready handler.");if(g===null)return $(p);typeof g=="object"&&(g=g.toString());for(var I=0,S="";S=Re(g,I++),p.c=S,!!S;)switch(p.trackPosition&&(p.position++,S===`
`?(p.line++,p.column=0):p.column++),p.state){case E.BEGIN:if(p.state=E.BEGIN_WHITESPACE,S==="\uFEFF")continue;pe(p,S);continue;case E.BEGIN_WHITESPACE:pe(p,S);continue;case E.TEXT:if(p.sawRoot&&!p.closedRoot){for(var ie=I-1;S&&S!=="<"&&S!=="&";)S=Re(g,I++),S&&p.trackPosition&&(p.position++,S===`
`?(p.line++,p.column=0):p.column++);p.textNode+=g.substring(ie,I-1)}S==="<"&&!(p.sawRoot&&p.closedRoot&&!p.strict)?(p.state=E.OPEN_WAKA,p.startTagPosition=p.position):(!v(S)&&(!p.sawRoot||p.closedRoot)&&C(p,"Text data outside of root node."),S==="&"?p.state=E.TEXT_ENTITY:p.textNode+=S);continue;case E.SCRIPT:S==="<"?p.state=E.SCRIPT_ENDING:p.script+=S;continue;case E.SCRIPT_ENDING:S==="/"?p.state=E.CLOSE_TAG:(p.script+="<"+S,p.state=E.SCRIPT);continue;case E.OPEN_WAKA:if(S==="!")p.state=E.SGML_DECL,p.sgmlDecl="";else if(!v(S))if(A(T,S))p.state=E.OPEN_TAG,p.tagName=S;else if(S==="/")p.state=E.CLOSE_TAG,p.tagName="";else if(S==="?")p.state=E.PROC_INST,p.procInstName=p.procInstBody="";else{if(C(p,"Unencoded <"),p.startTagPosition+1<p.position){var ge=p.position-p.startTagPosition;S=new Array(ge).join(" ")+S}p.textNode+="<"+S,p.state=E.TEXT}continue;case E.SGML_DECL:(p.sgmlDecl+S).toUpperCase()===l?(ce(p,"onopencdata"),p.state=E.CDATA,p.sgmlDecl="",p.cdata=""):p.sgmlDecl+S==="--"?(p.state=E.COMMENT,p.comment="",p.sgmlDecl=""):(p.sgmlDecl+S).toUpperCase()===d?(p.state=E.DOCTYPE,(p.doctype||p.sawRoot)&&C(p,"Inappropriately located doctype declaration"),p.doctype="",p.sgmlDecl=""):S===">"?(ce(p,"onsgmldeclaration",p.sgmlDecl),p.sgmlDecl="",p.state=E.TEXT):(O(S)&&(p.state=E.SGML_DECL_QUOTED),p.sgmlDecl+=S);continue;case E.SGML_DECL_QUOTED:S===p.q&&(p.state=E.SGML_DECL,p.q=""),p.sgmlDecl+=S;continue;case E.DOCTYPE:S===">"?(p.state=E.TEXT,ce(p,"ondoctype",p.doctype),p.doctype=!0):(p.doctype+=S,S==="["?p.state=E.DOCTYPE_DTD:O(S)&&(p.state=E.DOCTYPE_QUOTED,p.q=S));continue;case E.DOCTYPE_QUOTED:p.doctype+=S,S===p.q&&(p.q="",p.state=E.DOCTYPE);continue;case E.DOCTYPE_DTD:p.doctype+=S,S==="]"?p.state=E.DOCTYPE:O(S)&&(p.state=E.DOCTYPE_DTD_QUOTED,p.q=S);continue;case E.DOCTYPE_DTD_QUOTED:p.doctype+=S,S===p.q&&(p.state=E.DOCTYPE_DTD,p.q="");continue;case E.COMMENT:S==="-"?p.state=E.COMMENT_ENDING:p.comment+=S;continue;case E.COMMENT_ENDING:S==="-"?(p.state=E.COMMENT_ENDED,p.comment=er(p.opt,p.comment),p.comment&&ce(p,"oncomment",p.comment),p.comment=""):(p.comment+="-"+S,p.state=E.COMMENT);continue;case E.COMMENT_ENDED:S!==">"?(C(p,"Malformed comment"),p.comment+="--"+S,p.state=E.COMMENT):p.state=E.TEXT;continue;case E.CDATA:S==="]"?p.state=E.CDATA_ENDING:p.cdata+=S;continue;case E.CDATA_ENDING:S==="]"?p.state=E.CDATA_ENDING_2:(p.cdata+="]"+S,p.state=E.CDATA);continue;case E.CDATA_ENDING_2:S===">"?(p.cdata&&ce(p,"oncdata",p.cdata),ce(p,"onclosecdata"),p.cdata="",p.state=E.TEXT):S==="]"?p.cdata+="]":(p.cdata+="]]"+S,p.state=E.CDATA);continue;case E.PROC_INST:S==="?"?p.state=E.PROC_INST_ENDING:v(S)?p.state=E.PROC_INST_BODY:p.procInstName+=S;continue;case E.PROC_INST_BODY:if(!p.procInstBody&&v(S))continue;S==="?"?p.state=E.PROC_INST_ENDING:p.procInstBody+=S;continue;case E.PROC_INST_ENDING:S===">"?(ce(p,"onprocessinginstruction",{name:p.procInstName,body:p.procInstBody}),p.procInstName=p.procInstBody="",p.state=E.TEXT):(p.procInstBody+="?"+S,p.state=E.PROC_INST_BODY);continue;case E.OPEN_TAG:A(w,S)?p.tagName+=S:(G(p),S===">"?W(p):S==="/"?p.state=E.OPEN_TAG_SLASH:(v(S)||C(p,"Invalid character in tag name"),p.state=E.ATTRIB));continue;case E.OPEN_TAG_SLASH:S===">"?(W(p,!0),se(p)):(C(p,"Forward-slash in opening tag not followed by >"),p.state=E.ATTRIB);continue;case E.ATTRIB:if(v(S))continue;S===">"?W(p):S==="/"?p.state=E.OPEN_TAG_SLASH:A(T,S)?(p.attribName=S,p.attribValue="",p.state=E.ATTRIB_NAME):C(p,"Invalid attribute name");continue;case E.ATTRIB_NAME:S==="="?p.state=E.ATTRIB_VALUE:S===">"?(C(p,"Attribute without value"),p.attribValue=p.attribName,B(p),W(p)):v(S)?p.state=E.ATTRIB_NAME_SAW_WHITE:A(w,S)?p.attribName+=S:C(p,"Invalid attribute name");continue;case E.ATTRIB_NAME_SAW_WHITE:if(S==="=")p.state=E.ATTRIB_VALUE;else{if(v(S))continue;C(p,"Attribute without value"),p.tag.attributes[p.attribName]="",p.attribValue="",ce(p,"onattribute",{name:p.attribName,value:""}),p.attribName="",S===">"?W(p):A(T,S)?(p.attribName=S,p.state=E.ATTRIB_NAME):(C(p,"Invalid attribute name"),p.state=E.ATTRIB)}continue;case E.ATTRIB_VALUE:if(v(S))continue;O(S)?(p.q=S,p.state=E.ATTRIB_VALUE_QUOTED):(C(p,"Unquoted attribute value"),p.state=E.ATTRIB_VALUE_UNQUOTED,p.attribValue=S);continue;case E.ATTRIB_VALUE_QUOTED:if(S!==p.q){S==="&"?p.state=E.ATTRIB_VALUE_ENTITY_Q:p.attribValue+=S;continue}B(p),p.q="",p.state=E.ATTRIB_VALUE_CLOSED;continue;case E.ATTRIB_VALUE_CLOSED:v(S)?p.state=E.ATTRIB:S===">"?W(p):S==="/"?p.state=E.OPEN_TAG_SLASH:A(T,S)?(C(p,"No whitespace between attributes"),p.attribName=S,p.attribValue="",p.state=E.ATTRIB_NAME):C(p,"Invalid attribute name");continue;case E.ATTRIB_VALUE_UNQUOTED:if(!x(S)){S==="&"?p.state=E.ATTRIB_VALUE_ENTITY_U:p.attribValue+=S;continue}B(p),S===">"?W(p):p.state=E.ATTRIB;continue;case E.CLOSE_TAG:if(p.tagName)S===">"?se(p):A(w,S)?p.tagName+=S:p.script?(p.script+="</"+p.tagName,p.tagName="",p.state=E.SCRIPT):(v(S)||C(p,"Invalid tagname in closing tag"),p.state=E.CLOSE_TAG_SAW_WHITE);else{if(v(S))continue;J(T,S)?p.script?(p.script+="</"+S,p.state=E.SCRIPT):C(p,"Invalid tagname in closing tag."):p.tagName=S}continue;case E.CLOSE_TAG_SAW_WHITE:if(v(S))continue;S===">"?se(p):C(p,"Invalid characters in closing tag");continue;case E.TEXT_ENTITY:case E.ATTRIB_VALUE_ENTITY_Q:case E.ATTRIB_VALUE_ENTITY_U:var we,Ae;switch(p.state){case E.TEXT_ENTITY:we=E.TEXT,Ae="textNode";break;case E.ATTRIB_VALUE_ENTITY_Q:we=E.ATTRIB_VALUE_QUOTED,Ae="attribValue";break;case E.ATTRIB_VALUE_ENTITY_U:we=E.ATTRIB_VALUE_UNQUOTED,Ae="attribValue";break}if(S===";")if(p.opt.unparsedEntities){var Pe=ne(p);p.entity="",p.state=we,p.write(Pe)}else p[Ae]+=ne(p),p.entity="",p.state=we;else A(p.entity.length?b:_,S)?p.entity+=S:(C(p,"Invalid character in entity name"),p[Ae]+="&"+p.entity+S,p.entity="",p.state=we);continue;default:throw new Error(p,"Unknown state: "+p.state)}return p.position>=p.bufferCheckPosition&&n(p),p}/*! http://mths.be/fromcodepoint v0.1.0 by @mathias */return String.fromCodePoint||function(){var g=String.fromCharCode,p=Math.floor,I=function(){var S=16384,ie=[],ge,we,Ae=-1,Pe=arguments.length;if(!Pe)return"";for(var nt="";++Ae<Pe;){var Ee=Number(arguments[Ae]);if(!isFinite(Ee)||Ee<0||Ee>1114111||p(Ee)!==Ee)throw RangeError("Invalid code point: "+Ee);Ee<=65535?ie.push(Ee):(Ee-=65536,ge=(Ee>>10)+55296,we=Ee%1024+56320,ie.push(ge,we)),(Ae+1===Pe||ie.length>S)&&(nt+=g.apply(null,ie),ie.length=0)}return nt};Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:I,configurable:!0,writable:!0}):String.fromCodePoint=I}(),r},kb=Ab(),Pa=`The output should be formatted as a XML file.
1. Output should conform to the tags below. 
2. If tags are not given, make them on your own.
3. Remember to always open and close all the tags.

As an example, for the tags ["foo", "bar", "baz"]:
1. String "<foo>
   <bar>
      <baz></baz>
   </bar>
</foo>" is a well-formatted instance of the schema. 
2. String "<foo>
   <bar>
   </foo>" is a badly-formatted instance.
3. String "<foo>
   <tag>
   </tag>
</foo>" is a badly-formatted instance.

Here are the output tags:
\`\`\`
{tags}
\`\`\``;var Rb=class extends Es{constructor(e){super(e);y(this,"tags");y(this,"lc_namespace",["langchain_core","output_parsers"]);y(this,"lc_serializable",!0);this.tags=e==null?void 0:e.tags}static lc_name(){return"XMLOutputParser"}_diff(e,t){if(t)return e?yi(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return La(e[0].text)}async parse(e){return La(e)}getFormatInstructions(){var t;return!!(this.tags&&this.tags.length>0)?Pa.replace("{tags}",((t=this.tags)==null?void 0:t.join(", "))??""):Pa}};const $b=r=>r.split(`
`).map(e=>e.replace(/^\s+/,"")).join(`
`).trim(),Sd=r=>{if(Object.keys(r).length===0)return{};const e={};return r.children.length>0?(e[r.name]=r.children.map(Sd),e):(e[r.name]=r.text??void 0,e)};function La(r){const e=$b(r),t=kb.parser(!0);let n={};const s=[];t.onopentag=o=>{const c={name:o.name,attributes:o.attributes,children:[],text:"",isSelfClosing:o.isSelfClosing};s.length>0?s[s.length-1].children.push(c):n=c,o.isSelfClosing||s.push(c)},t.onclosetag=()=>{if(s.length>0){const o=s.pop();s.length===0&&o&&(n=o)}},t.ontext=o=>{if(s.length>0){const c=s[s.length-1];c.text+=o}},t.onattribute=o=>{if(s.length>0){const c=s[s.length-1];c.attributes[o.name]=o.value}};const a=/```(xml)?(.*)```/s.exec(e),i=a?a[2]:e;return t.write(i).close(),n&&n.name==="?xml"&&(n=n.children[0]),Sd(n)}var Cb={};he(Cb,{AsymmetricStructuredOutputParser:()=>Ob,BaseCumulativeTransformOutputParser:()=>Es,BaseLLMOutputParser:()=>bd,BaseOutputParser:()=>bs,BaseTransformOutputParser:()=>_n,BytesOutputParser:()=>bb,CommaSeparatedListOutputParser:()=>Eb,CustomListOutputParser:()=>Tb,JsonMarkdownStructuredOutputParser:()=>Td,JsonOutputParser:()=>Ed,ListOutputParser:()=>wn,MarkdownListOutputParser:()=>xb,NumberedListOutputParser:()=>Sb,OutputParserException:()=>kt,StringOutputParser:()=>Ib,StructuredOutputParser:()=>Ai,XMLOutputParser:()=>Rb,XML_FORMAT_INSTRUCTIONS:()=>Pa,parseJsonMarkdown:()=>ca,parsePartialJson:()=>as,parseXMLMarkdown:()=>La});function ki(r,e){if(r.function===void 0)return;let t;if(e!=null&&e.partial)try{t=as(r.function.arguments??"{}")}catch{return}else try{t=JSON.parse(r.function.arguments)}catch(s){throw new kt([`Function "${r.function.name}" arguments:`,"",r.function.arguments,"","are not valid JSON.",`Error: ${s.message}`].join(`
`))}const n={name:r.function.name,args:t,type:"tool_call"};return e!=null&&e.returnId&&(n.id=r.id),n}function xd(r){if(r.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:r.id,type:"function",function:{name:r.name,arguments:JSON.stringify(r.args)}}}function Id(r,e){var t,n;return{name:(t=r.function)==null?void 0:t.name,args:(n=r.function)==null?void 0:n.arguments,id:r.id,error:e,type:"invalid_tool_call"}}var Od=class extends Es{constructor(e){super(e);y(this,"returnId",!1);y(this,"lc_namespace",["langchain","output_parsers","openai_tools"]);y(this,"lc_serializable",!0);this.returnId=(e==null?void 0:e.returnId)??this.returnId}static lc_name(){return"JsonOutputToolsParser"}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){var i;const n=e[0].message;let s;if(is(n)&&((i=n.tool_calls)!=null&&i.length)?s=n.tool_calls.map(o=>{const{id:c,...u}=o;return this.returnId?{id:c,...u}:u}):n.additional_kwargs.tool_calls!==void 0&&(s=JSON.parse(JSON.stringify(n.additional_kwargs.tool_calls)).map(c=>ki(c,{returnId:this.returnId,partial:t}))),!s)return[];const a=[];for(const o of s)if(o!==void 0){const c={type:o.name,args:o.args,id:o.id};a.push(c)}return a}},ja=class extends Od{constructor(e){super(e);y(this,"lc_namespace",["langchain","output_parsers","openai_tools"]);y(this,"lc_serializable",!0);y(this,"returnId",!1);y(this,"keyName");y(this,"returnSingle",!1);y(this,"zodSchema");this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}static lc_name(){return"JsonOutputKeyToolsParser"}async _validateResult(e){var n;if(this.zodSchema===void 0)return e;const t=await Mc(this.zodSchema,e);if(t.success)return t.data;throw new kt(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify((n=t.error)==null?void 0:n.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const n=(await super.parsePartialResult(e)).filter(a=>a.type===this.keyName);let s=n;if(n.length)return this.returnId||(s=n.map(a=>a.args)),this.returnSingle?s[0]:s}async parseResult(e){const n=(await super.parsePartialResult(e,!1)).filter(i=>i.type===this.keyName);let s=n;return n.length?(this.returnId||(s=n.map(i=>i.args)),this.returnSingle?this._validateResult(s[0]):await Promise.all(s.map(i=>this._validateResult(i)))):void 0}},Nb={};he(Nb,{JsonOutputKeyToolsParser:()=>ja,JsonOutputToolsParser:()=>Od,convertLangChainToolCallToOpenAI:()=>xd,makeInvalidToolCall:()=>Id,parseToolCall:()=>ki});function Ad(r){return r!==void 0&&Array.isArray(r.lc_namespace)}function kd(r){return r!==void 0&&Ie.isRunnable(r)&&"lc_name"in r.constructor&&typeof r.constructor.lc_name=="function"&&r.constructor.lc_name()==="RunnableToolLike"}function Rd(r){return!!r&&typeof r=="object"&&"name"in r&&"schema"in r&&(or(r.schema)||r.schema!=null&&typeof r.schema=="object"&&"type"in r.schema&&typeof r.schema.type=="string"&&["null","boolean","object","array","number","string"].includes(r.schema.type))}function $d(r){return Rd(r)||kd(r)||Ad(r)}var Pb={};he(Pb,{convertToOpenAIFunction:()=>Cd,convertToOpenAITool:()=>Ma,isLangChainTool:()=>$d,isRunnableToolLike:()=>kd,isStructuredTool:()=>Ad,isStructuredToolParams:()=>Rd});function Cd(r,e){const t=typeof e=="number"?void 0:e;return{name:r.name,description:r.description,parameters:Wt(r.schema),...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}}function Ma(r,e){const t=typeof e=="number"?void 0:e;let n;return $d(r)?n={type:"function",function:Cd(r)}:n=r,(t==null?void 0:t.strict)!==void 0&&(n.function.strict=t.strict),n}const Lb=["frequency_penalty","function_call","functions","logit_bias","logprobs","max_completion_tokens","max_tokens","n","parallel_tool_calls","presence_penalty","reasoning_format","response_format","seed","service_tier","stop","temperature","tool_choice","top_logprobs","top_p"],jb=["headers","promptIndex","stream_options","tools"],Mb=[...Lb,...jb];function Db(r){if(r.role!=="system"&&r.role!=="assistant"&&r.role!=="user"&&r.role!=="function")throw new Error(`Unsupported message role: ${r.role}. Expected "system", "assistant", "user", or "function"`);return r.role}function Ub(r){switch(r.type){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!fr.isInstance(r))throw new Error("Invalid generic chat message");return Db(r);default:throw new Error(`Unknown message type: ${r.type}`)}}function xc(r){return r.map(e=>{var n;const t={role:Ub(e),content:e.content,name:e.name,function_call:e.additional_kwargs.function_call,tool_calls:e.additional_kwargs.tool_calls,tool_call_id:e.tool_call_id};return is(e)&&((n=e.tool_calls)!=null&&n.length)?t.tool_calls=e.tool_calls.map(xd):(e.additional_kwargs.tool_calls!=null&&(t.tool_calls=e.additional_kwargs.tool_calls),e.tool_call_id!=null&&(t.tool_call_id=e.tool_call_id)),t})}function Fb(r,e,t){const n=r.tool_calls;switch(r.role){case"assistant":{const s=[],a=[];for(const i of n??[])try{s.push(ki(i,{returnId:!0}))}catch(o){a.push(Id(i,o.message))}return new Nt({content:r.content||"",additional_kwargs:{tool_calls:n},tool_calls:s,invalid_tool_calls:a,usage_metadata:e,response_metadata:t})}default:return new fr(r.content||"",r.role??"unknown")}}function Bb(r,e,t,n){var f,h;const s=r.role??e,a=r.content??"";let i;r.function_call?i={function_call:r.function_call}:r.tool_calls?i={tool_calls:r.tool_calls}:i={},r.audio&&(i.audio={...r.audio,index:t.choices[0].index});let o,c=n,u;const l=t.x_groq;l!=null&&l.usage&&(o={input_tokens:l.usage.prompt_tokens,output_tokens:l.usage.completion_tokens,total_tokens:l.usage.total_tokens},u={completion_time:l.usage.completion_time,prompt_time:l.usage.prompt_time,queue_time:l.usage.queue_time,total_time:l.usage.total_time}),l!=null&&l.id&&(c=l.id);const d={usage:o,timing:u};if(s==="user")return new fn({content:a,response_metadata:d});if(s==="assistant"){const m=[];if(Array.isArray(r.tool_calls))for(const T of r.tool_calls)m.push({name:(f=T.function)==null?void 0:f.name,args:(h=T.function)==null?void 0:h.arguments,id:T.id,index:T.index,type:"tool_call_chunk"});return new Dt({content:a,tool_call_chunks:m,additional_kwargs:i,id:c,response_metadata:d})}else return s==="system"?new Xt({content:a,response_metadata:d}):s==="developer"?new Xt({content:a,response_metadata:d,additional_kwargs:{__openai_role__:"developer"}}):s==="function"?new dn({content:a,additional_kwargs:i,name:r.name,response_metadata:d}):s==="tool"?new un({content:a,additional_kwargs:i,tool_call_id:r.tool_call_id,response_metadata:d}):new ln({content:a,role:s,response_metadata:d})}var zb=class extends xi{constructor(e){super(e);y(this,"lc_namespace",["langchain","chat_models","groq"]);y(this,"client");y(this,"model");y(this,"temperature",.7);y(this,"stop");y(this,"stopSequences");y(this,"maxTokens");y(this,"streaming",!1);y(this,"apiKey");y(this,"streamUsage",!0);y(this,"topP");y(this,"frequencyPenalty");y(this,"presencePenalty");y(this,"logprobs");y(this,"n");y(this,"logitBias");y(this,"user");y(this,"reasoningFormat");y(this,"serviceTier");y(this,"topLogprobs");y(this,"lc_serializable",!0);const t=e.apiKey||Ot("GROQ_API_KEY");if(!t)throw new Error('Groq API key not found. Please set the GROQ_API_KEY environment variable or provide the key into "apiKey"');const n={"User-Agent":"langchainjs",...e.defaultHeaders??{}};this.client=new _e({apiKey:t,dangerouslyAllowBrowser:!0,baseURL:e.baseUrl,timeout:e.timeout,httpAgent:e.httpAgent,fetch:e.fetch,maxRetries:0,defaultHeaders:n,defaultQuery:e.defaultQuery}),this.apiKey=t,this.temperature=e.temperature??this.temperature,this.model=e.model,this.streaming=e.streaming??this.streaming,this.stop=e.stopSequences??(typeof e.stop=="string"?[e.stop]:e.stop)??[],this.stopSequences=this.stop,this.maxTokens=e.maxTokens,this.topP=e.topP,this.frequencyPenalty=e.frequencyPenalty,this.presencePenalty=e.presencePenalty,this.logprobs=e.logprobs,this.n=e.n,this.logitBias=e.logitBias,this.user=e.user}get lc_serialized_keys(){return["client","model","temperature","stop","stopSequences","maxTokens","streaming","apiKey","streamUsage","topP","frequencyPenalty","presencePenalty","logprobs","n","logitBias","user","reasoningFormat","serviceTier","topLogprobs"]}static lc_name(){return"ChatGroq"}_llmType(){return"groq"}get lc_secrets(){return{apiKey:"GROQ_API_KEY"}}get callKeys(){return[...super.callKeys,...Mb]}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"groq",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??this.temperature,ls_max_tokens:t.max_tokens??this.maxTokens,ls_stop:e.stop}}async completionWithRetry(e,t){return this.caller.call(async()=>this.client.chat.completions.create(e,t))}invocationParams(e,t){var i;const n=super.invocationParams(e);let s={};(e==null?void 0:e.stream_options)!==void 0?s={stream_options:e.stream_options}:(this.streamUsage&&this.streaming||t!=null&&t.streaming)&&(s={stream_options:{include_usage:!0}});const a={model:this.model,frequency_penalty:this.frequencyPenalty,function_call:e==null?void 0:e.function_call,functions:e==null?void 0:e.functions,logit_bias:this.logitBias,logprobs:this.logprobs,n:this.n,parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,presence_penalty:this.presencePenalty,reasoning_format:this.reasoningFormat,response_format:e==null?void 0:e.response_format,seed:e==null?void 0:e.seed,service_tier:this.serviceTier,stop:(e==null?void 0:e.stop)??this.stopSequences,temperature:(e==null?void 0:e.temperature)??this.temperature,tool_choice:Gb(e==null?void 0:e.tool_choice),tools:(i=e==null?void 0:e.tools)!=null&&i.length?e.tools.map(o=>Ma(o)):void 0,top_logprobs:this.topLogprobs,top_p:this.topP,user:this.user,stream:this.streaming,...n,...s};return a.max_completion_tokens=(e==null?void 0:e.max_completion_tokens)??(e==null?void 0:e.max_tokens)??this.maxTokens,a.max_completion_tokens===-1&&delete a.max_completion_tokens,a}bindTools(e,t){return this.withConfig({tools:e.map(n=>Ma(n)),...t})}async*_streamResponseChunks(e,t,n){var l,d;const s=this.invocationParams(t,{streaming:!0}),a=xc(e),i=await this.completionWithRetry({...s,messages:a,stream:!0},{signal:t==null?void 0:t.signal,headers:t==null?void 0:t.headers});let o,c,u;for await(const f of i){u=f;const h=f==null?void 0:f.choices[0];if(!h)continue;(l=h.delta)!=null&&l.role&&(o=h.delta.role);const m=Bb(h.delta,o,f,c),T={prompt:t.promptIndex??0,completion:h.index??0};if(typeof m.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const w={...T};h.finish_reason!=null&&(w.finish_reason=h.finish_reason,w.system_fingerprint=f.system_fingerprint,w.model_name=f.model);const _=new an({message:m,text:m.content,generationInfo:w});yield _,await(n==null?void 0:n.handleLLMNewToken(_.text??"",T,void 0,void 0,void 0,{chunk:_}))}if(u&&("choices"in u&&delete u.choices,yield new an({message:new Dt({content:"",response_metadata:u}),text:""})),(d=t.signal)!=null&&d.aborted)throw new Error("AbortError")}async _generate(e,t,n){var s;if(this.streaming){const a={},i=this._streamResponseChunks(e,t,n),o={};for await(const u of i){const l=((s=u.generationInfo)==null?void 0:s.completion)??0;o[l]===void 0?o[l]=u:o[l]=o[l].concat(u)}return{generations:Object.entries(o).sort(([u],[l])=>parseInt(u,10)-parseInt(l,10)).map(([u,l])=>l),llmOutput:{estimatedTokenUsage:a}}}else return this._generateNonStreaming(e,t,n)}async _generateNonStreaming(e,t,n){var u;const s={},a=this.invocationParams(t),i=xc(e),o=await this.completionWithRetry({...a,stream:!1,messages:i},{signal:t==null?void 0:t.signal,headers:t==null?void 0:t.headers});if("usage"in o&&o.usage){const{completion_tokens:l,prompt_tokens:d,total_tokens:f}=o.usage;l&&(s.completionTokens=(s.completionTokens??0)+l),d&&(s.promptTokens=(s.promptTokens??0)+d),f&&(s.totalTokens=(s.totalTokens??0)+f)}const c=[];if("choices"in o&&o.choices)for(const l of o.choices){const d=((u=l.message)==null?void 0:u.content)??"";let f;s.totalTokens!==void 0&&(f={input_tokens:s.promptTokens??0,output_tokens:s.completionTokens??0,total_tokens:s.totalTokens});const{choices:h,...m}=o,T={text:d,message:Fb(l.message??{role:"assistant"},f,m)};T.generationInfo={...l.finish_reason?{finish_reason:l.finish_reason}:{},...l.logprobs?{logprobs:l.logprobs}:{}},c.push(T)}return{generations:c,llmOutput:{tokenUsage:s}}}get profile(){return Dd[this.model]??{}}withStructuredOutput(e,t){const n=e,s=t==null?void 0:t.name,a=t==null?void 0:t.method,i=t==null?void 0:t.includeRaw;let o=s??"extract",c,u;if(a==="jsonMode"){let h;or(n)?(c=Ai.fromZodSchema(n),h=Wt(n)):c=new Ed,u=this.withConfig({response_format:{type:"json_object"},ls_structured_output_format:{kwargs:{method:"jsonMode"},schema:h}})}else if(or(n)){const h=Wt(n);u=this.bindTools([{type:"function",function:{name:o,description:h.description,parameters:h}}]).withConfig({tool_choice:{type:"function",function:{name:o}},ls_structured_output_format:{kwargs:{method:"functionCalling"},schema:h}}),c=new ja({returnSingle:!0,keyName:o,zodSchema:n})}else{let h;typeof n.name=="string"&&typeof n.parameters=="object"&&n.parameters!=null?(h=n,o=n.name):(o=n.title??o,h={name:o,description:n.description??"",parameters:n}),u=this.bindTools([{type:"function",function:h}]).withConfig({tool_choice:{type:"function",function:{name:o}},ls_structured_output_format:{kwargs:{method:"functionCalling"},schema:n}}),c=new ja({returnSingle:!0,keyName:o})}if(!i)return u.pipe(c).withConfig({runName:"ChatGroqStructuredOutput"});const l=$r.assign({parsed:(h,m)=>c.invoke(h.raw,m)}),d=$r.assign({parsed:()=>null}),f=l.withFallbacks({fallbacks:[d]});return gn.from([{raw:u},f]).withConfig({runName:"ChatGroqStructuredOutput"})}};function Gb(r){if(r)return r==="any"||r==="required"?"required":r==="auto"?"auto":r==="none"?"none":typeof r=="string"?{type:"function",function:{name:r}}:r}const qb="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",nE=async r=>{const e=r.slice(0,2e4),t=new zb({apiKey:qb,model:"llama-3.3-70b-versatile",temperature:0,maxTokens:4096}),n=`
    You are a data extraction AI. Your job is to extract candidate information from the provided text.
    
    The text may contain names, phone numbers, emails, locations (cities), and course interests.
    
    RULES:
    1. Extract a JSON array of objects.
    2. Each object MUST have 'name' and 'phone'. If name or phone is missing, skip that person.
    3. 'phone' must be normalized to digits only (e.g., "1234567890"). Remove spaces, dashes, parentheses.
    4. 'email', 'city', and 'course' are optional fields.
    5. Return ONLY the raw JSON array. Do not include markdown formatting (like \`\`\`json). Do not add any conversational text.
    
    Expected JSON Structure:
    [
      {
        "name": "John Doe",
        "phone": "9876543210",
        "email": "john@example.com",
        "city": "Mumbai",
        "course": "B.Tech"
      }
    ]
  `;try{const i=(await t.invoke([new Pt(n),new xt(e)])).content.replace(/```json/g,"").replace(/```/g,"").trim();return JSON.parse(i)}catch(s){throw console.error("Error extracting candidates with AI:",s),new Error("Failed to extract candidates from text")}};export{nE as extractCandidatesFromText};
